import{d as R,b as B}from"../chunks/kz80bbCR.js";import{i as Be}from"../chunks/2r1cYJse.js";import{o as Ve}from"../chunks/D0mpzbhj.js";import{w as Me,aj as M,z as Re,O as Q,ap as c,al as r,am as s,aq as Ee,ar as Ye,V as l,W as h,Q as e,ao as dt,au as Ke,as as ze,an as pt,aE as ut,aD as ke}from"../chunks/BUDlkbfV.js";import{s as v}from"../chunks/BbnaKca8.js";import{i as ue}from"../chunks/28pso2Hb.js";import{e as Pe,b as je}from"../chunks/CiCNsvIE.js";import{s as Ae,a as De}from"../chunks/D32zTIdM.js";import{g as $e}from"../chunks/DqiWXVxP.js";import{p as gt}from"../chunks/dMfnY97A.js";import{$ as He}from"../chunks/C36u96xB.js";import{g as ft}from"../chunks/e6l8DgL1.js";import{s as _t}from"../chunks/3azsccOw.js";import{t as we}from"../chunks/sXlFIKQv.js";import{c as mt}from"../chunks/CmEqjr1-.js";import{a as bt}from"../chunks/E07TNQLR.js";import{a as ht,f as yt,s as Pt}from"../chunks/Caezn3U5.js";import{L as xt}from"../chunks/Dr8j7HxN.js";import{F as Tt,K as kt,M as wt,a as Dt}from"../chunks/Dp02Bg33.js";import{p as I}from"../chunks/Bf5_DoVm.js";import{I as Ne}from"../chunks/DaDtKPX8.js";import{f as Ue,s as Ce,a as be,r as Ge}from"../chunks/BJyhluUY.js";import{b as Ie,c as St}from"../chunks/njKOc8Q7.js";import{s as Lt}from"../chunks/5HrxelVy.js";import{b as Ft}from"../chunks/CGc6l0L7.js";import{e as $t}from"../chunks/BOGOvxWJ.js";import{a as Et}from"../chunks/BS5RVGlS.js";var Ct=R('<button class="chat-button secondary svelte-3k5t7l"><!> <span> </span></button>'),It=R("<span> </span>"),Bt=R("<span> </span>"),Mt=R("<span> </span>"),Rt=R('<div class="header svelte-3k5t7l"><div class="header-title svelte-3k5t7l"> </div> <div class="header-actions svelte-3k5t7l"><!> <button class="save-button svelte-3k5t7l" type="submit"><!></button></div></div>');function At(ve,d){Me(d,!1);const[ee,oe]=Ae(),i=()=>De(He,"$t",ee);let t=I(d,"persona",8),te=I(d,"loading",8),V=I(d,"showSuccess",8),n=I(d,"uploadProgress",8),P=I(d,"onSave",8),L=I(d,"onStartChat",8);Be();var A=Rt(),Y=r(A),x=r(Y,!0);s(Y);var u=c(Y,2),g=r(u);{var k=T=>{var $=Ct(),E=r($);Ne(E,{icon:"ph:chat-circle-dots-bold"});var S=c(E,2),z=r(S,!0);s(S),s($),M(F=>v(z,F),[()=>i()("profilePage.startChatButton")],Q),Pe("click",$,function(...F){L()?.apply(this,F)}),B(T,$)};ue(g,T=>{t().id&&T(k)})}var D=c(g,2),J=r(D);{var W=T=>{var $=It(),E=r($);s($),M((S,z)=>v(E,`${S??""} (${z??""}%)`),[()=>i()("editPage.saveButtonLoading"),()=>Math.round(n())],Q),B(T,$)},de=(T,$)=>{{var E=z=>{var F=Bt(),se=r(F,!0);s(F),M(le=>v(se,le),[()=>i()("editPage.saveButtonSuccess")],Q),B(z,F)},S=z=>{var F=Mt(),se=r(F,!0);s(F),M(le=>v(se,le),[()=>i()("editPage.saveButton")],Q),B(z,F)};ue(T,z=>{V()?z(E):z(S,!1)},$)}};ue(J,T=>{te()?T(W):T(de,!1)})}s(D),s(u),s(A),M(T=>{v(x,T),D.disabled=te()||V()},[()=>i()("editPage.title")],Q),Pe("click",D,function(...T){P()?.apply(this,T)}),B(ve,A),Re(),oe()}const Ht=119,Ot=["m+Lzm8Xa","GZzF/5zH3g==","m9bHncbDnND7nPXf","m+znm9bHncLnm9fr","m/XDm+rPm+//ncTX","m+nnm/XDnMfenMXi","FB8eGxMHGAUZ","BxITGAcfHhseFg==","GR4QEBIF","ERYQEBgD","GRYNHg==","Hx4DGxIF","BBkCERE=","FRIfEhYTHhkQ","kvLnkNzSlPTqlPTclPT5","kvLnkNzSn8XAke/S","kdnNktnEk83/kub9","kP/xkNfDk83/kub9","nuDwlPTnlPXTlPT/"],zt=["nMTDm9D3","m+nnm9D3","m+POmvvj","m+LLnPju","ncfincfz","nOHLm+PO","nP3Sm+3i","mvjbnNLDnPLP","BxgFGQ==","Dw8P","HxIZAxYe","FRsYAB0YFQ==","ExISBwMfBRgWAw==","HxYZEx0YFQ==","ERIDHgQf","FRMEGg==","lPb9lPbJlPXklPbk","lPbWlPXklPbk","lPXzlPX9lPbJlPXk","k8/akvDNlPbg","k87Gk83T","lPTilPXQlPTe"],Qe=ve=>{try{const d=atob(ve),ee=new Uint8Array(d.length);for(let i=0;i<d.length;i++)ee[i]=d.charCodeAt(i);const oe=new Uint8Array(ee.length);for(let i=0;i<ee.length;i++)oe[i]=ee[i]^Ht;return new TextDecoder().decode(oe)}catch(d){return console.error("Decoding failed",d),""}};var Nt=R("<option>Live2D(beta)</option> <option>3D(beta)</option>",1),Xt=R('<div class="form-section-card svelte-g7fsw8"><h2 class="svelte-g7fsw8"> </h2> <div class="form-group svelte-g7fsw8"><label for="name" class="svelte-g7fsw8"> </label> <input id="name" required class="svelte-g7fsw8"/></div> <div class="form-group svelte-g7fsw8"><label for="one_liner" class="svelte-g7fsw8"> </label> <p class="description svelte-g7fsw8"> </p> <input id="one_liner" maxlength="60" class="input-field svelte-g7fsw8"/> <div> </div></div> <div class="form-group svelte-g7fsw8"><label for="greeting" class="svelte-g7fsw8"> </label> <p class="description svelte-g7fsw8"> </p> <textarea id="greeting" rows="3" maxlength="200" class="svelte-g7fsw8"></textarea> <div> </div></div> <div class="form-group svelte-g7fsw8"><label for="personaType" class="svelte-g7fsw8"> </label> <select id="personaType" required class="svelte-g7fsw8"><option disabled> </option><option>Chat</option><!></select></div> <div class="form-group svelte-g7fsw8"><label for="visibility" class="svelte-g7fsw8"> </label> <div class="content-type-selector svelte-g7fsw8"><button type="button"><!> <div class="text svelte-g7fsw8"><span class="title svelte-g7fsw8"> </span> <span class="desc svelte-g7fsw8"> </span></div></button> <button type="button"><!> <div class="text svelte-g7fsw8"><span class="title svelte-g7fsw8"> </span> <span class="desc svelte-g7fsw8"> </span></div></button></div></div></div>');function qt(ve,d){Me(d,!1);const[ee,oe]=Ae(),i=()=>De(He,"$t",ee);let t=I(d,"persona",12),te=I(d,"previousPersonaType",12,"");function V(m){t().tags.includes(m)?t(t().tags=t().tags.filter(ie=>ie!==m),!0):t(t().tags=[...t().tags,m],!0)}let n=h([]),P=h([]),L=h("");Ve(()=>{l(n,Ot.map(Qe).filter(m=>m)),l(P,zt.map(Qe).filter(m=>m))}),Ee(()=>(e(n),dt(t()),e(L),i(),e(P)),()=>{if(e(n).length>0&&(t().name||t().one_liner)){const m=(t().name+" "+(t().one_liner||"")).toLowerCase(),ie=e(n).find(ne=>ne&&m.includes(ne.toLowerCase()));ie?e(L)!==ie&&(l(L,ie),we.error((i()("editPage.validation.bannedWordHardDetected")||"Forbidden word detected: ")+ie)):(l(L,""),e(P).find(me=>me&&m.includes(me.toLowerCase()))&&(t().tags.includes("1003")||(V("1003"),we.warning(i()("editPage.validation.bannedWordDetected")||"Sensitive content detected. 'Adult Content' tag has been automatically enabled."))))}}),Ye(),Be();var A=Xt(),Y=r(A),x=r(Y,!0);s(Y);var u=c(Y,2),g=r(u),k=r(g,!0);s(g);var D=c(g,2);Ge(D),s(u);var J=c(u,2),W=r(J),de=r(W,!0);s(W);var T=c(W,2),$=r(T,!0);s(T);var E=c(T,2);Ge(E);var S=c(E,2),z=r(S);s(S),s(J);var F=c(J,2),se=r(F),le=r(se,!0);s(se);var ge=c(se,2),Se=r(ge,!0);s(ge);var fe=c(ge,2);je(fe);var xe=c(fe,2);let Te;var he=r(xe);s(xe),s(F);var ye=c(F,2),f=r(ye),_=r(f,!0);s(f);var y=c(f,2);M(()=>{t(),Ke(()=>{te(),i()})});var j=r(y);j.value=j.__value="";var C=r(j,!0);s(j);var K=c(j);K.value=K.__value="2D";var U=c(K);{var N=m=>{var ie=Nt(),ne=ze(ie);ne.value=ne.__value="2.5D";var me=c(ne,2);me.value=me.__value="3D",B(m,ie)};ue(U,m=>{t().contentType!=="story"&&m(N)})}s(y),s(ye);var ce=c(ye,2),H=r(ce),G=r(H,!0);s(H);var Z=c(H,2),X=r(Z);let re;var _e=r(X);Ne(_e,{icon:"ph:globe-duotone",width:"24"});var a=c(_e,2),o=r(a),p=r(o,!0);s(o);var b=c(o,2),O=r(b,!0);s(b),s(a),s(X);var q=c(X,2);let w;var ae=r(q);Ne(ae,{icon:"ph:lock-key-duotone",width:"24"});var pe=c(ae,2),Le=r(pe),Oe=r(Le,!0);s(Le);var Fe=c(Le,2),Xe=r(Fe,!0);s(Fe),s(pe),s(q),s(Z),s(ce),s(A),M((m,ie,ne,me,qe,Je,We,Ze,et,tt,at,st,rt,it,nt,ot,lt,ct,vt)=>{v(x,m),v(k,ie),Ce(D,"placeholder",ne),v(de,me),v($,qe),Ce(E,"placeholder",Je),be(S,1,`char-counter ${(t().one_liner||"").length>60?"error":""}`,"svelte-g7fsw8"),v(z,`${(t().one_liner||"").length??""}/60`),v(le,We),v(Se,Ze),Ce(fe,"placeholder",et),Te=be(xe,1,"char-counter svelte-g7fsw8",null,Te,tt),v(he,`${t().greeting.length??""} / 200`),v(_,at),v(C,st),v(G,rt),re=be(X,1,"svelte-g7fsw8",null,re,it),v(p,nt),v(O,ot),w=be(q,1,"svelte-g7fsw8",null,w,lt),v(Oe,ct),v(Xe,vt)},[()=>i()("editPage.basicInfo"),()=>t().contentType==="story"?i()("editPage.storyNameLabel"):i()("editPage.nameLabel"),()=>t().contentType==="story"?i()("editPage.storyNamePlaceholder"):i()("editPage.namePlaceholder"),()=>t().contentType==="story"?i()("editPage.storyOneLinerLabel"):i()("editPage.oneLinerLabel"),()=>t().contentType==="story"?i()("editPage.storyOneLinerDescription"):i()("editPage.oneLinerDescription"),()=>(t().contentType==="story",i()("editPage.oneLinerPlaceholder")),()=>i()("editPage.greetingLabel",{default:i()("editPage.greetingLabelDefault")}),()=>i()("editPage.greetingDescription",{default:i()("editPage.greetingDescriptionDefault")}),()=>i()("editPage.greetingPlaceholder",{default:i()("editPage.greetingPlaceholderDefault")}),()=>({warning:t().greeting.length>160,error:t().greeting.length>=200}),()=>i()("editPage.typeLabel"),()=>i()("editPage.typeSelectDefault"),()=>i()("editPage.visibilityLabel"),()=>({active:t().visibility==="public"}),()=>i()("editPage.public"),()=>i()("editPage.publicDesc",{default:"Anyone can see and chat"}),()=>({active:t().visibility==="private"}),()=>i()("editPage.private"),()=>i()("editPage.privateDesc",{default:"Only you can access"})],Q),Ie(D,()=>t().name,m=>t(t().name=m,!0)),Ie(E,()=>t().one_liner,m=>t(t().one_liner=m,!0)),Ie(fe,()=>t().greeting,m=>t(t().greeting=m,!0)),Ue(y,()=>t().personaType,m=>t(t().personaType=m,!0)),Pe("change",y,()=>{(te()==="3D"||te()==="2.5D")&&t().personaType==="2D"&&t(t().first_scene="",!0),te(t().personaType)}),Pe("click",X,()=>t(t().visibility="public",!0)),Pe("click",q,()=>t(t().visibility="private",!0)),B(ve,A),Re(),oe()}var Jt=R('<div class="toggle-container svelte-3260i8"><span></span> <label class="toggle-switch svelte-3260i8"><input type="checkbox" class="svelte-3260i8"/> <span class="slider svelte-3260i8"></span></label> <span></span> <div class="tooltip-icon svelte-3260i8"><!> <div class="tooltip-text svelte-3260i8"><p class="svelte-3260i8"><strong></strong> </p> <p class="svelte-3260i8"><strong></strong> </p></div></div></div> <button type="button" class="btn-util svelte-3260i8"> </button>',1),Wt=R('<!> <p class="description svelte-3260i8"> </p> <textarea id="first_scene" rows="5" maxlength="2500" class="svelte-3260i8"></textarea> <div> </div>',1),jt=R('<div class="form-group svelte-3260i8"><label for="prompt-template" class="svelte-3260i8"> </label> <select id="prompt-template" class="svelte-3260i8"><option> </option><option> </option><option> </option><option> </option></select></div>'),Gt=R('<div class="form-group svelte-3260i8"><label for="instruction-input" class="svelte-3260i8"> </label> <p class="description svelte-3260i8"> </p> <textarea id="instruction-input" rows="10" maxlength="3000" class="svelte-3260i8"></textarea> <div> </div></div>'),Qt=R('<div class="form-section-card svelte-3260i8"><h2 class="svelte-3260i8"> </h2> <div class="form-group svelte-3260i8"><label for="first_scene" class="svelte-3260i8"> </label> <!></div> <div class="form-group svelte-3260i8"><!> <!></div> <div class="form-group svelte-3260i8"><!></div></div>');function Vt(ve,d){Me(d,!1);const[ee,oe]=Ae(),i=()=>De(He,"$t",ee);let t=I(d,"persona",12),te=I(d,"selectedTemplate",12),V=I(d,"singleInstruction",12),n=I(d,"k_description",12),P=I(d,"k_personality",12),L=I(d,"k_userPersona",12),A=I(d,"k_scenario",12),Y=I(d,"firstSceneJson",12),x=I(d,"availableExpressions",8),u=I(d,"availableMotions",8),g=I(d,"kintsugiTemplateId",8),k=h(),D=h(!1);function J(){if(!e(k))return;const f=e(D)?"{{user}}":"{{char}}",_=`<dialogue speaker="${f}"></dialogue>`,y=e(k).selectionStart,j=t().first_scene;t(t().first_scene=j.substring(0,y)+_+j.substring(y),!0);const C=y+`<dialogue speaker="${f}">`.length;ut().then(()=>{e(k).focus(),ke(k,e(k).selectionStart=C),ke(k,e(k).selectionEnd=C)})}Be();var W=Qt(),de=r(W),T=r(de,!0);s(de);var $=c(de,2),E=r($),S=r(E,!0);s(E);var z=c(E,2);{var F=f=>{const _=Q(()=>t().personaType==="3D"?"3d":"live2d");Tt(f,{get initialData(){return t().first_scene},get availableExpressions(){return x()},get availableMotions(){return u()},get mode(){return e(_)},onChange:y=>{Y(y),t(t().first_scene=y,!0)}})},se=f=>{var _=Wt(),y=ze(_);{var j=G=>{var Z=Jt(),X=ze(Z),re=r(X);let _e;re.textContent="{{char}}";var a=c(re,2),o=r(a);Ge(o),pt(2),s(a);var p=c(a,2);let b;p.textContent="{{user}}";var O=c(p,2),q=r(O);Ne(q,{icon:"ph:question-bold"});var w=c(q,2),ae=r(w),pe=r(ae);pe.textContent="{{char}}";var Le=c(pe);s(ae);var Oe=c(ae,2),Fe=r(Oe);Fe.textContent="{{user}}";var Xe=c(Fe);s(Oe),s(w),s(O),s(X);var m=c(X,2),ie=r(m,!0);s(m),M((ne,me,qe,Je,We)=>{_e=be(re,1,"svelte-3260i8",null,_e,ne),b=be(p,1,"svelte-3260i8",null,b,me),v(Le,`: ${qe??""}`),v(Xe,`: ${Je??""}`),v(ie,We)},[()=>({active:!e(D)}),()=>({active:e(D)}),()=>i()("editPage.tooltip.char",{default:"캐릭터 이름"}),()=>i()("editPage.tooltip.user",{default:"사용자 이름"}),()=>i()("editPage.aiSettings.addDialogueTag")],Q),St(o,()=>e(D),ne=>l(D,ne)),Pe("click",m,J),B(G,Z)};ue(y,G=>{t().contentType!=="story"&&G(j)})}var C=c(y,2),K=r(C,!0);s(C);var U=c(C,2);je(U),Ft(U,G=>l(k,G),()=>e(k));var N=c(U,2);let ce;var H=r(N);s(N),M((G,Z,X)=>{v(K,G),Ce(U,"placeholder",Z),ce=be(N,1,"char-counter svelte-3260i8",null,ce,X),v(H,`${t().first_scene.length??""} / 2500`)},[()=>i()("editPage.firstSceneDescription"),()=>i()("editPage.firstScenePlaceholder"),()=>({warning:t().first_scene.length>2400,error:t().first_scene.length>=2500})],Q),Ie(U,()=>t().first_scene,G=>t(t().first_scene=G,!0)),B(f,_)};ue(z,f=>{t().personaType==="3D"||t().personaType==="2.5D"?f(F):f(se,!1)})}s($);var le=c($,2),ge=r(le);{var Se=f=>{var _=jt(),y=r(_),j=r(y,!0);s(y);var C=c(y,2);M(()=>{te(),Ke(()=>{i(),g()})});var K=r(C);K.value=K.__value="custom";var U=r(K,!0);s(K);var N=c(K);N.value=N.__value="conversation";var ce=r(N,!0);s(N);var H=c(N);H.value=H.__value="simulation";var G=r(H,!0);s(H);var Z=c(H),X={},re=r(Z,!0);s(Z),s(C),s(_),M((_e,a,o,p,b)=>{v(j,_e),v(U,a),v(ce,o),v(G,p),X!==(X=g())&&(Z.value=(Z.__value=g())??""),v(re,b)},[()=>i()("editPage.aiSettings.templateSelectLabel"),()=>i()("editPage.aiSettings.templateCustom"),()=>i()("editPage.aiSettings.templateConversation"),()=>i()("editPage.aiSettings.templateSimulation"),()=>i()("editPage.aiSettings.templateKintsugi")],Q),Ue(C,te),B(f,_)};ue(ge,f=>{t().personaType!=="3D"&&t().personaType!=="2.5D"&&f(Se)})}var fe=c(ge,2);{var xe=f=>{var _=Gt(),y=r(_),j=r(y,!0);s(y);var C=c(y,2),K=r(C,!0);s(C);var U=c(C,2);je(U);var N=c(U,2);let ce;var H=r(N);s(N),s(_),M((G,Z,X,re)=>{v(j,G),v(K,Z),Ce(U,"placeholder",X),ce=be(N,1,"char-counter svelte-3260i8",null,ce,re),v(H,`${V().length??""} / 3000`)},[()=>i()("editPage.instructionsLabel"),()=>i()("editPage.instructionsDescription"),()=>i()("editPage.instructionsPlaceholder"),()=>({warning:V().length>2500,error:V().length>=3e3})],Q),Ie(U,V),B(f,_)},Te=f=>{kt(f,{get k_description(){return n()},set k_description(_){n(_)},get k_personality(){return P()},set k_personality(_){P(_)},get k_userPersona(){return L()},set k_userPersona(_){L(_)},get k_scenario(){return A()},set k_scenario(_){A(_)},$$legacy:!0})};ue(fe,f=>{te()!==g()?f(xe):f(Te,!1)})}s(le);var he=c(le,2),ye=r(he);Lt(ye,d,"tags",{}),s(he),s(W),M((f,_)=>{v(T,f),v(S,_)},[()=>i()("editPage.aiSettings.title"),()=>t().personaType==="3D"||t().personaType==="2.5D"?i()("editPage.characterSettings.title"):i()("editPage.firstSceneLabel")],Q),B(ve,W),Re(),oe()}var Yt=R('<button type="button"> </button>'),Kt=R('<div class="form-group svelte-veynbq"><label for="tags-container" class="svelte-veynbq"> </label> <p class="description svelte-veynbq"> </p> <div class="category-button-container svelte-veynbq" id="tags-container"></div></div>');function Ut(ve,d){Me(d,!1);const[ee,oe]=Ae(),i=()=>De(He,"$t",ee);let t=I(d,"persona",12);function te(x){t().tags.includes(x)?t(t().tags=t().tags.filter(u=>u!==x),!0):t().tags.filter(g=>parseInt(g)<1e3).length<3?t(t().tags=[...t().tags,x],!0):we.warning(i()("editPage.validation.maxTags"))}Be();var V=Kt(),n=r(V),P=r(n,!0);s(n);var L=c(n,2),A=r(L,!0);s(L);var Y=c(L,2);$t(Y,5,()=>Et.filter(x=>x.id<1e3),x=>x.id,(x,u)=>{var g=Yt();let k;var D=r(g,!0);s(g),M((J,W)=>{k=be(g,1,"category-button svelte-veynbq",null,k,J),v(D,W)},[()=>({active:t().tags.includes(e(u).id.toString()),disabled:t().tags.filter(J=>parseInt(J)<1e3).length>=3&&!t().tags.includes(e(u).id.toString())}),()=>i()(e(u).nameKey)],Q),Pe("click",g,()=>te(e(u).id.toString())),B(x,g)}),s(Y),s(V),M((x,u)=>{v(P,x),v(A,u)},[()=>i()("editPage.tagsLabel"),()=>i()("editPage.tagsDescriptionCategory",{default:"카테고리를 선택하세요."})],Q),B(ve,V),Re(),oe()}var Zt=R('<p class="error svelte-1lto24z"> </p>'),ea=R('<div slot="tags"><!></div>'),ta=R("<span> </span>"),aa=R("<span> </span>"),sa=R("<span> </span>"),ra=R('<div class="container svelte-1lto24z"><!> <!> <div class="scrollable-content svelte-1lto24z"><div class="form-grid svelte-1lto24z"><div class="form-column svelte-1lto24z"><!> <!></div> <div class="form-column svelte-1lto24z"><!></div></div></div></div> <button class="mobile-save-button svelte-1lto24z" type="button"><!></button> <!> <!>',1);function Ca(ve,d){Me(d,!1);const[ee,oe]=Ae(),i=()=>De(gt,"$page",ee),t=()=>De(He,"$t",ee),te=h();let V=h(null),n=h({id:"",owner_id:[],name:"",one_liner:"",personaType:"",contentType:"character",instructions:[],promptExamples:[],tags:[],feedback:{view:0},voice_id:"",vrm_url:"",portrait_url:"",image_metadatas:[],image_count:0,visibility:"private",created_at:"",updated_at:"",creator_name:"",first_scene:"",greeting:"",likes_count:0,dislikes_count:0,chat_count:0}),P=h(""),L=h(!1),A=h(!1),Y=h(0);const x="kintsugi_v1";let u=h("custom"),g=h(""),k=h(""),D=h(""),J=h(""),W=h(""),de=h([]),T=h([]),$=h(""),E=h([]),S=h(""),z=h(""),F=h(null),se=h(!1),le=ft(_t)?.data.hasReceivedFirstCreationReward??!1;async function ge(a){try{const o=await ht(a);if(l(V,JSON.parse(JSON.stringify(o))),o.instructions.length>1&&o.instructions[1]){const p=o.instructions[1];if(p==="conversation")l(u,"conversation"),l(g,o.instructions[0]||"");else if(p==="simulation")l(u,"simulation"),l(g,o.instructions[0]||"");else if(p===x){l(u,x);try{const b=JSON.parse(o.instructions[0]||"{}");l(k,b.description||""),l(D,b.personality||""),l(J,b.userPersona||""),l(W,b.scenario||"")}catch(b){console.error("Kintsugi JSON parse failed",b),l(k,o.instructions[0]||"")}}else l(u,"custom"),l(g,o.instructions[0]||"")}else l(u,"custom"),l(g,o.instructions[0]||"");if(o.voice_id?l(S,o.voice_id):l(S,""),o.personaType==="3D"&&o.first_scene&&l($,o.first_scene),o.image_metadatas&&o.image_metadatas.length>0){const p=await yt(o.image_metadatas);o.image_metadatas=p}else o.image_metadatas=[];return o.contentType==="character"||o.contentType==="story"||(o.contentType="character"),l(n,o),e(n).one_liner||ke(n,e(n).one_liner=""),l(z,e(n).personaType),e(n).live2d_model_url&&(e(n).personaType==="2.5D"||e(n).personaType==="2D")&&Se(e(n).live2d_model_url),o}catch(o){console.error("Failed to load persona:",o),we.error("Failed to load persona")}}async function Se(a){if(a)try{const o=await fetch(a);if(!o.ok)throw new Error("Failed to fetch model3.json");const p=await o.json();let b=[];p.FileReferences?.Expressions?b=p.FileReferences.Expressions:p.expressions&&(b=p.expressions),Array.isArray(b)&&l(de,b.map(w=>{if(typeof w=="string")return w;const ae=w.Name||w.name||w.Id||w.id,pe=w.File||w.file;return ae||(pe?pe.split("/").pop().replace(".exp3.json",""):"")}).filter(w=>w));let O={};p.FileReferences?.Motions?O=p.FileReferences.Motions:p.motions&&(O=p.motions);const q=[];Object.values(O).forEach(w=>{Array.isArray(w)&&w.forEach(ae=>{const pe=ae.File||ae.file;pe&&q.push(pe)})}),l(T,q)}catch(o){console.warn("Failed to load Live2D metadata:",o)}}Ve(async()=>{if(!await bt.isLoggedIn()){$e("/login");return}try{const a=await fetch("/voices2.json");if(a.ok){const o=await a.json();l(E,o.items)}}catch(a){console.error("Failed to load voices.json",a)}});async function fe(){if(e(L)||e(A))return;l(P,"");let a=[];if(e(u)===x){if(e(k).length>1e3){l(P,t()("editPage.validation.kintsugiDescLimit"));return}if(e(D).length>1e3){l(P,t()("editPage.validation.kintsugiPersonalityLimit"));return}if(e(J).length>800){l(P,t()("editPage.validation.kintsugiUserPersonaLimit"));return}if(e(W).length>200){l(P,t()("editPage.validation.kintsugiScenarioLimit"));return}const o=JSON.stringify({description:e(k),personality:e(D),userPersona:e(J),scenario:e(W)});a.push(o)}else{if(a.push(e(g)),e(g).length>3e3){l(P,t()("editPage.validation.instructionsLimitExceeded"));return}if(!e(g).trim()){l(P,t()("editPage.validation.allFieldsRequired"));return}}if(e(u)==="conversation"?a.push("conversation"):e(u)==="simulation"?a.push("simulation"):e(u)===x?a.push(x):a.push("custom"),ke(n,e(n).instructions=a),!e(n).name.trim()||!e(n).personaType.trim()||!e(n).greeting.trim()||!e(n).first_scene.trim()||e(n).tags.length===0){l(P,t()("editPage.validation.allFieldsRequired"));return}if(e(n).greeting.length>200||e(n).first_scene.length>2500){l(P,t()("editPage.validation.charLimitExceeded"));return}if(e(n).promptExamples.some(o=>o.length>200)||e(n).promptExamples.length>10){l(P,t()("editPage.validation.promptExamplesLimitExceeded"));return}l(L,!0),l(Y,0);try{const o=await Pt(e(n));o&&(l(A,!0),setTimeout(()=>l(A,!1),2e3),e(n).id?ge(o):($e(`/edit?c=${o}`,{replaceState:!0}),le&&(l(se,!0),le=!1)))}catch(o){l(P,t()("editPage.errorSaveFailed",{values:{message:o.message}})),typeof window<"u"&&window.scrollTo({top:0,behavior:"smooth"})}finally{l(L,!1)}}function xe(){if(!e(n).id){we.error("저장 후 대화할 수 있습니다.");return}let a="gemini-flash-lite";mt.update(o=>{const p=o.find(b=>b.id===e(n)?.id);return p&&p.llmType&&(a=p.llmType),o}),(e(n)?.personaType==="3D"||e(n)?.personaType==="2.5D")&&(a="gemini-flash-lite"),e(n)?.personaType==="2D"||e(n)?.personaType==="2d"?$e(`/2d?c=${e(n).id}&llmType=${a}`):e(n)?.personaType==="3D"?$e(`/character?c=${e(n).id}&llmType=${a}`):e(n)?.personaType==="2.5D"?$e(`/live2d?c=${e(n).id}&llmType=${a}`):we.error(`Unknown Persona Type: ${e(n)?.personaType}`)}Ee(()=>(e(E),e(S)),()=>{l(te,e(E).find(a=>a._id===e(S)))}),Ee(()=>e(S),()=>{e(S)?ke(n,e(n).voice_id=e(S)):ke(n,e(n).voice_id="")}),Ee(()=>e(n),()=>{e(n).contentType==="story"&&ke(n,e(n).personaType="2D")}),Ee(()=>(i(),e(F),e(n)),()=>{const a=i().url.searchParams.get("c");a&&a!==e(F)&&(l(F,a),a!==e(n).id&&ge(a))}),Ye(),Be();var Te=ra(),he=ze(Te),ye=r(he);At(ye,{get persona(){return e(n)},get loading(){return e(L)},get showSuccess(){return e(A)},get uploadProgress(){return e(Y)},onSave:fe,onStartChat:xe});var f=c(ye,2);{var _=a=>{var o=Zt(),p=r(o,!0);s(o),M(()=>v(p,e(P))),B(a,o)};ue(f,a=>{e(P)&&a(_)})}var y=c(f,2),j=r(y),C=r(j),K=r(C);qt(K,{get persona(){return e(n)},set persona(a){l(n,a)},get previousPersonaType(){return e(z)},set previousPersonaType(a){l(z,a)},$$legacy:!0});var U=c(K,2);wt(U,{get originalPersona(){return e(V)},get allVoices(){return e(E)},get persona(){return e(n)},set persona(a){l(n,a)},get selectedVoiceId(){return e(S)},set selectedVoiceId(a){l(S,a)},$$events:{metadataLoaded:a=>{l(de,a.detail.expressions),l(T,a.detail.motions)}},$$legacy:!0}),s(C);var N=c(C,2),ce=r(N);Vt(ce,{get availableExpressions(){return e(de)},get availableMotions(){return e(T)},kintsugiTemplateId:x,get persona(){return e(n)},set persona(a){l(n,a)},get selectedTemplate(){return e(u)},set selectedTemplate(a){l(u,a)},get singleInstruction(){return e(g)},set singleInstruction(a){l(g,a)},get k_description(){return e(k)},set k_description(a){l(k,a)},get k_personality(){return e(D)},set k_personality(a){l(D,a)},get k_userPersona(){return e(J)},set k_userPersona(a){l(J,a)},get k_scenario(){return e(W)},set k_scenario(a){l(W,a)},get firstSceneJson(){return e($)},set firstSceneJson(a){l($,a)},$$slots:{tags:(a,o)=>{var p=ea(),b=r(p);Ut(b,{get persona(){return e(n)},set persona(O){l(n,O)},$$legacy:!0}),s(p),B(a,p)}},$$legacy:!0}),s(N),s(j),s(y),s(he);var H=c(he,2),G=r(H);{var Z=a=>{var o=ta(),p=r(o);s(o),M((b,O)=>v(p,`${b??""} (${O??""}%)`),[()=>t()("editPage.saveButtonLoading"),()=>Math.round(e(Y))],Q),B(a,o)},X=(a,o)=>{{var p=O=>{var q=aa(),w=r(q,!0);s(q),M(ae=>v(w,ae),[()=>t()("editPage.saveButtonSuccess")],Q),B(O,q)},b=O=>{var q=sa(),w=r(q,!0);s(q),M(ae=>v(w,ae),[()=>t()("editPage.saveButton")],Q),B(O,q)};ue(a,O=>{e(A)?O(p):O(b,!1)},o)}};ue(G,a=>{e(L)?a(Z):a(X,!1)})}s(H);var re=c(H,2);xt(re,{get isOpen(){return e(L)}});var _e=c(re,2);Dt(_e,{get isOpen(){return e(se)},set isOpen(a){l(se,a)},$$legacy:!0}),M(()=>H.disabled=e(L)||e(A)),Pe("click",H,fe),B(ve,Te),Re(),oe()}export{Ca as component};
