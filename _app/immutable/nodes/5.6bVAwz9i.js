import"../chunks/NZTpNUN0.js";import"../chunks/Vvm9udaT.js";import{a as ye,o as Le}from"../chunks/BB32ouRY.js";import{X as we,au as V,w as e,L as S,aA as ce,ay as de,k as He,av as be,Z as q,l as fe,aw as x,a2 as A,a0 as u,x as J,a3 as B,_ as _e}from"../chunks/DJxVeldX.js";import{b as D,a as M,f as ke}from"../chunks/fOQuHGXh.js";import{i as L}from"../chunks/292SS5JT.js";import{b as j}from"../chunks/B1Ur4i1a.js";import{i as Se}from"../chunks/Degfot_7.js";import{a as xe,s as Ce}from"../chunks/ZTUH0_7J.js";import{e as E}from"../chunks/C9woGF-z.js";import{e as Pe}from"../chunks/DHri6rd4.js";import{e as ue}from"../chunks/CVCkp_ml.js";import{b as Re}from"../chunks/Bw-tA-uZ.js";import{p as I}from"../chunks/Zfh5ko2t.js";import{u as Ze,s as me,t as Xe,g as Fe}from"../chunks/Da5C1udi.js";import{m as ge,i as Ye,C as Je,a as je,S as qe,b as Ge,l as he}from"../chunks/D_e-RsHg.js";import{g as Ke}from"../chunks/knpjl46v.js";import{l as Qe}from"../chunks/oasVcxk_.js";import{I as Ue}from"../chunks/Cphc7EI3.js";import{B as et,V as F}from"../chunks/Dq_rjOCf.js";import{p as tt}from"../chunks/pmDB9vb6.js";import{l as Y}from"../chunks/BGAOhipI.js";import{a as at}from"../chunks/BXQQiVcS.js";import{t as $,T as st}from"../chunks/BHS5tyI-.js";function ot(f){const s=f.matchAll(/<emo:([a-zA-Z_]+)>/g),c=[];for(const r of s)r[1]&&c.push(r[1]);return c}function rt(f){const s=f.matchAll(/<act:([a-zA-Z_]+)>/g),c=[];for(const r of s)r[1]&&c.push(r[1]);return c}async function nt(f,s,c){if(!s.trim())return;ge.update(i=>[...i,{role:"user",content:s}]);let r="";await Ye(s,f??"",i=>{if(i.startsWith("{")&&i.endsWith("}")){try{const o=JSON.parse(i);if(o.text&&(i=o.text),o.predictions){const d=JSON.parse("["+o.predictions[0]+"]");console.log("Emotion data received: ",d),c?.Emotion(d[0].key,d[0].value)}}catch(o){console.error("JSON 파싱 오류:",o)}return}r+=i,ge.update(o=>{let d=ot(r),m=rt(r);return d.length>0&&(r=r.replace(/<emo:([a-zA-Z_]+)>/g,""),c?.Emotion(d[0])),m.length>0&&(r=r.replace(/<act:([a-zA-Z_]+)>/g,"")),o.at(-1)?.role==="assistant"?[...o.slice(0,-1),{role:"assistant",content:r}]:[...o,{role:"assistant",content:r}]})},i=>{Qe(),Ke(`/character?c=${i}`)},"3d")}var it=D('<div class="spark svelte-6h29y5"></div>'),lt=D('<div class="model-loader svelte-6h29y5"><!></div>'),ct=D('<!> <div id="character-view" class="svelte-6h29y5"><canvas class="vrm-canvas svelte-6h29y5"></canvas> <!> <div id="speech-bubble" class="bubble svelte-6h29y5"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" class="svelte-6h29y5"><circle cx="4" cy="12" r="3" fill="currentColor" class="svelte-6h29y5"><animate id="svgSpinners3DotsFade0" fill="freeze" attributeName="opacity" begin="0;svgSpinners3DotsFade1.end-0.25s" dur="0.75s" values="1;0.2" class="svelte-6h29y5"></animate></circle><circle cx="12" cy="12" r="3" fill="currentColor" opacity="0.4" class="svelte-6h29y5"><animate fill="freeze" attributeName="opacity" begin="svgSpinners3DotsFade0.begin+0.15s" dur="0.75s" values="1;0.2" class="svelte-6h29y5"></animate></circle><circle cx="20" cy="12" r="3" fill="currentColor" opacity="0.3" class="svelte-6h29y5"><animate id="svgSpinners3DotsFade1" fill="freeze" attributeName="opacity" begin="svgSpinners3DotsFade0.begin+0.3s" dur="0.75s" values="1;0.2" class="svelte-6h29y5"></animate></circle></svg></div> <div class="chat-container select-none svelte-6h29y5"><div class="chat-content svelte-6h29y5"><!> <!></div></div></div>',1);function dt(f,s){we(s,!1);const[c,r]=Ce(),i=()=>xe(me,"$sparks",c);let o=I(s,"persona",8),d=I(s,"cssid",8,null),m=I(s,"show",8,!0),t=S(),b,_=S(),C=S(),n=null,h=S(!0),T={rotImpulseHead:30,halfRotHead:.5,rotImpulseBody:12,halfRotBody:.25,rotImpulseLimb:10,halfRotLimb:.3};ye(()=>{Ze(),clearTimeout(b)});function g(){try{o()&&Xe(e(_),o()).then(a=>{u(t,a),e(t)?.setCanvas(e(_)),n=Fe(),u(h,!1),K(),e(t)&&ce(t,e(t).cfg=T)}).catch(a=>{console.error("Error loading VRM:",a)}).finally(()=>{console.log("finally - model loaded!")})}catch(a){console.error("Error loading VRM:",a),u(h,!1)}}function z(a){if(e(t)){const l=a.clientX/window.innerWidth*2-1,p=a.clientY/window.innerHeight*2-1;e(t).updateMouseGaze(l,p)}}function H(a){if(e(t)){const l=e(_).getBoundingClientRect(),p=a.clientX-l.left,k=a.clientY-l.top,N=p/l.width*2-1,ne=-(k/l.height)*2+1;e(t).hitByMouse(N,ne)}}function P(a){if(e(t)?.stateManager?.setListening(!0),clearTimeout(b),a===""){e(t)?.stateManager?.setListening(!1);return}b=setTimeout(()=>{e(t)?.stateManager?.setListening(!1)},3e3)}let y=S(!1);const Te=async a=>{if(!(!e(t)||!o())){clearTimeout(b),e(t).stateManager?.setListening(!1);try{u(y,!0),await nt(o().id,a,e(t))}catch(l){console.error("Error sending prompt to character:",l)}finally{u(y,!1)}}};function G(a){e(t)?(e(t).stateManager?.setSpeaking(!0),e(t).speak(a).then(()=>{e(t).stateManager?.setSpeaking(!1)}).catch(l=>{console.error("Error speaking:",l)})):console.warn("Model not loaded yet, cannot speak.")}let ze=.2,Ae=-.45,Be=-8,Ie=14;function K(){if(!n||!n.model?.vrm)return;const a=n.model.vrm,l=new et().setFromObject(a.scene),p=new F;l.getSize(p);const k=new F;l.getCenter(k);const N=k.y+p.y/2*.9,Z=p.y*1.5+ze,ie=N+Ae,le=Be*(Math.PI/180),X=Ie*(Math.PI/180),$e=k.x+Z*Math.sin(le)*Math.cos(X),Ve=k.z+Z*Math.cos(le)*Math.cos(X),Ee=ie+Z*Math.sin(X);n.camera.position.set($e,Ee,Ve),n.camera.lookAt(new F(k.x,ie,k.z)),n.camera.updateProjectionMatrix()}V(()=>e(t),()=>{e(t)&&ce(t,e(t).cfg=structuredClone(T))}),V(()=>(He(o()),de),()=>{o()?.id&&de().then(g)}),V(()=>{},()=>{K()}),be(),Se();var Q=ct(),U=q(Q);Pe(U,1,i,a=>a.id,(a,l)=>{var p=it();fe(()=>ue(p,`left:${e(l).x??""}px; top:${e(l).y??""}px; --r:${e(l).angle??""}deg`)),E("animationend",p,()=>me.update(k=>k.filter(N=>N.id!==e(l).id))),M(a,p)});var W=x(U,2),ee=A(W);j(ee,a=>u(_,a),()=>e(_));var te=x(ee,2);{var Oe=a=>{var l=lt(),p=A(l);Ue(p,{icon:"line-md:loading-twotone-loop",width:"64",height:"64"}),B(l),M(a,l)};L(te,a=>{e(h)&&a(Oe)})}var R=x(te,2);let ae;j(R,a=>u(C,a),()=>e(C));var se=x(R,2),oe=A(se),re=A(oe);const De=J(()=>d()??"");Je(re,{get cssid(){return e(De)},get showChat(){return m()},get isLoading(){return e(y)}});var Ne=x(re,2);je(Ne,{onSend:Te,onChangeInput:P}),B(oe),B(se),B(W),fe(()=>ae=ue(R,"",ae,{visibility:e(y)?"visible":"hidden"})),E("mousedown",W,H),E("mousemove",W,z),M(f,Q),Re(s,"speek",G);var We=_e({speek:G});return r(),We}var ft=ke('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" class="svelte-8mvdzo"><path fill="currentColor" d="M12 9a3 3 0 0 0-3 3a3 3 0 0 0 3 3a3 3 0 0 0 3-3a3 3 0 0 0-3-3m0 8a5 5 0 0 1-5-5a5 5 0 0 1 5-5a5 5 0 0 1 5 5a5 5 0 0 1-5 5m0-12.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5"></path></svg>'),ut=ke('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" class="svelte-8mvdzo"><mask id="lineMdWatchOff0"><g fill="none" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"><circle cx="12" cy="12" r="0" fill="#fff" stroke="none"><animate fill="freeze" attributeName="r" dur="0.2s" values="0;3"></animate></circle><path d="M4 12c1.38 -0.77 4.42 -1.3 8 -1.3c3.58 0 6.62 0.53 8 1.3c-1.38 0.77 -4.42 1.3 -8 1.3c-3.58 0 -6.62 -0.53 -8 -1.3Z"><animate fill="freeze" attributeName="d" dur="0.5s" values="M4 12c1.38 -0.77 4.42 -1.3 8 -1.3c3.58 0 6.62 0.53 8 1.3c-1.38 0.77 -4.42 1.3 -8 1.3c-3.58 0 -6.62 -0.53 -8 -1.3Z;M2 12c1.72 -3.83 5.53 -6.5 10 -6.5c4.47 0 8.28 2.67 10 6.5c-1.72 3.83 -5.53 6.5 -10 6.5c-4.47 0 -8.28 -2.67 -10 -6.5Z"></animate></path><path stroke="#000" stroke-dasharray="28" stroke-dashoffset="28" d="M0 11h24" transform="rotate(45 12 12)"><animate fill="freeze" attributeName="stroke-dashoffset" begin="0.5s" dur="0.4s" values="28;0"></animate></path><path stroke-dasharray="28" stroke-dashoffset="28" d="M0 13h24" transform="rotate(45 12 12)"><animate fill="freeze" attributeName="stroke-dashoffset" begin="0.5s" dur="0.4s" values="28;0"></animate></path></g></mask><rect width="24" height="24" fill="currentColor" mask="url(#lineMdWatchOff0)"></rect></svg>'),mt=D('<!> <div class="control-box svelte-8mvdzo"><!> <button class="toggle-chat-button svelte-8mvdzo"><!></button></div>',1);function gt(f,s){I(s,"cssid",8);let c=I(s,"showChat",12),r=I(s,"persona",8),i=I(s,"llmType",8),o=S(!1);var d=mt(),m=q(d);{var t=g=>{Ge(g,{get persona(){return r()},get isOpen(){return e(o)},get llmType(){return i()},$$events:{close:()=>u(o,!1)}})};L(m,g=>{e(o)&&g(t)})}var b=x(m,2),_=A(b);qe(_,{onClick:()=>u(o,!0)});var C=x(_,2),n=A(C);{var h=g=>{var z=ft();M(g,z)},T=g=>{var z=ut();M(g,z)};L(n,g=>{c()?g(h):g(T,!1)})}B(C),B(b),E("click",C,()=>c(!c())),M(f,d)}let w=null,v=null,O=null;function ht(){v||(v=new(window.AudioContext||window.AudioContext),console.log("🎶 AudioContext 초기화됨"),v.state==="suspended"&&v.resume().then(()=>{console.log("AudioContext resumed successfully")}).catch(f=>console.error("AudioContext resume failed:",f)))}function pt(){O&&clearInterval(O),O=setInterval(()=>{w&&w.readyState===WebSocket.OPEN&&(console.log("❤️ Sending heartbeat ping"),w.send(JSON.stringify({type:"ping"})))},3e4)}function Me(){O&&(clearInterval(O),O=null)}function pe(f){return w=at.ws("/ws/tts",{}),w||(console.error("❌ WebSocket 연결 실패"),$.set("disconnected")),console.log("🔗 tts WebSocket 연결 시도..."),$.set("connecting"),w.onopen=()=>{console.log("✅ tts WebSocket 연결됨"),$.set("connected"),pt()},w.onclose=()=>{console.warn("⚠️ tts WebSocket 끊김"),$.set("disconnected"),Me()},w.onmessage=async s=>{if(typeof s.data=="string")try{if(JSON.parse(s.data).type==="pong"){console.log("❤️ Received heartbeat pong");return}}catch{}if((!v||v.state==="closed")&&ht(),!v){console.error("❌ AudioContext가 초기화되지 않았습니다. 사용자 제스처가 필요할 수 있습니다.");return}let c;if(s.data instanceof Blob)c=await s.data.arrayBuffer(),console.log("Blob 타입 오디오 데이터 수신. ArrayBuffer로 변환됨.");else if(s.data instanceof ArrayBuffer)c=s.data,console.log("ArrayBuffer 타입 오디오 데이터 수신.");else{console.error("❌ 알 수 없는 형식의 오디오 데이터:",typeof s.data,s.data);return}try{if(f){console.log("🎶 외부 함수 호출로 오디오 재생 시작"),f(c);return}const r=await v.decodeAudioData(c),i=v.createBufferSource();i.buffer=r,i.connect(v.destination),i.start(0),console.log("🎶 오디오 재생 시작!"),i.onended=()=>{console.log("🔇 오디오 재생 완료."),i.disconnect()}}catch(r){console.error("❌ 오디오 데이터 디코딩 또는 재생 실패:",r)}},w}function ve(){Me(),w?(w.close(),w=null,console.log("✅ tts WebSocket 연결 해제됨")):console.warn("⚠️ tts WebSocket이 이미 연결되어 있지 않습니다."),v&&v.close().then(()=>{v=null,console.log("🎶 AudioContext가 성공적으로 닫혔습니다.")}).catch(f=>console.error("AudioContext 닫기 실패:",f))}var vt=D("<!> <!> <!>",1),yt=D('<main class="svelte-2w4m96"><!></main>');function Zt(f,s){we(s,!1);const[c,r]=Ce(),i=()=>xe(tt,"$page",c);let o=S(null),d=S(null),m=S(),t=S(!1);Le(()=>{const n=i().url.searchParams.get("c");u(o,n),n&&(u(d,null),he(n),Y(n).then(h=>u(d,h)),pe(h=>{e(m)&&e(m).speek?e(m).speek(h):console.warn("Viewer not ready for TTS audio.")}))}),ye(()=>{ve()}),V(()=>(i(),e(o),Y),()=>{const n=i().url.searchParams.get("c");n!==e(o)&&(u(o,n),n&&(u(d,null),he(n),Y(n).then(h=>u(d,h))))}),be(),Se();var b=yt(),_=A(b);{var C=n=>{var h=vt(),T=q(h);st(T,{impl_connectTTS:()=>{pe(y=>{e(m)&&e(m).speek?e(m).speek(y):console.warn("Viewer not ready for TTS audio.")})},impl_disconnectTTS:()=>{ve()}});var g=x(T,2);const z=J(()=>e(o)??"");j(dt(g,{get persona(){return e(d)},get cssid(){return e(z)},get show(){return e(t)},set show(y){u(t,y)},$$legacy:!0}),y=>u(m,y),()=>e(m));var H=x(g,2);const P=J(()=>e(o)??"");gt(H,{get cssid(){return e(P)},get persona(){return e(d)},llmType:"",get showChat(){return e(t)},set showChat(y){u(t,y)},$$legacy:!0}),M(n,h)};L(_,n=>{e(d)&&n(C)})}B(b),M(f,b),_e(),r()}export{Zt as component};
