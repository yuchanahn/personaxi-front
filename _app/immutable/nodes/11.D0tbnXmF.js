import{d as g,b as _,e as _t}from"../chunks/kz80bbCR.js";import{i as Qe}from"../chunks/2r1cYJse.js";import{c as dt,o as ct,a as ht}from"../chunks/D0mpzbhj.js";import{w as Ye,aj as M,z as Ge,al as a,ap as r,am as t,as as Re,O as se,Q as e,W as N,V as o,aq as We,ao as vt,ar as pt,an as Ue,au as $t,aD as Ae,aE as Ft}from"../chunks/BUDlkbfV.js";import{i as A}from"../chunks/28pso2Hb.js";import{s as it,a as rt}from"../chunks/D32zTIdM.js";import{g as bt}from"../chunks/DqiWXVxP.js";import{p as Vt}from"../chunks/dMfnY97A.js";import{$ as nt}from"../chunks/C36u96xB.js";import{g as Mt}from"../chunks/e6l8DgL1.js";import{s as Ct}from"../chunks/3azsccOw.js";import{t as De}from"../chunks/sXlFIKQv.js";import"../chunks/CmEqjr1-.js";import{a as ze}from"../chunks/E07TNQLR.js";import{a as Nt,f as At,s as Jt}from"../chunks/Caezn3U5.js";import{L as Ot}from"../chunks/Dr8j7HxN.js";import{M as Rt,F as Kt,K as Bt,a as zt}from"../chunks/Dp02Bg33.js";import{s as d}from"../chunks/BbnaKca8.js";import{k as mt}from"../chunks/B5DqLm-d.js";import{e as He,i as at}from"../chunks/BOGOvxWJ.js";import{s as yt}from"../chunks/5HrxelVy.js";import{s as Ve,a as Fe,r as Ke,f as Lt,e as Wt}from"../chunks/BJyhluUY.js";import{e as ue,b as ot}from"../chunks/CiCNsvIE.js";import{t as lt,a as ut,f as St}from"../chunks/B2SxtloT.js";import{p as ye}from"../chunks/Bf5_DoVm.js";import{I as J}from"../chunks/DaDtKPX8.js";import{b as Ce,c as ft}from"../chunks/njKOc8Q7.js";import{b as gt}from"../chunks/BP_wOmgt.js";import{b as Ut}from"../chunks/CGc6l0L7.js";import{s as Tt}from"../chunks/BqlTOgs2.js";import{h as kt}from"../chunks/DlstPydP.js";import{a as wt}from"../chunks/BS5RVGlS.js";import{A as Ht}from"../chunks/DxUrSklm.js";const et={createLore:async B=>{const p=await ze.post("/api/lore",B);if(!p.ok)throw new Error("Failed to create lore");return p},getMyLores:async()=>{const B=await ze.get("/api/lore");if(!B.ok)throw new Error("Failed to fetch lores");return await B.json()},getLore:async B=>{const p=await ze.get(`/api/lore?id=${B}`);if(!p.ok)throw new Error("Failed to fetch lore");return await p.json()},updateLore:async(B,p)=>{const de=await ze.put(`/api/lore?id=${B}`,p);if(!de.ok)throw new Error("Failed to update lore");return de},deleteLore:async B=>{const p=await ze.delete(`/api/lore?id=${B}`);if(!p.ok)throw new Error("Failed to delete lore");return p},upsertEntry:async B=>{if(B.id){const p=await ze.put("/api/lore/entry",B);if(!p.ok)throw new Error("Failed to update entry");return p}else{const p=await ze.post("/api/lore/entry",B);if(!p.ok)throw new Error("Failed to create entry");return p}},deleteEntry:async(B,p)=>{const de=await ze.delete(`/api/lore/entry?id=${B}&lore_id=${p}`);if(!de.ok)throw new Error("Failed to delete entry");return de},getPersonaLores:async B=>{const p=await ze.get(`/api/lore/persona/list?persona_id=${B}`);if(!p.ok)throw new Error("Failed to fetch persona lores");return await p.json()},linkPersona:async(B,p,de=!1)=>{const re=await ze.post("/api/lore/link",{persona_id:B,lore_id:p,unlink:de});if(!re.ok)throw new Error("Failed to update linkage");return re},async testContext(B,p,de){const re=await ze.post("/api/lore/test",{persona_id:B,message:p,active_lore_ids:de});if(!re.ok)throw new Error("Failed to test context");return re.json()}};var Qt=g('<span class="step-number"></span>'),Yt=g("<div></div>"),Gt=g("<button><!></button> <!>",1),Xt=g('<button class="side-arrow side-arrow-left svelte-1i5mw22" aria-label="Previous step"><!></button>'),Zt=g('<div class="side-arrow-placeholder svelte-1i5mw22"></div>'),ea=g('<div class="step-inner"><!></div>'),ta=g("<!> <span> </span>",1),aa=g("<!> <span> </span>",1),ra=g('<div class="inline-save svelte-1i5mw22"><button class="nav-btn save svelte-1i5mw22"><!></button></div>'),sa=g('<div class="step-inner"><!></div>'),ia=g('<div class="step-panel panel-right svelte-1i5mw22"><div class="panel-header svelte-1i5mw22"><span class="panel-step-badge svelte-1i5mw22"> </span> <span class="panel-step-title svelte-1i5mw22"> </span></div> <div class="panel-body svelte-1i5mw22"><!></div></div>'),na=g('<button class="side-arrow side-arrow-right svelte-1i5mw22" aria-label="Next step"><!></button>'),oa=g('<div class="side-arrow-placeholder svelte-1i5mw22"></div>'),la=g('<button class="nav-btn secondary svelte-1i5mw22"><!> <span> </span></button>'),va=g("<div></div>"),da=g('<button class="nav-btn primary svelte-1i5mw22"><span> </span> <!></button>'),ca=g("<!> <span> </span>",1),pa=g("<!> <span> </span>",1),ua=g('<button class="nav-btn save svelte-1i5mw22"><!></button>'),_a=g('<div class="wizard-wrapper svelte-1i5mw22"><div class="progress-header svelte-1i5mw22"><div class="steps-indicator svelte-1i5mw22"></div> <p class="step-label svelte-1i5mw22"><!> </p></div> <div class="step-content-wrapper svelte-1i5mw22"><!> <div class="panels-container svelte-1i5mw22"><div class="step-panel panel-left svelte-1i5mw22"><div class="panel-header svelte-1i5mw22"><span class="panel-step-badge svelte-1i5mw22"> </span> <span class="panel-step-title svelte-1i5mw22"> </span></div> <div class="panel-body svelte-1i5mw22"><!> <!></div></div> <!></div> <!></div> <div class="nav-footer svelte-1i5mw22"><!> <!></div></div>');function fa(B,p){Ye(p,!1);const[de,re]=it(),v=()=>rt(nt,"$t",de);let s=ye(p,"currentStep",8,0),q=ye(p,"totalSteps",8,5),E=ye(p,"stepLabels",24,()=>[]),m=ye(p,"canProceed",8,!0),G=ye(p,"isSaving",8,!1);const n=dt();let F=N(1);const z=["ph:cube-duotone","ph:user-circle-duotone","ph:image-duotone","ph:brain-duotone","ph:check-circle-duotone"];function ge(l){if(!(l<0||l>=q())){if(l>s()&&!m()){n("validationFail");return}o(F,l>s()?1:-1),n("stepChange",{step:l,direction:e(F)})}}function ke(){ge(s()+1)}function ne(){ge(s()-1)}function T(){n("save")}Qe();var S=_a(),L=a(S),K=a(L);He(K,5,()=>Array(q()),at,(l,i,u)=>{var I=Gt(),Y=Re(I);let O;Ve(Y,"aria-label",`Step ${u+1}`);var c=a(Y);{var h=x=>{J(x,{icon:"ph:check-bold",width:"14"})},$=x=>{var P=Qt();P.textContent=u+1,_(x,P)};A(c,x=>{u<s()?x(h):x($,!1)})}t(Y);var k=r(Y,2);{var w=x=>{var P=Yt();let Z;M(R=>Z=Fe(P,1,"step-line svelte-1i5mw22",null,Z,R),[()=>({filled:u<s()})],se),_(x,P)};A(k,x=>{u<q()-1&&x(w)})}M(x=>O=Fe(Y,1,"step-dot svelte-1i5mw22",null,O,x),[()=>({active:u===s(),completed:u<s(),clickable:u<=s()})],se),ue("click",Y,()=>{u<=s()&&ge(u)}),_(l,I)}),t(K);var oe=r(K,2),X=a(oe);J(X,{get icon(){return z[s()]},width:"18"});var be=r(X);t(oe),t(L);var ie=r(L,2),te=a(ie);{var ce=l=>{var i=Xt(),u=a(i);J(u,{icon:"ph:caret-left-bold",width:"24"}),t(i),ue("click",i,ne),_(l,i)},H=l=>{var i=Zt();_(l,i)};A(te,l=>{s()>0?l(ce):l(H,!1)})}var fe=r(te,2),Ee=a(fe),we=a(Ee),Te=a(we),$e=a(Te,!0);t(Te);var C=r(Te,2),W=a(C,!0);t(C),t(we);var _e=r(we,2),Se=a(_e);mt(Se,s,l=>{var i=ea(),u=a(i);yt(u,p,"default",{}),t(i),lt(1,i,()=>ut,()=>({x:e(F)*40,duration:200,delay:30})),lt(2,i,()=>ut,()=>({x:e(F)*-40,duration:120})),_(l,i)});var j=r(Se,2);{var y=l=>{var i=ra(),u=a(i),I=a(u);{var Y=c=>{var h=ta(),$=Re(h);J($,{icon:"ph:spinner",width:"18",class:"spin"});var k=r($,2),w=a(k,!0);t(k),M(x=>d(w,x),[()=>v()("editPage.saveButtonLoading",{default:"ì €ì¥ ì¤‘..."})],se),_(c,h)},O=c=>{var h=aa(),$=Re(h);J($,{icon:"ph:floppy-disk-bold",width:"18"});var k=r($,2),w=a(k,!0);t(k),M(x=>d(w,x),[()=>v()("editPage.saveButton",{default:"ì €ì¥"})],se),_(c,h)};A(I,c=>{G()?c(Y):c(O,!1)})}t(u),t(i),M(()=>u.disabled=G()||!m()),ue("click",u,T),_(l,i)};A(j,l=>{s()===q()-1&&l(y)})}t(_e),t(Ee);var U=r(Ee,2);{var ae=l=>{var i=ia(),u=a(i),I=a(u),Y=a(I,!0);t(I);var O=r(I,2),c=a(O,!0);t(O),t(u);var h=r(u,2),$=a(h);mt($,s,k=>{var w=sa(),x=a(w);yt(x,p,"next",{}),t(w),lt(1,w,()=>ut,()=>({x:40,duration:200,delay:80})),lt(2,w,()=>ut,()=>({x:-40,duration:120})),_(k,w)}),t(h),t(i),M(()=>{d(Y,s()+2),d(c,E()[s()+1]||`Step ${s()+2}`)}),_(l,i)};A(U,l=>{s()<q()-1&&l(ae)})}t(fe);var pe=r(fe,2);{var le=l=>{var i=na(),u=a(i);J(u,{icon:"ph:caret-right-bold",width:"24"}),t(i),M(()=>i.disabled=!m()),ue("click",i,ke),_(l,i)},f=l=>{var i=oa();_(l,i)};A(pe,l=>{s()<q()-1?l(le):l(f,!1)})}t(ie);var b=r(ie,2),V=a(b);{var ee=l=>{var i=la(),u=a(i);J(u,{icon:"ph:arrow-left-bold",width:"18"});var I=r(u,2),Y=a(I,!0);t(I),t(i),M(O=>d(Y,O),[()=>v()("common.prev",{default:"ì´ì „"})],se),ue("click",i,ne),_(l,i)},Pe=l=>{var i=va();_(l,i)};A(V,l=>{s()>0?l(ee):l(Pe,!1)})}var qe=r(V,2);{var me=l=>{var i=da(),u=a(i),I=a(u,!0);t(u);var Y=r(u,2);J(Y,{icon:"ph:arrow-right-bold",width:"18"}),t(i),M(O=>{i.disabled=!m(),d(I,O)},[()=>v()("common.next",{default:"ë‹¤ìŒ"})],se),ue("click",i,ke),_(l,i)},Q=l=>{var i=ua(),u=a(i);{var I=O=>{var c=ca(),h=Re(c);J(h,{icon:"ph:spinner",width:"18",class:"spin"});var $=r(h,2),k=a($,!0);t($),M(w=>d(k,w),[()=>v()("editPage.saveButtonLoading",{default:"ì €ì¥ ì¤‘..."})],se),_(O,c)},Y=O=>{var c=pa(),h=Re(c);J(h,{icon:"ph:floppy-disk-bold",width:"18"});var $=r(h,2),k=a($,!0);t($),M(w=>d(k,w),[()=>v()("editPage.saveButton",{default:"ì €ì¥"})],se),_(O,c)};A(u,O=>{G()?O(I):O(Y,!1)})}t(i),M(()=>i.disabled=G()||!m()),ue("click",i,T),_(l,i)};A(qe,l=>{s()<q()-1?l(me):l(Q,!1)})}t(b),t(S),M(()=>{d(be,` ${(E()[s()]||`Step ${s()+1}`)??""}`),d($e,s()+1),d(W,E()[s()]||`Step ${s()+1}`)}),_(B,S),Ge(),re()}var ha=g("<button><!> <span> </span></button>"),ga=g('<span class="badge svelte-m4ir83"> </span>'),ba=g('<div class="check-icon svelte-m4ir83"><!></div>'),ma=g('<button><div class="type-card-icon svelte-m4ir83"><!></div> <div class="type-card-info svelte-m4ir83"><div class="type-card-label svelte-m4ir83"> <!></div> <p class="type-card-desc svelte-m4ir83"> </p></div> <!></button>'),ya=g('<div class="step-type svelte-m4ir83"><section class="type-section svelte-m4ir83"><h3 class="section-title svelte-m4ir83"><!> ë¬´ì—‡ì„ ë§Œë“¤ê¹Œìš”?</h3> <div class="content-type-grid svelte-m4ir83"></div></section> <section class="type-section svelte-m4ir83"><h3 class="section-title svelte-m4ir83"><!> ìºë¦­í„° íƒ€ì… ì„ íƒ</h3> <div class="type-cards-grid svelte-m4ir83"></div></section></div>');function ka(B,p){Ye(p,!1);const de=N();let re=ye(p,"persona",12);const v=[{value:"character",label:"ìºë¦­í„°",icon:"ph:robot-duotone"},{value:"story",label:"ìŠ¤í† ë¦¬",icon:"ph:book-open-duotone"}];function s(S){const L=[{type:"2D",icon:"ph:chat-circle-dots-duotone",label:"Chat",desc:"í…ìŠ¤íŠ¸ì™€ ì´ë¯¸ì§€ ê¸°ë°˜ì˜ ëŒ€í™”í˜• ìºë¦­í„°. ê°€ì¥ ê°„í¸í•˜ê²Œ ì‹œì‘í•  ìˆ˜ ìˆì–´ìš”."}];return S!=="story"&&L.push({type:"2.5D",icon:"ph:monitor-play-duotone",label:"Live2D",desc:"Live2D ëª¨ë¸ë¡œ í‘œì •ê³¼ ëª¨ì…˜ì´ ì‚´ì•„ìˆëŠ” ìºë¦­í„°ë¥¼ ë§Œë“¤ì–´ë³´ì„¸ìš”.",badge:"beta"},{type:"3D",icon:"ph:cube-duotone",label:"3D (VRM)",desc:"VRM 3D ëª¨ë¸ì„ ì‚¬ìš©í•˜ëŠ” ì…ì²´ì ì¸ ìºë¦­í„°ë¥¼ ë§Œë“¤ì–´ë³´ì„¸ìš”.",badge:"beta"}),L}function q(S){re(re().contentType=S,!0),S==="story"&&re(re().personaType="2D",!0)}function E(S){re(re().personaType=S,!0)}We(()=>vt(re()),()=>{o(de,s(re().contentType))}),pt(),Qe();var m=ya(),G=a(m),n=a(G),F=a(n);J(F,{icon:"ph:squares-four-duotone",width:"22"}),Ue(),t(n);var z=r(n,2);He(z,5,()=>v,at,(S,L)=>{var K=ha();let oe;var X=a(K);J(X,{get icon(){return e(L).icon},width:"28"});var be=r(X,2),ie=a(be,!0);t(be),t(K),M(te=>{oe=Fe(K,1,"content-card svelte-m4ir83",null,oe,te),d(ie,e(L).label)},[()=>({active:re().contentType===e(L).value})],se),ue("click",K,()=>q(e(L).value)),_(S,K)}),t(z),t(G);var ge=r(G,2),ke=a(ge),ne=a(ke);J(ne,{icon:"ph:paint-brush-duotone",width:"22"}),Ue(),t(ke);var T=r(ke,2);He(T,5,()=>e(de),at,(S,L)=>{var K=ma();let oe;var X=a(K),be=a(X);J(be,{get icon(){return e(L).icon},width:"36"}),t(X);var ie=r(X,2),te=a(ie),ce=a(te),H=r(ce);{var fe=C=>{var W=ga(),_e=a(W,!0);t(W),M(()=>d(_e,e(L).badge)),_(C,W)};A(H,C=>{e(L).badge&&C(fe)})}t(te);var Ee=r(te,2),we=a(Ee,!0);t(Ee),t(ie);var Te=r(ie,2);{var $e=C=>{var W=ba(),_e=a(W);J(_e,{icon:"ph:check-circle-fill",width:"24"}),t(W),_(C,W)};A(Te,C=>{re().personaType===e(L).type&&C($e)})}t(K),M(C=>{oe=Fe(K,1,"type-card svelte-m4ir83",null,oe,C),d(ce,`${e(L).label??""} `),d(we,e(L).desc)},[()=>({active:re().personaType===e(L).type})],se),ue("click",K,()=>E(e(L).type)),_(S,K)}),t(T),t(ge),t(m),_(B,m),Ge()}var wa=g(`<div class="step-basic svelte-h84rvr"><div class="field-group svelte-h84rvr"><label for="e3-name" class="field-label svelte-h84rvr"><!> <span class="required svelte-h84rvr">*</span></label> <input id="e3-name" type="text" class="field-input svelte-h84rvr" required maxlength="50"/></div> <div class="field-group svelte-h84rvr"><label for="e3-oneliner" class="field-label svelte-h84rvr"><!> </label> <p class="field-hint svelte-h84rvr">í”„ë¡œí•„ ì¹´ë“œì— í‘œì‹œë©ë‹ˆë‹¤. ë§¤ë ¥ì ì¸ í•œ ì¤„ë¡œ ì‚¬ëŒë“¤ì˜ ê´€ì‹¬ì„
            ëŒì–´ë³´ì„¸ìš”!</p> <input id="e3-oneliner" type="text" class="field-input svelte-h84rvr" maxlength="60"/> <div> </div></div> <div class="field-group svelte-h84rvr"><label for="e3-greeting" class="field-label svelte-h84rvr"><!> <span class="required svelte-h84rvr">*</span></label> <p class="field-hint svelte-h84rvr">í”„ë¡œí•„ í˜ì´ì§€ì—ì„œ ìºë¦­í„°ê°€ í•˜ëŠ” ì²« ì¸ì‚¬ì…ë‹ˆë‹¤.</p> <textarea id="e3-greeting" class="field-textarea svelte-h84rvr" maxlength="200" rows="3"></textarea> <div> </div></div> <div class="field-group svelte-h84rvr"><label class="field-label svelte-h84rvr"><!> </label> <div class="visibility-toggle svelte-h84rvr"><button><!> <div class="vis-text svelte-h84rvr"><span class="vis-label svelte-h84rvr"> </span> <span class="vis-desc svelte-h84rvr"> </span></div></button> <button><!> <div class="vis-text svelte-h84rvr"><span class="vis-label svelte-h84rvr"> </span> <span class="vis-desc svelte-h84rvr"> </span></div></button></div></div></div>`);function xt(B,p){Ye(p,!1);const[de,re]=it(),v=()=>rt(nt,"$t",de);let s=ye(p,"persona",12);Qe();var q=wa(),E=a(q),m=a(E),G=a(m);J(G,{icon:"ph:text-aa-duotone",width:"18"});var n=r(G);Ue(),t(m);var F=r(m,2);Ke(F),t(E);var z=r(E,2),ge=a(z),ke=a(ge);J(ke,{icon:"ph:quotes-duotone",width:"18"});var ne=r(ke);t(ge);var T=r(ge,4);Ke(T);var S=r(T,2);let L;var K=a(S);t(S),t(z);var oe=r(z,2),X=a(oe),be=a(X);J(be,{icon:"ph:hand-waving-duotone",width:"18"});var ie=r(be);Ue(),t(X);var te=r(X,4);ot(te);var ce=r(te,2);let H;var fe=a(ce);t(ce),t(oe);var Ee=r(oe,2),we=a(Ee),Te=a(we);J(Te,{icon:"ph:eye-duotone",width:"18"});var $e=r(Te);t(we);var C=r(we,2),W=a(C);let _e;var Se=a(W);J(Se,{icon:"ph:globe-duotone",width:"20"});var j=r(Se,2),y=a(j),U=a(y,!0);t(y);var ae=r(y,2),pe=a(ae,!0);t(ae),t(j),t(W);var le=r(W,2);let f;var b=a(le);J(b,{icon:"ph:lock-duotone",width:"20"});var V=r(b,2),ee=a(V),Pe=a(ee,!0);t(ee);var qe=r(ee,2),me=a(qe,!0);t(qe),t(V),t(le),t(C),t(Ee),t(q),M((Q,l,i,u,I,Y,O,c,h,$,k,w,x,P,Z)=>{d(n,` ${Q??""} `),Ve(F,"placeholder",l),d(ne,` ${i??""}`),Ve(T,"placeholder",u),L=Fe(S,1,"char-counter svelte-h84rvr",null,L,I),d(K,`${(s().one_liner||"").length??""}/60`),d(ie,` ${Y??""} `),Ve(te,"placeholder",O),H=Fe(ce,1,"char-counter svelte-h84rvr",null,H,c),d(fe,`${s().greeting.length??""} / 200`),d($e,` ${h??""}`),_e=Fe(W,1,"vis-btn svelte-h84rvr",null,_e,$),d(U,k),d(pe,w),f=Fe(le,1,"vis-btn svelte-h84rvr",null,f,x),d(Pe,P),d(me,Z)},[()=>s().contentType==="story"?v()("editPage.storyNameLabel",{default:"ìŠ¤í† ë¦¬ ì´ë¦„"}):v()("editPage.nameLabel",{default:"ìºë¦­í„° ì´ë¦„"}),()=>s().contentType==="story"?v()("editPage.storyNamePlaceholder",{default:"ìŠ¤í† ë¦¬ì˜ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”"}):v()("editPage.namePlaceholder",{default:"ìºë¦­í„°ì˜ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”"}),()=>s().contentType==="story"?v()("editPage.storyOneLinerLabel",{default:"ìŠ¤í† ë¦¬ í•œì¤„ ì†Œê°œ"}):v()("editPage.oneLinerLabel",{default:"í•œì¤„ ì†Œê°œ"}),()=>v()("editPage.oneLinerPlaceholder",{default:"ì˜ˆ: ë‹¹ì‹ ë§Œì„ ìœ„í•œ ìˆ˜í˜¸ì²œì‚¬"}),()=>({warning:(s().one_liner||"").length>50,error:(s().one_liner||"").length>60}),()=>v()("editPage.greetingLabel",{default:"ì¸ì‚¬ë§"}),()=>v()("editPage.greetingPlaceholder",{default:"ì•ˆë…•! ì˜¤ëŠ˜ë„ ë§Œë‚˜ì„œ ë°˜ê°€ì›Œ~"}),()=>({warning:s().greeting.length>160,error:s().greeting.length>=200}),()=>v()("editPage.visibilityLabel",{default:"ê³µê°œ ì„¤ì •"}),()=>({active:s().visibility==="public"}),()=>v()("editPage.public",{default:"ê³µê°œ"}),()=>v()("editPage.publicDesc",{default:"ëª¨ë‘ê°€ ë³¼ ìˆ˜ ìˆì–´ìš”"}),()=>({active:s().visibility==="private"}),()=>v()("editPage.private",{default:"ë¹„ê³µê°œ"}),()=>v()("editPage.privateDesc",{default:"ë‚˜ë§Œ ë³¼ ìˆ˜ ìˆì–´ìš”"})],se),Ce(F,()=>s().name,Q=>s(s().name=Q,!0)),Ce(T,()=>s().one_liner,Q=>s(s().one_liner=Q,!0)),Ce(te,()=>s().greeting,Q=>s(s().greeting=Q,!0)),ue("click",W,()=>s(s().visibility="public",!0)),ue("click",le,()=>s(s().visibility="private",!0)),_(B,q),Ge(),re()}var xa=g('<div class="step-media svelte-1ycw2ta"><div class="section-header svelte-1ycw2ta"><h3 class="svelte-1ycw2ta">ë¯¸ë””ì–´ & ì—ì…‹</h3> <p class="section-desc svelte-1ycw2ta">ìºë¦­í„°ì˜ í”„ë¡œí•„ ì´ë¯¸ì§€, ì—ì…‹, ëª¨ë¸ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”.</p></div> <!></div>');function Pt(B,p){Ye(p,!1);let de=ye(p,"persona",12),re=ye(p,"originalPersona",8),v=ye(p,"allVoices",24,()=>[]),s=ye(p,"selectedVoiceId",12);dt(),Qe();var q=xa(),E=r(a(q),2);Rt(E,{get originalPersona(){return re()},get allVoices(){return v()},get persona(){return de()},set persona(m){de(m)},get selectedVoiceId(){return s()},set selectedVoiceId(m){s(m)},$$events:{metadataLoaded(m){gt.call(this,p,m)}},$$legacy:!0}),t(q),_(B,q),Ge()}var Pa=g('<span class="var-range svelte-k3766"> </span>'),qa=g('<div class="var-desc svelte-k3766"> </div>'),Ea=g('<div class="var-item svelte-k3766"><div class="var-item-header svelte-k3766"><span class="var-name svelte-k3766"> </span> <span class="var-type svelte-k3766"> </span> <span class="var-default svelte-k3766"> </span> <!> <button class="var-remove svelte-k3766" type="button"><!></button></div> <!></div>'),$a=g('<div class="var-list svelte-k3766"></div>'),La=g('<input class="var-input range-input svelte-k3766" type="text" inputmode="numeric"/> <input class="var-input range-input svelte-k3766" type="text" inputmode="numeric"/>',1),Sa=g('<div class="variable-editor svelte-k3766"><div class="advanced-content svelte-k3766"><div class="section svelte-k3766"><h4 class="section-title svelte-k3766"><!> </h4> <p class="section-desc svelte-k3766"> </p> <!> <div class="add-var-form svelte-k3766"><div class="add-var-row svelte-k3766"><input class="var-input name-input svelte-k3766" maxlength="30"/> <select class="var-select svelte-k3766"><option> </option><option> </option><option> </option><option> </option></select></div> <div class="add-var-row svelte-k3766"><input class="var-input default-input svelte-k3766" maxlength="50"/> <!></div> <div class="add-var-row svelte-k3766"><input class="var-input desc-input svelte-k3766" maxlength="100"/> <button class="add-btn svelte-k3766" type="button"><!></button></div></div></div> <div class="section svelte-k3766"><h4 class="section-title svelte-k3766"><!> </h4> <p class="section-desc svelte-k3766"> </p> <textarea class="template-textarea svelte-k3766" rows="6"></textarea></div> <div class="section svelte-k3766"><h4 class="section-title svelte-k3766"><!> </h4> <p class="section-desc svelte-k3766"> </p> <textarea class="template-textarea css-textarea svelte-k3766" rows="5"></textarea></div></div></div>');function Ta(B,p){Ye(p,!1);const[de,re]=it(),v=()=>rt(nt,"$t",de);let s=ye(p,"persona",12),q=N(""),E=N("text"),m=N(""),G=N(""),n=N(""),F=N("");function z(){const k=e(q).trim();if(!k||s().variables&&s().variables.some(P=>P.name===k))return;const w={name:k,var_type:e(E),default_value:e(m).trim()||"0"},x=String(e(G)??"").trim();if(x&&(w.description=x),e(E)==="number"){const P=String(e(n)??"").trim(),Z=String(e(F)??"").trim();P&&(w.min_value=P),Z&&(w.max_value=Z)}s(s().variables=[...s().variables||[],w],!0),o(q,""),o(m,""),o(G,""),o(n,""),o(F,"")}function ge(k){const w=[...s().variables||[]];w.splice(k,1),s(s().variables=w,!0)}const ke="{{{var}}}";Qe();var ne=Sa(),T=a(ne),S=a(T),L=a(S),K=a(L);J(K,{icon:"ph:variable-duotone",width:"16"});var oe=r(K);t(L);var X=r(L,2),be=a(X,!0);t(X);var ie=r(X,2);{var te=k=>{var w=$a();He(w,5,()=>s().variables,at,(x,P,Z)=>{var R=Ea(),D=a(R),ve=a(D),Ie=a(ve,!0);t(ve);var xe=r(ve,2),he=a(xe,!0);t(xe);var Je=r(xe,2),Me=a(Je,!0);t(Je);var Be=r(Je,2);{var tt=je=>{var Ne=Pa(),st=a(Ne);t(Ne),M(()=>d(st,`${e(P).min_value||"âˆ’âˆ"}~${e(P).max_value||"âˆ"}`)),_(je,Ne)};A(Be,je=>{e(P).var_type==="number"&&(e(P).min_value||e(P).max_value)&&je(tt)})}var Xe=r(Be,2),Le=a(Xe);J(Le,{icon:"ph:trash-duotone",width:"14"}),t(Xe),t(D);var Oe=r(D,2);{var Ze=je=>{var Ne=qa(),st=a(Ne,!0);t(Ne),M(()=>d(st,e(P).description)),_(je,Ne)};A(Oe,je=>{e(P).description&&je(Ze)})}t(R),M((je,Ne)=>{d(Ie,e(P).name),d(he,e(P).var_type),d(Me,je),Ve(Xe,"title",Ne)},[()=>v()("editPage.variableEditor.defaultLabel",{values:{value:e(P).default_value}}),()=>v()("editPage.variableEditor.deleteTooltip")],se),ue("click",Xe,()=>ge(Z)),_(x,R)}),t(w),_(k,w)};A(ie,k=>{s().variables&&s().variables.length>0&&k(te)})}var ce=r(ie,2),H=a(ce),fe=a(H);Ke(fe);var Ee=r(fe,2);M(()=>{e(E),$t(()=>{v()})});var we=a(Ee);we.value=we.__value="text";var Te=a(we,!0);t(we);var $e=r(we);$e.value=$e.__value="number";var C=a($e,!0);t($e);var W=r($e);W.value=W.__value="enum";var _e=a(W,!0);t(W);var Se=r(W);Se.value=Se.__value="boolean";var j=a(Se,!0);t(Se),t(Ee),t(H);var y=r(H,2),U=a(y);Ke(U);var ae=r(U,2);{var pe=k=>{var w=La(),x=Re(w);Ke(x);var P=r(x,2);Ke(P),M((Z,R)=>{Ve(x,"placeholder",Z),Ve(P,"placeholder",R)},[()=>v()("editPage.variableEditor.minPlaceholder"),()=>v()("editPage.variableEditor.maxPlaceholder")],se),Ce(x,()=>e(n),Z=>o(n,Z)),Ce(P,()=>e(F),Z=>o(F,Z)),_(k,w)};A(ae,k=>{e(E)==="number"&&k(pe)})}t(y);var le=r(y,2),f=a(le);Ke(f);var b=r(f,2),V=a(b);J(V,{icon:"ph:plus-bold",width:"14"}),t(b),t(le),t(ce),t(S);var ee=r(S,2),Pe=a(ee),qe=a(Pe);J(qe,{icon:"ph:paint-brush-duotone",width:"16"});var me=r(qe);t(Pe);var Q=r(Pe,2),l=a(Q,!0);t(Q);var i=r(Q,2);ot(i),Ve(i,"placeholder",`<div class="stats">
  <div>ğŸ“ Location: {"{{{location}}}"}</div>
  <div>â¤ï¸ HP: {"{{{hp}}}"}</div>
</div>`),t(ee);var u=r(ee,2),I=a(u),Y=a(I);J(Y,{icon:"ph:code-duotone",width:"16"});var O=r(Y);t(I);var c=r(I,2),h=a(c,!0);t(c);var $=r(c,2);ot($),Ve($,"placeholder",`.stats { 
  display: flex; 
  gap: 12px; 
  color: #aaa; 
  font-size: 0.85em; 
}`),t(u),t(T),t(ne),M((k,w,x,P,Z,R,D,ve,Ie,xe,he,Je,Me,Be)=>{d(oe,` ${k??""}`),d(be,w),Ve(fe,"placeholder",x),d(Te,P),d(C,Z),d(_e,R),d(j,D),Ve(U,"placeholder",ve),Ve(f,"placeholder",Ie),b.disabled=xe,d(me,` ${he??""}`),d(l,Je),d(O,` ${Me??""}`),d(h,Be)},[()=>v()("editPage.variableEditor.sectionTitle"),()=>v()("editPage.variableEditor.sectionDesc",{values:{syntax:ke}}),()=>v()("editPage.variableEditor.namePlaceholder"),()=>v()("editPage.variableEditor.typeText"),()=>v()("editPage.variableEditor.typeNumber"),()=>v()("editPage.variableEditor.typeEnum"),()=>v()("editPage.variableEditor.typeBoolean"),()=>v()("editPage.variableEditor.defaultPlaceholder"),()=>v()("editPage.variableEditor.descriptionPlaceholder"),()=>!e(q).trim(),()=>v()("editPage.variableEditor.statusTitle"),()=>v()("editPage.variableEditor.statusDesc",{values:{syntax:ke}}),()=>v()("editPage.variableEditor.cssTitle"),()=>v()("editPage.variableEditor.cssDesc")],se),Ce(fe,()=>e(q),k=>o(q,k)),Lt(Ee,()=>e(E),k=>o(E,k)),Ce(U,()=>e(m),k=>o(m,k)),Ce(f,()=>e(G),k=>o(G,k)),ue("click",b,z),Ce(i,()=>s().status_template,k=>s(s().status_template=k,!0)),Ce($,()=>s().status_template_css,k=>s(s().status_template_css=k,!0)),_(B,ne),Ge(),re()}var Ia=g('<p class="hint">Save to start adding entries.</p>'),ja=g('<span class="badge svelte-3nq711"> </span>'),Da=g('<span class="badge svelte-3nq711"> </span>'),Fa=g('<span class="badge empty svelte-3nq711">No keywords</span>'),Va=g('<div><div class="entry-main svelte-3nq711"><div class="keywords svelte-3nq711"><!> <!> <!></div> <div class="preview svelte-3nq711"> </div></div> <div class="entry-meta"><span class="prio"> </span></div></div>'),Ma=g('<div class="empty-list">No entries yet.</div>'),Ca=g('<div class="entries-header svelte-3nq711"><h3 class="svelte-3nq711"> </h3> <button class="btn-sm svelte-3nq711"><!></button></div> <div class="entries-list svelte-3nq711"><!> <!></div>',1),Na=g('<span class="badge removable svelte-3nq711"> <button aria-label="Remove Keyword" class="svelte-3nq711"><!></button></span>'),Aa=g('<button class="btn destructive svelte-3nq711"> </button>'),Ja=g('<div class="entry-editor svelte-3nq711"><h3> </h3> <div class="field svelte-3nq711"><label for="kw-input" class="svelte-3nq711"> </label> <div class="keyword-input-row svelte-3nq711"><input id="kw-input" placeholder="Add keyword..." class="svelte-3nq711"/> <button aria-label="Add Keyword" class="svelte-3nq711"><!></button></div> <div class="keyword-list"></div></div> <div class="field svelte-3nq711"><label for="content-input" class="svelte-3nq711"> </label> <textarea id="content-input" rows="10" placeholder="Write the lore info here..." class="svelte-3nq711"></textarea> <div> </div></div> <div class="row svelte-3nq711"><div class="field half svelte-3nq711"><label for="prio-input" class="svelte-3nq711"> </label> <input id="prio-input" type="number"/></div> <div class="field half checkbox-field svelte-3nq711"><label class="checkbox-label svelte-3nq711"><input type="checkbox"/> </label> <label class="checkbox-label svelte-3nq711"><input type="checkbox"/> </label></div></div> <div class="editor-actions svelte-3nq711"><!> <div class="spacer svelte-3nq711"></div> <button class="btn secondary svelte-3nq711"> </button> <button class="btn primary svelte-3nq711"> </button></div></div>'),Oa=g("<p> </p>"),Ra=g("<p> </p>"),Ka=g('<div class="placeholder svelte-3nq711"><!></div>'),Ba=g('<div class="editor-layout svelte-3nq711"><div class="sidebar svelte-3nq711"><div class="meta-section svelte-3nq711"><input class="title-input svelte-3nq711"/> <textarea class="desc-input svelte-3nq711" rows="2"></textarea> <div class="actions svelte-3nq711"><button class="btn primary svelte-3nq711"> </button> <!></div></div> <!></div> <div class="main-panel svelte-3nq711"><!></div></div>');function za(B,p){Ye(p,!1);const[de,re]=it(),v=()=>rt(nt,"$t",de),s=N();let q=ye(p,"loreId",8,null);const E=dt();let m=N({name:"",description:"",visibility:"private"}),G=N([]),n=N(null),F=N(!1);ct(async()=>{q()&&await z()});async function z(){if(q())try{const y=await et.getLore(q());o(m,y.lore),o(G,y.entries.sort((U,ae)=>ae.priority-U.priority||U.order-ae.order))}catch(y){console.error(y),De.error("Failed to load lorebook")}finally{}}async function ge(){try{if(e(s))await et.createLore(e(m)),De.success("Lorebook created"),E("close");else{if(!q())return;await et.updateLore(q(),e(m)),De.success("Lorebook updated")}}catch(y){console.error(y),De.error("Failed to save lorebook")}}function ke(){o(n,{keywords:[],content:"",priority:10,recursion:!1,enabled:!0,lore_id:q()}),o(F,!0)}function ne(y){o(n,{...y}),o(F,!1)}async function T(){if(!(!e(n)||!q()))try{Ae(n,e(n).lore_id=q()),await et.upsertEntry(e(n)),De.success(e(F)?"Entry created":"Entry updated"),o(n,null),await z()}catch(y){console.error(y),De.error("Failed to save entry")}}async function S(y){if(confirm("Delete this entry?")&&q())try{await et.deleteEntry(y,q()),De.success("Entry deleted"),e(n)?.id===y&&o(n,null),await z()}catch(U){console.error(U),De.error("Failed to delete entry")}}let L=N("");function K(){e(L).trim()&&e(n)&&(e(n).keywords||Ae(n,e(n).keywords=[]),e(n).keywords.includes(e(L).trim())||Ae(n,e(n).keywords=[...e(n).keywords,e(L).trim()]),o(L,""))}function oe(y){!e(n)||!e(n).keywords||Ae(n,e(n).keywords=e(n).keywords.filter(U=>U!==y))}We(()=>vt(q()),()=>{o(s,!q())}),pt(),Qe();var X=Ba(),be=a(X),ie=a(be),te=a(ie);Ke(te);var ce=r(te,2);ot(ce);var H=r(ce,2),fe=a(H),Ee=a(fe,!0);t(fe);var we=r(fe,2);{var Te=y=>{var U=Ia();_(y,U)};A(we,y=>{e(s)&&y(Te)})}t(H),t(ie);var $e=r(ie,2);{var C=y=>{var U=Ca(),ae=Re(U),pe=a(ae),le=a(pe);t(pe);var f=r(pe,2),b=a(f);J(b,{icon:"ph:plus-bold"}),t(f),t(ae);var V=r(ae,2),ee=a(V);He(ee,1,()=>e(G),at,(me,Q)=>{var l=Va();let i;var u=a(l),I=a(u),Y=a(I);He(Y,1,()=>e(Q).keywords.slice(0,3),at,(R,D)=>{var ve=ja(),Ie=a(ve,!0);t(ve),M(()=>d(Ie,e(D))),_(R,ve)});var O=r(Y,2);{var c=R=>{var D=Da(),ve=a(D);t(D),M(()=>d(ve,`+${e(Q).keywords.length-3}`)),_(R,D)};A(O,R=>{e(Q).keywords.length>3&&R(c)})}var h=r(O,2);{var $=R=>{var D=Fa();_(R,D)};A(h,R=>{e(Q).keywords.length===0&&R($)})}t(I);var k=r(I,2),w=a(k);t(k),t(u);var x=r(u,2),P=a(x),Z=a(P);t(P),t(x),t(l),M((R,D)=>{i=Fe(l,1,"entry-item svelte-3nq711",null,i,R),d(w,`${D??""}${e(Q).content.length>50?"...":""}`),d(Z,`P:${e(Q).priority??""}`)},[()=>({selected:e(n)?.id===e(Q).id}),()=>e(Q).content.slice(0,50)],se),ue("click",l,()=>ne(e(Q))),_(me,l)});var Pe=r(ee,2);{var qe=me=>{var Q=Ma();_(me,Q)};A(Pe,me=>{e(G).length===0&&me(qe)})}t(V),M((me,Q)=>{d(le,`${me??""} (${e(G).length??""})`),Ve(f,"aria-label",Q)},[()=>v()("lorebook.entries"),()=>v()("lorebook.addEntry")],se),ue("click",f,ke),_(y,U)};A($e,y=>{e(s)||y(C)})}t(be);var W=r(be,2),_e=a(W);{var Se=y=>{var U=Ja(),ae=a(U),pe=a(ae,!0);t(ae);var le=r(ae,2),f=a(le),b=a(f,!0);t(f);var V=r(f,2),ee=a(V);Ke(ee);var Pe=r(ee,2),qe=a(Pe);J(qe,{icon:"ph:plus-bold"}),t(Pe),t(V);var me=r(V,2);He(me,5,()=>e(n).keywords||[],at,(Le,Oe)=>{var Ze=Na(),je=a(Ze),Ne=r(je),st=a(Ne);J(st,{icon:"ph:x-bold",width:"12"}),t(Ne),t(Ze),M(()=>d(je,`${e(Oe)??""} `)),ue("click",Ne,()=>oe(e(Oe))),_(Le,Ze)}),t(me),t(le);var Q=r(le,2),l=a(Q),i=a(l,!0);t(l);var u=r(l,2);ot(u);var I=r(u,2);let Y;var O=a(I);t(I),t(Q);var c=r(Q,2),h=a(c),$=a(h),k=a($,!0);t($);var w=r($,2);Ke(w),t(h);var x=r(h,2),P=a(x),Z=a(P);Ke(Z);var R=r(Z);t(P);var D=r(P,2),ve=a(D);Ke(ve);var Ie=r(ve);t(D),t(x),t(c);var xe=r(c,2),he=a(xe);{var Je=Le=>{var Oe=Aa(),Ze=a(Oe,!0);t(Oe),M(je=>d(Ze,je),[()=>v()("lorebook.deleteEntry")],se),ue("click",Oe,()=>S(e(n)?.id||"")),_(Le,Oe)};A(he,Le=>{!e(F)&&e(n).id&&Le(Je)})}var Me=r(he,4),Be=a(Me,!0);t(Me);var tt=r(Me,2),Xe=a(tt,!0);t(tt),t(xe),t(U),M((Le,Oe,Ze,je,Ne,st,It,jt,Dt)=>{d(pe,Le),d(b,Oe),d(i,Ze),Y=Fe(I,1,"char-count svelte-3nq711",null,Y,je),d(O,`${(e(n).content?.length||0)??""} / 500`),d(k,Ne),d(R,` ${st??""}`),d(Ie,` ${It??""}`),d(Be,jt),d(Xe,Dt)},[()=>e(F)?v()("lorebook.newEntry"):v()("lorebook.editEntry"),()=>v()("lorebook.keywords"),()=>v()("lorebook.content"),()=>({warn:(e(n).content?.length||0)>500}),()=>v()("lorebook.priority"),()=>v()("lorebook.enabled"),()=>v()("lorebook.recursion"),()=>v()("lorebook.cancel"),()=>v()("lorebook.saveEntry")],se),Ce(ee,()=>e(L),Le=>o(L,Le)),ue("keydown",ee,Le=>Le.key==="Enter"&&K()),ue("click",Pe,K),Ce(u,()=>e(n).content,Le=>Ae(n,e(n).content=Le)),Ce(w,()=>e(n).priority,Le=>Ae(n,e(n).priority=Le)),ft(Z,()=>e(n).enabled,Le=>Ae(n,e(n).enabled=Le)),ft(ve,()=>e(n).recursion,Le=>Ae(n,e(n).recursion=Le)),ue("click",Me,()=>o(n,null)),ue("click",tt,T),_(y,U)},j=y=>{var U=Ka(),ae=a(U);{var pe=f=>{var b=Oa(),V=a(b,!0);t(b),M(ee=>d(V,ee),[()=>v()("lorebook.createFirst")],se),_(f,b)},le=f=>{var b=Ra(),V=a(b,!0);t(b),M(ee=>d(V,ee),[()=>v()("lorebook.selectEntry")],se),_(f,b)};A(ae,f=>{e(s)?f(pe):f(le,!1)})}t(U),_(y,U)};A(_e,y=>{e(n)?y(Se):y(j,!1)})}t(W),t(X),M((y,U,ae,pe,le)=>{Ve(te,"placeholder",y),Ve(te,"aria-label",U),Ve(ce,"placeholder",ae),Ve(ce,"aria-label",pe),d(Ee,le)},[()=>v()("lorebook.name"),()=>v()("lorebook.name"),()=>v()("lorebook.descLabel"),()=>v()("lorebook.descLabel"),()=>e(s)?v()("lorebook.create"):v()("lorebook.saveMeta")],se),Ce(te,()=>e(m).name,y=>Ae(m,e(m).name=y)),Ce(ce,()=>e(m).description,y=>Ae(m,e(m).description=y)),ue("click",fe,ge),_(B,X),Ge(),re()}var Wa=g('<div class="modal-backdrop svelte-1wum1v2"><div class="modal-container svelte-1wum1v2"><button class="close-button svelte-1wum1v2" aria-label="Close"><!></button> <div class="modal-content svelte-1wum1v2"><!></div></div></div>');function Ua(B,p){Ye(p,!1);let de=ye(p,"loreId",8,null);const re=dt();function v(){re("close")}function s(z){z.key==="Escape"&&v()}ct(()=>{window.addEventListener("keydown",s),document.body.style.overflow="hidden",kt.hide()}),ht(()=>{window.removeEventListener("keydown",s),document.body.style.overflow="",kt.show()}),Qe();var q=Wa(),E=a(q),m=a(E),G=a(m);J(G,{icon:"ph:x-bold"}),t(m);var n=r(m,2),F=a(n);za(F,{get loreId(){return de()},$$events:{close:v}}),t(n),t(E),t(q),ue("click",m,v),ue("click",E,Tt(function(z){gt.call(this,p,z)})),ue("click",q,v),lt(3,q,()=>St),_(B,q),Ge()}var Ha=g('<span class="spin svelte-1o5snyl"><!></span>'),Qa=g("<!> ",1),Ya=g('<div class="empty-result svelte-1o5snyl"> </div>'),Ga=g('<div class="result-item svelte-1o5snyl"><div class="match-info svelte-1o5snyl"><span class="keyword-match svelte-1o5snyl"> </span> <span class="prio svelte-1o5snyl"> </span></div> <div class="content svelte-1o5snyl"> </div></div>'),Xa=g('<div class="result-list svelte-1o5snyl"></div>'),Za=g('<div class="results svelte-1o5snyl"><h3 class="svelte-1o5snyl"> </h3> <!></div>'),er=g('<div class="modal-backdrop svelte-1o5snyl"><div class="modal-container svelte-1o5snyl"><button class="close-button svelte-1o5snyl" aria-label="Close"><!></button> <h2 class="title svelte-1o5snyl"><!> </h2> <div class="test-body svelte-1o5snyl"><p class="desc svelte-1o5snyl"> </p> <textarea class="input-msg svelte-1o5snyl" placeholder="e.g. I walk into the ancient forest..." rows="3"></textarea> <button class="btn-test svelte-1o5snyl"><!></button> <!></div></div></div>');function tr(B,p){Ye(p,!1);const[de,re]=it(),v=()=>rt(nt,"$t",de);let s=ye(p,"personaId",8),q=ye(p,"activeLoreIds",24,()=>[]);const E=dt();let m=N(""),G=N(!1),n=N([]),F=N(!1);async function z(){if(e(m).trim()){o(G,!0);try{o(n,await et.testContext(s(),e(m),q())),o(F,!0)}catch(C){console.error(C),alert("Failed to test context")}finally{o(G,!1)}}}function ge(){E("close")}function ke(C){C.key==="Escape"&&ge()}ct(()=>{window.addEventListener("keydown",ke),document.body.style.overflow="hidden"}),ht(()=>{window.removeEventListener("keydown",ke),document.body.style.overflow=""}),Qe();var ne=er(),T=a(ne),S=a(T),L=a(S);J(L,{icon:"ph:x-bold"}),t(S);var K=r(S,2),oe=a(K);J(oe,{icon:"ph:flask-duotone"});var X=r(oe);t(K);var be=r(K,2),ie=a(be),te=a(ie,!0);t(ie);var ce=r(ie,2);ot(ce);var H=r(ce,2),fe=a(H);{var Ee=C=>{var W=Ha(),_e=a(W);J(_e,{icon:"ph:spinner-gap-bold"}),t(W),_(C,W)},we=C=>{var W=Qa(),_e=Re(W);J(_e,{icon:"ph:play-bold"});var Se=r(_e);M(j=>d(Se,` ${j??""}`),[()=>v()("lorebook.test.run")],se),_(C,W)};A(fe,C=>{e(G)?C(Ee):C(we,!1)})}t(H);var Te=r(H,2);{var $e=C=>{var W=Za(),_e=a(W),Se=a(_e);t(_e);var j=r(_e,2);{var y=ae=>{var pe=Ya(),le=a(pe,!0);t(pe),M(f=>d(le,f),[()=>v()("lorebook.test.noResult")],se),_(ae,pe)},U=ae=>{var pe=Xa();He(pe,5,()=>e(n),at,(le,f)=>{var b=Ga(),V=a(b),ee=a(V),Pe=a(ee);t(ee);var qe=r(ee,2),me=a(qe);t(qe),t(V);var Q=r(V,2),l=a(Q,!0);t(Q),t(b),M(()=>{d(Pe,`id: ${e(f).id??""}`),d(me,`Prio: ${e(f).priority??""}`),d(l,e(f).content)}),_(le,b)}),t(pe),_(ae,pe)};A(j,ae=>{e(n).length===0?ae(y):ae(U,!1)})}t(W),M(ae=>d(Se,`${ae??""} (${e(n).length??""})`),[()=>v()("lorebook.test.result")],se),_(C,W)};A(Te,C=>{e(F)&&C($e)})}t(be),t(T),t(ne),M((C,W,_e)=>{d(X,` ${C??""}`),d(te,W),H.disabled=_e},[()=>v()("lorebook.test.title"),()=>v()("lorebook.test.placeholder"),()=>e(G)||!e(m).trim()],se),ue("click",S,ge),Ce(ce,()=>e(m),C=>o(m,C)),ue("click",H,z),ue("click",T,Tt(function(C){gt.call(this,p,C)})),ue("click",ne,ge),lt(3,ne,()=>St),_(B,ne),Ge(),re()}var ar=g('<div class="loading svelte-wkjmps">Loading...</div>'),rr=g('<div class="empty svelte-wkjmps"> </div>'),sr=g('<div><label class="checkbox-wrapper svelte-wkjmps"><input type="checkbox" class="svelte-wkjmps"/> <span class="checkmark svelte-wkjmps"></span></label> <div class="info svelte-wkjmps"><div class="name svelte-wkjmps"> </div> <div class="desc svelte-wkjmps"> </div></div> <div class="actions svelte-wkjmps"><button class="btn-icon svelte-wkjmps" title="Edit"><!></button></div></div>'),ir=g('<div class="list svelte-wkjmps"></div>'),nr=g('<div class="lore-linker svelte-wkjmps"><div class="header svelte-wkjmps"><span class="title svelte-wkjmps"><!> </span> <div class="header-actions svelte-wkjmps"><button class="btn-new secondary svelte-wkjmps" title="Test Context"><!></button> <button class="btn-new svelte-wkjmps"><!> </button></div></div> <!> <!> <!></div>');function or(B,p){Ye(p,!1);const[de,re]=it(),v=()=>rt(nt,"$t",de);let s=ye(p,"personaId",8),q=ye(p,"pendingLinks",28,()=>new Set),E=N([]),m=N(new Set),G=N(!1),n=N(!1),F=N(!1),z=N(null);ct(()=>{s()||ge()});async function ge(){o(G,!0);try{o(E,await et.getMyLores()),s()||o(m,new Set(q()))}catch(j){console.error("Failed to load lorebooks",j)}finally{o(G,!1)}}async function ke(){o(G,!0);try{const j=[et.getMyLores()];s()&&j.push(et.getPersonaLores(s()));const[y,U]=await Promise.all(j);o(E,y),o(m,new Set(U.map(ae=>ae.id)))}catch(j){console.error("Failed to load lorebooks",j)}finally{o(G,!1)}}async function ne(j){const y=e(m).has(j.id);if(!s()){y?(q().delete(j.id),e(m).delete(j.id)):(q().add(j.id),e(m).add(j.id)),q(q()),o(m,e(m));return}try{await et.linkPersona(s(),j.id,y),y?e(m).delete(j.id):e(m).add(j.id),o(m,e(m))}catch(U){console.error("Failed to toggle link",U),alert("Failed to update link")}}function T(j){o(z,j),o(n,!0)}function S(){o(n,!1),o(z,null),s()?ke():ge()}We(()=>vt(s()),()=>{s()?ke():ge()}),We(()=>(vt(q()),vt(s())),()=>{q()&&!s()&&o(m,new Set(q()))}),pt(),Qe();var L=nr(),K=a(L),oe=a(K),X=a(oe);J(X,{icon:"ph:book-bookmark-duotone",width:"18"});var be=r(X);t(oe);var ie=r(oe,2),te=a(ie),ce=a(te);J(ce,{icon:"ph:flask-duotone"}),t(te);var H=r(te,2),fe=a(H);J(fe,{icon:"ph:plus-bold"});var Ee=r(fe);t(H),t(ie),t(K);var we=r(K,2);{var Te=j=>{var y=ar();_(j,y)},$e=(j,y)=>{{var U=pe=>{var le=rr(),f=a(le,!0);t(le),M(b=>d(f,b),[()=>v()("lorebook.noLorebooks",{default:"No lorebooks found. Create one to add context to your character."})],se),_(pe,le)},ae=pe=>{var le=ir();He(le,5,()=>e(E),f=>f.id,(f,b)=>{var V=sr();let ee;var Pe=a(V),qe=a(Pe);Ke(qe),Ue(2),t(Pe);var me=r(Pe,2),Q=a(me),l=a(Q,!0);t(Q);var i=r(Q,2),u=a(i,!0);t(i),t(me);var I=r(me,2),Y=a(I),O=a(Y);J(O,{icon:"ph:pencil-simple-duotone",width:"18"}),t(Y),t(I),t(V),M((c,h,$)=>{ee=Fe(V,1,"lore-item svelte-wkjmps",null,ee,c),Wt(qe,h),d(l,e(b).name),d(u,$)},[()=>({linked:e(m).has(e(b).id)}),()=>e(m).has(e(b).id),()=>e(b).description||v()("lorebook.noDescription",{default:"No description"})],se),ue("change",qe,()=>ne(e(b))),ue("click",Y,()=>T(e(b).id)),_(f,V)}),t(le),_(pe,le)};A(j,pe=>{e(E).length===0?pe(U):pe(ae,!1)},y)}};A(we,j=>{e(G)?j(Te):j($e,!1)})}var C=r(we,2);{var W=j=>{Ua(j,{get loreId(){return e(z)},$$events:{close:S}})};A(C,j=>{e(n)&&j(W)})}var _e=r(C,2);{var Se=j=>{const y=se(()=>Array.from(e(m)));tr(j,{get personaId(){return s()},get activeLoreIds(){return e(y)},$$events:{close:()=>o(F,!1)}})};A(_e,j=>{e(F)&&j(Se)})}t(L),M((j,y)=>{d(be,` ${j??""}`),d(Ee,` ${y??""}`)},[()=>v()("lorebook.title",{default:"Example Lorebooks"}),()=>v()("lorebook.createNew",{default:"Create New"})],se),ue("click",te,()=>o(F,!0)),ue("click",H,()=>T(null)),_(B,L),Ge(),re()}var lr=g("<button><!> </button>"),vr=g('<div class="tag-tools svelte-hvyrxq"><div class="toggle-row svelte-hvyrxq"><span></span> <label class="toggle-switch svelte-hvyrxq"><input type="checkbox" class="svelte-hvyrxq"/> <span class="slider svelte-hvyrxq"></span></label> <span></span></div> <button type="button" class="btn-util svelte-hvyrxq"><!> </button></div>'),dr=g('<p class="field-hint svelte-hvyrxq"> </p> <!> <textarea id="e3-first-scene" class="field-textarea svelte-hvyrxq" rows="8" maxlength="2500"></textarea> <div> </div>',1),cr=g('<div class="field-group svelte-hvyrxq"><label for="e3-template" class="field-label svelte-hvyrxq"><!> </label> <select id="e3-template" class="field-select svelte-hvyrxq"><option> </option><option> </option><option> </option><option> </option></select></div>'),pr=g('<textarea id="e3-instructions" class="field-textarea svelte-hvyrxq" rows="8" maxlength="3000"></textarea> <div> </div>',1),ur=g('<div class="step-prompt svelte-hvyrxq"><div class="tabs svelte-hvyrxq"></div> <div><div class="field-group svelte-hvyrxq"><label for="e3-first-scene" class="field-label svelte-hvyrxq"><!> <span class="required svelte-hvyrxq">*</span></label> <!></div> <!> <div class="field-group svelte-hvyrxq"><label for="e3-instructions" class="field-label svelte-hvyrxq"><!> <span class="required svelte-hvyrxq">*</span></label> <p class="field-hint svelte-hvyrxq"> </p> <!></div></div> <div><!></div> <div><div class="field-group svelte-hvyrxq"><label class="field-label svelte-hvyrxq"><!> </label> <p class="field-hint svelte-hvyrxq"> </p> <!></div></div></div>');function qt(B,p){Ye(p,!1);const[de,re]=it(),v=()=>rt(nt,"$t",de);let s=ye(p,"persona",12),q=ye(p,"selectedTemplate",12),E=ye(p,"singleInstruction",12),m=ye(p,"k_description",12),G=ye(p,"k_personality",12),n=ye(p,"k_userPersona",12),F=ye(p,"k_scenario",12),z=ye(p,"firstSceneJson",12),ge=ye(p,"availableExpressions",8),ke=ye(p,"availableMotions",8),ne=ye(p,"kintsugiTemplateId",8);ye(p,"pendingLoreLinks",24,()=>new Set);let T=N(),S=N(!1);function L(){if(!e(T))return;const h=`<dialogue speaker="${e(S)?"{{user}}":"{{char}}"}"></dialogue>`,$=e(T).selectionStart,k=e(T).selectionEnd,w=s().first_scene.substring(0,$),x=s().first_scene.substring(k);s(s().first_scene=w+h+x,!0);const P=$+h.indexOf("></")+1;Ft().then(()=>{e(T).focus(),Ae(T,e(T).selectionStart=P),Ae(T,e(T).selectionEnd=P)})}let K=N("prompt");const oe=[{id:"prompt",label:"editPage.tabs.prompt",icon:"ph:pencil-circle-duotone"},{id:"variable",label:"editPage.tabs.variable",icon:"ph:sliders-horizontal-duotone"},{id:"lore",label:"editPage.tabs.lorebook",icon:"ph:book-bookmark-duotone"}];Qe();var X=ur(),be=a(X);He(be,5,()=>oe,at,(c,h)=>{var $=_t(),k=Re($);{var w=P=>{},x=P=>{var Z=lr();let R;var D=a(Z);J(D,{get icon(){return e(h).icon},width:"18"});var ve=r(D);t(Z),M((Ie,xe)=>{R=Fe(Z,1,"tab-btn svelte-hvyrxq",null,R,Ie),d(ve,` ${xe??""}`)},[()=>({active:e(K)===e(h).id}),()=>v()(e(h).label,{default:e(h).label.split(".").pop()})],se),ue("click",Z,()=>o(K,e(h).id)),_(P,Z)};A(k,P=>{e(h).id==="variable"&&(s().personaType==="3D"||s().personaType==="2.5D")?P(w):P(x,!1)})}_(c,$)}),t(be);var ie=r(be,2);let te;var ce=a(ie),H=a(ce),fe=a(H);J(fe,{icon:"ph:film-script-duotone",width:"18"});var Ee=r(fe);Ue(),t(H);var we=r(H,2);{var Te=c=>{const h=se(()=>s().personaType==="3D"?"3d":"live2d");Kt(c,{get initialData(){return s().first_scene},get availableExpressions(){return ge()},get availableMotions(){return ke()},get mode(){return e(h)},onChange:$=>{z($),s(s().first_scene=$,!0)}})},$e=c=>{var h=dr(),$=Re(h),k=a($,!0);t($);var w=r($,2);{var x=ve=>{var Ie=vr(),xe=a(Ie),he=a(xe);let Je;he.textContent="{{char}}";var Me=r(he,2),Be=a(Me);Ke(Be),Ue(2),t(Me);var tt=r(Me,2);let Xe;tt.textContent="{{user}}",t(xe);var Le=r(xe,2),Oe=a(Le);J(Oe,{icon:"ph:plus-bold",width:"14"});var Ze=r(Oe);t(Le),t(Ie),M((je,Ne,st)=>{Je=Fe(he,1,"toggle-label svelte-hvyrxq",null,Je,je),Xe=Fe(tt,1,"toggle-label svelte-hvyrxq",null,Xe,Ne),d(Ze,` ${st??""}`)},[()=>({active:!e(S)}),()=>({active:e(S)}),()=>v()("editPage.aiSettings.addDialogueTag",{default:"ëŒ€í™” íƒœê·¸ ì‚½ì…"})],se),ft(Be,()=>e(S),je=>o(S,je)),ue("click",Le,L),_(ve,Ie)};A(w,ve=>{s().contentType!=="story"&&ve(x)})}var P=r(w,2);ot(P),Ut(P,ve=>o(T,ve),()=>e(T));var Z=r(P,2);let R;var D=a(Z);t(Z),M((ve,Ie,xe)=>{d(k,ve),Ve(P,"placeholder",Ie),R=Fe(Z,1,"char-counter svelte-hvyrxq",null,R,xe),d(D,`${s().first_scene.length??""} / 2500`)},[()=>v()("editPage.firstSceneDescription",{default:"ëŒ€í™”ê°€ ì‹œì‘ë  ë•Œì˜ ì²« ì¥ë©´ì„ ì‘ì„±í•˜ì„¸ìš”. ì—ì…‹ ì´ë¯¸ì§€ë¥¼ ë³¸ë¬¸ì— ë„£ìœ¼ë ¤ë©´ <img 0>, <img 1> í˜•íƒœì˜ íƒœê·¸ë¥¼ ì‚½ì…í•˜ì„¸ìš”."}),()=>v()("editPage.firstScenePlaceholder",{default:"ì˜ˆ: í•™êµ ì˜¥ìƒì—ì„œ ë°”ëŒì´ ë¶ˆì–´ì˜¤ëŠ” ì˜¤í›„. {{char}}ê°€ ë‚œê°„ì— ê¸°ëŒ€ì–´ í•˜ëŠ˜ì„ ë°”ë¼ë³´ê³  ìˆë‹¤."}),()=>({warning:s().first_scene.length>2400,error:s().first_scene.length>=2500})],se),Ce(P,()=>s().first_scene,ve=>s(s().first_scene=ve,!0)),_(c,h)};A(we,c=>{s().personaType==="3D"||s().personaType==="2.5D"?c(Te):c($e,!1)})}t(ce);var C=r(ce,2);{var W=c=>{var h=cr(),$=a(h),k=a($);J(k,{icon:"ph:file-code-duotone",width:"18"});var w=r(k);t($);var x=r($,2);M(()=>{q(),$t(()=>{v(),ne()})});var P=a(x);P.value=P.__value="custom";var Z=a(P,!0);t(P);var R=r(P);R.value=R.__value="conversation";var D=a(R,!0);t(R);var ve=r(R);ve.value=ve.__value="simulation";var Ie=a(ve,!0);t(ve);var xe=r(ve),he={},Je=a(xe,!0);t(xe),t(x),t(h),M((Me,Be,tt,Xe,Le)=>{d(w,` ${Me??""}`),d(Z,Be),d(D,tt),d(Ie,Xe),he!==(he=ne())&&(xe.value=(xe.__value=ne())??""),d(Je,Le)},[()=>v()("editPage.aiSettings.templateLabel",{default:"í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿"}),()=>v()("editPage.aiSettings.templateCustom",{default:"ììœ  í˜•ì‹"}),()=>v()("editPage.aiSettings.templateConversation",{default:"ëŒ€í™”í˜•"}),()=>v()("editPage.aiSettings.templateSimulation",{default:"ì‹œë®¬ë ˆì´ì…˜"}),()=>v()("editPage.aiSettings.templateKintsugi",{default:"Kintsugi"})],se),Lt(x,q),_(c,h)};A(C,c=>{s().personaType!=="3D"&&s().personaType!=="2.5D"&&c(W)})}var _e=r(C,2),Se=a(_e),j=a(Se);J(j,{icon:"ph:notepad-duotone",width:"18"});var y=r(j);Ue(),t(Se);var U=r(Se,2),ae=a(U,!0);t(U);var pe=r(U,2);{var le=c=>{var h=pr(),$=Re(h);ot($);var k=r($,2);let w;var x=a(k);t(k),M((P,Z)=>{Ve($,"placeholder",P),w=Fe(k,1,"char-counter svelte-hvyrxq",null,w,Z),d(x,`${E().length??""} / 3000`)},[()=>v()("editPage.instructionsPlaceholder",{default:"ìºë¦­í„°ì˜ ì„±ê²©ê³¼ ë§íˆ¬ë¥¼ ì„¤ëª…í•˜ì„¸ìš”..."}),()=>({warning:E().length>2800,error:E().length>=3e3})],se),Ce($,E),_(c,h)},f=c=>{Bt(c,{get k_description(){return m()},set k_description(h){m(h)},get k_personality(){return G()},set k_personality(h){G(h)},get k_userPersona(){return n()},set k_userPersona(h){n(h)},get k_scenario(){return F()},set k_scenario(h){F(h)},$$legacy:!0})};A(pe,c=>{q()!==ne()?c(le):c(f,!1)})}t(_e),t(ie);var b=r(ie,2);let V;var ee=a(b);{var Pe=c=>{Ta(c,{get persona(){return s()},set persona(h){s(h)},$$legacy:!0})};A(ee,c=>{s().personaType!=="3D"&&s().personaType!=="2.5D"&&c(Pe)})}t(b);var qe=r(b,2);let me;var Q=a(qe),l=a(Q),i=a(l);J(i,{icon:"ph:book-bookmark-duotone",width:"18"});var u=r(i);t(l);var I=r(l,2),Y=a(I,!0);t(I);var O=r(I,2);or(O,{get personaId(){return s().id}}),t(Q),t(qe),t(X),M((c,h,$,k,w,x,P,Z)=>{te=Fe(ie,1,"tab-content svelte-hvyrxq",null,te,c),d(Ee,` ${h??""} `),d(y,` ${$??""} `),d(ae,k),V=Fe(b,1,"tab-content svelte-hvyrxq",null,V,w),me=Fe(qe,1,"tab-content svelte-hvyrxq",null,me,x),d(u,` ${P??""}`),d(Y,Z)},[()=>({active:e(K)==="prompt"}),()=>s().personaType==="3D"||s().personaType==="2.5D"?v()("editPage.characterSettings.title",{default:"ìºë¦­í„° ì„¤ì •"}):v()("editPage.firstSceneLabel",{default:"ì²« ì¥ë©´"}),()=>v()("editPage.instructionsLabel",{default:"ì§€ì‹œì‚¬í•­ (Instructions)"}),()=>v()("editPage.instructionsDescription",{default:"ìºë¦­í„°ì˜ ì„±ê²©, ë§íˆ¬, í–‰ë™ ê·œì¹™ ë“±ì„ ììœ ë¡­ê²Œ ì‘ì„±í•˜ì„¸ìš”."}),()=>({active:e(K)==="variable"}),()=>({active:e(K)==="lore"}),()=>v()("editPage.lorebookLabel",{default:"ë¡œì–´ë¶ (Lorebook)"}),()=>v()("editPage.lorebookDescription",{default:"íŠ¹ì • í‚¤ì›Œë“œê°€ ë“±ì¥í•  ë•Œ AIì—ê²Œ ì¶”ê°€ ì •ë³´ë¥¼ ì œê³µí•©ë‹ˆë‹¤."})],se),_(B,X),Ge(),re()}var _r=g('<button type="button"> </button>'),fr=g('<div class="portrait-placeholder svelte-tqtjkv"><!></div>'),hr=g('<p class="preview-oneliner svelte-tqtjkv"> </p>'),gr=g('<p class="preview-greeting svelte-tqtjkv"> </p>'),br=g("<li> </li>"),mr=g('<section class="review-section svelte-tqtjkv"><div class="validation-box svelte-tqtjkv"><h4 class="validation-title svelte-tqtjkv"><!> ì‘ì„±ì´ í•„ìš”í•œ í•­ëª©</h4> <ul class="validation-list svelte-tqtjkv"></ul></div></section>'),yr=g('<section class="review-section svelte-tqtjkv"><div class="success-box svelte-tqtjkv"><!> <span>ëª¨ë“  í•„ìˆ˜ í•­ëª©ì´ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤. ì €ì¥í•  ì¤€ë¹„ê°€ ë˜ì—ˆì–´ìš”!</span></div></section>'),kr=g('<div class="step-review svelte-tqtjkv"><section class="review-section svelte-tqtjkv"><h3 class="section-title svelte-tqtjkv"><!> ì¹´í…Œê³ ë¦¬ íƒœê·¸ ì„ íƒ <span class="required svelte-tqtjkv">*</span></h3> <p class="section-hint svelte-tqtjkv"> </p> <div class="tags-grid svelte-tqtjkv"></div></section> <section class="review-section svelte-tqtjkv"><h3 class="section-title svelte-tqtjkv"><!> ë¯¸ë¦¬ë³´ê¸°</h3> <div class="preview-card svelte-tqtjkv"><div class="preview-portrait svelte-tqtjkv"><!></div> <div class="preview-info svelte-tqtjkv"><h4 class="preview-name svelte-tqtjkv"> </h4> <!> <div class="preview-meta svelte-tqtjkv"><span class="preview-type svelte-tqtjkv"> </span> <span class="preview-visibility svelte-tqtjkv"><!> </span></div> <!></div></div></section> <!></div>');function Et(B,p){Ye(p,!1);const[de,re]=it(),v=()=>rt(nt,"$t",de),s=N(),q=N();let E=ye(p,"persona",12),m=ye(p,"validationErrors",8);function G(f){E().tags.includes(f)?E(E().tags=E().tags.filter(b=>b!==f),!0):E().tags.filter(V=>parseInt(V)<1e3).length<3?E(E().tags=[...E().tags,f],!0):De.warning(v()("editPage.validation.maxTags",{default:"ìµœëŒ€ 3ê°œì˜ íƒœê·¸ë§Œ ì„ íƒ ê°€ëŠ¥í•©ë‹ˆë‹¤."}))}We(()=>wt,()=>{o(s,wt.filter(f=>f.id<1e3))}),We(()=>vt(E()),()=>{o(q,E().tags.filter(f=>parseInt(f)<1e3).length)}),pt(),Qe();var n=kr(),F=a(n),z=a(F),ge=a(z);J(ge,{icon:"ph:tag-duotone",width:"20"}),Ue(2),t(z);var ke=r(z,2),ne=a(ke);t(ke);var T=r(ke,2);He(T,5,()=>e(s),f=>f.id,(f,b)=>{var V=_r();let ee;var Pe=a(V,!0);t(V),M((qe,me)=>{ee=Fe(V,1,"tag-chip svelte-tqtjkv",null,ee,qe),d(Pe,me)},[()=>({active:E().tags.includes(e(b).id.toString()),disabled:e(q)>=3&&!E().tags.includes(e(b).id.toString())}),()=>v()(e(b).nameKey)],se),ue("click",V,()=>G(e(b).id.toString())),_(f,V)}),t(T),t(F);var S=r(F,2),L=a(S),K=a(L);J(K,{icon:"ph:eye-duotone",width:"20"}),Ue(),t(L);var oe=r(L,2),X=a(oe),be=a(X);{var ie=f=>{const b=se(()=>({url:E().portrait_url,description:""}));Ht(f,{get asset(){return e(b)}})},te=f=>{var b=fr(),V=a(b);J(V,{icon:"ph:user-duotone",width:"40"}),t(b),_(f,b)};A(be,f=>{E().portrait_url?f(ie):f(te,!1)})}t(X);var ce=r(X,2),H=a(ce),fe=a(H,!0);t(H);var Ee=r(H,2);{var we=f=>{var b=hr(),V=a(b,!0);t(b),M(()=>d(V,E().one_liner)),_(f,b)};A(Ee,f=>{E().one_liner&&f(we)})}var Te=r(Ee,2),$e=a(Te),C=a($e,!0);t($e);var W=r($e,2),_e=a(W);const Se=se(()=>E().visibility==="public"?"ph:globe":"ph:lock");J(_e,{get icon(){return e(Se)},width:"14"});var j=r(_e);t(W),t(Te);var y=r(Te,2);{var U=f=>{var b=gr(),V=a(b);t(b),M(()=>d(V,`"${E().greeting??""}"`)),_(f,b)};A(y,f=>{E().greeting&&f(U)})}t(ce),t(oe),t(S);var ae=r(S,2);{var pe=f=>{var b=mr(),V=a(b),ee=a(V),Pe=a(ee);J(Pe,{icon:"ph:warning-circle-duotone",width:"20"}),Ue(),t(ee);var qe=r(ee,2);He(qe,5,m,at,(me,Q)=>{var l=br(),i=a(l,!0);t(l),M(()=>d(i,e(Q))),_(me,l)}),t(qe),t(V),t(b),_(f,b)},le=f=>{var b=yr(),V=a(b),ee=a(V);J(ee,{icon:"ph:check-circle-duotone",width:"24"}),Ue(2),t(V),t(b),_(f,b)};A(ae,f=>{m().length>0?f(pe):f(le,!1)})}t(n),M(()=>{d(ne,`ìºë¦­í„°ì˜ ì¥ë¥´/ì„±ê²©ì„ ë‚˜íƒ€ë‚´ëŠ” íƒœê·¸ë¥¼ ìµœëŒ€ 3ê°œ ì„ íƒí•˜ì„¸ìš”. (${e(q)??""}/3)`),d(fe,E().name||"ì´ë¦„ ì—†ìŒ"),d(C,E().personaType||"íƒ€ì… ë¯¸ì„ íƒ"),d(j,` ${E().visibility==="public"?"ê³µê°œ":"ë¹„ê³µê°œ"}`)}),_(B,n),Ge(),re()}var wr=g('<div class="edit3-page svelte-10j21sm"><!></div> <!> <!>',1);function as(B,p){Ye(p,!1);const[de,re]=it(),v=()=>rt(Vt,"$page",de),s=()=>rt(nt,"$t",de),q=N(),E=N(),m=N();let G=N(null),n=N(_e()),F=N(0),z="",ge=N(!1),ke=!1;const ne="kintsugi_v1";let T=N("custom"),S=N(""),L=N(""),K=N(""),oe=N(""),X=N(""),be=N([]),ie=N([]),te=N(""),ce=N([]),H=N(""),fe=N(new Set),Ee=N(null),we=N(!1),Te=Mt(Ct)?.data.hasReceivedFirstCreationReward??!1,$e;const C="edit3_draft",W=["ìºë¦­í„° íƒ€ì…","ê¸°ë³¸ ì •ë³´","ë¯¸ë””ì–´ & ì—ì…‹","í”„ë¡¬í”„íŠ¸","íƒœê·¸ & ê²€í† "];function _e(){return{id:"",owner_id:[],name:"",one_liner:"",personaType:"",contentType:"character",instructions:[],promptExamples:[],tags:[],feedback:{view:0},voice_id:"",vrm_url:"",portrait_url:"",image_metadatas:[],image_count:0,visibility:"private",created_at:"",updated_at:"",creator_name:"",first_scene:"",greeting:"",likes_count:0,dislikes_count:0,chat_count:0}}function Se(l,i,u,I,Y){const O=[];return l.personaType||O.push("ìºë¦­í„° íƒ€ì…ì„ ì„ íƒí•´ì£¼ì„¸ìš”."),l.name.trim()||O.push("ìºë¦­í„° ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."),l.greeting.trim()||O.push("ì¸ì‚¬ë§ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."),l.first_scene.trim()||O.push("ì²« ì¥ë©´ì„ ì‘ì„±í•´ì£¼ì„¸ìš”."),u===I?Y.trim()||O.push("Kintsugi ì„¤ëª…(Description)ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."):i.trim()||O.push("ì§€ì‹œì‚¬í•­ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."),l.tags.filter(c=>parseInt(c)<1e3).length===0&&O.push("ì¹´í…Œê³ ë¦¬ íƒœê·¸ë¥¼ ìµœì†Œ 1ê°œ ì„ íƒí•´ì£¼ì„¸ìš”."),O}function j(l,i,u,I,Y,O){switch(l){case 0:return!!i.personaType;case 1:return!!i.name.trim()&&!!i.greeting.trim();case 2:return!0;case 3:return I===Y?!!O.trim():!!i.first_scene.trim()&&!!u.trim();case 4:return i.tags.filter(c=>parseInt(c)<1e3).length>0;default:return!0}}function y(l){o(F,l.detail.step),f()}function U(){De.warning("í•„ìˆ˜ í•­ëª©ì„ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.")}async function ae(l){try{const i=await Nt(l);if(o(G,JSON.parse(JSON.stringify(i))),i.instructions.length>1&&i.instructions[1]){const u=i.instructions[1];if(u==="conversation")o(T,"conversation"),o(S,i.instructions[0]||"");else if(u==="simulation")o(T,"simulation"),o(S,i.instructions[0]||"");else if(u===ne){o(T,ne);try{const I=JSON.parse(i.instructions[0]||"{}");o(L,I.description||""),o(K,I.personality||""),o(oe,I.userPersona||""),o(X,I.scenario||"")}catch(I){console.error("Kintsugi JSON parse failed",I),o(L,i.instructions[0]||"")}}else o(T,"custom"),o(S,i.instructions[0]||"")}else o(T,"custom"),o(S,i.instructions[0]||"");if(i.voice_id?o(H,i.voice_id):o(H,""),i.personaType==="3D"&&i.first_scene&&o(te,i.first_scene),i.image_metadatas&&i.image_metadatas.length>0){const u=await At(i.image_metadatas);i.image_metadatas=u}else i.image_metadatas=[];return i.contentType==="character"||i.contentType==="story"||(i.contentType="character"),o(n,i),e(n).one_liner||Ae(n,e(n).one_liner=""),e(n).live2d_model_url&&(e(n).personaType==="2.5D"||e(n).personaType==="2D")&&pe(e(n).live2d_model_url),i}catch(i){console.error("Failed to load persona:",i),De.error("Failed to load persona")}}async function pe(l){if(l)try{const i=await fetch(l);if(!i.ok)throw new Error("Failed to fetch model3.json");const u=await i.json();let I=[];u.FileReferences?.Expressions?I=u.FileReferences.Expressions:u.expressions&&(I=u.expressions),Array.isArray(I)&&o(be,I.map(c=>{if(typeof c=="string")return c;const h=c.Name||c.name||c.Id||c.id,$=c.File||c.file;return h||($?$.split("/").pop().replace(".exp3.json",""):"")}).filter(c=>c));let Y={};u.FileReferences?.Motions?Y=u.FileReferences.Motions:u.motions&&(Y=u.motions);const O=[];Object.values(Y).forEach(c=>{Array.isArray(c)&&c.forEach(h=>{const $=h.File||h.file;$&&O.push($)})}),o(ie,O)}catch(i){console.warn("Failed to load Live2D metadata:",i)}}async function le(){if(e(ge)||ke)return;z="";let l=[];if(e(T)===ne){if(e(L).length>1e3){z=s()("editPage.validation.kintsugiDescLimit"),De.error(z);return}const i=JSON.stringify({description:e(L),personality:e(K),userPersona:e(oe),scenario:e(X)});l.push(i)}else{if(l.push(e(S)),e(S).length>3e3){z=s()("editPage.validation.instructionsLimitExceeded"),De.error(z);return}if(!e(S).trim()){z=s()("editPage.validation.allFieldsRequired"),De.error(z);return}}if(e(T)==="conversation"?l.push("conversation"):e(T)==="simulation"?l.push("simulation"):e(T)===ne?l.push(ne):l.push("custom"),Ae(n,e(n).instructions=l),!e(n).name.trim()||!e(n).personaType.trim()||!e(n).greeting.trim()||!e(n).first_scene.trim()||e(n).tags.length===0){z=s()("editPage.validation.allFieldsRequired"),De.error(z);return}if(e(n).greeting.length>200||e(n).first_scene.length>2500){z=s()("editPage.validation.charLimitExceeded"),De.error(z);return}if(e(n).promptExamples.some(i=>i.length>200)||e(n).promptExamples.length>10){z=s()("editPage.validation.promptExamplesLimitExceeded"),De.error(z);return}o(ge,!0);try{const i=await Jt(e(n));if(i){if(!e(n).id&&e(fe).size>0)try{await Promise.all(Array.from(e(fe)).map(u=>et.linkPersona(i,u,!1)))}catch(u){console.error("Failed to link lorebooks",u)}ke=!0,De.success("ì €ì¥ ì™„ë£Œ!"),V(),setTimeout(()=>ke=!1,2e3),e(n).id?ae(i):(bt(`/edit3?c=${i}`,{replaceState:!0}),Te&&(o(we,!0),Te=!1))}}catch(i){z=s()("editPage.errorSaveFailed",{values:{message:i.message}}),De.error(z)}finally{o(ge,!1)}}function f(){if(!e(n).id)try{const l={persona:e(n),selectedTemplate:e(T),singleInstruction:e(S),k_description:e(L),k_personality:e(K),k_userPersona:e(oe),k_scenario:e(X),firstSceneJson:e(te),selectedVoiceId:e(H),currentStep:e(F),savedAt:Date.now()};localStorage.setItem(C,JSON.stringify(l))}catch{}}function b(){try{const l=localStorage.getItem(C);if(!l)return!1;const i=JSON.parse(l);return Date.now()-i.savedAt>24*60*60*1e3?(V(),!1):(o(n,{..._e(),...i.persona}),o(T,i.selectedTemplate||"custom"),o(S,i.singleInstruction||""),o(L,i.k_description||""),o(K,i.k_personality||""),o(oe,i.k_userPersona||""),o(X,i.k_scenario||""),o(te,i.firstSceneJson||""),o(H,i.selectedVoiceId||""),o(F,i.currentStep||0),!0)}catch{return!1}}function V(){localStorage.removeItem(C)}ct(async()=>{if(!await ze.isLoggedIn()){bt("/login");return}try{const i=await fetch("/voices2.json");if(i.ok){const u=await i.json();o(ce,u.items)}}catch(i){console.error("Failed to load voices.json",i)}v().url.searchParams.get("c")||b()&&De.info("ì´ì „ì— ì‘ì„± ì¤‘ì´ë˜ ìºë¦­í„°ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤."),$e=setInterval(f,3e4)}),ht(()=>{$e&&clearInterval($e)}),We(()=>(e(ce),e(H)),()=>{o(q,e(ce).find(l=>l._id===e(H)))}),We(()=>e(H),()=>{e(H)?Ae(n,e(n).voice_id=e(H)):Ae(n,e(n).voice_id="")}),We(()=>e(n),()=>{e(n).contentType==="story"&&Ae(n,e(n).personaType="2D")}),We(()=>(e(n),e(S),e(T),e(L)),()=>{o(E,Se(e(n),e(S),e(T),ne,e(L)))}),We(()=>(e(F),e(n),e(S),e(T),e(L)),()=>{o(m,j(e(F),e(n),e(S),e(T),ne,e(L)))}),We(()=>(v(),e(Ee),e(n)),()=>{const l=v().url.searchParams.get("c");l&&l!==e(Ee)&&(o(Ee,l),l!==e(n).id&&ae(l))}),pt(),Qe();var ee=wr(),Pe=Re(ee),qe=a(Pe);fa(qe,{get currentStep(){return e(F)},totalSteps:5,get stepLabels(){return W},get canProceed(){return e(m)},get isSaving(){return e(ge)},$$events:{stepChange:y,validationFail:U,save:le},children:(l,i)=>{var u=_t(),I=Re(u);{var Y=c=>{ka(c,{get persona(){return e(n)},set persona(h){o(n,h)},$$legacy:!0})},O=(c,h)=>{{var $=w=>{xt(w,{get persona(){return e(n)},set persona(x){o(n,x)},$$legacy:!0})},k=(w,x)=>{{var P=R=>{Pt(R,{get originalPersona(){return e(G)},get allVoices(){return e(ce)},get persona(){return e(n)},set persona(D){o(n,D)},get selectedVoiceId(){return e(H)},set selectedVoiceId(D){o(H,D)},$$events:{metadataLoaded:D=>{o(be,D.detail.expressions),o(ie,D.detail.motions)}},$$legacy:!0})},Z=(R,D)=>{{var ve=xe=>{qt(xe,{get availableExpressions(){return e(be)},get availableMotions(){return e(ie)},kintsugiTemplateId:ne,get persona(){return e(n)},set persona(he){o(n,he)},get selectedTemplate(){return e(T)},set selectedTemplate(he){o(T,he)},get singleInstruction(){return e(S)},set singleInstruction(he){o(S,he)},get k_description(){return e(L)},set k_description(he){o(L,he)},get k_personality(){return e(K)},set k_personality(he){o(K,he)},get k_userPersona(){return e(oe)},set k_userPersona(he){o(oe,he)},get k_scenario(){return e(X)},set k_scenario(he){o(X,he)},get firstSceneJson(){return e(te)},set firstSceneJson(he){o(te,he)},get pendingLoreLinks(){return e(fe)},set pendingLoreLinks(he){o(fe,he)},$$legacy:!0})},Ie=(xe,he)=>{{var Je=Me=>{Et(Me,{get validationErrors(){return e(E)},get persona(){return e(n)},set persona(Be){o(n,Be)},$$legacy:!0})};A(xe,Me=>{e(F)===4&&Me(Je)},he)}};A(R,xe=>{e(F)===3?xe(ve):xe(Ie,!1)},D)}};A(w,R=>{e(F)===2?R(P):R(Z,!1)},x)}};A(c,w=>{e(F)===1?w($):w(k,!1)},h)}};A(I,c=>{e(F)===0?c(Y):c(O,!1)})}_(l,u)},$$slots:{default:!0,next:(l,i)=>{var u=_t(),I=Re(u);{var Y=c=>{xt(c,{get persona(){return e(n)},set persona(h){o(n,h)},$$legacy:!0})},O=(c,h)=>{{var $=w=>{Pt(w,{get originalPersona(){return e(G)},get allVoices(){return e(ce)},get persona(){return e(n)},set persona(x){o(n,x)},get selectedVoiceId(){return e(H)},set selectedVoiceId(x){o(H,x)},$$events:{metadataLoaded:x=>{o(be,x.detail.expressions),o(ie,x.detail.motions)}},$$legacy:!0})},k=(w,x)=>{{var P=R=>{qt(R,{get availableExpressions(){return e(be)},get availableMotions(){return e(ie)},kintsugiTemplateId:ne,get persona(){return e(n)},set persona(D){o(n,D)},get selectedTemplate(){return e(T)},set selectedTemplate(D){o(T,D)},get singleInstruction(){return e(S)},set singleInstruction(D){o(S,D)},get k_description(){return e(L)},set k_description(D){o(L,D)},get k_personality(){return e(K)},set k_personality(D){o(K,D)},get k_userPersona(){return e(oe)},set k_userPersona(D){o(oe,D)},get k_scenario(){return e(X)},set k_scenario(D){o(X,D)},get firstSceneJson(){return e(te)},set firstSceneJson(D){o(te,D)},get pendingLoreLinks(){return e(fe)},set pendingLoreLinks(D){o(fe,D)},$$legacy:!0})},Z=(R,D)=>{{var ve=Ie=>{Et(Ie,{get validationErrors(){return e(E)},get persona(){return e(n)},set persona(xe){o(n,xe)},$$legacy:!0})};A(R,Ie=>{e(F)+1===4&&Ie(ve)},D)}};A(w,R=>{e(F)+1===3?R(P):R(Z,!1)},x)}};A(c,w=>{e(F)+1===2?w($):w(k,!1)},h)}};A(I,c=>{e(F)+1===1?c(Y):c(O,!1)})}_(l,u)}}}),t(Pe);var me=r(Pe,2);Ot(me,{get isOpen(){return e(ge)}});var Q=r(me,2);zt(Q,{get isOpen(){return e(we)},set isOpen(l){o(we,l)},$$legacy:!0}),_(B,ee),Ge(),re()}export{as as component};
