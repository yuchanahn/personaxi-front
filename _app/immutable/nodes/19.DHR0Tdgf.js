import{d as V,b as X,e as us}from"../chunks/kz80bbCR.js";import{i as Wt}from"../chunks/2r1cYJse.js";import{c as hs,o as $t,a as Et}from"../chunks/D0mpzbhj.js";import{w as Zt,V as o,W as y,Q as e,aD as D,aq as pe,ao as Fe,ar as qt,al as v,ap as h,am as f,aj as ge,O as Ge,z as Qt,an as vt,as as Jt}from"../chunks/BUDlkbfV.js";import{i as Te}from"../chunks/28pso2Hb.js";import{a as gs,s as Rt,b as bt,r as at,e as ps,d as fs}from"../chunks/BJyhluUY.js";import{b as es}from"../chunks/CGc6l0L7.js";import{s as ms,a as Re,b as vs}from"../chunks/D32zTIdM.js";import{s as ie}from"../chunks/BbnaKca8.js";import{e as Ke,i as je}from"../chunks/BOGOvxWJ.js";import{e as O}from"../chunks/CiCNsvIE.js";import{b as Gt}from"../chunks/njKOc8Q7.js";import{b as _e}from"../chunks/CAWQASXy.js";import{p as $}from"../chunks/Bf5_DoVm.js";import{I as Xt}from"../chunks/DaDtKPX8.js";import{t as ts}from"../chunks/sXlFIKQv.js";import{d as zt,c as ys,C as Es,T as Ut,S as bs}from"../chunks/CymZ0rla.js";import{m as Vt,l as _s,s as Ts,C as Ms,a as Ss}from"../chunks/-q0Oa4Q3.js";import{p as xs}from"../chunks/dMfnY97A.js";import{l as Kt}from"../chunks/Caezn3U5.js";import{t as Ps}from"../chunks/2yqvXdGA.js";import{s as ks}from"../chunks/3azsccOw.js";import{p as ws}from"../chunks/Do-RpF6d.js";import{c as Os}from"../chunks/CmEqjr1-.js";import{s as Ds}from"../chunks/IXAamO68.js";const Is=["https://cubism.live2d.com/sdk-web/cubismcore/live2dcubismcore.min.js","https://cdn.jsdelivr.net/gh/dylanNew/live2d/webgl/Live2D/lib/live2d.min.js","https://cdn.jsdelivr.net/npm/pixi.js@7/dist/pixi.min.js","https://cdn.jsdelivr.net/gh/RaSan147/pixi-live2d-display@v0.5.0-ls-8/dist/index.min.js"];let jt=!1;function Ls(Z){return new Promise((t,s)=>{if(document.querySelector(`script[src="${Z}"]`)){t();return}const p=document.createElement("script");p.src=Z,p.onload=()=>t(),p.onerror=()=>s(new Error(`Failed to load script: ${Z}`)),document.head.appendChild(p)})}async function As(){if(!jt){for(const Z of Is)await Ls(Z);await Cs(),jt=!0}}function Cs(){return new Promise(Z=>{const t=()=>{typeof window.PIXI<"u"&&typeof window.PIXI.live2d<"u"&&typeof window.Live2D<"u"&&typeof window.Live2D.init=="function"&&typeof window.Live2DCubismCore<"u"?Z():setTimeout(t,50)};t()})}class yt{static _context=null;static _audio=null;static _source=null;static _analyser=null;static _gain=null;static _isInit=!1;static init(){if(!(this._isInit&&this._context?.state==="running"))try{if(!this._context){const t=window.AudioContext||window.webkitAudioContext;this._context=new t,this._audio=new Audio,this._audio.crossOrigin="anonymous",this._audio.preload="auto",this._gain=this._context.createGain(),this._gain.connect(this._context.destination),this._analyser=this._context.createAnalyser(),this._analyser.fftSize=256,this._analyser.minDecibels=-90,this._analyser.maxDecibels=-10,this._analyser.smoothingTimeConstant=.85,this._analyser.connect(this._gain),this._source=this._context.createMediaElementSource(this._audio),this._source.connect(this._analyser),console.log("üîä SafeAudioManager Initialized (Singleton)")}this._context.state==="suspended"&&this._context.resume().then(()=>{console.log("üîä AudioContext Resumed!")}),this._isInit=!0}catch(t){console.error("‚ùå SafeAudioManager Init Failed:",t)}}static async speak(t,s,p={}){if(this.init(),!this._context||!this._audio||!this._gain||!this._analyser)return console.error("‚ùå Audio System not ready. Call init() on user click."),p.onError?.(new Error("Audio System not ready")),!1;const{volume:l=.5,expression:E,resetExpression:P=!1,onFinish:Y,onError:ae}=p;if(this._gain.gain.value=l,this._audio.pause(),this._audio.src=s,this._audio.currentTime=0,t&&t.internalModel&&t.internalModel.motionManager){const H=t.internalModel.motionManager;H.currentAudio=this._audio,H.currentContext=this._context,H.currentAnalyzer=this._analyser}return E&&t.expression&&t.expression(E),new Promise(H=>{if(!this._audio)return H(!1);const N=()=>{z(),P&&t.internalModel?.motionManager?.expressionManager&&t.internalModel.motionManager.expressionManager.resetExpression(),Y?.()},I=m=>{z(),console.error("Audio Playback Error:",m),ae?.(new Error("Audio Playback Error")),H(!1)},z=()=>{this._audio?.removeEventListener("ended",N),this._audio?.removeEventListener("error",I)};this._audio.addEventListener("ended",N),this._audio.addEventListener("error",I),this._audio.play().then(()=>{H(!0)}).catch(m=>{console.warn("Autoplay blocked or interrupted:",m),z(),ts.error("ÌôîÎ©¥ÏùÑ ÌÑ∞ÏπòÌï¥Ï£ºÏÑ∏Ïöî (Audio Blocked)"),ae?.(new Error("Audio Blocked")),H(!1)})})}static getLipSyncValue(){if(!this._analyser)return 0;const t=new Float32Array(this._analyser.fftSize);this._analyser.getFloatTimeDomainData(t);let s=0;for(const p of t)s+=p*p;return parseFloat(Math.sqrt(s/t.length*20).toFixed(1))}static stop(){this._audio&&(this._audio.pause(),this._audio.currentTime=0)}}class Ys{sensitivity=1;model;app;ticker=null;dragTargetX=0;dragTargetY=0;dragPhysicsX=0;dragPhysicsY=0;currentBodyX=0;currentBodyY=0;bodyVol=0;blinkState="OPEN";nextBlinkTime=0;blinkOpenValue=1;blinkValue=1;blinkDuration=150;blinkTimer=0;gazeTargetX=0;gazeTargetY=0;gazeCurrentX=0;gazeCurrentY=0;saccadeOffsetX=0;saccadeOffsetY=0;nextSaccadeTime=0;idleTargetHeadX=0;idleTargetHeadY=0;idleTargetHeadZ=0;idleEyeOpenMax=1;nextIdleMoveTime=0;nextGazeMoveTime=0;isGesturePlaying=!1;gestureStartTime=0;gestureDuration=0;currentGesture=null;isSpeaking=!1;setSpeaking(t){this.isSpeaking=t,console.log(`üó£Ô∏è Speaking State: ${t}`)}currentEmotion="CALM";emotionConfigs={ELATED:{headYOffset:8,motionSpeed:.15,eyeOpenMin:1,breathRate:2,idleIntervalMin:500},GENTLE:{headYOffset:2,motionSpeed:.06,eyeOpenMin:.9,breathRate:1,idleIntervalMin:1200},STERN:{headYOffset:-3,motionSpeed:.07,eyeOpenMin:.4,breathRate:1.3,idleIntervalMin:100},DEPRESSED:{headYOffset:-12,motionSpeed:.02,eyeOpenMin:.5,breathRate:.5,idleIntervalMin:3e3},TENSE:{headYOffset:-2,motionSpeed:.1,eyeOpenMin:1.1,breathRate:2.2,idleIntervalMin:600},ASTONISHED:{headYOffset:10,motionSpeed:.18,eyeOpenMin:1.5,breathRate:.3,idleIntervalMin:3500},SLEEP:{headYOffset:-2,motionSpeed:.02,eyeOpenMin:0,breathRate:.3,idleIntervalMin:999999},CALM:{headYOffset:0,motionSpeed:.04,eyeOpenMin:.8,breathRate:.8,idleIntervalMin:2e3}};activeConfig=this.emotionConfigs.CALM;paramIndices={};currentHeadZ=0;voiceEnv=0;SleepTimer=null;StopSleepTimer=()=>{this.SleepTimer&&clearTimeout(this.SleepTimer)};StartSleepTimer=()=>{this.StopSleepTimer(),this.SleepTimer=setTimeout(()=>{this.setEmotion("SLEEP")},1e3*60*3)};constructor(t,s,p=1){this.model=t,this.app=s,this.sensitivity=this.clamp(p,.1,2),this.cacheParamIndices(),this.scheduleNextBlink(),this.scheduleNextSaccade(),console.log(`ü§ñ Autonomy Initialized (Sensitivity: ${this.sensitivity}x)`)}start(){this.ticker||(this.ticker=t=>{let s=this.app.ticker.deltaMS;(!s||isNaN(s))&&(s=16.6),this.update(s)},this.app.ticker.add(this.ticker,null,0),console.log("ü§ñ Live2D Autonomy Enhanced Started"),this.StartSleepTimer())}stop(){this.ticker&&(this.app.ticker.remove(this.ticker),this.ticker=null),this.StopSleepTimer()}setSensitivity(t){this.sensitivity=this.clamp(t,.1,2),console.log(`‚öôÔ∏è Sensitivity changed to ${this.sensitivity}x`)}playGesture(t){if(!this.isGesturePlaying)switch(console.log(`üé≠ Playing Gesture: ${t}`),this.currentGesture=t,this.isGesturePlaying=!0,this.gestureStartTime=Date.now(),t){case"NOD":this.gestureDuration=800;break;case"SHAKE":this.gestureDuration=1200;break;case"TILT":this.gestureDuration=600;break;case"FIDGET":this.gestureDuration=2e3;break;case"SIGH":this.gestureDuration=1500;break;case"LOOK_DOWN":this.gestureDuration=1e3;break;case"CLOSE_EYES":this.gestureDuration=2e3;break;case"WINK":this.gestureDuration=1e3;break;case"PUFF_CHEEKS":this.gestureDuration=800;break;case"STICK_TONGUE":this.gestureDuration=600;break;case"SQUINT":this.gestureDuration=700;break;case"ROLL_EYES":this.gestureDuration=1200;break;case"LOOK_UP_THINK":this.gestureDuration=1500;break;case"FLINCH":this.gestureDuration=300;break;case"PANT":this.gestureDuration=3e3;break;case"WAKE_UP":this.gestureDuration=2500;break}}onEmotionChange=null;WakeUp(){this.isSleeping()&&this.setEmotion("CALM")}isSleeping(){return this.currentEmotion==="SLEEP"}setEmotion(t){this.currentEmotion!==t&&(console.log(`ü§ñ Emotion Changed: ${this.currentEmotion} -> ${t}`),this.currentEmotion==="SLEEP"&&t!=="SLEEP"&&(console.log("üåÖ Waking Up!"),this.playGesture("WAKE_UP")),this.currentEmotion=t,this.activeConfig=this.emotionConfigs[t],this.onEmotionChange&&this.onEmotionChange(t),this.nextIdleMoveTime=Date.now(),(t==="ELATED"||t==="STERN")&&(this.blinkState="OPEN",this.blinkValue=1,this.nextBlinkTime=Date.now()+2e3),this.StartSleepTimer())}handleDrag(t,s){const p=(t-this.dragTargetX)*20,l=(s-this.dragTargetY)*20;this.dragPhysicsX+=p,this.dragPhysicsY+=l,this.dragPhysicsX=this.clamp(this.dragPhysicsX,-30,30),this.dragPhysicsY=this.clamp(this.dragPhysicsY,-30,30),this.dragTargetX=t,this.dragTargetY=s}update(t){if(!this.model||!this.model.internalModel)return;const s=this.model.internalModel,l=s.coreModel._parameterValues;this.updateBlinking(t,l),this.updateBreathing(t,l),this.updateSaccades(t),this.updateGestures(t),this.updatePhysics(t,l,s)}updateSaccades(t){const s=Date.now();s>=this.nextSaccadeTime&&(this.saccadeOffsetX=(Math.random()-.5)*.08*this.sensitivity,this.saccadeOffsetY=(Math.random()-.5)*.06*this.sensitivity,this.nextSaccadeTime=s+50+Math.random()*250),this.saccadeOffsetX*=.85,this.saccadeOffsetY*=.85}updateGestures(t){if(!this.isGesturePlaying||!this.currentGesture)return;const p=Date.now()-this.gestureStartTime,l=Math.min(p/this.gestureDuration,1);switch(this.currentGesture){case"NOD":this.gestureNod(l);break;case"SHAKE":this.gestureShake(l);break;case"TILT":this.gestureTilt(l);break;case"FIDGET":this.gestureFidget(l);break;case"SIGH":this.gestureSigh(l);break;case"LOOK_DOWN":this.gestureLookDown(l);break;case"CLOSE_EYES":this.gestureCloseEyes(l);break;case"WINK":this.gestureWink(l);break;case"PUFF_CHEEKS":this.gesturePuffCheeks(l);break;case"STICK_TONGUE":this.gestureStickTongue(l);break;case"SQUINT":this.gestureSquint(l);break;case"ROLL_EYES":this.gestureRollEyes(l);break;case"LOOK_UP_THINK":this.gestureLookUpThink(l);break;case"FLINCH":this.gestureFlinch(l);break;case"PANT":this.gesturePant(l);break;case"WAKE_UP":this.gestureWakeUp(l);break}l>=1&&(this.isGesturePlaying=!1,this.currentGesture=null,console.log("üé≠ Gesture Finished"))}gestureNod(t){const s=Math.sin(t*Math.PI*5)*30*this.sensitivity;this.idleTargetHeadY=s,this.idleTargetHeadX=0,this.idleTargetHeadZ=0}gestureShake(t){const s=Math.sin(t*Math.PI*4)*35*this.sensitivity;this.idleTargetHeadX=s,this.idleTargetHeadY=0,this.idleTargetHeadZ=-s*.3}gestureTilt(t){const s=t<.5?16*t*t*t*t*t:1-Math.pow(-2*t+2,5)/2;this.idleTargetHeadZ=Math.sin(s*Math.PI/2)*40*this.sensitivity,this.idleTargetHeadX=Math.sin(s*Math.PI/2)*15*this.sensitivity,this.idleTargetHeadY=8*this.sensitivity}gestureFidget(t){Math.random()<.1&&(this.gazeTargetX=(Math.random()-.5)*2.5*this.sensitivity,this.gazeTargetY=(Math.random()-.5)*2*this.sensitivity,this.idleTargetHeadX=(Math.random()-.5)*40*this.sensitivity,this.idleTargetHeadY=(Math.random()-.5)*20*this.sensitivity)}gestureMouthOpen=0;gestureSigh(t){this.idleTargetHeadY=Math.sin(t*Math.PI)*-15,this.gestureMouthOpen=Math.sin(t*Math.PI)*.4}gestureLookDown(t){const s=Math.sin(t*Math.PI);this.gazeTargetY=-1.5*s*this.sensitivity,this.idleEyeOpenMax=.7*(1-s*.3)}gestureCloseEyes(t){const s=t<.5?t*2:(1-t)*2;this.blinkValue=1-Math.sin(s*Math.PI/2)}gestureWink(t){this.setParamOverride("ParamEyeROpen",t<.5?0:1)}gesturePuffCheeks(t){const s=Math.sin(t*Math.PI);this.setParamOverride("ParamCheek",s*1*this.sensitivity),this.setParamOverride("ParamMouthOpenY",s*.5)}gestureStickTongue(t){const s=Math.sin(t*Math.PI);this.setParamOverride("ParamTongue",s*1*this.sensitivity),this.setParamOverride("ParamMouthOpenY",s*.8)}gestureSquint(t){const s=Math.sin(t*Math.PI);this.idleEyeOpenMax=.6+s*.4,this.setParamOverride("ParamBrowLY",-s*.5)}gestureRollEyes(t){const s=t*Math.PI*2;this.gazeTargetX=Math.cos(s)*1.5*this.sensitivity,this.gazeTargetY=Math.sin(s)*1.5*this.sensitivity}gestureLookUpThink(t){const s=Math.sin(t*Math.PI);this.gazeTargetY=1.2*s*this.sensitivity,this.gazeTargetX=(Math.random()-.5)*.5*s,this.idleTargetHeadY=15*s*this.sensitivity}gestureFlinch(t){const s=Math.pow(1-t,2)*20*this.sensitivity;this.idleTargetHeadY=-s,this.blinkValue=t<.5?0:1}gesturePant(t){const p=(Math.sin(t*Math.PI*2*7.2)+1)*.5;this.idleTargetHeadY=p*50*this.sensitivity,this.idleTargetHeadX=0,this.idleTargetHeadZ=p*10*this.sensitivity}gestureWakeUp(t){if(t<.7){const s=Math.sin(t/.7*Math.PI);this.idleTargetHeadY=15*s*this.sensitivity,this.idleTargetHeadZ=-5*s,this.setParamOverride("ParamMouthOpenY",.6*s);const p=Math.min(1,t/.5);this.idleEyeOpenMax=.2+p*.8}else{const s=(t-.7)/.3,p=Math.sin(s*Math.PI*4);this.blinkValue=p>.8?0:1,this.idleTargetHeadY=0,this.idleEyeOpenMax=1}}updateBlinking(t,s){const p=Date.now();switch(this.blinkState){case"OPEN":p>=this.nextBlinkTime&&(this.blinkState="CLOSING",this.blinkTimer=0);break;case"CLOSING":this.blinkTimer+=t;const l=this.blinkTimer/(this.blinkDuration*.4);l>=1?(this.blinkValue=0,this.blinkState="CLOSED",this.blinkTimer=0):this.blinkValue=1-l;break;case"CLOSED":this.blinkTimer+=t,this.blinkTimer>50&&(this.blinkState="OPENING",this.blinkTimer=0);break;case"OPENING":this.blinkTimer+=t;const E=this.blinkTimer/(this.blinkDuration*.6);E>=1?(this.blinkValue=1,this.blinkState="OPEN",this.scheduleNextBlink()):this.blinkValue=E;break}}setBreathOverride=null;updateBreathing(t,s){const p=Date.now()/1e3;let l=(Math.sin(p*1.5*this.activeConfig.breathRate)+1)*.5;this.setBreathOverride!==null&&(l=this.setBreathOverride,this.isGesturePlaying||(this.setBreathOverride=null)),this.setParam(s,"ParamBreath",l)}updatePhysics(t,s,p){const l=Date.now(),E=this.activeConfig;if(p.motionManager&&typeof p.motionManager.mouthSync=="function"&&(this.bodyVol=p.motionManager.mouthSync()),!this.isGesturePlaying&&l>=this.nextIdleMoveTime){const L=Math.random();L<.4?(this.idleTargetHeadX=(Math.random()-.5)*60*this.sensitivity,this.idleTargetHeadY=(Math.random()-.5)*10*this.sensitivity+E.headYOffset,this.idleTargetHeadZ=-this.idleTargetHeadX*.2):L<.6?(this.idleTargetHeadX=0,this.idleTargetHeadY=(Math.random()-.5)*20*this.sensitivity+E.headYOffset,this.idleTargetHeadZ=0):(this.idleTargetHeadX=(Math.random()-.5)*5*this.sensitivity,this.idleTargetHeadY=(Math.random()-.5)*5*this.sensitivity+E.headYOffset,this.idleTargetHeadZ=0),E.eyeOpenMin>=1?this.idleEyeOpenMax=E.eyeOpenMin:this.idleEyeOpenMax=Math.random()<.3?E.eyeOpenMin:1,this.nextIdleMoveTime=l+E.idleIntervalMin+Math.random()*2e3}this.currentEmotion!=="SLEEP"&&this.currentGesture!=="FIDGET"&&this.currentGesture!=="ROLL_EYES"&&this.currentGesture!=="LOOK_UP_THINK"&&l>=this.nextGazeMoveTime?(this.gazeTargetX=(Math.random()-.5)*2*this.sensitivity,this.gazeTargetY=(Math.random()-.5)*1.5*this.sensitivity,this.nextGazeMoveTime=l+200+Math.random()*1300):this.currentEmotion==="SLEEP"&&(this.gazeTargetX=0,this.gazeTargetY=0);const P=E.motionSpeed,Y=this.isSpeaking?.6:1,ae=this.idleTargetHeadX*Y,H=this.idleTargetHeadY*Y,N=this.idleTargetHeadZ*Y;this.currentBodyX+=(ae-this.currentBodyX)*P,this.currentBodyY+=(H-this.currentBodyY)*P,this.currentHeadZ+=(N-this.currentHeadZ)*P;const I=this.isSpeaking?this.gazeTargetX*.3:this.gazeTargetX,z=this.isSpeaking?this.gazeTargetY*.3:this.gazeTargetY;this.gazeCurrentX+=(I-this.gazeCurrentX)*.3,this.gazeCurrentY+=(z-this.gazeCurrentY)*.3,this.blinkOpenValue+=(this.idleEyeOpenMax-this.blinkOpenValue)*.1;const m=this.clamp(this.bodyVol??0,0,1),M=.06,ne=m<=M?0:(m-M)/(1-M),x=60,u=180,Q=1-Math.exp(-t/x),fe=1-Math.exp(-t/u),K=ne,n=K>this.voiceEnv?Q:fe;this.voiceEnv+=(K-this.voiceEnv)*n;let A=6*this.sensitivity;this.currentEmotion==="ELATED"&&(A=5*this.sensitivity),this.currentEmotion==="DEPRESSED"&&(A=2*this.sensitivity),this.currentEmotion==="STERN"&&(A=3*this.sensitivity),this.currentEmotion==="ASTONISHED"&&(A=6*this.sensitivity),this.currentEmotion==="GENTLE"&&(A=4*this.sensitivity),this.currentEmotion==="TENSE"&&(A=3.5*this.sensitivity);const U=this.clamp(this.voiceEnv*A,0,A),re=this.blinkValue*this.blinkOpenValue;this.setParam(s,"ParamEyeLOpen",this.getParamOverride("ParamEyeLOpen",re)),this.setParam(s,"ParamEyeROpen",this.getParamOverride("ParamEyeROpen",re)),this.setParam(s,"ParamEyeBallX",this.gazeCurrentX+this.saccadeOffsetX),this.setParam(s,"ParamEyeBallY",this.gazeCurrentY+this.saccadeOffsetY);const me=this.dragTargetX*70*this.sensitivity,Me=this.dragTargetY*60*this.sensitivity,oe=this.currentBodyX+me,ye=this.currentBodyY+Me+U*.35,J=this.currentHeadZ+me*-.2;this.setParam(s,"ParamAngleX",oe),this.setParam(s,"ParamAngleY",ye),this.setParam(s,"ParamAngleZ",J);const le=(this.currentBodyX+me)*.5,ve=(this.currentBodyY+Me)*.5+U,ee=(this.currentBodyX+me)*.2;this.setParam(s,"ParamBodyAngleX",le),this.setParam(s,"ParamBodyAngleY",ve),this.setParam(s,"ParamBodyAngleZ",ee),this.applyParamOverrides(s),this.isGesturePlaying&&this.setParam(s,"ParamMouthOpenY",this.gestureMouthOpen),this.applySpeakingExpressions(s),this.currentEmotion==="SLEEP"&&(this.setParam(s,"ParamEyeLOpen",0),this.setParam(s,"ParamEyeROpen",0),this.setParam(s,"ParamEyeBallX",0),this.setParam(s,"ParamEyeBallY",0))}paramOverrides={};setParamOverride(t,s){this.paramOverrides[t]=s}getParamOverride(t,s){return this.paramOverrides[t]!==void 0?this.paramOverrides[t]:s}applyParamOverrides(t){for(const[s,p]of Object.entries(this.paramOverrides))this.setParam(t,s,p);this.isGesturePlaying||(this.paramOverrides={})}applySpeakingExpressions(t){if(this.voiceEnv>.1){const s=Math.min(this.voiceEnv*1.5,1),p=this.blinkValue*this.blinkOpenValue;let l=1,E=0,P=0;switch(this.currentEmotion){case"ELATED":l=1+s*.1,E=s*.5,P=s*.2;break;case"GENTLE":l=1-s*.1,E=-s*.2,P=s*.1;break;case"STERN":l=1-s*.25,E=-s*.8,P=s*.05;break;case"DEPRESSED":l=1-s*.3,E=-s*.4,P=s*.05;break;case"TENSE":l=1+s*.05,E=-s*.6,P=s*.1;break;case"ASTONISHED":l=1+s*.2,E=s*.7,P=s*.3;break;case"CALM":l=1-s*.15,E=0,P=0;break}const Y=p*this.clamp(l,.5,1.5);this.setParam(t,"ParamEyeLOpen",this.getParamOverride("ParamEyeLOpen",Y)),this.setParam(t,"ParamEyeROpen",this.getParamOverride("ParamEyeROpen",Y)),this.setParam(t,"ParamBrowLY",E),this.setParam(t,"ParamBrowRY",E);const ae=this.getParamOverride("ParamMouthOpenY",0);this.setParam(t,"ParamMouthOpenY",ae+P)}}scheduleNextBlink(){this.nextBlinkTime=Date.now()+2e3+Math.random()*4e3,Math.random()<.1&&(this.nextBlinkTime=Date.now()+150+Math.random()*100)}scheduleNextSaccade(){this.nextSaccadeTime=Date.now()+50+Math.random()*250}cacheParamIndices(){if(!this.model||!this.model.internalModel)return;const s=this.model.internalModel.coreModel._parameterIds,p=["ParamAngleX","ParamAngleY","ParamAngleZ","ParamBodyAngleX","ParamBodyAngleY","ParamBodyAngleZ","ParamEyeLOpen","ParamEyeROpen","ParamBreath","ParamEyeBallX","ParamEyeBallY","ParamMouthOpenY","ParamMouthForm","ParamCheek","ParamTongue","ParamBrowLY","ParamBrowRY"],l={ParamBodyAngleX:["ParamBodyX"],ParamBodyAngleY:["ParamBodyY","ParamBodyAngle"],ParamBodyAngleZ:["ParamBodyZ"],ParamMouthOpenY:["ParamMouthOpen"],ParamCheek:["ParamCheekPuff"],ParamTongue:["ParamTongueOut"],ParamBrowLY:["ParamBrowL","ParamBrowY"],ParamBrowRY:["ParamBrowR"]};p.forEach(E=>{let P=s.indexOf(E);if(P===-1&&l[E]){for(const Y of l[E])if(P=s.indexOf(Y),P!==-1)break}this.paramIndices[E]=P}),console.log("ü§ñ Autonomy Parameter Map:",this.paramIndices)}setParam(t,s,p){const l=this.paramIndices[s];l!==void 0&&l!==-1&&typeof p=="number"&&isFinite(p)&&(t[l]=p)}clamp(t,s,p){return Math.min(Math.max(t,s),p)}}var Ns=V('<img alt="background" class="live2d-bg svelte-lp18cf" draggable="false"/>'),Fs=V('<div class="hand-cursor svelte-lp18cf"><!></div>'),Hs=V('<div class="model-loader svelte-lp18cf"><div class="loader-content svelte-lp18cf"><!> <span class="loading-text svelte-lp18cf">Live2D Î™®Îç∏ Î°úÎî© Ï§ë...</span> <small class="loading-hint svelte-lp18cf">Loading...</small></div></div>'),Bs=V('<button class="list-item clickable svelte-lp18cf"> </button>'),Rs=V('<button class="list-item clickable svelte-lp18cf" style="flex: 1; text-align: center; border: 1px solid #00AAFF; border-radius: 4px; font-size: 11px;"> </button>'),Gs=V('<button class="list-item sub-item clickable svelte-lp18cf"><span class="motion-index svelte-lp18cf"></span> <span class="motion-name svelte-lp18cf"> </span></button>'),Xs=V('<div class="group-container svelte-lp18cf"><button class="group-header clickable svelte-lp18cf"><span class="group-name svelte-lp18cf"> </span> <span class="play-icon svelte-lp18cf">‚ñ∂</span></button> <!></div>'),zs=V('<button class="list-item clickable svelte-lp18cf"> </button>'),Us=V('<div class="info-section svelte-lp18cf"><strong class="svelte-lp18cf"> </strong> <div class="scroll-list svelte-lp18cf"></div></div>'),Vs=V('<div class="debug-panel svelte-lp18cf"><h3 class="svelte-lp18cf">üé≠ Live2D Debug</h3> <div class="controls-row svelte-lp18cf"><button class="stop-btn reset-btn svelte-lp18cf">üîÑ Reset Model</button></div> <div class="info-item svelte-lp18cf"><strong class="svelte-lp18cf">Model:</strong> <span class="break-all svelte-lp18cf"> </span></div> <div class="info-item svelte-lp18cf"><strong class="svelte-lp18cf">Emotion Input:</strong> <span class="highlight svelte-lp18cf"> </span></div> <div class="info-item svelte-lp18cf"><strong class="svelte-lp18cf">Expression:</strong> <span class="highlight svelte-lp18cf"> </span></div> <div class="info-item svelte-lp18cf"><strong class="svelte-lp18cf">Last Motion:</strong> <span class="highlight svelte-lp18cf"> </span></div> <div class="debug-control-group svelte-lp18cf"><div class="slider-row svelte-lp18cf"><label for="autonomySensitivity" class="svelte-lp18cf"><span class="svelte-lp18cf">Sensitivity</span> <span class="svelte-lp18cf"> </span></label> <input id="autonomySensitivity" type="range" min="0.1" max="2.0" step="0.1" class="svelte-lp18cf"/></div> <div class="debug-panel svelte-lp18cf"></div> <div class="gesture-grid svelte-lp18cf"><button class="gesture-btn svelte-lp18cf">Nod</button> <button class="gesture-btn svelte-lp18cf">Shake</button> <button class="gesture-btn svelte-lp18cf">Tilt</button> <button class="gesture-btn svelte-lp18cf">Fidget</button> <button class="gesture-btn svelte-lp18cf">Sigh</button> <button class="gesture-btn svelte-lp18cf">Look Down</button> <button class="gesture-btn svelte-lp18cf">Close Eyes</button> <button class="gesture-btn svelte-lp18cf">Wink</button> <button class="gesture-btn svelte-lp18cf">Puff</button> <button class="gesture-btn svelte-lp18cf">Tongue</button> <button class="gesture-btn svelte-lp18cf">Squint</button> <button class="gesture-btn svelte-lp18cf">Roll</button> <button class="gesture-btn svelte-lp18cf">Think</button> <button class="gesture-btn svelte-lp18cf">Flinch</button> <button class="gesture-btn svelte-lp18cf">Pant</button></div></div> <div class="info-section svelte-lp18cf"><strong class="svelte-lp18cf"> </strong> <div class="scroll-list svelte-lp18cf"></div></div> <div class="info-section svelte-lp18cf"><label style="display: flex; align-items: center; gap: 5px; margin-bottom: 5px; color: #fab;" class="svelte-lp18cf"><input type="checkbox" class="svelte-lp18cf"/> Enable Autonomy (Uncheck to test manually)</label> <strong class="svelte-lp18cf">üîß Manual Parameter Test:</strong> <div style="display: flex; gap: 5px; margin-top: 5px;" class="svelte-lp18cf"><input type="text" placeholder="Param ID (e.g. ParamEyeLOpen)" style="flex: 2; padding: 4px; border-radius: 4px; border: 1px solid #444; background: #222; color: #fff; font-size: 12px;" class="svelte-lp18cf"/> <input type="number" placeholder="Val" step="0.1" style="flex: 1; padding: 4px; border-radius: 4px; border: 1px solid #444; background: #222; color: #fff; font-size: 12px;" class="svelte-lp18cf"/> <button style="padding: 4px 8px; border-radius: 4px; background: #4caf50; color: white; border: none; cursor: pointer; font-size: 12px;" class="svelte-lp18cf">Set</button></div></div> <div class="info-section svelte-lp18cf"><strong class="svelte-lp18cf">Autonomy Emotions:</strong> <div class="presets-row svelte-lp18cf" style="display: flex; gap: 5px; flex-wrap: wrap; margin-top: 5px;"></div></div> <div class="info-section svelte-lp18cf"><strong class="svelte-lp18cf">Motion Groups:</strong> <div class="scroll-list svelte-lp18cf"></div></div> <!></div>'),Ks=V('<div class="sleep-effect-container svelte-lp18cf"><div class="z-particle z1 svelte-lp18cf">Z</div> <div class="z-particle z2 svelte-lp18cf">Z</div> <div class="z-particle z3 svelte-lp18cf">Z</div></div>'),js=V('<div><!> <canvas class="live2d-canvas svelte-lp18cf"></canvas> <!> <!> <!>  <!></div>');function Ws(Z,t){Zt(t,!1);const s=hs();let p=$(t,"modelUrl",8),l=$(t,"scale",8,.3),E=$(t,"x",8,0),P=$(t,"y",8,0),Y=$(t,"expressionMap",24,()=>({}));$(t,"hitMotionMap",24,()=>({}));let ae=$(t,"backgroundImage",8,null),H=$(t,"closeupScale",8,2),N=$(t,"closeupOffset",8,.2),I=$(t,"startVoiceUrl",8,void 0),z=$(t,"persona",8,null),m=$(t,"autonomy",12,null),M=$(t,"error_showSpeech",12,!1),ne=y(),x=y(),u=y(null),Q=y(!1),fe=y(!1),K=y(!1),n=y({modelUrl:"",currentEmotion:"None",currentExpression:"None",lastMotion:"None",availableExpressions:[],availableMotionGroups:[],fileMotions:[],error:"",manualParamId:"",manualParamValue:0}),A=!1,U=y("CALM"),re=y("CALM");async function me(i,d){e(u)&&(M(!1),m()&&m().setSpeaking(!0),await yt.speak(e(u),i,{onFinish:()=>{m()&&m().setSpeaking(!1),d&&d()},onError:b=>{console.error("### TTS Error",b),m()&&m().setSpeaking(!1),M(!0)}}))}function Me(){o(K,!e(K)),e(u)&&e(u).hitAreaFrames&&D(u,e(u).hitAreaFrames.visible=e(K))}function oe(){if(!e(u)||!e(u).internalModel)return;console.log("Debug: üßπ Performing Hard Reset to Default");const i=e(u).internalModel,d=i.motionManager;d&&(typeof d.stopAll=="function"?d.stopAll():typeof d.stop=="function"&&d.stop(),d.queue&&(d.queue=[]),d.expressionManager&&(console.log("Debug: Stopping all expressions"),typeof d.expressionManager.stopAllExpressions=="function"?d.expressionManager.stopAllExpressions():typeof d.expressionManager.restore=="function"&&d.expressionManager.restore()));const b=i.coreModel;if(b){const c=b.getParameterCount();for(let a=0;a<c;a++){const r=b.getParameterDefaultValue(a);b.setParameterValueByIndex(a,r)}}D(n,e(n).currentEmotion="None"),D(n,e(n).currentExpression="None"),D(n,e(n).lastMotion="Reset (Hard)"),o(n,e(n)),setTimeout(()=>{const c=["Idle","idle","Stand","stand","Wait","wait"],a=i.motionManager?.definitions;if(a){for(const r of c)if(a[r]){e(u).motion(r,0,3),console.log(`Debug: Triggering idle motion: ${r}`);break}}},50)}function ye(i){if(!e(u)||!e(u).internalModel||!e(u).internalModel.motionManager)return;console.log(`Debug: Triggering motion by filename: ${i}`);const b=e(u).internalModel.motionManager.definitions;for(const[c,a]of Object.entries(b))if(Array.isArray(a))for(let r=0;r<a.length;r++){const g=a[r];if(g.File&&(g.File===i||g.File.endsWith("/"+i)||g.File.endsWith("\\"+i))){console.log(`Debug: Found motion in group ${c} at index ${r}`),oe(),e(u).motion(c,r),D(n,e(n).lastMotion=`${c} (${r}): ${i}`);return}}console.warn(`Debug: Motion file not found: ${i}`)}let J=0,le=null,ve=null;function ee(i){e(u)&&(console.log(`Debug: |triggerExpression| Found custom mapping for category '${i}'`),e(u).expression(i),D(n,e(n).currentExpression=i),J=Date.now()+2e3,console.log(`Debug: Expression Locked until ${J}`),ve&&clearTimeout(ve),le=null)}function L(i){m()&&m().playGesture(i)}function He(i){m()&&m().setSensitivity(i)}function Ee(i){if(!e(u))return;if(Date.now()<J){if(console.log(`Debug: setExpression Locked. queueing emotion: ${i}`),le=i,!ve){const g=J-Date.now();ve=setTimeout(()=>{ve=null,le&&(console.log(`Debug: Applying pending emotion: ${le}`),Ee(le),le=null)},g)}return}console.log(`Debug: |setExpression| called with: ${i}`),D(n,e(n).currentEmotion=i);const d=i.toLowerCase();let b="neutral",c;const r={joy:{cat:"joy",type:"GENTLE"},happy:{cat:"joy",type:"GENTLE"},love:{cat:"joy",type:"GENTLE"},gratitude:{cat:"joy",type:"GENTLE"},relief:{cat:"joy",type:"GENTLE"},pride:{cat:"joy",type:"GENTLE"},amusement:{cat:"amuse",type:"ELATED"},excitement:{cat:"amuse",type:"ELATED"},fun:{cat:"amuse",type:"ELATED"},curiosity:{cat:"amuse",type:"ELATED"},anger:{cat:"anger",type:"STERN"},annoyance:{cat:"anger",type:"STERN"},disapproval:{cat:"anger",type:"STERN"},disgust:{cat:"anger",type:"STERN"},sadness:{cat:"sorrow",type:"DEPRESSED"},grief:{cat:"sorrow",type:"DEPRESSED"},disappointment:{cat:"sorrow",type:"DEPRESSED"},remorse:{cat:"sorrow",type:"DEPRESSED"},fear:{cat:"unease",type:"TENSE"},nervousness:{cat:"unease",type:"TENSE"},embarrassment:{cat:"unease",type:"TENSE"},surprise:{cat:"surprise",type:"ASTONISHED"},realization:{cat:"surprise",type:"ASTONISHED"},confusion:{cat:"surprise",type:"ASTONISHED"},neutral:{cat:"neutral",type:"CALM"},approval:{cat:"neutral",type:"CALM"},caring:{cat:"neutral",type:"CALM"}}[d];if(!r){console.log(`Debug: Unmapped emotion '${d}', ignoring.`);return}if(b=r.cat,c=r.type,Y()){let g="";if(m()?.setEmotion(c),Y()[c]?g=Y()[c]:Y()[b]&&(g=Y()[b]),g){console.log(`Debug: Found custom mapping for '${c}'/'${b}' -> '${g}'`),e(u).expression(g),D(n,e(n).currentExpression=g);return}}}function Oe(i){i.buttonMode=!0;let d=0,b=0;const c=10;i.on("pointerdown",r=>{d=r.data.global.x,b=r.data.global.y,o(Le,!0),o(Se,{x:r.data.global.x,y:r.data.global.y}),m()&&De(r)}),i.on("pointermove",r=>{if(e(Le)&&o(Se,{x:r.data.global.x,y:r.data.global.y}),!A&&d!==0&&b!==0){const g=Math.abs(r.data.global.x-d),_=Math.abs(r.data.global.y-b);(g>c||_>c)&&(A=!0,s("interaction",{action:"touch_start",duration:"start",state:"contact",is_ongoing:!0}),m()?.WakeUp())}A&&De(r)});const a=()=>{A&&s("interactionEnd"),A=!1,o(Le,!1),d=0,b=0,m()&&m().handleDrag(0,0)};i.on("pointerupoutside",a),i.on("pointerup",a)}function De(i){if(!e(x)||!m())return;const d=i.data.global.x,b=i.data.global.y,c=e(x).screen.width/2,a=e(x).screen.height/2,r=(T,j,te)=>Math.min(Math.max(T,j),te),g=r((d-c)/(e(x).screen.width/3),-1,1),_=r((b-a)/(e(x).screen.height/3),-1,1);m().handleDrag(g,_)}let We=()=>{};$t(async()=>{const i=()=>{yt.init(),window.removeEventListener("click",i),window.removeEventListener("touchstart",i),console.log("üëÜ User interacted, Audio System initialized.")};window.addEventListener("click",i),window.addEventListener("touchstart",i),We=()=>{window.removeEventListener("click",i),window.removeEventListener("touchstart",i)},setTimeout(async()=>{try{await As();const d=window.PIXI,b=Math.min(window.devicePixelRatio||1,2);o(x,new d.Application({view:e(ne),autoStart:!0,backgroundAlpha:0,resizeTo:e(ne).parentElement,resolution:b,autoDensity:!0,antialias:!1}));const c=await d.live2d.Live2DModel.from(p(),{autoInteract:!1});c.interactive=!0,c.buttonMode=!0,Oe(c);try{if(d.live2d.HitAreaFrames&&typeof d.live2d.HitAreaFrames=="function"){const S=new d.live2d.HitAreaFrames;S.visible=e(K),c.addChild(S),c.hitAreaFrames=S,console.log("Debug: HitAreaFrames added. Visible:",S.visible)}else console.warn("PIXI.live2d.HitAreaFrames not available. Debug visuals disabled.")}catch(S){console.error("Failed to add HitAreaFrames:",S)}console.log("Debug: Inspecting Model Hit Areas...");const a=c.hitAreas?Object.keys(c.hitAreas):[];console.log("Debug: Detected Hit Area Keys:",a),a.length===0?(console.warn("‚ö†Ô∏è This model seems to have NO Hit Areas defined in its settings."),D(n,e(n).error="No Hit Areas detected in this model! (Check .model3.json)")):D(n,e(n).fileMotions=a),c.scale.set(1);const r=c.getBounds(),g=1.3,_=e(x).screen.width*g/r.width,T=e(x).screen.height*g/r.height,j=Math.min(_,T),te=E()===0&&P()===0?j:l();c.scale.set(te),c.x=E(),c.y=P(),E()===0&&P()===0&&(c.anchor.set(.5,.5),c.x=e(x).screen.width/2,c.y=e(x).screen.height/2+150),e(x).stage.addChild(c),o(u,c),m(new Ys(c,e(x))),m().start(),o(Q,!0),D(n,e(n).modelUrl=p()),console.log("Debug: Model loaded",c),console.log("Debug: Internal Model",c.internalModel),console.log("Debug: Settings",c.internalModel?.settings),c.internalModel?.coreModel?._parameterIds&&console.log("Debug: Available Parameter IDs:",c.internalModel.coreModel._parameterIds);const B=new Set;c.expressions&&(console.log("Debug: model.expressions found:",c.expressions),c.expressions.forEach(S=>B.add(S)));try{const S=c.internalModel?.settings;if(S)if(S.FileReferences?.Expressions){console.log("Debug: Found FileReferences.Expressions",S.FileReferences.Expressions);const W=S.FileReferences.Expressions;Array.isArray(W)&&W.forEach(F=>{F.Name?B.add(F.Name):F.File&&B.add(F.File.split("/").pop().replace(".exp3.json",""))})}else S.expressions&&(console.log("Debug: Found settings.expressions",S.expressions),S.expressions.forEach(W=>{W.name?B.add(W.name):W.Name&&B.add(W.Name)}))}catch(S){console.error("Debug: Expression discovery error",S)}D(n,e(n).availableExpressions=Array.from(B)),console.log("Debug: Final available expressions:",e(n).availableExpressions),D(n,e(n).availableExpressions=Array.from(B));const Pe=new Set;if(c.internalModel?.motionManager?.definitions&&Object.keys(c.internalModel.motionManager.definitions).forEach(S=>Pe.add(S)),D(n,e(n).availableMotionGroups=Array.from(Pe)),o(n,e(n)),window.addEventListener("resize",Be),z()&&z().first_scene)try{const S=JSON.parse(z().first_scene);if(Array.isArray(S.live2d_permanent_expressions)){console.log("Applying Permanent Expressions (Hard Lock):",S.live2d_permanent_expressions);const W=async F=>{try{const se=c.internalModel?.settings;let de="";if(se?.FileReferences?.Expressions){const w=se.FileReferences.Expressions.find(ke=>ke.Name===F||ke.File?.includes(F));w&&(de=w.File)}else if(se?.expressions){const w=se.expressions.find(ke=>ke.name===F||ke.Name===F);w&&(de=w.file||w.File)}if(!de){console.warn(`Could not find file for expression: ${F}`);return}const Ne=p().substring(0,p().lastIndexOf("/")+1)+de;console.log(`Fetching Expression JSON: ${Ne}`);const ue=await(await fetch(Ne)).json();ue.Parameters&&Array.isArray(ue.Parameters)&&(ue.Parameters.forEach(w=>{c.internalModel.coreModel.setParameterValueById?c.internalModel.coreModel.setParameterValueById(w.Id,w.Value):console.warn("setParameterValueById not found on coreModel")}),console.log(`‚úÖ Applied hard-lock for ${F}`))}catch(se){console.error(`Failed to apply hard expression ${F}:`,se)}};S.live2d_permanent_expressions.forEach(F=>{W(F)})}}catch{}}catch(d){console.error("Failed to initialize Live2D:",d),D(n,e(n).error=d.message||d.toString()),o(Q,!0)}},100)});let q=$(t,"isCloseup",12,!1);function Ie(){q(!q())}let Se=y({x:0,y:0}),Le=y(!1);function Be(){if(e(x)&&e(u)&&E()===0&&P()===0){const i=e(u).getBounds(),d=i.width/e(u).scale.x,b=i.height/e(u).scale.y,c=1.3,a=e(x).screen.width*c/d,r=e(x).screen.height*c/b;let g=Math.min(a,r),_=e(x).screen.height/2+50;if(q()){g*=H();const T=b*g;_+=T*N()}else{const T=b*g;_+=T*.1}e(u).scale.set(g),D(u,e(u).x=e(x).screen.width/2),D(u,e(u).y=_)}}Et(()=>{if(window.removeEventListener("resize",Be),We(),yt.stop(),e(u))try{e(u).destroy()}catch{}if(e(x))try{e(x).destroy(!0,{children:!0,texture:!0,baseTexture:!0})}catch{}}),pe(()=>(e(Q),e(u),e(fe),Fe(I()),Fe(m())),()=>{e(Q)&&e(u)&&!e(fe)&&(o(fe,!0),I()?(console.log("[Live2D] Autoplay Start Voice:",I()),setTimeout(()=>{me(I())},500)):setTimeout(()=>{m()?.setEmotion("SLEEP")},500))}),pe(()=>(Fe(m()),e(U)),()=>{m()&&m(m().onEmotionChange=i=>{o(re,i),e(U)!==i&&o(U,i)},!0)}),pe(()=>(Fe(q()),e(x),e(u)),()=>{q()!==void 0&&e(x)&&e(u)&&Be()}),pe(()=>(Fe(H()),Fe(N()),Fe(q())),()=>{(H()||N())&&q()&&Be()}),qt(),Wt();var xe=js();let Xe;var $e=v(xe);{var Ze=i=>{var d=Ns();ge(()=>Rt(d,"src",ae())),X(i,d)};Te($e,i=>{ae()&&i(Ze)})}var Ae=h($e,2);es(Ae,i=>o(ne,i),()=>e(ne));var qe=h(Ae,2);{var Ce=i=>{var d=Fs(),b=v(d);Xt(b,{icon:"ph:hand-grabbing-fill",width:"48",height:"48",color:"white"}),f(d),ge(()=>bt(d,`left: ${e(Se).x??""}px; top: ${e(Se).y??""}px;`)),X(i,d)};Te(qe,i=>{e(Le)&&i(Ce)})}var Qe=h(qe,2);{var nt=i=>{var d=Hs(),b=v(d),c=v(b);Xt(c,{icon:"line-md:loading-twotone-loop",width:"64",height:"64"}),vt(4),f(b),f(d),X(i,d)};Te(Qe,i=>{e(Q)||i(nt)})}var ce=h(Qe,2);{var Je=i=>{var d=Vs(),b=h(v(d),2),c=v(b);f(b);var a=h(b,2),r=h(v(a),2),g=v(r,!0);f(r),f(a);var _=h(a,2),T=h(v(_),2),j=v(T,!0);f(T),f(_);var te=h(_,2),B=h(v(te),2),Pe=v(B,!0);f(B),f(te);var S=h(te,2),W=h(v(S),2),F=v(W,!0);f(W),f(S);var se=h(S,2),de=v(se),Ye=v(de),Ne=h(v(Ye),2),R=v(Ne);f(Ne),f(Ye);var ue=h(Ye,2);at(ue),f(de);var w=h(de,4),ke=v(w),_t=h(ke,2),Tt=h(_t,2),Mt=h(Tt,2),St=h(Mt,2),xt=h(St,2),Pt=h(xt,2),kt=h(Pt,2),wt=h(kt,2),Ot=h(wt,2),Dt=h(Ot,2),It=h(Dt,2),Lt=h(It,2),At=h(Lt,2),ss=h(At,2);f(w),f(se);var rt=h(se,2),ot=v(rt),is=v(ot);f(ot);var Ct=h(ot,2);Ke(Ct,5,()=>e(n).availableExpressions,je,(C,k)=>{var G=Bs(),he=v(G,!0);f(G),ge(()=>ie(he,e(k))),O("click",G,()=>{console.log("Debug: Triggering expression",e(k)),e(u).expression(e(k)),D(n,e(n).currentExpression=e(k))}),X(C,G)}),f(Ct),f(rt);var lt=h(rt,2),ct=v(lt),dt=v(ct);at(dt),ps(dt,!0),vt(),f(ct);var Yt=h(ct,4),ut=v(Yt);at(ut);var ht=h(ut,2);at(ht);var as=h(ht,2);f(Yt),f(lt);var gt=h(lt,2),Nt=h(v(gt),2);Ke(Nt,4,()=>["CALM","ELATED","GENTLE","STERN","DEPRESSED","TENSE","ASTONISHED","SLEEP"],je,(C,k)=>{var G=Rs(),he=v(G,!0);f(G),ge(()=>ie(he,k)),O("click",G,()=>{m()&&(m().setEmotion(k),console.log("Set Emotion:",k))}),X(C,G)}),f(Nt),f(gt);var pt=h(gt,2),Ft=h(v(pt),2);Ke(Ft,5,()=>e(n).availableMotionGroups,je,(C,k)=>{var G=Xs(),he=v(G),Ue=v(he),ft=v(Ue,!0);f(Ue),vt(2),f(he);var Ve=h(he,2);{var mt=we=>{var et=us(),os=Jt(et);Ke(os,1,()=>e(u).internalModel.motionManager.definitions[e(k)],je,(ls,tt,st)=>{var it=Gs(),Ht=v(it);Ht.textContent=`[${st}]`;var Bt=h(Ht,2),cs=v(Bt,!0);f(Bt),f(it),ge(ds=>ie(cs,ds),[()=>e(tt).File?e(tt).File.split("/").pop():"Unknown"],Ge),O("click",it,()=>{console.log(`Debug: Triggering ${e(k)} index ${st}`,e(tt).File),e(u).motion(e(k),st),D(n,e(n).lastMotion=`${e(k)} (${st}): ${e(tt).File}`)}),X(ls,it)}),X(we,et)};Te(Ve,we=>{e(u)&&e(u).internalModel&&e(u).internalModel.motionManager&&e(u).internalModel.motionManager.definitions[e(k)]&&we(mt)})}f(G),ge(()=>{Rt(he,"title",`Play Random ${e(k)??""} Motion`),ie(ft,e(k))}),O("click",he,()=>{console.log("Debug: Triggering motion group",e(k)),e(u).motion(e(k)),D(n,e(n).lastMotion=`${e(k)} (Group Trigger)`)}),X(C,G)}),f(Ft),f(pt);var ns=h(pt,2);{var rs=C=>{var k=Us(),G=v(k),he=v(G);f(G);var Ue=h(G,2);Ke(Ue,5,()=>e(n).fileMotions,je,(ft,Ve,mt)=>{var we=zs(),et=v(we,!0);f(we),ge(()=>ie(et,e(Ve))),O("click",we,()=>{console.log("Debug: Playing file",e(Ve)),e(u).motion("__debug__",mt),D(n,e(n).lastMotion=e(Ve))}),X(ft,we)}),f(Ue),f(k),ge(()=>ie(he,`üìÇ Found Files (${e(n).fileMotions.length??""}):`)),X(C,k)};Te(ns,C=>{e(n).fileMotions&&e(n).fileMotions.length>0&&C(rs)})}f(d),ge((C,k)=>{ie(g,C),ie(j,e(n).currentEmotion),ie(Pe,e(n).currentExpression),ie(F,e(n).lastMotion),ie(R,`${k??""}x`),fs(ue,m()?.sensitivity||1),ie(is,`Expressions (${(e(n).availableExpressions?e(n).availableExpressions.length:0)??""}) :`)},[()=>e(n).modelUrl.split("/").pop(),()=>m()?.sensitivity.toFixed(1)],Ge),O("click",c,oe),O("input",ue,C=>m()?.setSensitivity(parseFloat(C.currentTarget.value))),O("click",ke,()=>L("NOD")),O("click",_t,()=>L("SHAKE")),O("click",Tt,()=>L("TILT")),O("click",Mt,()=>L("FIDGET")),O("click",St,()=>L("SIGH")),O("click",xt,()=>L("LOOK_DOWN")),O("click",Pt,()=>L("CLOSE_EYES")),O("click",kt,()=>L("WINK")),O("click",wt,()=>L("PUFF_CHEEKS")),O("click",Ot,()=>L("STICK_TONGUE")),O("click",Dt,()=>L("SQUINT")),O("click",It,()=>L("ROLL_EYES")),O("click",Lt,()=>L("LOOK_UP_THINK")),O("click",At,()=>L("FLINCH")),O("click",ss,()=>L("PANT")),O("change",dt,C=>{m()&&(C.currentTarget.checked?m().start():m().stop())}),Gt(ut,()=>e(n).manualParamId,C=>D(n,e(n).manualParamId=C)),Gt(ht,()=>e(n).manualParamValue,C=>D(n,e(n).manualParamValue=C)),O("click",as,()=>{if(e(u)&&e(u).internalModel&&e(n).manualParamId)try{e(u).internalModel.coreModel.setParameterValueById(e(n).manualParamId,Number(e(n).manualParamValue)),console.log(`‚úÖ Set ${e(n).manualParamId} to ${e(n).manualParamValue}`),e(u).internalModel.coreModel.update()}catch(C){console.error("‚ùå Failed to set parameter:",C),alert("Error setting parameter. Check ID.")}}),X(i,d)};Te(ce,i=>{e(K)&&i(Je)})}var be=h(ce,2);{var ze=i=>{var d=Ks();X(i,d)};Te(be,i=>{e(re)==="SLEEP"&&i(ze)})}return f(xe),ge(i=>Xe=gs(xe,1,"live2d-container svelte-lp18cf",null,Xe,i),[()=>({"hiding-cursor":e(Le)})],Ge),X(Z,xe),_e(t,"speak",me),_e(t,"toggleDebug",Me),_e(t,"resetToDefault",oe),_e(t,"triggerMotion",ye),_e(t,"triggerExpression",ee),_e(t,"playGesture",L),_e(t,"setSensitivity",He),_e(t,"setExpression",Ee),_e(t,"toggleCamera",Ie),Qt({speak:me,toggleDebug:Me,resetToDefault:oe,triggerMotion:ye,triggerExpression:ee,playGesture:L,setSensitivity:He,setExpression:Ee,toggleCamera:Ie})}var $s=V('<div class="error-message svelte-25hv72">No Model URL</div>'),Zs=V('<div class="live2d-wrapper svelte-25hv72"><!></div> <div class="chat-overlay svelte-25hv72"><div class="chat-content svelte-25hv72"><!> <!></div></div> <!> <!> <!> <!>',1),qs=V('<main class="svelte-25hv72"><div class="vignette-overlay vignette-black svelte-25hv72"></div> <div class="vignette-overlay vignette-pink svelte-25hv72"></div> <!></main>');function Mi(Z,t){Zt(t,!1);const[s,p]=ms(),l=()=>Re(Vt,"$messages",s),E=()=>Re(Os,"$chatSessions",s),P=()=>Re(ws,"$pricingStore",s),Y=()=>Re(xs,"$page",s),ae=()=>Re(Ps,"$ttsState",s),H=()=>Re(Ds,"$settings",s);let N=y(null),I=y(null),z=null;const m=6e4;let M=y(),ne=y(!1),x=y(!1),u=y(1.5),Q=y(.1),fe=y(!1),K=y(""),n=y(""),A=y(!1),U=y(!1),re=y(!1);const me="/live2d/huohuo/huohuo.model3.json";let Me=y(""),oe=y(!1),ye=y(0),J=y(0),le=y(1),ve=y(0),ee=y({}),L=y({}),He=y({}),Ee=y({}),Oe=y(""),De=y(!1),We=1;const q=[];let Ie=y(null);const Se=async a=>{!e(I)||!e(N)||(ks.update(r=>(r&&r.credits>=e(ye)&&(r.credits-=e(ye)),r)),o(x,!0),o(K,""),o(n,""),o(A,!1),o(U,!1),o(Oe,""),e(Ie)&&e(Ie).WakeUp(),await Ts(e(N),a,"live2d",()=>{o(x,!1),Ae()},r=>{e(M)&&e(M).setExpression&&e(M).setExpression(r)}))},Le=a=>{};Et(()=>{zt()});function Be(){if(ae()=="connected")return;const a=l()[l().length-1];if(a.role==="assistant"){let r=a.content;r=r.replace(/\([^)]*\)/g,""),r=r.replace(/\[[^\]]*\]/g,""),console.log("content: ",r),o(Me,r)}xe(),o(oe,!0),setTimeout(()=>{o(A,!1)},2e3)}function xe(){for(;q.length>0;){const a=q.shift();a&&a.type==="gesture"?e(M)&&e(M).playGesture&&e(M).playGesture(a.name):a&&a.type==="motion"?e(M)&&e(M).triggerMotion&&e(M).triggerMotion(a.name):a&&a.type==="expression"&&e(M)&&e(M).triggerExpression&&e(M).triggerExpression(a.name)}}function Xe(){if(o(oe,!1),o(A,!1),o(U,!0),o(re,!1),e(n)){const a=Math.floor(Math.random()*1e3)+2e3;setTimeout(()=>{o(U,!0),setTimeout(()=>{o(U,!1)},8e3)},a)}}const $e=async a=>{if(!a){ts.error("TTS Server Busy (Fallback to Text)"),console.warn("TTS Failed (Fallback)."),o(be,!0);return}if(e(M)&&e(M).speak){const r=new Blob([a],{type:"audio/mp3"}),g=URL.createObjectURL(r),_=new Audio(g);if(await new Promise(j=>{_.onloadedmetadata=()=>j(!0),setTimeout(()=>j(!0),1e3)}),!_.duration){console.warn("Audio duration not found."),o(be,!0);return}const T=_.duration*1e3||3e3;console.log(`Audio Duration: ${T}ms`),console.log("Audio Start: Resetting thoughts"),o(re,!0),o(U,!1),o(A,!1),e(M).speak(g,Xe),xe()}else console.warn("Viewer not ready for TTS audio.")},Ze=async()=>{await ys($e)};function Ae(){z&&clearTimeout(z),H().enableIdleTrigger&&!e(re)&&!e(x)&&!e(ne)&&(z=setTimeout(()=>{console.log("üí§ Triggering Idle..."),Se("<idle>")},m))}const qe=3e3;let Ce;function Qe(a){console.log("üëÜ Interaction:",a.detail),Ae(),Ce&&clearTimeout(Ce),Ce=setTimeout(()=>{H().enableInteractionTrigger&&!e(x)&&Se("<interaction>"+JSON.stringify(a.detail))},qe)}function nt(){console.log("üëá Interaction End"),Ce&&clearTimeout(Ce)}function ce(){Ae()}let Je;$t(async()=>{const a=g=>{g.detail?.score!==void 0&&o(J,g.detail.score)};window.addEventListener("affection-update",a),Je=()=>window.removeEventListener("affection-update",a);const r=Y().url.searchParams.get("c");o(N,r),vs(Vt,[]),r&&(o(I,null),Ze()),window.addEventListener("mousemove",ce),window.addEventListener("keydown",ce),window.addEventListener("click",ce),window.addEventListener("touchstart",ce),Ae()}),Et(()=>{z&&clearTimeout(z),window.removeEventListener("mousemove",ce),window.removeEventListener("keydown",ce),window.removeEventListener("click",ce),window.removeEventListener("touchstart",ce),Je()});let be=y(!1);pe(()=>(Y(),e(N),e(De),Kt),()=>{const a=Y().url.searchParams.get("c");a!==e(N)&&(o(N,a),a&&(o(I,null),o(ee,{}),o(L,{}),o(Ee,{}),o(He,{}),o(J,0),Promise.all([_s(a,r=>{o(De,r.recent_turns.length<1),console.log("@@@ isStartSpeech @@@",e(De))}),Kt(a)]).then(([r,g])=>{if(g){g.live2d_model_url||(g.live2d_model_url=me);try{if(g.first_scene){const _=JSON.parse(g.first_scene);_.live2d_motion_list&&Array.isArray(_.live2d_motion_list)&&_.live2d_motion_list.forEach(T=>{T.name&&T.file&&D(ee,e(ee)[T.name]=T.file)}),_.live2d_hit_motion_map&&o(He,_.live2d_hit_motion_map),_.live2d_expression_map&&o(Ee,_.live2d_expression_map)}}catch(_){console.error("Failed to parse first_scene JSON:",_)}o(I,g)}})))}),pe(()=>(l(),e(I),e(K),e(re),e(U)),()=>{if(l().length>0&&e(I)!==null){const a=l()[l().length-1];if(a.role==="assistant"){const r=a.content,g=r.match(/^\s*\((.*?)\)/);g&&e(K)!==g[1]&&(o(K,g[1]),!e(re)&&!e(U)&&o(A,!0));const _=r.match(/\((.*?)\)\s*$/);_&&r.trim()!==_[0].trim()&&o(n,_[1])}}}),pe(()=>(e(N),E(),P()),()=>{if(e(N)){const r=E().find(T=>T.id===e(N))?.llmType||"gemini-flash-lite",g=P().costs.chat_live2d||10,_=P().model_multipliers[r]||1;o(ye,Math.round(g*_))}}),pe(()=>e(J),()=>{const a=Math.max(0,Math.min(100,e(J)))/100;o(le,.95-a*.95),o(ve,a*.45)}),pe(()=>e(M),()=>{e(M)&&e(M).setSensitivity&&e(M).setSensitivity(We)}),pe(()=>(l(),e(Oe),e(ee),e(Ee),e(M)),()=>{if(l().length>0){const a=l()[l().length-1];if(a.role==="assistant"){const g=a.content.match(/\[(.*?)\]/);if(g){const T=g[1].split(":")[0].trim();if(T&&T!==e(Oe)){o(Oe,T);const j=T.toUpperCase().replace(/\s+/g,"_");if(["NOD","SHAKE","TILT","FIDGET","SIGH","LOOK_DOWN","CLOSE_EYES","WINK","PUFF_CHEEKS","STICK_TONGUE","SQUINT","ROLL_EYES","LOOK_UP_THINK","FLINCH","PANT"].includes(j))console.log(`Debug: Triggering Gesture: ${j}`),q.push({name:j,type:"gesture"});else if(e(ee)[T]||e(Ee)[T]){const B=e(ee)[T];e(M)?(console.log("Debug: Triggering action:",T),e(M).getAvailableExpressions&&e(M).getAvailableExpressions().includes(B)||B.endsWith(".exp3.json")||B.endsWith(".exp.json")?q.push({name:T,type:"expression"}):q.push({name:T,type:"motion"})):console.warn("Debug: Viewer or triggerMotion missing")}else console.warn(`Debug: Action [${T}] not found in map. Available: ${Object.keys(e(ee)).join(", ")}`)}else e(Oe)}}}}),pe(()=>e(be),()=>{e(be)&&(console.log("Audio Blocked Error Detected: Triggering Fallback"),o(be,!1),o(oe,!0),xe())}),qt(),Wt();var ze=qs(),i=v(ze),d=h(i,2),b=h(d,2);{var c=a=>{var r=Zs(),g=Jt(r),_=v(g);{var T=R=>{const ue=Ge(()=>e(De)?e(I).start_voice_url:"");es(Ws(R,{get modelUrl(){return e(I).live2d_model_url},get startVoiceUrl(){return e(ue)},backgroundImage:"/chat_bg.png",scale:.2,get expressionMap(){return e(Ee)},get hitMotionMap(){return e(He)},get persona(){return e(I)},get closeupScale(){return e(u)},set closeupScale(w){o(u,w)},get closeupOffset(){return e(Q)},set closeupOffset(w){o(Q,w)},get isCloseup(){return e(fe)},set isCloseup(w){o(fe,w)},get error_showSpeech(){return e(be)},set error_showSpeech(w){o(be,w)},get autonomy(){return e(Ie)},set autonomy(w){o(Ie,w)},$$events:{interaction:Qe,interactionEnd:nt},$$legacy:!0}),w=>o(M,w),()=>e(M))},j=R=>{var ue=$s();X(R,ue)};Te(_,R=>{e(I).live2d_model_url?R(T):R(j,!1)})}f(g);var te=h(g,2),B=v(te),Pe=v(B);Ms(Pe,{get showChat(){return e(ne)},get isLoading(){return e(x)}});var S=h(Pe,2);const W=Ge(()=>e(I)?.name);Ss(S,{onSend:Se,onChangeInput:Le,get placeholderName(){return e(W)},mode:"3d",get neededNeurons(){return e(ye)},iosVV:!0}),f(B),f(te);var F=h(te,2);const se=Ge(()=>e(N)??"");Es(F,{get cssid(){return e(se)},get persona(){return e(I)},llmType:"3d",impl_connectTTS:Ze,get impl_disconnectTTS(){return zt},impl_changeCamera:()=>e(M)?.toggleCamera(),get affectionScore(){return e(J)},get showChat(){return e(ne)},set showChat(R){o(ne,R)},get closeupScale(){return e(u)},set closeupScale(R){o(u,R)},get closeupOffset(){return e(Q)},set closeupOffset(R){o(Q,R)},get isCloseup(){return e(fe)},set isCloseup(R){o(fe,R)},$$legacy:!0});var de=h(F,2);Ut(de,{get text(){return e(K)},get visible(){return e(A)},customStyle:"top: 5vh; left: 50%; transform: translateX(-50%); z-index: 20;",onEnded:Be});var Ye=h(de,2);Ut(Ye,{get text(){return e(n)},get visible(){return e(U)},customStyle:"top: 5vh; left: 50%; transform: translateX(-50%); z-index: 20;"});var Ne=h(Ye,2);bs(Ne,{get text(){return e(Me)},get visible(){return e(oe)},customStyle:"top: 25vh; left: 50%; transform: translateX(-50%); z-index: 25;",onEnded:Xe}),X(a,r)};Te(b,a=>{e(I)&&a(c)})}f(ze),ge(()=>{bt(i,`opacity: ${e(le)??""};`),bt(d,`opacity: ${e(ve)??""};`)}),X(Z,ze),Qt(),p()}export{Mi as component};
