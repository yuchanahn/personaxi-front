import{d as N,b as P}from"../chunks/kz80bbCR.js";import{i as Ae}from"../chunks/2r1cYJse.js";import{a as Pe,o as ot}from"../chunks/D0mpzbhj.js";import{w as Ne,aq as D,V as t,W as i,aE as ze,ao as F,Q as e,aD as De,ar as Xe,as as Fe,aj as H,ap as h,al as O,O as K,am as I,z as He,an as nt}from"../chunks/BUDlkbfV.js";import{s as rt}from"../chunks/BbnaKca8.js";import{i as ge}from"../chunks/28pso2Hb.js";import{b as te,s as lt,r as it}from"../chunks/BJyhluUY.js";import{e as Y}from"../chunks/CiCNsvIE.js";import{b as ct}from"../chunks/njKOc8Q7.js";import{b as pe}from"../chunks/CGc6l0L7.js";import{a as ee,s as Ye,b as ft}from"../chunks/D32zTIdM.js";import{e as ut}from"../chunks/BOGOvxWJ.js";import{b as dt}from"../chunks/CAWQASXy.js";import{p as z}from"../chunks/Bf5_DoVm.js";import{u as mt,s as Oe,t as gt,g as pt}from"../chunks/CY9TbF48.js";import{m as W,i as vt,C as ht,a as bt,l as _t}from"../chunks/-q0Oa4Q3.js";import{g as yt}from"../chunks/DqiWXVxP.js";import{l as St}from"../chunks/Do-RpF6d.js";import{I as wt}from"../chunks/DaDtKPX8.js";import{B as Tt,V as me}from"../chunks/pfmv5nwf.js";import{T as Ie,S as xt,c as Le,d as Re,C as Mt}from"../chunks/CymZ0rla.js";import{t as kt}from"../chunks/2yqvXdGA.js";import{p as Ct}from"../chunks/dMfnY97A.js";import{l as $e}from"../chunks/Caezn3U5.js";import"../chunks/C36u96xB.js";/* empty css                */import{t as Be}from"../chunks/sXlFIKQv.js";function jt(x){const d=x.matchAll(/<emo:([a-zA-Z_]+)>/g),b=[];for(const m of d)m[1]&&b.push(m[1]);return b}function Vt(x){const d=x.matchAll(/\[(.*?)\]/g),b=[];for(const m of d)m[1]&&b.push(m[1]);return b}async function Et(x,d,b){if(!d.trim())return;W.update(c=>[...c,{role:"user",content:d}]);let m="";await vt(d,x??"",c=>{if(c.startsWith("{")&&c.endsWith("}")){try{const f=JSON.parse(c);if(f.text&&(c=f.text),f.predictions){const p=JSON.parse("["+f.predictions[0]+"]");console.log("Emotion data received: ",p),b?.Emotion(p[0].key,p[0].value)}}catch(f){console.error("JSON ÌååÏã± Ïò§Î•ò:",f)}return}m+=c,W.update(f=>{let p=jt(m),u=Vt(m);return p.length>0&&(m=m.replace(/<emo:([a-zA-Z_]+)>/g,""),b?.Emotion(p[0])),u.length>0&&(console.log("üî• [Animation Detected]:",u),m=m.replace(/\[(.*?)\]/g,""),u.forEach(v=>{console.log("‚û°Ô∏è Triggering gesture:",v),b?.doGesture(v)})),f.at(-1)?.role==="assistant"?[...f.slice(0,-1),{role:"assistant",content:m}]:[...f,{role:"assistant",content:m}]})},c=>{St(),yt(`/character?c=${c}`)},"3d"),W.update(c=>{const f=[...c],p=f.at(-1);return p?.role==="assistant"&&(p.done=!0),f})}var zt=N('<div class="spark svelte-flcsaj"></div>'),Dt=N('<img alt="background" class="vrm-bg svelte-flcsaj" draggable="false"/>'),Ot=N('<div class="model-loader svelte-flcsaj"><div class="loader-content svelte-flcsaj"><!> <span class="loading-text svelte-flcsaj">VRM Î™®Îç∏ Î°úÎî© Ï§ë...</span> <small class="loading-hint svelte-flcsaj">Ïû†Ïãú ÌôîÎ©¥Ïù¥ Î©àÏ∂ú Ïàò ÏûàÏäµÎãàÎã§ (Ï†ïÏÉÅ ÎèôÏûë)</small></div></div>'),It=N('<!> <div id="character-view" class="svelte-flcsaj"><!> <canvas class="vrm-canvas svelte-flcsaj"></canvas>  <!> <!> <!> <!> <div id="speech-bubble" class="bubble svelte-flcsaj"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" class="svelte-flcsaj"><circle cx="4" cy="12" r="3" fill="currentColor" class="svelte-flcsaj"><animate id="svgSpinners3DotsFade0" fill="freeze" attributeName="opacity" begin="0;svgSpinners3DotsFade1.end-0.25s" dur="0.75s" values="1;0.2" class="svelte-flcsaj"></animate></circle><circle cx="12" cy="12" r="3" fill="currentColor" opacity="0.4" class="svelte-flcsaj"><animate fill="freeze" attributeName="opacity" begin="svgSpinners3DotsFade0.begin+0.15s" dur="0.75s" values="1;0.2" class="svelte-flcsaj"></animate></circle><circle cx="20" cy="12" r="3" fill="currentColor" opacity="0.3" class="svelte-flcsaj"><animate id="svgSpinners3DotsFade1" fill="freeze" attributeName="opacity" begin="svgSpinners3DotsFade0.begin+0.3s" dur="0.75s" values="1;0.2" class="svelte-flcsaj"></animate></circle></svg></div> <div class="chat-container select-none svelte-flcsaj"><div class="chat-content svelte-flcsaj"><!> <!></div></div></div>',1);function Lt(x,d){Ne(d,!1);const[b,m]=Ye(),c=()=>ee(W,"$messages",b),f=()=>ee(kt,"$ttsState",b),p=()=>ee(Oe,"$sparks",b);let u=z(d,"persona",8);z(d,"cssid",8,null);let L=z(d,"show",8,!0),v=z(d,"backgroundImage",8,null),R=z(d,"startVoiceUrl",8,void 0),o=i(),M,w=i(),k=i(),A=i(!1),_=i(null),T=i(!0),j=i(""),V=i(""),E=i(!1),l=i(!1),y=i(!1),S=i(""),C=i(!1);function se(){if(f()=="connected")return;const s=c()[c().length-1];if(s.role==="assistant"){let a=s.content;a=a.replace(/\([^)]*\)/g,""),a=a.replace(/\[[^\]]*\]/g,""),console.log("content: ",a),t(S,a)}t(C,!0),setTimeout(()=>{t(E,!1)},2e3)}function J(){t(C,!1),t(E,!1),t(l,!0),setTimeout(()=>{t(l,!1)},8e3)}let U={rotImpulseHead:30,halfRotHead:.5,rotImpulseBody:12,halfRotBody:.25,rotImpulseLimb:10,halfRotLimb:.3};Pe(()=>{mt(),clearTimeout(M)});function q(){const a=Date.now();try{u()&&gt(e(w),u()).then(r=>{t(o,r),e(o)?.setCanvas(e(w)),t(_,pt()),le(),e(o)&&De(o,e(o).cfg=U);const g=Date.now()-a,B=Math.max(0,3e3-g);setTimeout(()=>{t(T,!1),console.log("## Model loaded! END TIMER END!")},B+5e3)}).catch(r=>{console.error("Error loading VRM:",r),t(T,!1)}).finally(()=>{console.log("finally - model loaded!")})}catch(r){console.error("Error loading VRM:",r),t(T,!1)}}function X(s){if(e(o)){const a=s.clientX/window.innerWidth*2-1,r=s.clientY/window.innerHeight*2-1;e(o).updateMouseGaze(a,r)}}function G(s){if(e(o)){const a=e(w).getBoundingClientRect(),r=s.clientX-a.left,g=s.clientY-a.top,B=r/a.width*2-1,ce=-(g/a.height)*2+1;if(ce<-.7)return;e(o).hitByMouse(B,ce)}}function Z(s){if(e(o)?.stateManager?.setListening(!0),clearTimeout(M),s===""){e(o)?.stateManager?.setListening(!1);return}M=setTimeout(()=>{e(o)?.stateManager?.setListening(!1)},3e3)}let $=i(!1);const ae=async s=>{if(!(!e(o)||!u())){clearTimeout(M),e(o).stateManager?.setListening(!1),t(j,""),t(V,""),t(E,!1),t(l,!1);try{t($,!0),await Et(u().id,s,e(o))}catch(a){console.error("Error sending prompt to character:",a)}finally{t($,!1)}}};function n(s){e(o)?(e(o).stateManager?.setSpeaking(!0),t(y,!0),t(l,!1),t(C,!1),e(o).speak(s).then(()=>{e(o).stateManager?.setSpeaking(!1),t(y,!1),t(E,!1),e(V)&&(t(l,!0),setTimeout(()=>{t(l,!1)},8e3))}).catch(a=>{console.error("Error speaking:",a),t(y,!1)})):console.warn("Model not loaded yet, cannot speak.")}let oe=z(d,"closeupScale",8,1),ne=z(d,"closeupOffset",8,0),re=z(d,"isCloseup",8,!1),We=.2,Je=-.45,Ue=-8,qe=14;function le(){if(!e(_)||!e(_).model?.vrm)return;const s=e(_).model.vrm,a=new Tt().setFromObject(s.scene),r=new me;a.getSize(r);const g=new me;a.getCenter(g);const B=g.y+r.y/2*.9;let fe=r.y*1.5+We,je=B+Je;re()&&(fe=fe/oe(),je+=ne()*r.y);const ue=fe,Ve=je,Ee=Ue*(Math.PI/180),de=qe*(Math.PI/180),tt=g.x+ue*Math.sin(Ee)*Math.cos(de),st=g.z+ue*Math.cos(Ee)*Math.cos(de),at=Ve+ue*Math.sin(de);e(_).camera.position.set(tt,at,st),e(_).camera.lookAt(new me(g.x,Ve,g.z)),e(_).camera.updateProjectionMatrix()}D(()=>(F(u()),ze),()=>{u()?.id&&(async()=>(t(T,!0),await ze(),setTimeout(()=>{q()},50)))()}),D(()=>(e(T),e(_),e(o),F(R()),e(A)),()=>{!e(T)&&e(_)&&e(o)&&R()&&!e(A)&&(console.log("[VRM] Autoplay Start Voice:",R()),t(A,!0),setTimeout(()=>{fetch(R()).then(s=>s.arrayBuffer()).then(s=>{e(o)&&n(s)}).catch(s=>console.error("[VRM] Start Voice Fetch Error",s))},1e3))}),D(()=>(c(),e(j),e(y),e(l),e(V)),()=>{if(c().length>0){const s=c()[c().length-1];if(s.role==="assistant"){const a=s.content,r=a.match(/^\s*\((.*?)\)/);r&&e(j)!==r[1]&&(console.log("VRM Thought 1 detected:",r[1]),t(j,r[1]),!e(y)&&!e(l)&&(console.log("VRM Showing Thought 1"),t(E,!0)));const g=a.match(/\((.*?)\)\s*$/);g&&a.trim()!==g[0].trim()&&e(V)!==g[1]&&t(V,g[1])}}}),D(()=>e(o),()=>{e(o)&&De(o,e(o).cfg=structuredClone(U))}),D(()=>(F(re()),F(oe()),F(ne())),()=>{(re()!==void 0||oe()||ne())&&le()}),D(()=>{},()=>{le()}),Xe(),Ae();var ve=It(),he=Fe(ve);ut(he,1,p,s=>s.id,(s,a)=>{var r=zt();H(()=>te(r,`left:${e(a).x??""}px; top:${e(a).y??""}px; --r:${e(a).angle??""}deg`)),Y("animationend",r,()=>Oe.update(g=>g.filter(B=>B.id!==e(a).id))),P(s,r)});var Q=h(he,2),be=O(Q);{var Ge=s=>{var a=Dt();H(()=>lt(a,"src",v())),P(s,a)};ge(be,s=>{v()&&s(Ge)})}var _e=h(be,2);pe(_e,s=>t(w,s),()=>e(w));var ye=h(_e,2);Ie(ye,{get text(){return e(j)},get visible(){return e(E)},customStyle:"top: 5vh; bottom: auto; left: 50%; transform: translateX(-50%); z-index: 20;",onEnded:se});var Se=h(ye,2);Ie(Se,{get text(){return e(V)},get visible(){return e(l)},customStyle:"top: 5vh; bottom: auto; left: 50%; transform: translateX(-50%); z-index: 20;"});var we=h(Se,2);xt(we,{get text(){return e(S)},get visible(){return e(C)},customStyle:"top: 25vh; left: 50%; transform: translateX(-50%); z-index: 25;",onEnded:J});var Te=h(we,2);{var Ze=s=>{var a=Ot(),r=O(a),g=O(r);wt(g,{icon:"line-md:loading-twotone-loop",width:"64",height:"64"}),nt(4),I(r),I(a),P(s,a)};ge(Te,s=>{e(T)&&s(Ze)})}var ie=h(Te,2);let xe;pe(ie,s=>t(k,s),()=>e(k));var Me=h(ie,2),ke=O(Me),Ce=O(ke);ht(Ce,{get showChat(){return L()},get isLoading(){return e($)},get persona(){return u()}});var Qe=h(Ce,2);const Ke=K(()=>u()?.name);bt(Qe,{onSend:ae,onChangeInput:Z,get placeholderName(){return e(Ke)},iosVV:!0}),I(ke),I(Me),I(Q),H(()=>xe=te(ie,"",xe,{visibility:e($)?"visible":"hidden"})),Y("mousedown",Q,G),Y("mousemove",Q,X),P(x,ve),dt(d,"speek",n);var et=He({speek:n});return m(),et}var Rt=N('<!> <!> <div class="debug-controls"><label> <input type="range" min="0" max="100"/></label> <button>0</button> <button>100</button></div>',1),$t=N('<main class="svelte-1hz3xj3"><div class="vignette-overlay vignette-black svelte-1hz3xj3"></div> <div class="vignette-overlay vignette-pink svelte-1hz3xj3"></div> <!></main>');function us(x,d){Ne(d,!1);const[b,m]=Ye(),c=()=>ee(Ct,"$page",b);let f=i(null),p=i(null),u=i(),L=i(!1),v=i(0),R=i(1),o=i(0),M=i(1),w=i(0),k=i(!1);ot(()=>{const l=S=>{S.detail?.score!==void 0&&t(v,S.detail.score)};window.addEventListener("affection-update",l);const y=()=>window.removeEventListener("affection-update",l);return(async()=>{const S=c().url.searchParams.get("c");t(f,S),ft(W,[]),S&&await Le(async C=>{if(!C){Be.error("TTS Server Busy"),console.warn("TTS Failed (3D).");return}e(u)&&e(u).speek?e(u).speek(C):console.warn("Viewer not ready for TTS audio.")})})(),y});let A=i(!1);Pe(()=>{Re()}),D(()=>(c(),e(f),$e),()=>{const l=c().url.searchParams.get("c");l!==e(f)&&(t(f,l),l&&(t(p,null),t(v,0),Promise.all([_t(l,y=>{t(A,y.recent_turns.length<1)}),$e(l)]).then(([y,S])=>{t(p,S)})))}),D(()=>e(v),()=>{const l=Math.max(0,Math.min(100,e(v)))/100;t(R,.95-l*.95),t(o,l*.45)}),Xe(),Ae();var _=$t(),T=O(_),j=h(T,2),V=h(j,2);{var E=l=>{var y=Rt(),S=Fe(y);const C=K(()=>e(f)??""),se=K(()=>e(A)?e(p).start_voice_url:"");pe(Lt(S,{get persona(){return e(p)},backgroundImage:"/chat_bg.png",get cssid(){return e(C)},get startVoiceUrl(){return e(se)},get show(){return e(L)},set show(n){t(L,n)},get closeupScale(){return e(M)},set closeupScale(n){t(M,n)},get closeupOffset(){return e(w)},set closeupOffset(n){t(w,n)},get isCloseup(){return e(k)},set isCloseup(n){t(k,n)},$$legacy:!0}),n=>t(u,n),()=>e(u));var J=h(S,2);const U=K(()=>e(f)??"");Mt(J,{get cssid(){return e(U)},get persona(){return e(p)},llmType:"3d",impl_connectTTS:async()=>{await Le(async n=>{if(!n){Be.error("TTS Server Busy");return}e(u)&&e(u).speek?e(u).speek(n):console.warn("Viewer not ready for TTS audio.")})},impl_disconnectTTS:()=>{Re()},impl_changeCamera:()=>t(k,!e(k)),get affectionScore(){return e(v)},get showChat(){return e(L)},set showChat(n){t(L,n)},get closeupScale(){return e(M)},set closeupScale(n){t(M,n)},get closeupOffset(){return e(w)},set closeupOffset(n){t(w,n)},get isCloseup(){return e(k)},set isCloseup(n){t(k,n)},$$legacy:!0});var q=h(J,2),X=O(q),G=O(X),Z=h(G);it(Z),I(X);var $=h(X,2),ae=h($,2);I(q),H(()=>rt(G,`Affection: ${e(v)??""} `)),ct(Z,()=>e(v),n=>t(v,n)),Y("click",$,()=>t(v,0)),Y("click",ae,()=>t(v,100)),P(l,y)};ge(V,l=>{e(p)&&l(E)})}I(_),H(()=>{te(T,`opacity: ${e(R)??""};`),te(j,`opacity: ${e(o)??""};`)}),P(x,_),He(),m()}export{us as component};
