import{e as we,b as R,d as X}from"./kz80bbCR.js";import{i as se}from"./2r1cYJse.js";import{a as ae,o as xe}from"./D0mpzbhj.js";import{w as le,aq as V,Q as e,W as g,V as l,ao as N,ar as me,as as he,z as re,al as C,ap as H,am as k,an as ye,aj as Y,O as ge}from"./BUDlkbfV.js";import{s as oe}from"./BbnaKca8.js";import{i as ne}from"./28pso2Hb.js";import{b as U,a as Se,s as Ce}from"./BJyhluUY.js";import{p as i}from"./Bf5_DoVm.js";import{a as ke,s as Ae}from"./D32zTIdM.js";import{s as Me}from"./IXAamO68.js";import{S as ze,b as Ie}from"./-q0Oa4Q3.js";import{e as Oe}from"./BOGOvxWJ.js";import{I as be}from"./DaDtKPX8.js";import{a as We}from"./E07TNQLR.js";import{t as te}from"./2yqvXdGA.js";var Ee=X('<div class="thought-bubble-wrapper svelte-1ectzor"><div class="thought-bubble svelte-1ectzor"><div class="glow-effect svelte-1ectzor"></div> <div class="content-row svelte-1ectzor"><span class="icon svelte-1ectzor">ðŸ’­</span> <p class="svelte-1ectzor"> </p></div></div> <div class="bubble-tail svelte-1ectzor"></div> <div class="bubble-tail-small svelte-1ectzor"></div></div>');function nt(m,t){le(t,!1);let u=i(t,"text",8,""),r=i(t,"visible",8,!1),h=i(t,"customStyle",8,"");i(t,"speed",8,30);let P=i(t,"onEnded",8,()=>{}),W=g(""),S=g(!1),T,I=g(""),A=g(!1);function p(y){const b=/([^.?!~\n]+[.?!~\n]*)/g,d=y.match(b);if(!d)return[y];const f=d.map(x=>x.trim()).filter(x=>x.length>0),w=[];let v="";for(const x of f)v?v+=" "+x:v=x,v.length>=10&&(w.push(v),v="");return v&&w.push(v),w}function E(y){clearTimeout(T),l(S,!0),l(I,y);const b=p(y);let d=0;const f=()=>{if(!r()&&!e(A)){l(S,!1);return}if(d>=b.length){l(S,!1),P()();return}const w=b[d];l(W,w);const v=Math.max(1200,w.length*120);d++,T=setTimeout(f,v)};f()}ae(()=>{clearTimeout(T)}),V(()=>(N(r()),N(u()),e(I),e(A),e(S)),()=>{r()&&u()?((u()!==e(I)||!e(A))&&E(u()),l(A,!0)):r()||(l(A,!1),e(S)||l(W,""))}),me(),se();var _=we(),L=he(_);{var D=y=>{var b=Ee(),d=C(b),f=H(C(d),2),w=H(C(f),2),v=C(w,!0);k(w),k(f),k(d),ye(4),k(b),Y(()=>{U(b,h()),oe(v,e(W))}),R(y,b)};ne(L,y=>{(r()||e(S))&&u()&&y(D)})}R(m,_),re()}var Be=X('<div class="speaker-badge svelte-3sfb8w"><span class="dot svelte-3sfb8w"></span> <span class="name svelte-3sfb8w"> </span></div>'),De=X('<div aria-live="polite" aria-atomic="true"><!> <div class="bubble svelte-3sfb8w"><div class="bubble-inner svelte-3sfb8w"><p class="text svelte-3sfb8w"> </p></div></div></div>');function st(m,t){le(t,!1);const[u,r]=Ae(),h=()=>ke(Me,"$settings",u),P=g(),W=g();let S=i(t,"text",8,""),T=i(t,"visible",8,!1);i(t,"speed",8,28),i(t,"pausePunct",8,140);let I=i(t,"holdMs",8,1400),A=i(t,"onEnded",8,()=>{}),p=i(t,"variant",24,()=>h().theme==="dark"?"dark":"light"),E=i(t,"position",8,"bottom"),_=i(t,"x",8,50),L=i(t,"y",8,140),D=i(t,"maxWidth",8,"78vw"),y=i(t,"customStyle",8,"");i(t,"showCaret",8,!0);let b=g(""),d=g(""),f=g(!1),w=null,v=null,x=g(""),M=g(!1);const ie=/speaker=["']([^"']*)["']/,ce=/<dialogue[^>]*>([\s\S]*?)<\/dialogue>/;function F(){w&&clearTimeout(w),v&&clearTimeout(v),w=null,v=null}function Z(z){F();const O=z.match(ie);l(d,O?O[1].trim():"");const o=z.match(ce);let n=(o?o[1]:z).trim();fe(n,z)}function J(z){const O=/([^.?!~\n]+[.?!~\n]*)/g,o=z.match(O);if(!o)return[z];const n=o.map(c=>c.trim()).filter(c=>c.length>0),s=[];let a="";for(const c of n)a?a+=" "+c:a=c,a.length>=10&&(s.push(a),a="");return a&&s.push(a),s}function fe(z,O){l(b,""),l(x,O),l(f,!0);const o=J(z);let n=0;const s=()=>{if(!T()&&!e(M)){l(f,!1);return}if(n>=o.length){l(f,!1),v=setTimeout(()=>{(T()||e(M))&&A()()},I());return}const a=o[n];l(b,a);const c=Math.max(1200,a.length*120);n++,w=setTimeout(s,c)};s()}ae(()=>F()),V(()=>(N(T()),N(S()),e(x),e(M),e(f)),()=>{T()&&S()?((S()!==e(x)||!e(M))&&Z(S()),l(M,!0)):T()||(l(M,!1),e(f)||(l(b,""),l(d,"")),F())}),V(()=>(N(E()),N(_()),N(L())),()=>{l(P,E()==="bottom"?`left:${_()}vw; bottom:${L()}px;`:`left:${_()}vw; top:${L()}px;`)}),V(()=>N(p()),()=>{l(W,`variant-${p()}`)}),me(),se();var G=we(),ue=he(G);{var Q=z=>{var O=De(),o=C(O);{var n=de=>{var ee=Be(),pe=H(C(ee),2),_e=C(pe,!0);k(pe),k(ee),Y(()=>{Ce(ee,"title",e(d)),oe(_e,e(d))}),R(de,ee)};ne(o,de=>{e(d)&&de(n)})}var s=H(o,2),a=C(s),c=C(a),$=C(c,!0);k(c),k(a),k(s),k(O),Y(()=>{Se(O,1,`bubble-wrap ${e(W)} ${E()==="top"?"pos-top":"pos-bottom"}`,"svelte-3sfb8w"),U(O,`${e(P)} max-width:${D()}; ${y()}`),oe($,e(b))}),R(z,O)};ne(ue,z=>{(T()||e(f))&&S()&&z(Q)})}R(m,G),re(),r()}var je=X('<div class="particle svelte-vjsft7"><!></div>'),Pe=X('<div><div class="heart-icon svelte-vjsft7"><!></div> <div class="bar-track svelte-vjsft7"><div class="bar-fill svelte-vjsft7"></div></div> <div class="score-label svelte-vjsft7"> </div> <!></div>');function Le(m,t){le(t,!1);const u=g();let r=i(t,"score",8,0);const h=(o,n,s)=>Math.max(n,Math.min(s,o)),P=(o,n,s)=>o+(n-o)*s;let W=g(r()),S=g(!1),T=g(!1),I=null,A=null,p=g("#9ca3af"),E=g("#cbd5e1"),_=g([]),L=0,D=0;const y=["ph:heart-fill","ph:sparkle","ph:sparkle-fill","ph:star-four-fill"];function b(o){const n=o.replace("#",""),s=n.length===3?n.split("").map(c=>c+c).join(""):n,a=parseInt(s,16);return{r:a>>16&255,g:a>>8&255,b:a&255}}function d(o,n,s){const a=c=>h(Math.round(c),0,255).toString(16).padStart(2,"0");return`#${a(o)}${a(n)}${a(s)}`}function f(o,n,s){const a=b(o),c=b(n);return d(P(a.r,c.r,s),P(a.g,c.g,s),P(a.b,c.b,s))}function w(o){const n=h(o,0,100)/100,s="#9ca3af",a="#f472b6",c="#ef4444";return n<=.55?f(s,a,n/.55):f(a,c,(n-.55)/.45)}function v(){l(S,!0),I&&clearTimeout(I),I=setTimeout(()=>l(S,!1),560)}function x(){l(T,!0),A&&clearTimeout(A),A=setTimeout(()=>l(T,!1),340)}function M(){const o=L++,n=(Math.random()-.5)*24,s=-(Math.random()*80+20),a=8+Math.random()*12,c=y[Math.floor(Math.random()*y.length)]??"ph:heart-fill";l(_,[...e(_),{id:o,x:n,y:s,size:a,icon:c,expires:Date.now()+950}])}function ie(){if(D)return;const o=()=>{const n=Date.now();if(e(_).length){const s=e(_).filter(a=>a.expires>n);s.length!==e(_).length&&l(_,s)}D=requestAnimationFrame(o)};D=requestAnimationFrame(o)}function ce(o){const n=h(Math.round(o),1,8);for(let s=0;s<n;s++)M();ie()}xe(()=>{const o=window.matchMedia?.("(prefers-reduced-motion: reduce)")??null;o?.matches;const n=()=>{o?.matches};return o?.addEventListener?.("change",n),()=>o?.removeEventListener?.("change",n)}),ae(()=>{I&&clearTimeout(I),A&&clearTimeout(A),D&&cancelAnimationFrame(D)}),V(()=>(N(r()),e(W)),()=>{if(r()!==e(W)){const o=r()-e(W);o>0?(ce(o),v()):x(),l(W,r())}}),V(()=>N(r()),()=>{l(u,r()<=0?1:r())}),V(()=>(e(p),e(u)),()=>{l(p,w(e(u))),l(E,f(e(p),"#ffffff",.45))}),me(),se();var F=Pe();let Z;var J=C(F),fe=C(J);be(fe,{icon:"ph:heart-fill",width:"16",height:"16"}),k(J);var G=H(J,2),ue=C(G);k(G);var Q=H(G,2),z=C(Q,!0);k(Q);var O=H(Q,2);Oe(O,1,()=>e(_),o=>o.id,(o,n)=>{var s=je(),a=C(s);be(a,{get icon(){return e(n).icon}}),k(s),Y(c=>U(s,`
                left: calc(50% + ${e(n).x??""}px);
                bottom: calc(${c??""}% + 20px);
                font-size: ${e(n).size??""}px;
                color: ${e(p)??""};
                --py: ${e(n).y??""}px;
            `),[()=>h(e(u),0,100)],ge),R(o,s)}),k(F),Y((o,n,s,a,c,$)=>{Z=Se(F,1,"gauge-container svelte-vjsft7",null,Z,o),U(J,`color:${e(p)??""}`),U(ue,`
                height: ${n??""}%;
                background: linear-gradient(to top, ${s??""}, ${e(p)??""}, ${a??""});
                box-shadow: 0 0 8px ${e(E)??""}, 0 0 16px ${c??""};
            `),U(Q,`color:${e(p)??""}`),oe(z,$)},[()=>({pulse:e(S),shake:e(T)}),()=>h(e(u),0,100),()=>f(e(p),"#000000",.15),()=>f(e(p),"#ffffff",.3),()=>f(e(p),"#000000",.3),()=>h(r(),0,100)],ge),R(m,F),re()}var Ne=X('<!> <div class="affection-wrapper svelte-7uuhlz"><!></div> <div class="control-box svelte-7uuhlz"><!></div>',1);function at(m,t){le(t,!1),i(t,"cssid",8);let u=i(t,"showChat",12),r=i(t,"persona",8),h=i(t,"llmType",8),P=i(t,"impl_connectTTS",8,()=>{}),W=i(t,"impl_disconnectTTS",8,()=>{}),S=i(t,"impl_changeCamera",8,()=>{}),T=i(t,"closeupScale",12,1),I=i(t,"closeupOffset",12,0),A=i(t,"isCloseup",12,!1),p=g(!1),E=g("3d"),_=i(t,"affectionScore",12,0);function L(x){x.detail.score!==void 0&&_(x.detail.score)}xe(()=>{window.addEventListener("affection-update",L),r().personaType==="2D"?l(E,"2d"):r().personaType==="3D"?l(E,"3d"):r().personaType==="2.5D"&&l(E,"live2d")}),ae(()=>{typeof window<"u"&&window.removeEventListener("affection-update",L)}),se();var D=Ne(),y=he(D);{var b=x=>{Ie(x,{get persona(){return r()},get isOpen(){return e(p)},get llmType(){return h()},impl_connectTTS:P(),impl_disconnectTTS:W(),impl_changeCamera:S(),get mode(){return e(E)},get showChat(){return u()},set showChat(M){u(M)},get closeupScale(){return T()},set closeupScale(M){T(M)},get closeupOffset(){return I()},set closeupOffset(M){I(M)},get isCloseup(){return A()},set isCloseup(M){A(M)},$$events:{close:()=>l(p,!1)},$$legacy:!0})};ne(y,x=>{e(p)&&x(b)})}var d=H(y,2),f=C(d);Le(f,{get score(){return _()}}),k(d);var w=H(d,2),v=C(w);ze(v,{onClick:()=>l(p,!0)}),k(w),R(m,D),re()}let j=null,B=null,K=null,q=null;function ve(){if(q){console.log("ðŸ›‘ í˜„ìž¬ ì˜¤ë””ì˜¤ ìž¬ìƒì„ ì¤‘ì§€í•©ë‹ˆë‹¤."),q.onended=null;try{q.stop(0)}catch(m){console.warn("ì˜¤ë””ì˜¤ ì¤‘ì§€ ì‹œë„ ì¤‘ ì˜¤ë¥˜:",m)}q.disconnect(),q=null}}function qe(){B||(B=new(window.AudioContext||window.AudioContext),console.log("ðŸŽ¶ AudioContext ì´ˆê¸°í™”ë¨"),B.state==="suspended"&&B.resume().then(()=>{console.log("AudioContext resumed successfully")}).catch(m=>console.error("AudioContext resume failed:",m)))}function He(){K&&clearInterval(K),K=setInterval(()=>{j&&j.readyState===WebSocket.OPEN&&j.send(JSON.stringify({type:"ping"}))},3e4)}function Te(){K&&(clearInterval(K),K=null)}async function lt(m){try{j=await We.ws("/ws/tts",{})}catch(t){throw console.error("âŒ WebSocket ì—°ê²° ì‹¤íŒ¨:",t),te.set("disconnected"),t}return console.log("ðŸ”— tts WebSocket ì—°ê²° ì‹œë„..."),te.set("connecting"),j.onopen=()=>{console.log("âœ… tts WebSocket ì—°ê²°ë¨"),te.set("connected"),He()},j.onclose=()=>{console.warn("âš ï¸ tts WebSocket ëŠê¹€"),te.set("disconnected"),Te()},j.onmessage=async t=>{if(typeof t.data=="string")try{const r=JSON.parse(t.data);if(r.type==="pong")return;if(r.type==="error"){console.warn(`TTS Error: ${r.code} - ${r.message}`),m&&m(null);return}}catch{}if((!B||B.state==="closed")&&qe(),!B){console.error("âŒ AudioContextê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì‚¬ìš©ìž ì œìŠ¤ì²˜ê°€ í•„ìš”í•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤.");return}let u;if(t.data instanceof Blob)u=await t.data.arrayBuffer();else if(t.data instanceof ArrayBuffer)u=t.data;else{console.error("âŒ ì•Œ ìˆ˜ ì—†ëŠ” í˜•ì‹ì˜ ì˜¤ë””ì˜¤ ë°ì´í„°:",typeof t.data,t.data);return}try{if(m){ve(),console.log("ðŸŽ¶ ì™¸ë¶€ í•¨ìˆ˜ í˜¸ì¶œë¡œ ì˜¤ë””ì˜¤ ìž¬ìƒ ì‹œìž‘ (ìžì²´ ì¤‘ë‹¨ ë¡œì§ í•„ìš”)"),m(u);return}q&&(console.log("â© ìƒˆë¡œìš´ ì˜¤ë””ì˜¤ ìˆ˜ì‹ . ì´ì „ ì˜¤ë””ì˜¤ë¥¼ ì¤‘ì§€í•©ë‹ˆë‹¤."),ve());const r=await B.decodeAudioData(u),h=B.createBufferSource();h.buffer=r,h.connect(B.destination),q=h,h.start(0),h.onended=()=>{h.disconnect(),q===h&&(q=null)}}catch(r){console.error("âŒ ì˜¤ë””ì˜¤ ë°ì´í„° ë””ì½”ë”© ë˜ëŠ” ìž¬ìƒ ì‹¤íŒ¨:",r),q=null}},j}function rt(){if(Te(),ve(),j){try{j.close()}catch(m){console.warn("WebSocket ë‹«ê¸° ì‹¤íŒ¨:",m)}j=null,console.log("âœ… tts WebSocket ì—°ê²° í•´ì œë¨")}else console.warn("âš ï¸ tts WebSocketì´ ì´ë¯¸ ì—°ê²°ë˜ì–´ ìžˆì§€ ì•ŠìŠµë‹ˆë‹¤.");B&&B.close().then(()=>{B=null,console.log("ðŸŽ¶ AudioContextê°€ ì„±ê³µì ìœ¼ë¡œ ë‹«í˜”ìŠµë‹ˆë‹¤.")}).catch(m=>console.error("AudioContext ë‹«ê¸° ì‹¤íŒ¨:",m))}export{at as C,st as S,nt as T,lt as c,rt as d};
