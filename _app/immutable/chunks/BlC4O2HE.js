import{w as u,g as r}from"./e6l8DgL1.js";import{s as y}from"./C-VEydUt.js";import{a as l}from"./-4D0oWvs.js";import{t as k}from"./sXlFIKQv.js";function C(){const{subscribe:p,set:$,update:s}=u([]),c=u(0),d=u(!1),m=u(!1);let h=null;async function f(t=20,e=0){const i=r(l);if(i){d.set(!0);try{const o=await fetch(`/api/notifications?limit=${t}&offset=${e}`,{headers:{Authorization:`Bearer ${i}`}});if(o.ok){const a=await o.json();e===0?$(a||[]):s(n=>[...n,...a||[]])}}catch(o){console.error("Failed to fetch notifications",o)}finally{d.set(!1),m.set(!0)}}}async function w(){const t=r(l);if(t)try{const e=await fetch("/api/notifications/unread-count",{headers:{Authorization:`Bearer ${t}`}});if(e.ok){const i=await e.json();c.set(i.count)}}catch(e){console.error("Failed to fetch unread count",e)}}async function g(t,e="notification"){const i=r(l);if(!i)return;const a=r({subscribe:p}).find(n=>n.id===t);a&&!a.isRead&&c.update(n=>Math.max(0,n-1)),s(n=>n.map(b=>b.id===t?{...b,isRead:!0}:b));try{await fetch(`/api/notifications/${t}/read`,{method:"POST",headers:{Authorization:`Bearer ${i}`,"Content-Type":"application/json"},body:JSON.stringify({type:e})})}catch(n){console.error("Failed to mark as read",n)}}async function N(t){const e=r(l);if(e){s(i=>i.filter(o=>o.id!==t));try{(await fetch(`/api/notifications/${t}`,{method:"DELETE",headers:{Authorization:`Bearer ${e}`}})).ok||(console.error("Failed to delete notification"),k.error("Failed to delete notification"),f())}catch(i){console.error("Failed to delete notification",i),f()}}}function z(t){h&&y.removeChannel(h),h=y.channel("public:notifications").on("postgres_changes",{event:"INSERT",schema:"public",table:"notifications",filter:`user_id=eq.${t}`},e=>{console.log("New notification received!",e);const i=e.new;s(o=>[i,...o]),c.update(o=>o+1),k.success(i.content)}).subscribe()}return{subscribe:p,unreadCount:{subscribe:c.subscribe},loading:{subscribe:d.subscribe},initialized:{subscribe:m.subscribe},fetchNotifications:f,fetchUnreadCount:w,markAsRead:g,deleteNotification:N,init:t=>{f(),w(),z(t)}}}const T=C();export{T as n};
