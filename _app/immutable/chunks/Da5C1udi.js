import{V as en}from"./BRDq7uV6.js";import{T as tn,a as Ue,b as Tt,L as Ee,c as ae,F as Qe,M as z,d as Je,C as D,e as W,S as X,f as yt,P as Ge,D as At,g as b,I as nn,Q as O,h as R,i as sn,O as oe,j as Ft,k as rn,l as Le,m as an,n as Et,N as on,o as cn,p as ln,q as xt,r as un,R as de,s as hn,t as Ve,u as pn,v as Ne,w as Mt,x as Rt,y as fn,z as fe,A as _e,E as Fe,G as vt,H as $e,J as gn,K as St,U as mn,W as dn,X as ge,Y as Lt,Z as k,_ as Nt,$ as It,a0 as xe,a1 as je,a2 as _n,a3 as bt,a4 as wn,a5 as Ye,a6 as le,a7 as ze,a8 as ue,a9 as ot,aa as Tn,ab as yn,ac as An,ad as Fn,ae as En,af as xn,ag as Mn,ah as Me,ai as Rn,aj as Ie,ak as vn,al as Sn,am as Ln,an as se,ao as Nn,ap as In,aq as bn,ar as Y,as as Hn,at as Ht,au as Ke,V as B,av as ye,aw as Pn,ax as kn,ay as Dn,az as Cn,aA as Bn,aB as On,aC as Un,aD as Gn,aE as Vn,aF as jn,aG as Yn,aH as zn,aI as Kn,aJ as Xn,aK as Wn,B as qn}from"./Dq_rjOCf.js";import"./BXQQiVcS.js";import{b as Qn}from"./knpjl46v.js";import"./Bit4kGOU.js";import"./gt9WcTCj.js";import{W as Jn}from"./DJxVeldX.js";function ct(l,e){if(e===tn)return console.warn("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Geometry already defined as triangles."),l;if(e===Ue||e===Tt){let t=l.getIndex();if(t===null){const i=[],a=l.getAttribute("position");if(a!==void 0){for(let o=0;o<a.count;o++)i.push(o);l.setIndex(i),t=l.getIndex()}else return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Undefined position attribute. Processing not possible."),l}const n=t.count-2,s=[];if(e===Ue)for(let i=1;i<=n;i++)s.push(t.getX(0)),s.push(t.getX(i)),s.push(t.getX(i+1));else for(let i=0;i<n;i++)i%2===0?(s.push(t.getX(i)),s.push(t.getX(i+1)),s.push(t.getX(i+2))):(s.push(t.getX(i+2)),s.push(t.getX(i+1)),s.push(t.getX(i)));s.length/3!==n&&console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unable to generate correct amount of triangles.");const r=l.clone();return r.setIndex(s),r.clearGroups(),r}else return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unknown draw mode:",e),l}class $n extends Ee{constructor(e){super(e),this.dracoLoader=null,this.ktx2Loader=null,this.meshoptDecoder=null,this.pluginCallbacks=[],this.register(function(t){return new ss(t)}),this.register(function(t){return new rs(t)}),this.register(function(t){return new fs(t)}),this.register(function(t){return new gs(t)}),this.register(function(t){return new ms(t)}),this.register(function(t){return new as(t)}),this.register(function(t){return new os(t)}),this.register(function(t){return new cs(t)}),this.register(function(t){return new ls(t)}),this.register(function(t){return new ns(t)}),this.register(function(t){return new us(t)}),this.register(function(t){return new is(t)}),this.register(function(t){return new ps(t)}),this.register(function(t){return new hs(t)}),this.register(function(t){return new es(t)}),this.register(function(t){return new ds(t)}),this.register(function(t){return new _s(t)})}load(e,t,n,s){const r=this;let i;if(this.resourcePath!=="")i=this.resourcePath;else if(this.path!==""){const u=ae.extractUrlBase(e);i=ae.resolveURL(u,this.path)}else i=ae.extractUrlBase(e);this.manager.itemStart(e);const a=function(u){s?s(u):console.error(u),r.manager.itemError(e),r.manager.itemEnd(e)},o=new Qe(this.manager);o.setPath(this.path),o.setResponseType("arraybuffer"),o.setRequestHeader(this.requestHeader),o.setWithCredentials(this.withCredentials),o.load(e,function(u){try{r.parse(u,i,function(h){t(h),r.manager.itemEnd(e)},a)}catch(h){a(h)}},n,a)}setDRACOLoader(e){return this.dracoLoader=e,this}setDDSLoader(){throw new Error('THREE.GLTFLoader: "MSFT_texture_dds" no longer supported. Please update to "KHR_texture_basisu".')}setKTX2Loader(e){return this.ktx2Loader=e,this}setMeshoptDecoder(e){return this.meshoptDecoder=e,this}register(e){return this.pluginCallbacks.indexOf(e)===-1&&this.pluginCallbacks.push(e),this}unregister(e){return this.pluginCallbacks.indexOf(e)!==-1&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this}parse(e,t,n,s){let r;const i={},a={},o=new TextDecoder;if(typeof e=="string")r=JSON.parse(e);else if(e instanceof ArrayBuffer)if(o.decode(new Uint8Array(e,0,4))===Pt){try{i[x.KHR_BINARY_GLTF]=new ws(e)}catch(c){s&&s(c);return}r=JSON.parse(i[x.KHR_BINARY_GLTF].content)}else r=JSON.parse(o.decode(e));else r=e;if(r.asset===void 0||r.asset.version[0]<2){s&&s(new Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported."));return}const u=new Is(r,{path:t||this.resourcePath||"",crossOrigin:this.crossOrigin,requestHeader:this.requestHeader,manager:this.manager,ktx2Loader:this.ktx2Loader,meshoptDecoder:this.meshoptDecoder});u.fileLoader.setRequestHeader(this.requestHeader);for(let h=0;h<this.pluginCallbacks.length;h++){const c=this.pluginCallbacks[h](u);c.name||console.error("THREE.GLTFLoader: Invalid plugin found: missing name"),a[c.name]=c,i[c.name]=!0}if(r.extensionsUsed)for(let h=0;h<r.extensionsUsed.length;++h){const c=r.extensionsUsed[h],p=r.extensionsRequired||[];switch(c){case x.KHR_MATERIALS_UNLIT:i[c]=new ts;break;case x.KHR_DRACO_MESH_COMPRESSION:i[c]=new Ts(r,this.dracoLoader);break;case x.KHR_TEXTURE_TRANSFORM:i[c]=new ys;break;case x.KHR_MESH_QUANTIZATION:i[c]=new As;break;default:p.indexOf(c)>=0&&a[c]===void 0&&console.warn('THREE.GLTFLoader: Unknown extension "'+c+'".')}}u.setExtensions(i),u.setPlugins(a),u.parse(n,s)}parseAsync(e,t){const n=this;return new Promise(function(s,r){n.parse(e,t,s,r)})}}function Zn(){let l={};return{get:function(e){return l[e]},add:function(e,t){l[e]=t},remove:function(e){delete l[e]},removeAll:function(){l={}}}}const x={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_DISPERSION:"KHR_materials_dispersion",KHR_MATERIALS_IOR:"KHR_materials_ior",KHR_MATERIALS_SHEEN:"KHR_materials_sheen",KHR_MATERIALS_SPECULAR:"KHR_materials_specular",KHR_MATERIALS_TRANSMISSION:"KHR_materials_transmission",KHR_MATERIALS_IRIDESCENCE:"KHR_materials_iridescence",KHR_MATERIALS_ANISOTROPY:"KHR_materials_anisotropy",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_MATERIALS_VOLUME:"KHR_materials_volume",KHR_TEXTURE_BASISU:"KHR_texture_basisu",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",KHR_MATERIALS_EMISSIVE_STRENGTH:"KHR_materials_emissive_strength",EXT_MATERIALS_BUMP:"EXT_materials_bump",EXT_TEXTURE_WEBP:"EXT_texture_webp",EXT_TEXTURE_AVIF:"EXT_texture_avif",EXT_MESHOPT_COMPRESSION:"EXT_meshopt_compression",EXT_MESH_GPU_INSTANCING:"EXT_mesh_gpu_instancing"};class es{constructor(e){this.parser=e,this.name=x.KHR_LIGHTS_PUNCTUAL,this.cache={refs:{},uses:{}}}_markDefs(){const e=this.parser,t=this.parser.json.nodes||[];for(let n=0,s=t.length;n<s;n++){const r=t[n];r.extensions&&r.extensions[this.name]&&r.extensions[this.name].light!==void 0&&e._addNodeRef(this.cache,r.extensions[this.name].light)}}_loadLight(e){const t=this.parser,n="light:"+e;let s=t.cache.get(n);if(s)return s;const r=t.json,o=((r.extensions&&r.extensions[this.name]||{}).lights||[])[e];let u;const h=new D(16777215);o.color!==void 0&&h.setRGB(o.color[0],o.color[1],o.color[2],W);const c=o.range!==void 0?o.range:0;switch(o.type){case"directional":u=new At(h),u.target.position.set(0,0,-1),u.add(u.target);break;case"point":u=new Ge(h),u.distance=c;break;case"spot":u=new yt(h),u.distance=c,o.spot=o.spot||{},o.spot.innerConeAngle=o.spot.innerConeAngle!==void 0?o.spot.innerConeAngle:0,o.spot.outerConeAngle=o.spot.outerConeAngle!==void 0?o.spot.outerConeAngle:Math.PI/4,u.angle=o.spot.outerConeAngle,u.penumbra=1-o.spot.innerConeAngle/o.spot.outerConeAngle,u.target.position.set(0,0,-1),u.add(u.target);break;default:throw new Error("THREE.GLTFLoader: Unexpected light type: "+o.type)}return u.position.set(0,0,0),u.decay=2,K(u,o),o.intensity!==void 0&&(u.intensity=o.intensity),u.name=t.createUniqueName(o.name||"light_"+e),s=Promise.resolve(u),t.cache.add(n,s),s}getDependency(e,t){if(e==="light")return this._loadLight(t)}createNodeAttachment(e){const t=this,n=this.parser,r=n.json.nodes[e],a=(r.extensions&&r.extensions[this.name]||{}).light;return a===void 0?null:this._loadLight(a).then(function(o){return n._getNodeRef(t.cache,a,o)})}}class ts{constructor(){this.name=x.KHR_MATERIALS_UNLIT}getMaterialType(){return fe}extendParams(e,t,n){const s=[];e.color=new D(1,1,1),e.opacity=1;const r=t.pbrMetallicRoughness;if(r){if(Array.isArray(r.baseColorFactor)){const i=r.baseColorFactor;e.color.setRGB(i[0],i[1],i[2],W),e.opacity=i[3]}r.baseColorTexture!==void 0&&s.push(n.assignTexture(e,"map",r.baseColorTexture,X))}return Promise.all(s)}}class ns{constructor(e){this.parser=e,this.name=x.KHR_MATERIALS_EMISSIVE_STRENGTH}extendMaterialParams(e,t){const s=this.parser.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const r=s.extensions[this.name].emissiveStrength;return r!==void 0&&(t.emissiveIntensity=r),Promise.resolve()}}class ss{constructor(e){this.parser=e,this.name=x.KHR_MATERIALS_CLEARCOAT}getMaterialType(e){const n=this.parser.json.materials[e];return!n.extensions||!n.extensions[this.name]?null:z}extendMaterialParams(e,t){const n=this.parser,s=n.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const r=[],i=s.extensions[this.name];if(i.clearcoatFactor!==void 0&&(t.clearcoat=i.clearcoatFactor),i.clearcoatTexture!==void 0&&r.push(n.assignTexture(t,"clearcoatMap",i.clearcoatTexture)),i.clearcoatRoughnessFactor!==void 0&&(t.clearcoatRoughness=i.clearcoatRoughnessFactor),i.clearcoatRoughnessTexture!==void 0&&r.push(n.assignTexture(t,"clearcoatRoughnessMap",i.clearcoatRoughnessTexture)),i.clearcoatNormalTexture!==void 0&&(r.push(n.assignTexture(t,"clearcoatNormalMap",i.clearcoatNormalTexture)),i.clearcoatNormalTexture.scale!==void 0)){const a=i.clearcoatNormalTexture.scale;t.clearcoatNormalScale=new Je(a,a)}return Promise.all(r)}}class rs{constructor(e){this.parser=e,this.name=x.KHR_MATERIALS_DISPERSION}getMaterialType(e){const n=this.parser.json.materials[e];return!n.extensions||!n.extensions[this.name]?null:z}extendMaterialParams(e,t){const s=this.parser.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const r=s.extensions[this.name];return t.dispersion=r.dispersion!==void 0?r.dispersion:0,Promise.resolve()}}class is{constructor(e){this.parser=e,this.name=x.KHR_MATERIALS_IRIDESCENCE}getMaterialType(e){const n=this.parser.json.materials[e];return!n.extensions||!n.extensions[this.name]?null:z}extendMaterialParams(e,t){const n=this.parser,s=n.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const r=[],i=s.extensions[this.name];return i.iridescenceFactor!==void 0&&(t.iridescence=i.iridescenceFactor),i.iridescenceTexture!==void 0&&r.push(n.assignTexture(t,"iridescenceMap",i.iridescenceTexture)),i.iridescenceIor!==void 0&&(t.iridescenceIOR=i.iridescenceIor),t.iridescenceThicknessRange===void 0&&(t.iridescenceThicknessRange=[100,400]),i.iridescenceThicknessMinimum!==void 0&&(t.iridescenceThicknessRange[0]=i.iridescenceThicknessMinimum),i.iridescenceThicknessMaximum!==void 0&&(t.iridescenceThicknessRange[1]=i.iridescenceThicknessMaximum),i.iridescenceThicknessTexture!==void 0&&r.push(n.assignTexture(t,"iridescenceThicknessMap",i.iridescenceThicknessTexture)),Promise.all(r)}}class as{constructor(e){this.parser=e,this.name=x.KHR_MATERIALS_SHEEN}getMaterialType(e){const n=this.parser.json.materials[e];return!n.extensions||!n.extensions[this.name]?null:z}extendMaterialParams(e,t){const n=this.parser,s=n.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const r=[];t.sheenColor=new D(0,0,0),t.sheenRoughness=0,t.sheen=1;const i=s.extensions[this.name];if(i.sheenColorFactor!==void 0){const a=i.sheenColorFactor;t.sheenColor.setRGB(a[0],a[1],a[2],W)}return i.sheenRoughnessFactor!==void 0&&(t.sheenRoughness=i.sheenRoughnessFactor),i.sheenColorTexture!==void 0&&r.push(n.assignTexture(t,"sheenColorMap",i.sheenColorTexture,X)),i.sheenRoughnessTexture!==void 0&&r.push(n.assignTexture(t,"sheenRoughnessMap",i.sheenRoughnessTexture)),Promise.all(r)}}class os{constructor(e){this.parser=e,this.name=x.KHR_MATERIALS_TRANSMISSION}getMaterialType(e){const n=this.parser.json.materials[e];return!n.extensions||!n.extensions[this.name]?null:z}extendMaterialParams(e,t){const n=this.parser,s=n.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const r=[],i=s.extensions[this.name];return i.transmissionFactor!==void 0&&(t.transmission=i.transmissionFactor),i.transmissionTexture!==void 0&&r.push(n.assignTexture(t,"transmissionMap",i.transmissionTexture)),Promise.all(r)}}class cs{constructor(e){this.parser=e,this.name=x.KHR_MATERIALS_VOLUME}getMaterialType(e){const n=this.parser.json.materials[e];return!n.extensions||!n.extensions[this.name]?null:z}extendMaterialParams(e,t){const n=this.parser,s=n.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const r=[],i=s.extensions[this.name];t.thickness=i.thicknessFactor!==void 0?i.thicknessFactor:0,i.thicknessTexture!==void 0&&r.push(n.assignTexture(t,"thicknessMap",i.thicknessTexture)),t.attenuationDistance=i.attenuationDistance||1/0;const a=i.attenuationColor||[1,1,1];return t.attenuationColor=new D().setRGB(a[0],a[1],a[2],W),Promise.all(r)}}class ls{constructor(e){this.parser=e,this.name=x.KHR_MATERIALS_IOR}getMaterialType(e){const n=this.parser.json.materials[e];return!n.extensions||!n.extensions[this.name]?null:z}extendMaterialParams(e,t){const s=this.parser.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const r=s.extensions[this.name];return t.ior=r.ior!==void 0?r.ior:1.5,Promise.resolve()}}class us{constructor(e){this.parser=e,this.name=x.KHR_MATERIALS_SPECULAR}getMaterialType(e){const n=this.parser.json.materials[e];return!n.extensions||!n.extensions[this.name]?null:z}extendMaterialParams(e,t){const n=this.parser,s=n.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const r=[],i=s.extensions[this.name];t.specularIntensity=i.specularFactor!==void 0?i.specularFactor:1,i.specularTexture!==void 0&&r.push(n.assignTexture(t,"specularIntensityMap",i.specularTexture));const a=i.specularColorFactor||[1,1,1];return t.specularColor=new D().setRGB(a[0],a[1],a[2],W),i.specularColorTexture!==void 0&&r.push(n.assignTexture(t,"specularColorMap",i.specularColorTexture,X)),Promise.all(r)}}class hs{constructor(e){this.parser=e,this.name=x.EXT_MATERIALS_BUMP}getMaterialType(e){const n=this.parser.json.materials[e];return!n.extensions||!n.extensions[this.name]?null:z}extendMaterialParams(e,t){const n=this.parser,s=n.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const r=[],i=s.extensions[this.name];return t.bumpScale=i.bumpFactor!==void 0?i.bumpFactor:1,i.bumpTexture!==void 0&&r.push(n.assignTexture(t,"bumpMap",i.bumpTexture)),Promise.all(r)}}class ps{constructor(e){this.parser=e,this.name=x.KHR_MATERIALS_ANISOTROPY}getMaterialType(e){const n=this.parser.json.materials[e];return!n.extensions||!n.extensions[this.name]?null:z}extendMaterialParams(e,t){const n=this.parser,s=n.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const r=[],i=s.extensions[this.name];return i.anisotropyStrength!==void 0&&(t.anisotropy=i.anisotropyStrength),i.anisotropyRotation!==void 0&&(t.anisotropyRotation=i.anisotropyRotation),i.anisotropyTexture!==void 0&&r.push(n.assignTexture(t,"anisotropyMap",i.anisotropyTexture)),Promise.all(r)}}class fs{constructor(e){this.parser=e,this.name=x.KHR_TEXTURE_BASISU}loadTexture(e){const t=this.parser,n=t.json,s=n.textures[e];if(!s.extensions||!s.extensions[this.name])return null;const r=s.extensions[this.name],i=t.options.ktx2Loader;if(!i){if(n.extensionsRequired&&n.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setKTX2Loader must be called before loading KTX2 textures");return null}return t.loadTextureImage(e,r.source,i)}}class gs{constructor(e){this.parser=e,this.name=x.EXT_TEXTURE_WEBP,this.isSupported=null}loadTexture(e){const t=this.name,n=this.parser,s=n.json,r=s.textures[e];if(!r.extensions||!r.extensions[t])return null;const i=r.extensions[t],a=s.images[i.source];let o=n.textureLoader;if(a.uri){const u=n.options.manager.getHandler(a.uri);u!==null&&(o=u)}return this.detectSupport().then(function(u){if(u)return n.loadTextureImage(e,i.source,o);if(s.extensionsRequired&&s.extensionsRequired.indexOf(t)>=0)throw new Error("THREE.GLTFLoader: WebP required by asset but unsupported.");return n.loadTexture(e)})}detectSupport(){return this.isSupported||(this.isSupported=new Promise(function(e){const t=new Image;t.src="data:image/webp;base64,UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA",t.onload=t.onerror=function(){e(t.height===1)}})),this.isSupported}}class ms{constructor(e){this.parser=e,this.name=x.EXT_TEXTURE_AVIF,this.isSupported=null}loadTexture(e){const t=this.name,n=this.parser,s=n.json,r=s.textures[e];if(!r.extensions||!r.extensions[t])return null;const i=r.extensions[t],a=s.images[i.source];let o=n.textureLoader;if(a.uri){const u=n.options.manager.getHandler(a.uri);u!==null&&(o=u)}return this.detectSupport().then(function(u){if(u)return n.loadTextureImage(e,i.source,o);if(s.extensionsRequired&&s.extensionsRequired.indexOf(t)>=0)throw new Error("THREE.GLTFLoader: AVIF required by asset but unsupported.");return n.loadTexture(e)})}detectSupport(){return this.isSupported||(this.isSupported=new Promise(function(e){const t=new Image;t.src="data:image/avif;base64,AAAAIGZ0eXBhdmlmAAAAAGF2aWZtaWYxbWlhZk1BMUIAAADybWV0YQAAAAAAAAAoaGRscgAAAAAAAAAAcGljdAAAAAAAAAAAAAAAAGxpYmF2aWYAAAAADnBpdG0AAAAAAAEAAAAeaWxvYwAAAABEAAABAAEAAAABAAABGgAAABcAAAAoaWluZgAAAAAAAQAAABppbmZlAgAAAAABAABhdjAxQ29sb3IAAAAAamlwcnAAAABLaXBjbwAAABRpc3BlAAAAAAAAAAEAAAABAAAAEHBpeGkAAAAAAwgICAAAAAxhdjFDgQAMAAAAABNjb2xybmNseAACAAIABoAAAAAXaXBtYQAAAAAAAAABAAEEAQKDBAAAAB9tZGF0EgAKCBgABogQEDQgMgkQAAAAB8dSLfI=",t.onload=t.onerror=function(){e(t.height===1)}})),this.isSupported}}class ds{constructor(e){this.name=x.EXT_MESHOPT_COMPRESSION,this.parser=e}loadBufferView(e){const t=this.parser.json,n=t.bufferViews[e];if(n.extensions&&n.extensions[this.name]){const s=n.extensions[this.name],r=this.parser.getDependency("buffer",s.buffer),i=this.parser.options.meshoptDecoder;if(!i||!i.supported){if(t.extensionsRequired&&t.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setMeshoptDecoder must be called before loading compressed files");return null}return r.then(function(a){const o=s.byteOffset||0,u=s.byteLength||0,h=s.count,c=s.byteStride,p=new Uint8Array(a,o,u);return i.decodeGltfBufferAsync?i.decodeGltfBufferAsync(h,c,p,s.mode,s.filter).then(function(f){return f.buffer}):i.ready.then(function(){const f=new ArrayBuffer(h*c);return i.decodeGltfBuffer(new Uint8Array(f),h,c,p,s.mode,s.filter),f})})}else return null}}class _s{constructor(e){this.name=x.EXT_MESH_GPU_INSTANCING,this.parser=e}createNodeMesh(e){const t=this.parser.json,n=t.nodes[e];if(!n.extensions||!n.extensions[this.name]||n.mesh===void 0)return null;const s=t.meshes[n.mesh];for(const u of s.primitives)if(u.mode!==U.TRIANGLES&&u.mode!==U.TRIANGLE_STRIP&&u.mode!==U.TRIANGLE_FAN&&u.mode!==void 0)return null;const i=n.extensions[this.name].attributes,a=[],o={};for(const u in i)a.push(this.parser.getDependency("accessor",i[u]).then(h=>(o[u]=h,o[u])));return a.length<1?null:(a.push(this.parser.createNodeMesh(e)),Promise.all(a).then(u=>{const h=u.pop(),c=h.isGroup?h.children:[h],p=u[0].count,f=[];for(const g of c){const m=new R,d=new b,_=new O,T=new b(1,1,1),w=new nn(g.geometry,g.material,p);for(let y=0;y<p;y++)o.TRANSLATION&&d.fromBufferAttribute(o.TRANSLATION,y),o.ROTATION&&_.fromBufferAttribute(o.ROTATION,y),o.SCALE&&T.fromBufferAttribute(o.SCALE,y),w.setMatrixAt(y,m.compose(d,_,T));for(const y in o)if(y==="_COLOR_0"){const M=o[y];w.instanceColor=new sn(M.array,M.itemSize,M.normalized)}else y!=="TRANSLATION"&&y!=="ROTATION"&&y!=="SCALE"&&g.geometry.setAttribute(y,o[y]);oe.prototype.copy.call(w,g),this.parser.assignFinalMaterial(w),f.push(w)}return h.isGroup?(h.clear(),h.add(...f),h):f[0]}))}}const Pt="glTF",pe=12,lt={JSON:1313821514,BIN:5130562};class ws{constructor(e){this.name=x.KHR_BINARY_GLTF,this.content=null,this.body=null;const t=new DataView(e,0,pe),n=new TextDecoder;if(this.header={magic:n.decode(new Uint8Array(e.slice(0,4))),version:t.getUint32(4,!0),length:t.getUint32(8,!0)},this.header.magic!==Pt)throw new Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("THREE.GLTFLoader: Legacy binary file detected.");const s=this.header.length-pe,r=new DataView(e,pe);let i=0;for(;i<s;){const a=r.getUint32(i,!0);i+=4;const o=r.getUint32(i,!0);if(i+=4,o===lt.JSON){const u=new Uint8Array(e,pe+i,a);this.content=n.decode(u)}else if(o===lt.BIN){const u=pe+i;this.body=e.slice(u,u+a)}i+=a}if(this.content===null)throw new Error("THREE.GLTFLoader: JSON content not found.")}}class Ts{constructor(e,t){if(!t)throw new Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=x.KHR_DRACO_MESH_COMPRESSION,this.json=e,this.dracoLoader=t,this.dracoLoader.preload()}decodePrimitive(e,t){const n=this.json,s=this.dracoLoader,r=e.extensions[this.name].bufferView,i=e.extensions[this.name].attributes,a={},o={},u={};for(const h in i){const c=Xe[h]||h.toLowerCase();a[c]=i[h]}for(const h in e.attributes){const c=Xe[h]||h.toLowerCase();if(i[h]!==void 0){const p=n.accessors[e.attributes[h]],f=ce[p.componentType];u[c]=f.name,o[c]=p.normalized===!0}}return t.getDependency("bufferView",r).then(function(h){return new Promise(function(c,p){s.decodeDracoFile(h,function(f){for(const g in f.attributes){const m=f.attributes[g],d=o[g];d!==void 0&&(m.normalized=d)}c(f)},a,u,W,p)})})}}class ys{constructor(){this.name=x.KHR_TEXTURE_TRANSFORM}extendTexture(e,t){return(t.texCoord===void 0||t.texCoord===e.channel)&&t.offset===void 0&&t.rotation===void 0&&t.scale===void 0||(e=e.clone(),t.texCoord!==void 0&&(e.channel=t.texCoord),t.offset!==void 0&&e.offset.fromArray(t.offset),t.rotation!==void 0&&(e.rotation=t.rotation),t.scale!==void 0&&e.repeat.fromArray(t.scale),e.needsUpdate=!0),e}}class As{constructor(){this.name=x.KHR_MESH_QUANTIZATION}}class kt extends yn{constructor(e,t,n,s){super(e,t,n,s)}copySampleValue_(e){const t=this.resultBuffer,n=this.sampleValues,s=this.valueSize,r=e*s*3+s;for(let i=0;i!==s;i++)t[i]=n[r+i];return t}interpolate_(e,t,n,s){const r=this.resultBuffer,i=this.sampleValues,a=this.valueSize,o=a*2,u=a*3,h=s-t,c=(n-t)/h,p=c*c,f=p*c,g=e*u,m=g-u,d=-2*f+3*p,_=f-p,T=1-d,w=_-p+c;for(let y=0;y!==a;y++){const M=i[m+y+a],A=i[m+y+o]*h,F=i[g+y+a],S=i[g+y]*h;r[y]=T*M+w*A+d*F+_*S}return r}}const Fs=new O;class Es extends kt{interpolate_(e,t,n,s){const r=super.interpolate_(e,t,n,s);return Fs.fromArray(r).normalize().toArray(r),r}}const U={POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6},ce={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},ut={9728:un,9729:xt,9984:ln,9985:cn,9986:on,9987:Et},ht={33071:Ve,33648:hn,10497:de},be={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},Xe={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv1",TEXCOORD_2:"uv2",TEXCOORD_3:"uv3",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},Q={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},xs={CUBICSPLINE:void 0,LINEAR:bt,STEP:_n},He={OPAQUE:"OPAQUE",MASK:"MASK",BLEND:"BLEND"};function Ms(l){return l.DefaultMaterial===void 0&&(l.DefaultMaterial=new Rt({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:Tn})),l.DefaultMaterial}function Z(l,e,t){for(const n in t.extensions)l[n]===void 0&&(e.userData.gltfExtensions=e.userData.gltfExtensions||{},e.userData.gltfExtensions[n]=t.extensions[n])}function K(l,e){e.extras!==void 0&&(typeof e.extras=="object"?Object.assign(l.userData,e.extras):console.warn("THREE.GLTFLoader: Ignoring primitive type .extras, "+e.extras))}function Rs(l,e,t){let n=!1,s=!1,r=!1;for(let u=0,h=e.length;u<h;u++){const c=e[u];if(c.POSITION!==void 0&&(n=!0),c.NORMAL!==void 0&&(s=!0),c.COLOR_0!==void 0&&(r=!0),n&&s&&r)break}if(!n&&!s&&!r)return Promise.resolve(l);const i=[],a=[],o=[];for(let u=0,h=e.length;u<h;u++){const c=e[u];if(n){const p=c.POSITION!==void 0?t.getDependency("accessor",c.POSITION):l.attributes.position;i.push(p)}if(s){const p=c.NORMAL!==void 0?t.getDependency("accessor",c.NORMAL):l.attributes.normal;a.push(p)}if(r){const p=c.COLOR_0!==void 0?t.getDependency("accessor",c.COLOR_0):l.attributes.color;o.push(p)}}return Promise.all([Promise.all(i),Promise.all(a),Promise.all(o)]).then(function(u){const h=u[0],c=u[1],p=u[2];return n&&(l.morphAttributes.position=h),s&&(l.morphAttributes.normal=c),r&&(l.morphAttributes.color=p),l.morphTargetsRelative=!0,l})}function vs(l,e){if(l.updateMorphTargets(),e.weights!==void 0)for(let t=0,n=e.weights.length;t<n;t++)l.morphTargetInfluences[t]=e.weights[t];if(e.extras&&Array.isArray(e.extras.targetNames)){const t=e.extras.targetNames;if(l.morphTargetInfluences.length===t.length){l.morphTargetDictionary={};for(let n=0,s=t.length;n<s;n++)l.morphTargetDictionary[t[n]]=n}else console.warn("THREE.GLTFLoader: Invalid extras.targetNames length. Ignoring names.")}}function Ss(l){let e;const t=l.extensions&&l.extensions[x.KHR_DRACO_MESH_COMPRESSION];if(t?e="draco:"+t.bufferView+":"+t.indices+":"+Pe(t.attributes):e=l.indices+":"+Pe(l.attributes)+":"+l.mode,l.targets!==void 0)for(let n=0,s=l.targets.length;n<s;n++)e+=":"+Pe(l.targets[n]);return e}function Pe(l){let e="";const t=Object.keys(l).sort();for(let n=0,s=t.length;n<s;n++)e+=t[n]+":"+l[t[n]]+";";return e}function We(l){switch(l){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:throw new Error("THREE.GLTFLoader: Unsupported normalized accessor component type.")}}function Ls(l){return l.search(/\.jpe?g($|\?)/i)>0||l.search(/^data\:image\/jpeg/)===0?"image/jpeg":l.search(/\.webp($|\?)/i)>0||l.search(/^data\:image\/webp/)===0?"image/webp":"image/png"}const Ns=new R;class Is{constructor(e={},t={}){this.json=e,this.extensions={},this.plugins={},this.options=t,this.cache=new Zn,this.associations=new Map,this.primitiveCache={},this.nodeCache={},this.meshCache={refs:{},uses:{}},this.cameraCache={refs:{},uses:{}},this.lightCache={refs:{},uses:{}},this.sourceCache={},this.textureCache={},this.nodeNamesUsed={};let n=!1,s=-1,r=!1,i=-1;if(typeof navigator<"u"){const a=navigator.userAgent;n=/^((?!chrome|android).)*safari/i.test(a)===!0;const o=a.match(/Version\/(\d+)/);s=n&&o?parseInt(o[1],10):-1,r=a.indexOf("Firefox")>-1,i=r?a.match(/Firefox\/([0-9]+)\./)[1]:-1}typeof createImageBitmap>"u"||n&&s<17||r&&i<98?this.textureLoader=new Ft(this.options.manager):this.textureLoader=new rn(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.textureLoader.setRequestHeader(this.options.requestHeader),this.fileLoader=new Qe(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),this.options.crossOrigin==="use-credentials"&&this.fileLoader.setWithCredentials(!0)}setExtensions(e){this.extensions=e}setPlugins(e){this.plugins=e}parse(e,t){const n=this,s=this.json,r=this.extensions;this.cache.removeAll(),this.nodeCache={},this._invokeAll(function(i){return i._markDefs&&i._markDefs()}),Promise.all(this._invokeAll(function(i){return i.beforeRoot&&i.beforeRoot()})).then(function(){return Promise.all([n.getDependencies("scene"),n.getDependencies("animation"),n.getDependencies("camera")])}).then(function(i){const a={scene:i[0][s.scene||0],scenes:i[0],animations:i[1],cameras:i[2],asset:s.asset,parser:n,userData:{}};return Z(r,a,s),K(a,s),Promise.all(n._invokeAll(function(o){return o.afterRoot&&o.afterRoot(a)})).then(function(){for(const o of a.scenes)o.updateMatrixWorld();e(a)})}).catch(t)}_markDefs(){const e=this.json.nodes||[],t=this.json.skins||[],n=this.json.meshes||[];for(let s=0,r=t.length;s<r;s++){const i=t[s].joints;for(let a=0,o=i.length;a<o;a++)e[i[a]].isBone=!0}for(let s=0,r=e.length;s<r;s++){const i=e[s];i.mesh!==void 0&&(this._addNodeRef(this.meshCache,i.mesh),i.skin!==void 0&&(n[i.mesh].isSkinnedMesh=!0)),i.camera!==void 0&&this._addNodeRef(this.cameraCache,i.camera)}}_addNodeRef(e,t){t!==void 0&&(e.refs[t]===void 0&&(e.refs[t]=e.uses[t]=0),e.refs[t]++)}_getNodeRef(e,t,n){if(e.refs[t]<=1)return n;const s=n.clone(),r=(i,a)=>{const o=this.associations.get(i);o!=null&&this.associations.set(a,o);for(const[u,h]of i.children.entries())r(h,a.children[u])};return r(n,s),s.name+="_instance_"+e.uses[t]++,s}_invokeOne(e){const t=Object.values(this.plugins);t.push(this);for(let n=0;n<t.length;n++){const s=e(t[n]);if(s)return s}return null}_invokeAll(e){const t=Object.values(this.plugins);t.unshift(this);const n=[];for(let s=0;s<t.length;s++){const r=e(t[s]);r&&n.push(r)}return n}getDependency(e,t){const n=e+":"+t;let s=this.cache.get(n);if(!s){switch(e){case"scene":s=this.loadScene(t);break;case"node":s=this._invokeOne(function(r){return r.loadNode&&r.loadNode(t)});break;case"mesh":s=this._invokeOne(function(r){return r.loadMesh&&r.loadMesh(t)});break;case"accessor":s=this.loadAccessor(t);break;case"bufferView":s=this._invokeOne(function(r){return r.loadBufferView&&r.loadBufferView(t)});break;case"buffer":s=this.loadBuffer(t);break;case"material":s=this._invokeOne(function(r){return r.loadMaterial&&r.loadMaterial(t)});break;case"texture":s=this._invokeOne(function(r){return r.loadTexture&&r.loadTexture(t)});break;case"skin":s=this.loadSkin(t);break;case"animation":s=this._invokeOne(function(r){return r.loadAnimation&&r.loadAnimation(t)});break;case"camera":s=this.loadCamera(t);break;default:if(s=this._invokeOne(function(r){return r!=this&&r.getDependency&&r.getDependency(e,t)}),!s)throw new Error("Unknown type: "+e);break}this.cache.add(n,s)}return s}getDependencies(e){let t=this.cache.get(e);if(!t){const n=this,s=this.json[e+(e==="mesh"?"es":"s")]||[];t=Promise.all(s.map(function(r,i){return n.getDependency(e,i)})),this.cache.add(e,t)}return t}loadBuffer(e){const t=this.json.buffers[e],n=this.fileLoader;if(t.type&&t.type!=="arraybuffer")throw new Error("THREE.GLTFLoader: "+t.type+" buffer type is not supported.");if(t.uri===void 0&&e===0)return Promise.resolve(this.extensions[x.KHR_BINARY_GLTF].body);const s=this.options;return new Promise(function(r,i){n.load(ae.resolveURL(t.uri,s.path),r,void 0,function(){i(new Error('THREE.GLTFLoader: Failed to load buffer "'+t.uri+'".'))})})}loadBufferView(e){const t=this.json.bufferViews[e];return this.getDependency("buffer",t.buffer).then(function(n){const s=t.byteLength||0,r=t.byteOffset||0;return n.slice(r,r+s)})}loadAccessor(e){const t=this,n=this.json,s=this.json.accessors[e];if(s.bufferView===void 0&&s.sparse===void 0){const i=be[s.type],a=ce[s.componentType],o=s.normalized===!0,u=new a(s.count*i);return Promise.resolve(new Le(u,i,o))}const r=[];return s.bufferView!==void 0?r.push(this.getDependency("bufferView",s.bufferView)):r.push(null),s.sparse!==void 0&&(r.push(this.getDependency("bufferView",s.sparse.indices.bufferView)),r.push(this.getDependency("bufferView",s.sparse.values.bufferView))),Promise.all(r).then(function(i){const a=i[0],o=be[s.type],u=ce[s.componentType],h=u.BYTES_PER_ELEMENT,c=h*o,p=s.byteOffset||0,f=s.bufferView!==void 0?n.bufferViews[s.bufferView].byteStride:void 0,g=s.normalized===!0;let m,d;if(f&&f!==c){const _=Math.floor(p/f),T="InterleavedBuffer:"+s.bufferView+":"+s.componentType+":"+_+":"+s.count;let w=t.cache.get(T);w||(m=new u(a,_*f,s.count*f/h),w=new an(m,f/h),t.cache.add(T,w)),d=new wn(w,o,p%f/h,g)}else a===null?m=new u(s.count*o):m=new u(a,p,s.count*o),d=new Le(m,o,g);if(s.sparse!==void 0){const _=be.SCALAR,T=ce[s.sparse.indices.componentType],w=s.sparse.indices.byteOffset||0,y=s.sparse.values.byteOffset||0,M=new T(i[1],w,s.sparse.count*_),A=new u(i[2],y,s.sparse.count*o);a!==null&&(d=new Le(d.array.slice(),d.itemSize,d.normalized));for(let F=0,S=M.length;F<S;F++){const L=M[F];if(d.setX(L,A[F*o]),o>=2&&d.setY(L,A[F*o+1]),o>=3&&d.setZ(L,A[F*o+2]),o>=4&&d.setW(L,A[F*o+3]),o>=5)throw new Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}}return d})}loadTexture(e){const t=this.json,n=this.options,r=t.textures[e].source,i=t.images[r];let a=this.textureLoader;if(i.uri){const o=n.manager.getHandler(i.uri);o!==null&&(a=o)}return this.loadTextureImage(e,r,a)}loadTextureImage(e,t,n){const s=this,r=this.json,i=r.textures[e],a=r.images[t],o=(a.uri||a.bufferView)+":"+i.sampler;if(this.textureCache[o])return this.textureCache[o];const u=this.loadImageSource(t,n).then(function(h){h.flipY=!1,h.name=i.name||a.name||"",h.name===""&&typeof a.uri=="string"&&a.uri.startsWith("data:image/")===!1&&(h.name=a.uri);const p=(r.samplers||{})[i.sampler]||{};return h.magFilter=ut[p.magFilter]||xt,h.minFilter=ut[p.minFilter]||Et,h.wrapS=ht[p.wrapS]||de,h.wrapT=ht[p.wrapT]||de,s.associations.set(h,{textures:e}),h}).catch(function(){return null});return this.textureCache[o]=u,u}loadImageSource(e,t){const n=this,s=this.json,r=this.options;if(this.sourceCache[e]!==void 0)return this.sourceCache[e].then(c=>c.clone());const i=s.images[e],a=self.URL||self.webkitURL;let o=i.uri||"",u=!1;if(i.bufferView!==void 0)o=n.getDependency("bufferView",i.bufferView).then(function(c){u=!0;const p=new Blob([c],{type:i.mimeType});return o=a.createObjectURL(p),o});else if(i.uri===void 0)throw new Error("THREE.GLTFLoader: Image "+e+" is missing URI and bufferView");const h=Promise.resolve(o).then(function(c){return new Promise(function(p,f){let g=p;t.isImageBitmapLoader===!0&&(g=function(m){const d=new Ye(m);d.needsUpdate=!0,p(d)}),t.load(ae.resolveURL(c,r.path),g,void 0,f)})}).then(function(c){return u===!0&&a.revokeObjectURL(o),K(c,i),c.userData.mimeType=i.mimeType||Ls(i.uri),c}).catch(function(c){throw console.error("THREE.GLTFLoader: Couldn't load texture",o),c});return this.sourceCache[e]=h,h}assignTexture(e,t,n,s){const r=this;return this.getDependency("texture",n.index).then(function(i){if(!i)return null;if(n.texCoord!==void 0&&n.texCoord>0&&(i=i.clone(),i.channel=n.texCoord),r.extensions[x.KHR_TEXTURE_TRANSFORM]){const a=n.extensions!==void 0?n.extensions[x.KHR_TEXTURE_TRANSFORM]:void 0;if(a){const o=r.associations.get(i);i=r.extensions[x.KHR_TEXTURE_TRANSFORM].extendTexture(i,a),r.associations.set(i,o)}}return s!==void 0&&(i.colorSpace=s),e[t]=i,i})}assignFinalMaterial(e){const t=e.geometry;let n=e.material;const s=t.attributes.tangent===void 0,r=t.attributes.color!==void 0,i=t.attributes.normal===void 0;if(e.isPoints){const a="PointsMaterial:"+n.uuid;let o=this.cache.get(a);o||(o=new pn,Ne.prototype.copy.call(o,n),o.color.copy(n.color),o.map=n.map,o.sizeAttenuation=!1,this.cache.add(a,o)),n=o}else if(e.isLine){const a="LineBasicMaterial:"+n.uuid;let o=this.cache.get(a);o||(o=new Mt,Ne.prototype.copy.call(o,n),o.color.copy(n.color),o.map=n.map,this.cache.add(a,o)),n=o}if(s||r||i){let a="ClonedMaterial:"+n.uuid+":";s&&(a+="derivative-tangents:"),r&&(a+="vertex-colors:"),i&&(a+="flat-shading:");let o=this.cache.get(a);o||(o=n.clone(),r&&(o.vertexColors=!0),i&&(o.flatShading=!0),s&&(o.normalScale&&(o.normalScale.y*=-1),o.clearcoatNormalScale&&(o.clearcoatNormalScale.y*=-1)),this.cache.add(a,o),this.associations.set(o,this.associations.get(n))),n=o}e.material=n}getMaterialType(){return Rt}loadMaterial(e){const t=this,n=this.json,s=this.extensions,r=n.materials[e];let i;const a={},o=r.extensions||{},u=[];if(o[x.KHR_MATERIALS_UNLIT]){const c=s[x.KHR_MATERIALS_UNLIT];i=c.getMaterialType(),u.push(c.extendParams(a,r,t))}else{const c=r.pbrMetallicRoughness||{};if(a.color=new D(1,1,1),a.opacity=1,Array.isArray(c.baseColorFactor)){const p=c.baseColorFactor;a.color.setRGB(p[0],p[1],p[2],W),a.opacity=p[3]}c.baseColorTexture!==void 0&&u.push(t.assignTexture(a,"map",c.baseColorTexture,X)),a.metalness=c.metallicFactor!==void 0?c.metallicFactor:1,a.roughness=c.roughnessFactor!==void 0?c.roughnessFactor:1,c.metallicRoughnessTexture!==void 0&&(u.push(t.assignTexture(a,"metalnessMap",c.metallicRoughnessTexture)),u.push(t.assignTexture(a,"roughnessMap",c.metallicRoughnessTexture))),i=this._invokeOne(function(p){return p.getMaterialType&&p.getMaterialType(e)}),u.push(Promise.all(this._invokeAll(function(p){return p.extendMaterialParams&&p.extendMaterialParams(e,a)})))}r.doubleSided===!0&&(a.side=fn);const h=r.alphaMode||He.OPAQUE;if(h===He.BLEND?(a.transparent=!0,a.depthWrite=!1):(a.transparent=!1,h===He.MASK&&(a.alphaTest=r.alphaCutoff!==void 0?r.alphaCutoff:.5)),r.normalTexture!==void 0&&i!==fe&&(u.push(t.assignTexture(a,"normalMap",r.normalTexture)),a.normalScale=new Je(1,1),r.normalTexture.scale!==void 0)){const c=r.normalTexture.scale;a.normalScale.set(c,c)}if(r.occlusionTexture!==void 0&&i!==fe&&(u.push(t.assignTexture(a,"aoMap",r.occlusionTexture)),r.occlusionTexture.strength!==void 0&&(a.aoMapIntensity=r.occlusionTexture.strength)),r.emissiveFactor!==void 0&&i!==fe){const c=r.emissiveFactor;a.emissive=new D().setRGB(c[0],c[1],c[2],W)}return r.emissiveTexture!==void 0&&i!==fe&&u.push(t.assignTexture(a,"emissiveMap",r.emissiveTexture,X)),Promise.all(u).then(function(){const c=new i(a);return r.name&&(c.name=r.name),K(c,r),t.associations.set(c,{materials:e}),r.extensions&&Z(s,c,r),c})}createUniqueName(e){const t=_e.sanitizeNodeName(e||"");return t in this.nodeNamesUsed?t+"_"+ ++this.nodeNamesUsed[t]:(this.nodeNamesUsed[t]=0,t)}loadGeometries(e){const t=this,n=this.extensions,s=this.primitiveCache;function r(a){return n[x.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(a,t).then(function(o){return pt(o,a,t)})}const i=[];for(let a=0,o=e.length;a<o;a++){const u=e[a],h=Ss(u),c=s[h];if(c)i.push(c.promise);else{let p;u.extensions&&u.extensions[x.KHR_DRACO_MESH_COMPRESSION]?p=r(u):p=pt(new Fe,u,t),s[h]={primitive:u,promise:p},i.push(p)}}return Promise.all(i)}loadMesh(e){const t=this,n=this.json,s=this.extensions,r=n.meshes[e],i=r.primitives,a=[];for(let o=0,u=i.length;o<u;o++){const h=i[o].material===void 0?Ms(this.cache):this.getDependency("material",i[o].material);a.push(h)}return a.push(t.loadGeometries(i)),Promise.all(a).then(function(o){const u=o.slice(0,o.length-1),h=o[o.length-1],c=[];for(let f=0,g=h.length;f<g;f++){const m=h[f],d=i[f];let _;const T=u[f];if(d.mode===U.TRIANGLES||d.mode===U.TRIANGLE_STRIP||d.mode===U.TRIANGLE_FAN||d.mode===void 0)_=r.isSkinnedMesh===!0?new vt(m,T):new $e(m,T),_.isSkinnedMesh===!0&&_.normalizeSkinWeights(),d.mode===U.TRIANGLE_STRIP?_.geometry=ct(_.geometry,Tt):d.mode===U.TRIANGLE_FAN&&(_.geometry=ct(_.geometry,Ue));else if(d.mode===U.LINES)_=new gn(m,T);else if(d.mode===U.LINE_STRIP)_=new St(m,T);else if(d.mode===U.LINE_LOOP)_=new mn(m,T);else if(d.mode===U.POINTS)_=new dn(m,T);else throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+d.mode);Object.keys(_.geometry.morphAttributes).length>0&&vs(_,r),_.name=t.createUniqueName(r.name||"mesh_"+e),K(_,r),d.extensions&&Z(s,_,d),t.assignFinalMaterial(_),c.push(_)}for(let f=0,g=c.length;f<g;f++)t.associations.set(c[f],{meshes:e,primitives:f});if(c.length===1)return r.extensions&&Z(s,c[0],r),c[0];const p=new ge;r.extensions&&Z(s,p,r),t.associations.set(p,{meshes:e});for(let f=0,g=c.length;f<g;f++)p.add(c[f]);return p})}loadCamera(e){let t;const n=this.json.cameras[e],s=n[n.type];if(!s){console.warn("THREE.GLTFLoader: Missing camera parameters.");return}return n.type==="perspective"?t=new Lt(k.radToDeg(s.yfov),s.aspectRatio||1,s.znear||1,s.zfar||2e6):n.type==="orthographic"&&(t=new Nt(-s.xmag,s.xmag,s.ymag,-s.ymag,s.znear,s.zfar)),n.name&&(t.name=this.createUniqueName(n.name)),K(t,n),Promise.resolve(t)}loadSkin(e){const t=this.json.skins[e],n=[];for(let s=0,r=t.joints.length;s<r;s++)n.push(this._loadNodeShallow(t.joints[s]));return t.inverseBindMatrices!==void 0?n.push(this.getDependency("accessor",t.inverseBindMatrices)):n.push(null),Promise.all(n).then(function(s){const r=s.pop(),i=s,a=[],o=[];for(let u=0,h=i.length;u<h;u++){const c=i[u];if(c){a.push(c);const p=new R;r!==null&&p.fromArray(r.array,u*16),o.push(p)}else console.warn('THREE.GLTFLoader: Joint "%s" could not be found.',t.joints[u])}return new It(a,o)})}loadAnimation(e){const t=this.json,n=this,s=t.animations[e],r=s.name?s.name:"animation_"+e,i=[],a=[],o=[],u=[],h=[];for(let c=0,p=s.channels.length;c<p;c++){const f=s.channels[c],g=s.samplers[f.sampler],m=f.target,d=m.node,_=s.parameters!==void 0?s.parameters[g.input]:g.input,T=s.parameters!==void 0?s.parameters[g.output]:g.output;m.node!==void 0&&(i.push(this.getDependency("node",d)),a.push(this.getDependency("accessor",_)),o.push(this.getDependency("accessor",T)),u.push(g),h.push(m))}return Promise.all([Promise.all(i),Promise.all(a),Promise.all(o),Promise.all(u),Promise.all(h)]).then(function(c){const p=c[0],f=c[1],g=c[2],m=c[3],d=c[4],_=[];for(let T=0,w=p.length;T<w;T++){const y=p[T],M=f[T],A=g[T],F=m[T],S=d[T];if(y===void 0)continue;y.updateMatrix&&y.updateMatrix();const L=n._createAnimationTracks(y,M,A,F,S);if(L)for(let N=0;N<L.length;N++)_.push(L[N])}return new xe(r,void 0,_)})}createNodeMesh(e){const t=this.json,n=this,s=t.nodes[e];return s.mesh===void 0?null:n.getDependency("mesh",s.mesh).then(function(r){const i=n._getNodeRef(n.meshCache,s.mesh,r);return s.weights!==void 0&&i.traverse(function(a){if(a.isMesh)for(let o=0,u=s.weights.length;o<u;o++)a.morphTargetInfluences[o]=s.weights[o]}),i})}loadNode(e){const t=this.json,n=this,s=t.nodes[e],r=n._loadNodeShallow(e),i=[],a=s.children||[];for(let u=0,h=a.length;u<h;u++)i.push(n.getDependency("node",a[u]));const o=s.skin===void 0?Promise.resolve(null):n.getDependency("skin",s.skin);return Promise.all([r,Promise.all(i),o]).then(function(u){const h=u[0],c=u[1],p=u[2];p!==null&&h.traverse(function(f){f.isSkinnedMesh&&f.bind(p,Ns)});for(let f=0,g=c.length;f<g;f++)h.add(c[f]);return h})}_loadNodeShallow(e){const t=this.json,n=this.extensions,s=this;if(this.nodeCache[e]!==void 0)return this.nodeCache[e];const r=t.nodes[e],i=r.name?s.createUniqueName(r.name):"",a=[],o=s._invokeOne(function(u){return u.createNodeMesh&&u.createNodeMesh(e)});return o&&a.push(o),r.camera!==void 0&&a.push(s.getDependency("camera",r.camera).then(function(u){return s._getNodeRef(s.cameraCache,r.camera,u)})),s._invokeAll(function(u){return u.createNodeAttachment&&u.createNodeAttachment(e)}).forEach(function(u){a.push(u)}),this.nodeCache[e]=Promise.all(a).then(function(u){let h;if(r.isBone===!0?h=new je:u.length>1?h=new ge:u.length===1?h=u[0]:h=new oe,h!==u[0])for(let c=0,p=u.length;c<p;c++)h.add(u[c]);if(r.name&&(h.userData.name=r.name,h.name=i),K(h,r),r.extensions&&Z(n,h,r),r.matrix!==void 0){const c=new R;c.fromArray(r.matrix),h.applyMatrix4(c)}else r.translation!==void 0&&h.position.fromArray(r.translation),r.rotation!==void 0&&h.quaternion.fromArray(r.rotation),r.scale!==void 0&&h.scale.fromArray(r.scale);return s.associations.has(h)||s.associations.set(h,{}),s.associations.get(h).nodes=e,h}),this.nodeCache[e]}loadScene(e){const t=this.extensions,n=this.json.scenes[e],s=this,r=new ge;n.name&&(r.name=s.createUniqueName(n.name)),K(r,n),n.extensions&&Z(t,r,n);const i=n.nodes||[],a=[];for(let o=0,u=i.length;o<u;o++)a.push(s.getDependency("node",i[o]));return Promise.all(a).then(function(o){for(let h=0,c=o.length;h<c;h++)r.add(o[h]);const u=h=>{const c=new Map;for(const[p,f]of s.associations)(p instanceof Ne||p instanceof Ye)&&c.set(p,f);return h.traverse(p=>{const f=s.associations.get(p);f!=null&&c.set(p,f)}),c};return s.associations=u(r),r})}_createAnimationTracks(e,t,n,s,r){const i=[],a=e.name?e.name:e.uuid,o=[];Q[r.path]===Q.weights?e.traverse(function(p){p.morphTargetInfluences&&o.push(p.name?p.name:p.uuid)}):o.push(a);let u;switch(Q[r.path]){case Q.weights:u=ze;break;case Q.rotation:u=ue;break;case Q.position:case Q.scale:u=le;break;default:switch(n.itemSize){case 1:u=ze;break;case 2:case 3:default:u=le;break}break}const h=s.interpolation!==void 0?xs[s.interpolation]:bt,c=this._getArrayFromAccessor(n);for(let p=0,f=o.length;p<f;p++){const g=new u(o[p]+"."+Q[r.path],t.array,c,h);s.interpolation==="CUBICSPLINE"&&this._createCubicSplineTrackInterpolant(g),i.push(g)}return i}_getArrayFromAccessor(e){let t=e.array;if(e.normalized){const n=We(t.constructor),s=new Float32Array(t.length);for(let r=0,i=t.length;r<i;r++)s[r]=t[r]*n;t=s}return t}_createCubicSplineTrackInterpolant(e){e.createInterpolant=function(n){const s=this instanceof ue?Es:kt;return new s(this.times,this.values,this.getValueSize()/3,n)},e.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0}}function bs(l,e,t){const n=e.attributes,s=new An;if(n.POSITION!==void 0){const a=t.json.accessors[n.POSITION],o=a.min,u=a.max;if(o!==void 0&&u!==void 0){if(s.set(new b(o[0],o[1],o[2]),new b(u[0],u[1],u[2])),a.normalized){const h=We(ce[a.componentType]);s.min.multiplyScalar(h),s.max.multiplyScalar(h)}}else{console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.");return}}else return;const r=e.targets;if(r!==void 0){const a=new b,o=new b;for(let u=0,h=r.length;u<h;u++){const c=r[u];if(c.POSITION!==void 0){const p=t.json.accessors[c.POSITION],f=p.min,g=p.max;if(f!==void 0&&g!==void 0){if(o.setX(Math.max(Math.abs(f[0]),Math.abs(g[0]))),o.setY(Math.max(Math.abs(f[1]),Math.abs(g[1]))),o.setZ(Math.max(Math.abs(f[2]),Math.abs(g[2]))),p.normalized){const m=We(ce[p.componentType]);o.multiplyScalar(m)}a.max(o)}else console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.")}}s.expandByVector(a)}l.boundingBox=s;const i=new Fn;s.getCenter(i.center),i.radius=s.min.distanceTo(s.max)/2,l.boundingSphere=i}function pt(l,e,t){const n=e.attributes,s=[];function r(i,a){return t.getDependency("accessor",i).then(function(o){l.setAttribute(a,o)})}for(const i in n){const a=Xe[i]||i.toLowerCase();a in l.attributes||s.push(r(n[i],a))}if(e.indices!==void 0&&!l.index){const i=t.getDependency("accessor",e.indices).then(function(a){l.setIndex(a)});s.push(i)}return ot.workingColorSpace!==W&&"COLOR_0"in n&&console.warn(`THREE.GLTFLoader: Converting vertex colors from "srgb-linear" to "${ot.workingColorSpace}" not supported.`),K(l,e),bs(l,e,t),Promise.all(s).then(function(){return e.targets!==void 0?Rs(l,e.targets,t):l})}function Hs(){const l=new $n;return l.register(e=>{const t=new En(e,{materialType:xn});return new Mn(e,{mtoonMaterialPlugin:t})}),l}/*!
fflate - fast JavaScript compression/decompression
<https://101arrowz.github.io/fflate>
Licensed under MIT. https://github.com/101arrowz/fflate/blob/master/LICENSE
version 0.8.2
*/var G=Uint8Array,ie=Uint16Array,Ps=Int32Array,Dt=new G([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),Ct=new G([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),ks=new G([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),Bt=function(l,e){for(var t=new ie(31),n=0;n<31;++n)t[n]=e+=1<<l[n-1];for(var s=new Ps(t[30]),n=1;n<30;++n)for(var r=t[n];r<t[n+1];++r)s[r]=r-t[n]<<5|n;return{b:t,r:s}},Ot=Bt(Dt,2),Ut=Ot.b,Ds=Ot.r;Ut[28]=258,Ds[258]=28;var Cs=Bt(Ct,0),Bs=Cs.b,qe=new ie(32768);for(var v=0;v<32768;++v){var J=(v&43690)>>1|(v&21845)<<1;J=(J&52428)>>2|(J&13107)<<2,J=(J&61680)>>4|(J&3855)<<4,qe[v]=((J&65280)>>8|(J&255)<<8)>>1}var me=function(l,e,t){for(var n=l.length,s=0,r=new ie(e);s<n;++s)l[s]&&++r[l[s]-1];var i=new ie(e);for(s=1;s<e;++s)i[s]=i[s-1]+r[s-1]<<1;var a;if(t){a=new ie(1<<e);var o=15-e;for(s=0;s<n;++s)if(l[s])for(var u=s<<4|l[s],h=e-l[s],c=i[l[s]-1]++<<h,p=c|(1<<h)-1;c<=p;++c)a[qe[c]>>o]=u}else for(a=new ie(n),s=0;s<n;++s)l[s]&&(a[s]=qe[i[l[s]-1]++]>>15-l[s]);return a},we=new G(288);for(var v=0;v<144;++v)we[v]=8;for(var v=144;v<256;++v)we[v]=9;for(var v=256;v<280;++v)we[v]=7;for(var v=280;v<288;++v)we[v]=8;var Gt=new G(32);for(var v=0;v<32;++v)Gt[v]=5;var Os=me(we,9,1),Us=me(Gt,5,1),ke=function(l){for(var e=l[0],t=1;t<l.length;++t)l[t]>e&&(e=l[t]);return e},V=function(l,e,t){var n=e/8|0;return(l[n]|l[n+1]<<8)>>(e&7)&t},De=function(l,e){var t=e/8|0;return(l[t]|l[t+1]<<8|l[t+2]<<16)>>(e&7)},Gs=function(l){return(l+7)/8|0},Vs=function(l,e,t){return(t==null||t>l.length)&&(t=l.length),new G(l.subarray(e,t))},js=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],j=function(l,e,t){var n=new Error(e||js[l]);if(n.code=l,Error.captureStackTrace&&Error.captureStackTrace(n,j),!t)throw n;return n},Ys=function(l,e,t,n){var s=l.length,r=0;if(!s||e.f&&!e.l)return t||new G(0);var i=!t,a=i||e.i!=2,o=e.i;i&&(t=new G(s*3));var u=function(rt){var it=t.length;if(rt>it){var at=new G(Math.max(it*2,rt));at.set(t),t=at}},h=e.f||0,c=e.p||0,p=e.b||0,f=e.l,g=e.d,m=e.m,d=e.n,_=s*8;do{if(!f){h=V(l,c,1);var T=V(l,c+1,3);if(c+=3,T)if(T==1)f=Os,g=Us,m=9,d=5;else if(T==2){var A=V(l,c,31)+257,F=V(l,c+10,15)+4,S=A+V(l,c+5,31)+1;c+=14;for(var L=new G(S),N=new G(19),P=0;P<F;++P)N[ks[P]]=V(l,c+P*3,7);c+=F*3;for(var ee=ke(N),qt=(1<<ee)-1,Qt=me(N,ee,1),P=0;P<S;){var Ze=Qt[V(l,c,qt)];c+=Ze&15;var w=Ze>>4;if(w<16)L[P++]=w;else{var te=0,Te=0;for(w==16?(Te=3+V(l,c,3),c+=2,te=L[P-1]):w==17?(Te=3+V(l,c,7),c+=3):w==18&&(Te=11+V(l,c,127),c+=7);Te--;)L[P++]=te}}var et=L.subarray(0,A),q=L.subarray(A);m=ke(et),d=ke(q),f=me(et,m,1),g=me(q,d,1)}else j(1);else{var w=Gs(c)+4,y=l[w-4]|l[w-3]<<8,M=w+y;if(M>s){o&&j(0);break}a&&u(p+y),t.set(l.subarray(w,M),p),e.b=p+=y,e.p=c=M*8,e.f=h;continue}if(c>_){o&&j(0);break}}a&&u(p+131072);for(var Jt=(1<<m)-1,$t=(1<<d)-1,Re=c;;Re=c){var te=f[De(l,c)&Jt],ne=te>>4;if(c+=te&15,c>_){o&&j(0);break}if(te||j(2),ne<256)t[p++]=ne;else if(ne==256){Re=c,f=null;break}else{var tt=ne-254;if(ne>264){var P=ne-257,he=Dt[P];tt=V(l,c,(1<<he)-1)+Ut[P],c+=he}var ve=g[De(l,c)&$t],Se=ve>>4;ve||j(3),c+=ve&15;var q=Bs[Se];if(Se>3){var he=Ct[Se];q+=De(l,c)&(1<<he)-1,c+=he}if(c>_){o&&j(0);break}a&&u(p+131072);var nt=p+tt;if(p<q){var st=r-q,Zt=Math.min(q,nt);for(st+p<0&&j(3);p<Zt;++p)t[p]=n[st+p]}for(;p<nt;++p)t[p]=t[p-q]}}e.l=f,e.p=Re,e.b=p,e.f=h,f&&(h=1,e.m=m,e.d=g,e.n=d)}while(!h);return p!=t.length&&i?Vs(t,0,p):t.subarray(0,p)},zs=new G(0),Ks=function(l,e){return((l[0]&15)!=8||l[0]>>4>7||(l[0]<<8|l[1])%31)&&j(6,"invalid zlib data"),(l[1]>>5&1)==1&&j(6,"invalid zlib data: "+(l[1]&32?"need":"unexpected")+" dictionary"),(l[1]>>3&4)+2};function Xs(l,e){return Ys(l.subarray(Ks(l),-4),{i:2},e,e)}var Ws=typeof TextDecoder<"u"&&new TextDecoder,qs=0;try{Ws.decode(zs,{stream:!0}),qs=1}catch{}function Vt(l,e,t){const n=t.length-l-1;if(e>=t[n])return n-1;if(e<=t[l])return l;let s=l,r=n,i=Math.floor((s+r)/2);for(;e<t[i]||e>=t[i+1];)e<t[i]?r=i:s=i,i=Math.floor((s+r)/2);return i}function Qs(l,e,t,n){const s=[],r=[],i=[];s[0]=1;for(let a=1;a<=t;++a){r[a]=e-n[l+1-a],i[a]=n[l+a]-e;let o=0;for(let u=0;u<a;++u){const h=i[u+1],c=r[a-u],p=s[u]/(h+c);s[u]=o+h*p,o=c*p}s[a]=o}return s}function Js(l,e,t,n){const s=Vt(l,n,e),r=Qs(s,n,l,e),i=new Me(0,0,0,0);for(let a=0;a<=l;++a){const o=t[s-l+a],u=r[a],h=o.w*u;i.x+=o.x*h,i.y+=o.y*h,i.z+=o.z*h,i.w+=o.w*u}return i}function $s(l,e,t,n,s){const r=[];for(let c=0;c<=t;++c)r[c]=0;const i=[];for(let c=0;c<=n;++c)i[c]=r.slice(0);const a=[];for(let c=0;c<=t;++c)a[c]=r.slice(0);a[0][0]=1;const o=r.slice(0),u=r.slice(0);for(let c=1;c<=t;++c){o[c]=e-s[l+1-c],u[c]=s[l+c]-e;let p=0;for(let f=0;f<c;++f){const g=u[f+1],m=o[c-f];a[c][f]=g+m;const d=a[f][c-1]/a[c][f];a[f][c]=p+g*d,p=m*d}a[c][c]=p}for(let c=0;c<=t;++c)i[0][c]=a[c][t];for(let c=0;c<=t;++c){let p=0,f=1;const g=[];for(let m=0;m<=t;++m)g[m]=r.slice(0);g[0][0]=1;for(let m=1;m<=n;++m){let d=0;const _=c-m,T=t-m;c>=m&&(g[f][0]=g[p][0]/a[T+1][_],d=g[f][0]*a[_][T]);const w=_>=-1?1:-_,y=c-1<=T?m-1:t-c;for(let A=w;A<=y;++A)g[f][A]=(g[p][A]-g[p][A-1])/a[T+1][_+A],d+=g[f][A]*a[_+A][T];c<=T&&(g[f][m]=-g[p][m-1]/a[T+1][c],d+=g[f][m]*a[c][T]),i[m][c]=d;const M=p;p=f,f=M}}let h=t;for(let c=1;c<=n;++c){for(let p=0;p<=t;++p)i[c][p]*=h;h*=t-c}return i}function Zs(l,e,t,n,s){const r=s<l?s:l,i=[],a=Vt(l,n,e),o=$s(a,n,l,r,e),u=[];for(let h=0;h<t.length;++h){const c=t[h].clone(),p=c.w;c.x*=p,c.y*=p,c.z*=p,u[h]=c}for(let h=0;h<=r;++h){const c=u[a-l].clone().multiplyScalar(o[h][0]);for(let p=1;p<=l;++p)c.add(u[a-l+p].clone().multiplyScalar(o[h][p]));i[h]=c}for(let h=r+1;h<=s+1;++h)i[h]=new Me(0,0,0);return i}function er(l,e){let t=1;for(let s=2;s<=l;++s)t*=s;let n=1;for(let s=2;s<=e;++s)n*=s;for(let s=2;s<=l-e;++s)n*=s;return t/n}function tr(l){const e=l.length,t=[],n=[];for(let r=0;r<e;++r){const i=l[r];t[r]=new b(i.x,i.y,i.z),n[r]=i.w}const s=[];for(let r=0;r<e;++r){const i=t[r].clone();for(let a=1;a<=r;++a)i.sub(s[r-a].clone().multiplyScalar(er(r,a)*n[a]));s[r]=i.divideScalar(n[0])}return s}function nr(l,e,t,n,s){const r=Zs(l,e,t,n,s);return tr(r)}class sr extends Rn{constructor(e,t,n,s,r){super(),this.degree=e,this.knots=t,this.controlPoints=[],this.startKnot=s||0,this.endKnot=r||this.knots.length-1;for(let i=0;i<n.length;++i){const a=n[i];this.controlPoints[i]=new Me(a.x,a.y,a.z,a.w)}}getPoint(e,t=new b){const n=t,s=this.knots[this.startKnot]+e*(this.knots[this.endKnot]-this.knots[this.startKnot]),r=Js(this.degree,this.knots,this.controlPoints,s);return r.w!==1&&r.divideScalar(r.w),n.set(r.x,r.y,r.z)}getTangent(e,t=new b){const n=t,s=this.knots[0]+e*(this.knots[this.knots.length-1]-this.knots[0]),r=nr(this.degree,this.knots,this.controlPoints,s,1);return n.copy(r[1]).normalize(),n}}let E,I,C;class rr extends Ee{constructor(e){super(e)}load(e,t,n,s){const r=this,i=r.path===""?ae.extractUrlBase(e):r.path,a=new Qe(this.manager);a.setPath(r.path),a.setResponseType("arraybuffer"),a.setRequestHeader(r.requestHeader),a.setWithCredentials(r.withCredentials),a.load(e,function(o){try{t(r.parse(o,i))}catch(u){s?s(u):console.error(u),r.manager.itemError(e)}},n,s)}parse(e,t){if(ur(e))E=new lr().parse(e);else{const s=Kt(e);if(!hr(s))throw new Error("THREE.FBXLoader: Unknown format.");if(gt(s)<7e3)throw new Error("THREE.FBXLoader: FBX version not supported, FileVersion: "+gt(s));E=new cr().parse(s)}const n=new Ft(this.manager).setPath(this.resourcePath||t).setCrossOrigin(this.crossOrigin);return new ir(n,this.manager).parse(E)}}class ir{constructor(e,t){this.textureLoader=e,this.manager=t}parse(){I=this.parseConnections();const e=this.parseImages(),t=this.parseTextures(e),n=this.parseMaterials(t),s=this.parseDeformers(),r=new ar().parse(s);return this.parseScene(s,r,n),C}parseConnections(){const e=new Map;return"Connections"in E&&E.Connections.connections.forEach(function(n){const s=n[0],r=n[1],i=n[2];e.has(s)||e.set(s,{parents:[],children:[]});const a={ID:r,relationship:i};e.get(s).parents.push(a),e.has(r)||e.set(r,{parents:[],children:[]});const o={ID:s,relationship:i};e.get(r).children.push(o)}),e}parseImages(){const e={},t={};if("Video"in E.Objects){const n=E.Objects.Video;for(const s in n){const r=n[s],i=parseInt(s);if(e[i]=r.RelativeFilename||r.Filename,"Content"in r){const a=r.Content instanceof ArrayBuffer&&r.Content.byteLength>0,o=typeof r.Content=="string"&&r.Content!=="";if(a||o){const u=this.parseImage(n[s]);t[r.RelativeFilename||r.Filename]=u}}}}for(const n in e){const s=e[n];t[s]!==void 0?e[n]=t[s]:e[n]=e[n].split("\\").pop()}return e}parseImage(e){const t=e.Content,n=e.RelativeFilename||e.Filename,s=n.slice(n.lastIndexOf(".")+1).toLowerCase();let r;switch(s){case"bmp":r="image/bmp";break;case"jpg":case"jpeg":r="image/jpeg";break;case"png":r="image/png";break;case"tif":r="image/tiff";break;case"tga":this.manager.getHandler(".tga")===null&&console.warn("FBXLoader: TGA loader not found, skipping ",n),r="image/tga";break;default:console.warn('FBXLoader: Image type "'+s+'" is not supported.');return}if(typeof t=="string")return"data:"+r+";base64,"+t;{const i=new Uint8Array(t);return window.URL.createObjectURL(new Blob([i],{type:r}))}}parseTextures(e){const t=new Map;if("Texture"in E.Objects){const n=E.Objects.Texture;for(const s in n){const r=this.parseTexture(n[s],e);t.set(parseInt(s),r)}}return t}parseTexture(e,t){const n=this.loadTexture(e,t);n.ID=e.id,n.name=e.attrName;const s=e.WrapModeU,r=e.WrapModeV,i=s!==void 0?s.value:0,a=r!==void 0?r.value:0;if(n.wrapS=i===0?de:Ve,n.wrapT=a===0?de:Ve,"Scaling"in e){const o=e.Scaling.value;n.repeat.x=o[0],n.repeat.y=o[1]}if("Translation"in e){const o=e.Translation.value;n.offset.x=o[0],n.offset.y=o[1]}return n}loadTexture(e,t){const n=new Set(["tga","tif","tiff","exr","dds","hdr","ktx2"]),s=e.FileName.split(".").pop().toLowerCase(),r=n.has(s)?this.manager.getHandler(`.${s}`):this.textureLoader;if(!r)return console.warn(`FBXLoader: ${s.toUpperCase()} loader not found, creating placeholder texture for`,e.RelativeFilename),new Ye;const i=r.path;i||r.setPath(this.textureLoader.path);const a=I.get(e.id).children;let o;a!==void 0&&a.length>0&&t[a[0].ID]!==void 0&&(o=t[a[0].ID],(o.indexOf("blob:")===0||o.indexOf("data:")===0)&&r.setPath(void 0));const u=r.load(o);return r.setPath(i),u}parseMaterials(e){const t=new Map;if("Material"in E.Objects){const n=E.Objects.Material;for(const s in n){const r=this.parseMaterial(n[s],e);r!==null&&t.set(parseInt(s),r)}}return t}parseMaterial(e,t){const n=e.id,s=e.attrName;let r=e.ShadingModel;if(typeof r=="object"&&(r=r.value),!I.has(n))return null;const i=this.parseParameters(e,t,n);let a;switch(r.toLowerCase()){case"phong":a=new Ie;break;case"lambert":a=new vn;break;default:console.warn('THREE.FBXLoader: unknown material type "%s". Defaulting to MeshPhongMaterial.',r),a=new Ie;break}return a.setValues(i),a.name=s,a}parseParameters(e,t,n){const s={};e.BumpFactor&&(s.bumpScale=e.BumpFactor.value),e.Diffuse?s.color=new D().fromArray(e.Diffuse.value).convertSRGBToLinear():e.DiffuseColor&&(e.DiffuseColor.type==="Color"||e.DiffuseColor.type==="ColorRGB")&&(s.color=new D().fromArray(e.DiffuseColor.value).convertSRGBToLinear()),e.DisplacementFactor&&(s.displacementScale=e.DisplacementFactor.value),e.Emissive?s.emissive=new D().fromArray(e.Emissive.value).convertSRGBToLinear():e.EmissiveColor&&(e.EmissiveColor.type==="Color"||e.EmissiveColor.type==="ColorRGB")&&(s.emissive=new D().fromArray(e.EmissiveColor.value).convertSRGBToLinear()),e.EmissiveFactor&&(s.emissiveIntensity=parseFloat(e.EmissiveFactor.value)),e.Opacity&&(s.opacity=parseFloat(e.Opacity.value)),s.opacity<1&&(s.transparent=!0),e.ReflectionFactor&&(s.reflectivity=e.ReflectionFactor.value),e.Shininess&&(s.shininess=e.Shininess.value),e.Specular?s.specular=new D().fromArray(e.Specular.value).convertSRGBToLinear():e.SpecularColor&&e.SpecularColor.type==="Color"&&(s.specular=new D().fromArray(e.SpecularColor.value).convertSRGBToLinear());const r=this;return I.get(n).children.forEach(function(i){const a=i.relationship;switch(a){case"Bump":s.bumpMap=r.getTexture(t,i.ID);break;case"Maya|TEX_ao_map":s.aoMap=r.getTexture(t,i.ID);break;case"DiffuseColor":case"Maya|TEX_color_map":s.map=r.getTexture(t,i.ID),s.map!==void 0&&(s.map.colorSpace=X);break;case"DisplacementColor":s.displacementMap=r.getTexture(t,i.ID);break;case"EmissiveColor":s.emissiveMap=r.getTexture(t,i.ID),s.emissiveMap!==void 0&&(s.emissiveMap.colorSpace=X);break;case"NormalMap":case"Maya|TEX_normal_map":s.normalMap=r.getTexture(t,i.ID);break;case"ReflectionColor":s.envMap=r.getTexture(t,i.ID),s.envMap!==void 0&&(s.envMap.mapping=Sn,s.envMap.colorSpace=X);break;case"SpecularColor":s.specularMap=r.getTexture(t,i.ID),s.specularMap!==void 0&&(s.specularMap.colorSpace=X);break;case"TransparentColor":case"TransparencyFactor":s.alphaMap=r.getTexture(t,i.ID),s.transparent=!0;break;case"AmbientColor":case"ShininessExponent":case"SpecularFactor":case"VectorDisplacementColor":default:console.warn("THREE.FBXLoader: %s map is not supported in three.js, skipping texture.",a);break}}),s}getTexture(e,t){return"LayeredTexture"in E.Objects&&t in E.Objects.LayeredTexture&&(console.warn("THREE.FBXLoader: layered textures are not supported in three.js. Discarding all but first layer."),t=I.get(t).children[0].ID),e.get(t)}parseDeformers(){const e={},t={};if("Deformer"in E.Objects){const n=E.Objects.Deformer;for(const s in n){const r=n[s],i=I.get(parseInt(s));if(r.attrType==="Skin"){const a=this.parseSkeleton(i,n);a.ID=s,i.parents.length>1&&console.warn("THREE.FBXLoader: skeleton attached to more than one geometry is not supported."),a.geometryID=i.parents[0].ID,e[s]=a}else if(r.attrType==="BlendShape"){const a={id:s};a.rawTargets=this.parseMorphTargets(i,n),a.id=s,i.parents.length>1&&console.warn("THREE.FBXLoader: morph target attached to more than one geometry is not supported."),t[s]=a}}}return{skeletons:e,morphTargets:t}}parseSkeleton(e,t){const n=[];return e.children.forEach(function(s){const r=t[s.ID];if(r.attrType!=="Cluster")return;const i={ID:s.ID,indices:[],weights:[],transformLink:new R().fromArray(r.TransformLink.a)};"Indexes"in r&&(i.indices=r.Indexes.a,i.weights=r.Weights.a),n.push(i)}),{rawBones:n,bones:[]}}parseMorphTargets(e,t){const n=[];for(let s=0;s<e.children.length;s++){const r=e.children[s],i=t[r.ID],a={name:i.attrName,initialWeight:i.DeformPercent,id:i.id,fullWeights:i.FullWeights.a};if(i.attrType!=="BlendShapeChannel")return;a.geoID=I.get(parseInt(r.ID)).children.filter(function(o){return o.relationship===void 0})[0].ID,n.push(a)}return n}parseScene(e,t,n){C=new ge;const s=this.parseModels(e.skeletons,t,n),r=E.Objects.Model,i=this;s.forEach(function(o){const u=r[o.ID];i.setLookAtProperties(o,u),I.get(o.ID).parents.forEach(function(c){const p=s.get(c.ID);p!==void 0&&p.add(o)}),o.parent===null&&C.add(o)}),this.bindSkeleton(e.skeletons,t,s),this.addGlobalSceneSettings(),C.traverse(function(o){if(o.userData.transformData){o.parent&&(o.userData.transformData.parentMatrix=o.parent.matrix,o.userData.transformData.parentMatrixWorld=o.parent.matrixWorld);const u=Yt(o.userData.transformData);o.applyMatrix4(u),o.updateWorldMatrix()}});const a=new or().parse();C.children.length===1&&C.children[0].isGroup&&(C.children[0].animations=a,C=C.children[0]),C.animations=a}parseModels(e,t,n){const s=new Map,r=E.Objects.Model;for(const i in r){const a=parseInt(i),o=r[i],u=I.get(a);let h=this.buildSkeleton(u,e,a,o.attrName);if(!h){switch(o.attrType){case"Camera":h=this.createCamera(u);break;case"Light":h=this.createLight(u);break;case"Mesh":h=this.createMesh(u,t,n);break;case"NurbsCurve":h=this.createCurve(u,t);break;case"LimbNode":case"Root":h=new je;break;case"Null":default:h=new ge;break}h.name=o.attrName?_e.sanitizeNodeName(o.attrName):"",h.userData.originalName=o.attrName,h.ID=a}this.getTransformData(h,o),s.set(a,h)}return s}buildSkeleton(e,t,n,s){let r=null;return e.parents.forEach(function(i){for(const a in t){const o=t[a];o.rawBones.forEach(function(u,h){if(u.ID===i.ID){const c=r;r=new je,r.matrixWorld.copy(u.transformLink),r.name=s?_e.sanitizeNodeName(s):"",r.userData.originalName=s,r.ID=n,o.bones[h]=r,c!==null&&r.add(c)}})}}),r}createCamera(e){let t,n;if(e.children.forEach(function(s){const r=E.Objects.NodeAttribute[s.ID];r!==void 0&&(n=r)}),n===void 0)t=new oe;else{let s=0;n.CameraProjectionType!==void 0&&n.CameraProjectionType.value===1&&(s=1);let r=1;n.NearPlane!==void 0&&(r=n.NearPlane.value/1e3);let i=1e3;n.FarPlane!==void 0&&(i=n.FarPlane.value/1e3);let a=window.innerWidth,o=window.innerHeight;n.AspectWidth!==void 0&&n.AspectHeight!==void 0&&(a=n.AspectWidth.value,o=n.AspectHeight.value);const u=a/o;let h=45;n.FieldOfView!==void 0&&(h=n.FieldOfView.value);const c=n.FocalLength?n.FocalLength.value:null;switch(s){case 0:t=new Lt(h,u,r,i),c!==null&&t.setFocalLength(c);break;case 1:t=new Nt(-a/2,a/2,o/2,-o/2,r,i);break;default:console.warn("THREE.FBXLoader: Unknown camera type "+s+"."),t=new oe;break}}return t}createLight(e){let t,n;if(e.children.forEach(function(s){const r=E.Objects.NodeAttribute[s.ID];r!==void 0&&(n=r)}),n===void 0)t=new oe;else{let s;n.LightType===void 0?s=0:s=n.LightType.value;let r=16777215;n.Color!==void 0&&(r=new D().fromArray(n.Color.value).convertSRGBToLinear());let i=n.Intensity===void 0?1:n.Intensity.value/100;n.CastLightOnObject!==void 0&&n.CastLightOnObject.value===0&&(i=0);let a=0;n.FarAttenuationEnd!==void 0&&(n.EnableFarAttenuation!==void 0&&n.EnableFarAttenuation.value===0?a=0:a=n.FarAttenuationEnd.value);const o=1;switch(s){case 0:t=new Ge(r,i,a,o);break;case 1:t=new At(r,i);break;case 2:let u=Math.PI/3;n.InnerAngle!==void 0&&(u=k.degToRad(n.InnerAngle.value));let h=0;n.OuterAngle!==void 0&&(h=k.degToRad(n.OuterAngle.value),h=Math.max(h,1)),t=new yt(r,i,a,u,h,o);break;default:console.warn("THREE.FBXLoader: Unknown light type "+n.LightType.value+", defaulting to a PointLight."),t=new Ge(r,i);break}n.CastShadows!==void 0&&n.CastShadows.value===1&&(t.castShadow=!0)}return t}createMesh(e,t,n){let s,r=null,i=null;const a=[];return e.children.forEach(function(o){t.has(o.ID)&&(r=t.get(o.ID)),n.has(o.ID)&&a.push(n.get(o.ID))}),a.length>1?i=a:a.length>0?i=a[0]:(i=new Ie({name:Ee.DEFAULT_MATERIAL_NAME,color:13421772}),a.push(i)),"color"in r.attributes&&a.forEach(function(o){o.vertexColors=!0}),r.FBX_Deformer?(s=new vt(r,i),s.normalizeSkinWeights()):s=new $e(r,i),s}createCurve(e,t){const n=e.children.reduce(function(r,i){return t.has(i.ID)&&(r=t.get(i.ID)),r},null),s=new Mt({name:Ee.DEFAULT_MATERIAL_NAME,color:3342591,linewidth:1});return new St(n,s)}getTransformData(e,t){const n={};"InheritType"in t&&(n.inheritType=parseInt(t.InheritType.value)),"RotationOrder"in t?n.eulerOrder=zt(t.RotationOrder.value):n.eulerOrder="ZYX","Lcl_Translation"in t&&(n.translation=t.Lcl_Translation.value),"PreRotation"in t&&(n.preRotation=t.PreRotation.value),"Lcl_Rotation"in t&&(n.rotation=t.Lcl_Rotation.value),"PostRotation"in t&&(n.postRotation=t.PostRotation.value),"Lcl_Scaling"in t&&(n.scale=t.Lcl_Scaling.value),"ScalingOffset"in t&&(n.scalingOffset=t.ScalingOffset.value),"ScalingPivot"in t&&(n.scalingPivot=t.ScalingPivot.value),"RotationOffset"in t&&(n.rotationOffset=t.RotationOffset.value),"RotationPivot"in t&&(n.rotationPivot=t.RotationPivot.value),e.userData.transformData=n}setLookAtProperties(e,t){"LookAtProperty"in t&&I.get(e.ID).children.forEach(function(s){if(s.relationship==="LookAtProperty"){const r=E.Objects.Model[s.ID];if("Lcl_Translation"in r){const i=r.Lcl_Translation.value;e.target!==void 0?(e.target.position.fromArray(i),C.add(e.target)):e.lookAt(new b().fromArray(i))}}})}bindSkeleton(e,t,n){const s=this.parsePoseNodes();for(const r in e){const i=e[r];I.get(parseInt(i.ID)).parents.forEach(function(o){if(t.has(o.ID)){const u=o.ID;I.get(u).parents.forEach(function(c){n.has(c.ID)&&n.get(c.ID).bind(new It(i.bones),s[c.ID])})}})}}parsePoseNodes(){const e={};if("Pose"in E.Objects){const t=E.Objects.Pose;for(const n in t)if(t[n].attrType==="BindPose"&&t[n].NbPoseNodes>0){const s=t[n].PoseNode;Array.isArray(s)?s.forEach(function(r){e[r.Node]=new R().fromArray(r.Matrix.a)}):e[s.Node]=new R().fromArray(s.Matrix.a)}}return e}addGlobalSceneSettings(){if("GlobalSettings"in E){if("AmbientColor"in E.GlobalSettings){const e=E.GlobalSettings.AmbientColor.value,t=e[0],n=e[1],s=e[2];if(t!==0||n!==0||s!==0){const r=new D(t,n,s).convertSRGBToLinear();C.add(new Ln(r,1))}}"UnitScaleFactor"in E.GlobalSettings&&(C.userData.unitScaleFactor=E.GlobalSettings.UnitScaleFactor.value)}}}class ar{constructor(){this.negativeMaterialIndices=!1}parse(e){const t=new Map;if("Geometry"in E.Objects){const n=E.Objects.Geometry;for(const s in n){const r=I.get(parseInt(s)),i=this.parseGeometry(r,n[s],e);t.set(parseInt(s),i)}}return this.negativeMaterialIndices===!0&&console.warn("THREE.FBXLoader: The FBX file contains invalid (negative) material indices. The asset might not render as expected."),t}parseGeometry(e,t,n){switch(t.attrType){case"Mesh":return this.parseMeshGeometry(e,t,n);case"NurbsCurve":return this.parseNurbsGeometry(t)}}parseMeshGeometry(e,t,n){const s=n.skeletons,r=[],i=e.parents.map(function(c){return E.Objects.Model[c.ID]});if(i.length===0)return;const a=e.children.reduce(function(c,p){return s[p.ID]!==void 0&&(c=s[p.ID]),c},null);e.children.forEach(function(c){n.morphTargets[c.ID]!==void 0&&r.push(n.morphTargets[c.ID])});const o=i[0],u={};"RotationOrder"in o&&(u.eulerOrder=zt(o.RotationOrder.value)),"InheritType"in o&&(u.inheritType=parseInt(o.InheritType.value)),"GeometricTranslation"in o&&(u.translation=o.GeometricTranslation.value),"GeometricRotation"in o&&(u.rotation=o.GeometricRotation.value),"GeometricScaling"in o&&(u.scale=o.GeometricScaling.value);const h=Yt(u);return this.genGeometry(t,a,r,h)}genGeometry(e,t,n,s){const r=new Fe;e.attrName&&(r.name=e.attrName);const i=this.parseGeoNode(e,t),a=this.genBuffers(i),o=new se(a.vertex,3);if(o.applyMatrix4(s),r.setAttribute("position",o),a.colors.length>0&&r.setAttribute("color",new se(a.colors,3)),t&&(r.setAttribute("skinIndex",new Nn(a.weightsIndices,4)),r.setAttribute("skinWeight",new se(a.vertexWeights,4)),r.FBX_Deformer=t),a.normal.length>0){const u=new In().getNormalMatrix(s),h=new se(a.normal,3);h.applyNormalMatrix(u),r.setAttribute("normal",h)}if(a.uvs.forEach(function(u,h){const c=h===0?"uv":`uv${h}`;r.setAttribute(c,new se(a.uvs[h],2))}),i.material&&i.material.mappingType!=="AllSame"){let u=a.materialIndex[0],h=0;if(a.materialIndex.forEach(function(c,p){c!==u&&(r.addGroup(h,p-h,u),u=c,h=p)}),r.groups.length>0){const c=r.groups[r.groups.length-1],p=c.start+c.count;p!==a.materialIndex.length&&r.addGroup(p,a.materialIndex.length-p,u)}r.groups.length===0&&r.addGroup(0,a.materialIndex.length,a.materialIndex[0])}return this.addMorphTargets(r,e,n,s),r}parseGeoNode(e,t){const n={};if(n.vertexPositions=e.Vertices!==void 0?e.Vertices.a:[],n.vertexIndices=e.PolygonVertexIndex!==void 0?e.PolygonVertexIndex.a:[],e.LayerElementColor&&(n.color=this.parseVertexColors(e.LayerElementColor[0])),e.LayerElementMaterial&&(n.material=this.parseMaterialIndices(e.LayerElementMaterial[0])),e.LayerElementNormal&&(n.normal=this.parseNormals(e.LayerElementNormal[0])),e.LayerElementUV){n.uv=[];let s=0;for(;e.LayerElementUV[s];)e.LayerElementUV[s].UV&&n.uv.push(this.parseUVs(e.LayerElementUV[s])),s++}return n.weightTable={},t!==null&&(n.skeleton=t,t.rawBones.forEach(function(s,r){s.indices.forEach(function(i,a){n.weightTable[i]===void 0&&(n.weightTable[i]=[]),n.weightTable[i].push({id:r,weight:s.weights[a]})})})),n}genBuffers(e){const t={vertex:[],normal:[],colors:[],uvs:[],materialIndex:[],vertexWeights:[],weightsIndices:[]};let n=0,s=0,r=!1,i=[],a=[],o=[],u=[],h=[],c=[];const p=this;return e.vertexIndices.forEach(function(f,g){let m,d=!1;f<0&&(f=f^-1,d=!0);let _=[],T=[];if(i.push(f*3,f*3+1,f*3+2),e.color){const w=Ae(g,n,f,e.color);o.push(w[0],w[1],w[2])}if(e.skeleton){if(e.weightTable[f]!==void 0&&e.weightTable[f].forEach(function(w){T.push(w.weight),_.push(w.id)}),T.length>4){r||(console.warn("THREE.FBXLoader: Vertex has more than 4 skinning weights assigned to vertex. Deleting additional weights."),r=!0);const w=[0,0,0,0],y=[0,0,0,0];T.forEach(function(M,A){let F=M,S=_[A];y.forEach(function(L,N,P){if(F>L){P[N]=F,F=L;const ee=w[N];w[N]=S,S=ee}})}),_=w,T=y}for(;T.length<4;)T.push(0),_.push(0);for(let w=0;w<4;++w)h.push(T[w]),c.push(_[w])}if(e.normal){const w=Ae(g,n,f,e.normal);a.push(w[0],w[1],w[2])}e.material&&e.material.mappingType!=="AllSame"&&(m=Ae(g,n,f,e.material)[0],m<0&&(p.negativeMaterialIndices=!0,m=0)),e.uv&&e.uv.forEach(function(w,y){const M=Ae(g,n,f,w);u[y]===void 0&&(u[y]=[]),u[y].push(M[0]),u[y].push(M[1])}),s++,d&&(p.genFace(t,e,i,m,a,o,u,h,c,s),n++,s=0,i=[],a=[],o=[],u=[],h=[],c=[])}),t}getNormalNewell(e){const t=new b(0,0,0);for(let n=0;n<e.length;n++){const s=e[n],r=e[(n+1)%e.length];t.x+=(s.y-r.y)*(s.z+r.z),t.y+=(s.z-r.z)*(s.x+r.x),t.z+=(s.x-r.x)*(s.y+r.y)}return t.normalize(),t}getNormalTangentAndBitangent(e){const t=this.getNormalNewell(e),s=(Math.abs(t.z)>.5?new b(0,1,0):new b(0,0,1)).cross(t).normalize(),r=t.clone().cross(s).normalize();return{normal:t,tangent:s,bitangent:r}}flattenVertex(e,t,n){return new Je(e.dot(t),e.dot(n))}genFace(e,t,n,s,r,i,a,o,u,h){let c;if(h>3){const p=[],f=t.baseVertexPositions||t.vertexPositions;for(let _=0;_<n.length;_+=3)p.push(new b(f[n[_]],f[n[_+1]],f[n[_+2]]));const{tangent:g,bitangent:m}=this.getNormalTangentAndBitangent(p),d=[];for(const _ of p)d.push(this.flattenVertex(_,g,m));c=bn.triangulateShape(d,[])}else c=[[0,1,2]];for(const[p,f,g]of c)e.vertex.push(t.vertexPositions[n[p*3]]),e.vertex.push(t.vertexPositions[n[p*3+1]]),e.vertex.push(t.vertexPositions[n[p*3+2]]),e.vertex.push(t.vertexPositions[n[f*3]]),e.vertex.push(t.vertexPositions[n[f*3+1]]),e.vertex.push(t.vertexPositions[n[f*3+2]]),e.vertex.push(t.vertexPositions[n[g*3]]),e.vertex.push(t.vertexPositions[n[g*3+1]]),e.vertex.push(t.vertexPositions[n[g*3+2]]),t.skeleton&&(e.vertexWeights.push(o[p*4]),e.vertexWeights.push(o[p*4+1]),e.vertexWeights.push(o[p*4+2]),e.vertexWeights.push(o[p*4+3]),e.vertexWeights.push(o[f*4]),e.vertexWeights.push(o[f*4+1]),e.vertexWeights.push(o[f*4+2]),e.vertexWeights.push(o[f*4+3]),e.vertexWeights.push(o[g*4]),e.vertexWeights.push(o[g*4+1]),e.vertexWeights.push(o[g*4+2]),e.vertexWeights.push(o[g*4+3]),e.weightsIndices.push(u[p*4]),e.weightsIndices.push(u[p*4+1]),e.weightsIndices.push(u[p*4+2]),e.weightsIndices.push(u[p*4+3]),e.weightsIndices.push(u[f*4]),e.weightsIndices.push(u[f*4+1]),e.weightsIndices.push(u[f*4+2]),e.weightsIndices.push(u[f*4+3]),e.weightsIndices.push(u[g*4]),e.weightsIndices.push(u[g*4+1]),e.weightsIndices.push(u[g*4+2]),e.weightsIndices.push(u[g*4+3])),t.color&&(e.colors.push(i[p*3]),e.colors.push(i[p*3+1]),e.colors.push(i[p*3+2]),e.colors.push(i[f*3]),e.colors.push(i[f*3+1]),e.colors.push(i[f*3+2]),e.colors.push(i[g*3]),e.colors.push(i[g*3+1]),e.colors.push(i[g*3+2])),t.material&&t.material.mappingType!=="AllSame"&&(e.materialIndex.push(s),e.materialIndex.push(s),e.materialIndex.push(s)),t.normal&&(e.normal.push(r[p*3]),e.normal.push(r[p*3+1]),e.normal.push(r[p*3+2]),e.normal.push(r[f*3]),e.normal.push(r[f*3+1]),e.normal.push(r[f*3+2]),e.normal.push(r[g*3]),e.normal.push(r[g*3+1]),e.normal.push(r[g*3+2])),t.uv&&t.uv.forEach(function(m,d){e.uvs[d]===void 0&&(e.uvs[d]=[]),e.uvs[d].push(a[d][p*2]),e.uvs[d].push(a[d][p*2+1]),e.uvs[d].push(a[d][f*2]),e.uvs[d].push(a[d][f*2+1]),e.uvs[d].push(a[d][g*2]),e.uvs[d].push(a[d][g*2+1])})}addMorphTargets(e,t,n,s){if(n.length===0)return;e.morphTargetsRelative=!0,e.morphAttributes.position=[];const r=this;n.forEach(function(i){i.rawTargets.forEach(function(a){const o=E.Objects.Geometry[a.geoID];o!==void 0&&r.genMorphGeometry(e,t,o,s,a.name)})})}genMorphGeometry(e,t,n,s,r){const i=t.Vertices!==void 0?t.Vertices.a:[],a=t.PolygonVertexIndex!==void 0?t.PolygonVertexIndex.a:[],o=n.Vertices!==void 0?n.Vertices.a:[],u=n.Indexes!==void 0?n.Indexes.a:[],h=e.attributes.position.count*3,c=new Float32Array(h);for(let m=0;m<u.length;m++){const d=u[m]*3;c[d]=o[m*3],c[d+1]=o[m*3+1],c[d+2]=o[m*3+2]}const p={vertexIndices:a,vertexPositions:c,baseVertexPositions:i},f=this.genBuffers(p),g=new se(f.vertex,3);g.name=r||n.attrName,g.applyMatrix4(s),e.morphAttributes.position.push(g)}parseNormals(e){const t=e.MappingInformationType,n=e.ReferenceInformationType,s=e.Normals.a;let r=[];return n==="IndexToDirect"&&("NormalIndex"in e?r=e.NormalIndex.a:"NormalsIndex"in e&&(r=e.NormalsIndex.a)),{dataSize:3,buffer:s,indices:r,mappingType:t,referenceType:n}}parseUVs(e){const t=e.MappingInformationType,n=e.ReferenceInformationType,s=e.UV.a;let r=[];return n==="IndexToDirect"&&(r=e.UVIndex.a),{dataSize:2,buffer:s,indices:r,mappingType:t,referenceType:n}}parseVertexColors(e){const t=e.MappingInformationType,n=e.ReferenceInformationType,s=e.Colors.a;let r=[];n==="IndexToDirect"&&(r=e.ColorIndex.a);for(let i=0,a=new D;i<s.length;i+=4)a.fromArray(s,i).convertSRGBToLinear().toArray(s,i);return{dataSize:4,buffer:s,indices:r,mappingType:t,referenceType:n}}parseMaterialIndices(e){const t=e.MappingInformationType,n=e.ReferenceInformationType;if(t==="NoMappingInformation")return{dataSize:1,buffer:[0],indices:[0],mappingType:"AllSame",referenceType:n};const s=e.Materials.a,r=[];for(let i=0;i<s.length;++i)r.push(i);return{dataSize:1,buffer:s,indices:r,mappingType:t,referenceType:n}}parseNurbsGeometry(e){const t=parseInt(e.Order);if(isNaN(t))return console.error("THREE.FBXLoader: Invalid Order %s given for geometry ID: %s",e.Order,e.id),new Fe;const n=t-1,s=e.KnotVector.a,r=[],i=e.Points.a;for(let c=0,p=i.length;c<p;c+=4)r.push(new Me().fromArray(i,c));let a,o;if(e.Form==="Closed")r.push(r[0]);else if(e.Form==="Periodic"){a=n,o=s.length-1-a;for(let c=0;c<n;++c)r.push(r[c])}const h=new sr(n,s,r,a,o).getPoints(r.length*12);return new Fe().setFromPoints(h)}}class or{parse(){const e=[],t=this.parseClips();if(t!==void 0)for(const n in t){const s=t[n],r=this.addClip(s);e.push(r)}return e}parseClips(){if(E.Objects.AnimationCurve===void 0)return;const e=this.parseAnimationCurveNodes();this.parseAnimationCurves(e);const t=this.parseAnimationLayers(e);return this.parseAnimStacks(t)}parseAnimationCurveNodes(){const e=E.Objects.AnimationCurveNode,t=new Map;for(const n in e){const s=e[n];if(s.attrName.match(/S|R|T|DeformPercent/)!==null){const r={id:s.id,attr:s.attrName,curves:{}};t.set(r.id,r)}}return t}parseAnimationCurves(e){const t=E.Objects.AnimationCurve;for(const n in t){const s={id:t[n].id,times:t[n].KeyTime.a.map(pr),values:t[n].KeyValueFloat.a},r=I.get(s.id);if(r!==void 0){const i=r.parents[0].ID,a=r.parents[0].relationship;a.match(/X/)?e.get(i).curves.x=s:a.match(/Y/)?e.get(i).curves.y=s:a.match(/Z/)?e.get(i).curves.z=s:a.match(/DeformPercent/)&&e.has(i)&&(e.get(i).curves.morph=s)}}}parseAnimationLayers(e){const t=E.Objects.AnimationLayer,n=new Map;for(const s in t){const r=[],i=I.get(parseInt(s));i!==void 0&&(i.children.forEach(function(o,u){if(e.has(o.ID)){const h=e.get(o.ID);if(h.curves.x!==void 0||h.curves.y!==void 0||h.curves.z!==void 0){if(r[u]===void 0){const c=I.get(o.ID).parents.filter(function(p){return p.relationship!==void 0})[0].ID;if(c!==void 0){const p=E.Objects.Model[c.toString()];if(p===void 0){console.warn("THREE.FBXLoader: Encountered a unused curve.",o);return}const f={modelName:p.attrName?_e.sanitizeNodeName(p.attrName):"",ID:p.id,initialPosition:[0,0,0],initialRotation:[0,0,0],initialScale:[1,1,1]};C.traverse(function(g){g.ID===p.id&&(f.transform=g.matrix,g.userData.transformData&&(f.eulerOrder=g.userData.transformData.eulerOrder))}),f.transform||(f.transform=new R),"PreRotation"in p&&(f.preRotation=p.PreRotation.value),"PostRotation"in p&&(f.postRotation=p.PostRotation.value),r[u]=f}}r[u]&&(r[u][h.attr]=h)}else if(h.curves.morph!==void 0){if(r[u]===void 0){const c=I.get(o.ID).parents.filter(function(_){return _.relationship!==void 0})[0].ID,p=I.get(c).parents[0].ID,f=I.get(p).parents[0].ID,g=I.get(f).parents[0].ID,m=E.Objects.Model[g],d={modelName:m.attrName?_e.sanitizeNodeName(m.attrName):"",morphName:E.Objects.Deformer[c].attrName};r[u]=d}r[u][h.attr]=h}}}),n.set(parseInt(s),r))}return n}parseAnimStacks(e){const t=E.Objects.AnimationStack,n={};for(const s in t){const r=I.get(parseInt(s)).children;r.length>1&&console.warn("THREE.FBXLoader: Encountered an animation stack with multiple layers, this is currently not supported. Ignoring subsequent layers.");const i=e.get(r[0].ID);n[s]={name:t[s].attrName,layer:i}}return n}addClip(e){let t=[];const n=this;return e.layer.forEach(function(s){t=t.concat(n.generateTracks(s))}),new xe(e.name,-1,t)}generateTracks(e){const t=[];let n=new b,s=new b;if(e.transform&&e.transform.decompose(n,new O,s),n=n.toArray(),s=s.toArray(),e.T!==void 0&&Object.keys(e.T.curves).length>0){const r=this.generateVectorTrack(e.modelName,e.T.curves,n,"position");r!==void 0&&t.push(r)}if(e.R!==void 0&&Object.keys(e.R.curves).length>0){const r=this.generateRotationTrack(e.modelName,e.R.curves,e.preRotation,e.postRotation,e.eulerOrder);r!==void 0&&t.push(r)}if(e.S!==void 0&&Object.keys(e.S.curves).length>0){const r=this.generateVectorTrack(e.modelName,e.S.curves,s,"scale");r!==void 0&&t.push(r)}if(e.DeformPercent!==void 0){const r=this.generateMorphTrack(e);r!==void 0&&t.push(r)}return t}generateVectorTrack(e,t,n,s){const r=this.getTimesForAllAxes(t),i=this.getKeyframeTrackValues(r,t,n);return new le(e+"."+s,r,i)}generateRotationTrack(e,t,n,s,r){let i,a;if(t.x!==void 0&&t.y!==void 0&&t.z!==void 0){const c=this.interpolateRotations(t.x,t.y,t.z,r);i=c[0],a=c[1]}n!==void 0&&(n=n.map(k.degToRad),n.push(r),n=new Y().fromArray(n),n=new O().setFromEuler(n)),s!==void 0&&(s=s.map(k.degToRad),s.push(r),s=new Y().fromArray(s),s=new O().setFromEuler(s).invert());const o=new O,u=new Y,h=[];if(!a||!i)return new ue(e+".quaternion",[0],[0]);for(let c=0;c<a.length;c+=3)u.set(a[c],a[c+1],a[c+2],r),o.setFromEuler(u),n!==void 0&&o.premultiply(n),s!==void 0&&o.multiply(s),c>2&&new O().fromArray(h,(c-3)/3*4).dot(o)<0&&o.set(-o.x,-o.y,-o.z,-o.w),o.toArray(h,c/3*4);return new ue(e+".quaternion",i,h)}generateMorphTrack(e){const t=e.DeformPercent.curves.morph,n=t.values.map(function(r){return r/100}),s=C.getObjectByName(e.modelName).morphTargetDictionary[e.morphName];return new ze(e.modelName+".morphTargetInfluences["+s+"]",t.times,n)}getTimesForAllAxes(e){let t=[];if(e.x!==void 0&&(t=t.concat(e.x.times)),e.y!==void 0&&(t=t.concat(e.y.times)),e.z!==void 0&&(t=t.concat(e.z.times)),t=t.sort(function(n,s){return n-s}),t.length>1){let n=1,s=t[0];for(let r=1;r<t.length;r++){const i=t[r];i!==s&&(t[n]=i,s=i,n++)}t=t.slice(0,n)}return t}getKeyframeTrackValues(e,t,n){const s=n,r=[];let i=-1,a=-1,o=-1;return e.forEach(function(u){if(t.x&&(i=t.x.times.indexOf(u)),t.y&&(a=t.y.times.indexOf(u)),t.z&&(o=t.z.times.indexOf(u)),i!==-1){const h=t.x.values[i];r.push(h),s[0]=h}else r.push(s[0]);if(a!==-1){const h=t.y.values[a];r.push(h),s[1]=h}else r.push(s[1]);if(o!==-1){const h=t.z.values[o];r.push(h),s[2]=h}else r.push(s[2])}),r}interpolateRotations(e,t,n,s){const r=[],i=[];r.push(e.times[0]),i.push(k.degToRad(e.values[0])),i.push(k.degToRad(t.values[0])),i.push(k.degToRad(n.values[0]));for(let a=1;a<e.values.length;a++){const o=[e.values[a-1],t.values[a-1],n.values[a-1]];if(isNaN(o[0])||isNaN(o[1])||isNaN(o[2]))continue;const u=o.map(k.degToRad),h=[e.values[a],t.values[a],n.values[a]];if(isNaN(h[0])||isNaN(h[1])||isNaN(h[2]))continue;const c=h.map(k.degToRad),p=[h[0]-o[0],h[1]-o[1],h[2]-o[2]],f=[Math.abs(p[0]),Math.abs(p[1]),Math.abs(p[2])];if(f[0]>=180||f[1]>=180||f[2]>=180){const m=Math.max(...f)/180,d=new Y(...u,s),_=new Y(...c,s),T=new O().setFromEuler(d),w=new O().setFromEuler(_);T.dot(w)&&w.set(-w.x,-w.y,-w.z,-w.w);const y=e.times[a-1],M=e.times[a]-y,A=new O,F=new Y;for(let S=0;S<1;S+=1/m)A.copy(T.clone().slerp(w.clone(),S)),r.push(y+S*M),F.setFromQuaternion(A,s),i.push(F.x),i.push(F.y),i.push(F.z)}else r.push(e.times[a]),i.push(k.degToRad(e.values[a])),i.push(k.degToRad(t.values[a])),i.push(k.degToRad(n.values[a]))}return[r,i]}}class cr{getPrevNode(){return this.nodeStack[this.currentIndent-2]}getCurrentNode(){return this.nodeStack[this.currentIndent-1]}getCurrentProp(){return this.currentProp}pushStack(e){this.nodeStack.push(e),this.currentIndent+=1}popStack(){this.nodeStack.pop(),this.currentIndent-=1}setCurrentProp(e,t){this.currentProp=e,this.currentPropName=t}parse(e){this.currentIndent=0,this.allNodes=new jt,this.nodeStack=[],this.currentProp=[],this.currentPropName="";const t=this,n=e.split(/[\r\n]+/);return n.forEach(function(s,r){const i=s.match(/^[\s\t]*;/),a=s.match(/^[\s\t]*$/);if(i||a)return;const o=s.match("^\\t{"+t.currentIndent+"}(\\w+):(.*){",""),u=s.match("^\\t{"+t.currentIndent+"}(\\w+):[\\s\\t\\r\\n](.*)"),h=s.match("^\\t{"+(t.currentIndent-1)+"}}");o?t.parseNodeBegin(s,o):u?t.parseNodeProperty(s,u,n[++r]):h?t.popStack():s.match(/^[^\s\t}]/)&&t.parseNodePropertyContinued(s)}),this.allNodes}parseNodeBegin(e,t){const n=t[1].trim().replace(/^"/,"").replace(/"$/,""),s=t[2].split(",").map(function(o){return o.trim().replace(/^"/,"").replace(/"$/,"")}),r={name:n},i=this.parseNodeAttr(s),a=this.getCurrentNode();this.currentIndent===0?this.allNodes.add(n,r):n in a?(n==="PoseNode"?a.PoseNode.push(r):a[n].id!==void 0&&(a[n]={},a[n][a[n].id]=a[n]),i.id!==""&&(a[n][i.id]=r)):typeof i.id=="number"?(a[n]={},a[n][i.id]=r):n!=="Properties70"&&(n==="PoseNode"?a[n]=[r]:a[n]=r),typeof i.id=="number"&&(r.id=i.id),i.name!==""&&(r.attrName=i.name),i.type!==""&&(r.attrType=i.type),this.pushStack(r)}parseNodeAttr(e){let t=e[0];e[0]!==""&&(t=parseInt(e[0]),isNaN(t)&&(t=e[0]));let n="",s="";return e.length>1&&(n=e[1].replace(/^(\w+)::/,""),s=e[2]),{id:t,name:n,type:s}}parseNodeProperty(e,t,n){let s=t[1].replace(/^"/,"").replace(/"$/,"").trim(),r=t[2].replace(/^"/,"").replace(/"$/,"").trim();s==="Content"&&r===","&&(r=n.replace(/"/g,"").replace(/,$/,"").trim());const i=this.getCurrentNode();if(i.name==="Properties70"){this.parseNodeSpecialProperty(e,s,r);return}if(s==="C"){const o=r.split(",").slice(1),u=parseInt(o[0]),h=parseInt(o[1]);let c=r.split(",").slice(3);c=c.map(function(p){return p.trim().replace(/^"/,"")}),s="connections",r=[u,h],gr(r,c),i[s]===void 0&&(i[s]=[])}s==="Node"&&(i.id=r),s in i&&Array.isArray(i[s])?i[s].push(r):s!=="a"?i[s]=r:i.a=r,this.setCurrentProp(i,s),s==="a"&&r.slice(-1)!==","&&(i.a=Be(r))}parseNodePropertyContinued(e){const t=this.getCurrentNode();t.a+=e,e.slice(-1)!==","&&(t.a=Be(t.a))}parseNodeSpecialProperty(e,t,n){const s=n.split('",').map(function(h){return h.trim().replace(/^\"/,"").replace(/\s/,"_")}),r=s[0],i=s[1],a=s[2],o=s[3];let u=s[4];switch(i){case"int":case"enum":case"bool":case"ULongLong":case"double":case"Number":case"FieldOfView":u=parseFloat(u);break;case"Color":case"ColorRGB":case"Vector3D":case"Lcl_Translation":case"Lcl_Rotation":case"Lcl_Scaling":u=Be(u);break}this.getPrevNode()[r]={type:i,type2:a,flag:o,value:u},this.setCurrentProp(this.getPrevNode(),r)}}class lr{parse(e){const t=new ft(e);t.skip(23);const n=t.getUint32();if(n<6400)throw new Error("THREE.FBXLoader: FBX version not supported, FileVersion: "+n);const s=new jt;for(;!this.endOfContent(t);){const r=this.parseNode(t,n);r!==null&&s.add(r.name,r)}return s}endOfContent(e){return e.size()%16===0?(e.getOffset()+160+16&-16)>=e.size():e.getOffset()+160+16>=e.size()}parseNode(e,t){const n={},s=t>=7500?e.getUint64():e.getUint32(),r=t>=7500?e.getUint64():e.getUint32();t>=7500?e.getUint64():e.getUint32();const i=e.getUint8(),a=e.getString(i);if(s===0)return null;const o=[];for(let p=0;p<r;p++)o.push(this.parseProperty(e));const u=o.length>0?o[0]:"",h=o.length>1?o[1]:"",c=o.length>2?o[2]:"";for(n.singleProperty=r===1&&e.getOffset()===s;s>e.getOffset();){const p=this.parseNode(e,t);p!==null&&this.parseSubNode(a,n,p)}return n.propertyList=o,typeof u=="number"&&(n.id=u),h!==""&&(n.attrName=h),c!==""&&(n.attrType=c),a!==""&&(n.name=a),n}parseSubNode(e,t,n){if(n.singleProperty===!0){const s=n.propertyList[0];Array.isArray(s)?(t[n.name]=n,n.a=s):t[n.name]=s}else if(e==="Connections"&&n.name==="C"){const s=[];n.propertyList.forEach(function(r,i){i!==0&&s.push(r)}),t.connections===void 0&&(t.connections=[]),t.connections.push(s)}else if(n.name==="Properties70")Object.keys(n).forEach(function(r){t[r]=n[r]});else if(e==="Properties70"&&n.name==="P"){let s=n.propertyList[0],r=n.propertyList[1];const i=n.propertyList[2],a=n.propertyList[3];let o;s.indexOf("Lcl ")===0&&(s=s.replace("Lcl ","Lcl_")),r.indexOf("Lcl ")===0&&(r=r.replace("Lcl ","Lcl_")),r==="Color"||r==="ColorRGB"||r==="Vector"||r==="Vector3D"||r.indexOf("Lcl_")===0?o=[n.propertyList[4],n.propertyList[5],n.propertyList[6]]:o=n.propertyList[4],t[s]={type:r,type2:i,flag:a,value:o}}else t[n.name]===void 0?typeof n.id=="number"?(t[n.name]={},t[n.name][n.id]=n):t[n.name]=n:n.name==="PoseNode"?(Array.isArray(t[n.name])||(t[n.name]=[t[n.name]]),t[n.name].push(n)):t[n.name][n.id]===void 0&&(t[n.name][n.id]=n)}parseProperty(e){const t=e.getString(1);let n;switch(t){case"C":return e.getBoolean();case"D":return e.getFloat64();case"F":return e.getFloat32();case"I":return e.getInt32();case"L":return e.getInt64();case"R":return n=e.getUint32(),e.getArrayBuffer(n);case"S":return n=e.getUint32(),e.getString(n);case"Y":return e.getInt16();case"b":case"c":case"d":case"f":case"i":case"l":const s=e.getUint32(),r=e.getUint32(),i=e.getUint32();if(r===0)switch(t){case"b":case"c":return e.getBooleanArray(s);case"d":return e.getFloat64Array(s);case"f":return e.getFloat32Array(s);case"i":return e.getInt32Array(s);case"l":return e.getInt64Array(s)}const a=Xs(new Uint8Array(e.getArrayBuffer(i))),o=new ft(a.buffer);switch(t){case"b":case"c":return o.getBooleanArray(s);case"d":return o.getFloat64Array(s);case"f":return o.getFloat32Array(s);case"i":return o.getInt32Array(s);case"l":return o.getInt64Array(s)}break;default:throw new Error("THREE.FBXLoader: Unknown property type "+t)}}}class ft{constructor(e,t){this.dv=new DataView(e),this.offset=0,this.littleEndian=t!==void 0?t:!0,this._textDecoder=new TextDecoder}getOffset(){return this.offset}size(){return this.dv.buffer.byteLength}skip(e){this.offset+=e}getBoolean(){return(this.getUint8()&1)===1}getBooleanArray(e){const t=[];for(let n=0;n<e;n++)t.push(this.getBoolean());return t}getUint8(){const e=this.dv.getUint8(this.offset);return this.offset+=1,e}getInt16(){const e=this.dv.getInt16(this.offset,this.littleEndian);return this.offset+=2,e}getInt32(){const e=this.dv.getInt32(this.offset,this.littleEndian);return this.offset+=4,e}getInt32Array(e){const t=[];for(let n=0;n<e;n++)t.push(this.getInt32());return t}getUint32(){const e=this.dv.getUint32(this.offset,this.littleEndian);return this.offset+=4,e}getInt64(){let e,t;return this.littleEndian?(e=this.getUint32(),t=this.getUint32()):(t=this.getUint32(),e=this.getUint32()),t&2147483648?(t=~t&4294967295,e=~e&4294967295,e===4294967295&&(t=t+1&4294967295),e=e+1&4294967295,-(t*4294967296+e)):t*4294967296+e}getInt64Array(e){const t=[];for(let n=0;n<e;n++)t.push(this.getInt64());return t}getUint64(){let e,t;return this.littleEndian?(e=this.getUint32(),t=this.getUint32()):(t=this.getUint32(),e=this.getUint32()),t*4294967296+e}getFloat32(){const e=this.dv.getFloat32(this.offset,this.littleEndian);return this.offset+=4,e}getFloat32Array(e){const t=[];for(let n=0;n<e;n++)t.push(this.getFloat32());return t}getFloat64(){const e=this.dv.getFloat64(this.offset,this.littleEndian);return this.offset+=8,e}getFloat64Array(e){const t=[];for(let n=0;n<e;n++)t.push(this.getFloat64());return t}getArrayBuffer(e){const t=this.dv.buffer.slice(this.offset,this.offset+e);return this.offset+=e,t}getString(e){const t=this.offset;let n=new Uint8Array(this.dv.buffer,t,e);this.skip(e);const s=n.indexOf(0);return s>=0&&(n=new Uint8Array(this.dv.buffer,t,s)),this._textDecoder.decode(n)}}class jt{add(e,t){this[e]=t}}function ur(l){const e="Kaydara FBX Binary  \0";return l.byteLength>=e.length&&e===Kt(l,0,e.length)}function hr(l){const e=["K","a","y","d","a","r","a","\\","F","B","X","\\","B","i","n","a","r","y","\\","\\"];let t=0;function n(s){const r=l[s-1];return l=l.slice(t+s),t++,r}for(let s=0;s<e.length;++s)if(n(1)===e[s])return!1;return!0}function gt(l){const e=/FBXVersion: (\d+)/,t=l.match(e);if(t)return parseInt(t[1]);throw new Error("THREE.FBXLoader: Cannot find the version number for the file given.")}function pr(l){return l/46186158e3}const fr=[];function Ae(l,e,t,n){let s;switch(n.mappingType){case"ByPolygonVertex":s=l;break;case"ByPolygon":s=e;break;case"ByVertice":s=t;break;case"AllSame":s=n.indices[0];break;default:console.warn("THREE.FBXLoader: unknown attribute mapping type "+n.mappingType)}n.referenceType==="IndexToDirect"&&(s=n.indices[s]);const r=s*n.dataSize,i=r+n.dataSize;return mr(fr,n.buffer,r,i)}const Ce=new Y,re=new b;function Yt(l){const e=new R,t=new R,n=new R,s=new R,r=new R,i=new R,a=new R,o=new R,u=new R,h=new R,c=new R,p=new R,f=l.inheritType?l.inheritType:0;if(l.translation&&e.setPosition(re.fromArray(l.translation)),l.preRotation){const N=l.preRotation.map(k.degToRad);N.push(l.eulerOrder||Y.DEFAULT_ORDER),t.makeRotationFromEuler(Ce.fromArray(N))}if(l.rotation){const N=l.rotation.map(k.degToRad);N.push(l.eulerOrder||Y.DEFAULT_ORDER),n.makeRotationFromEuler(Ce.fromArray(N))}if(l.postRotation){const N=l.postRotation.map(k.degToRad);N.push(l.eulerOrder||Y.DEFAULT_ORDER),s.makeRotationFromEuler(Ce.fromArray(N)),s.invert()}l.scale&&r.scale(re.fromArray(l.scale)),l.scalingOffset&&a.setPosition(re.fromArray(l.scalingOffset)),l.scalingPivot&&i.setPosition(re.fromArray(l.scalingPivot)),l.rotationOffset&&o.setPosition(re.fromArray(l.rotationOffset)),l.rotationPivot&&u.setPosition(re.fromArray(l.rotationPivot)),l.parentMatrixWorld&&(c.copy(l.parentMatrix),h.copy(l.parentMatrixWorld));const g=t.clone().multiply(n).multiply(s),m=new R;m.extractRotation(h);const d=new R;d.copyPosition(h);const _=d.clone().invert().multiply(h),T=m.clone().invert().multiply(_),w=r,y=new R;if(f===0)y.copy(m).multiply(g).multiply(T).multiply(w);else if(f===1)y.copy(m).multiply(T).multiply(g).multiply(w);else{const P=new R().scale(new b().setFromMatrixScale(c)).clone().invert(),ee=T.clone().multiply(P);y.copy(m).multiply(g).multiply(ee).multiply(w)}const M=u.clone().invert(),A=i.clone().invert();let F=e.clone().multiply(o).multiply(u).multiply(t).multiply(n).multiply(s).multiply(M).multiply(a).multiply(i).multiply(r).multiply(A);const S=new R().copyPosition(F),L=h.clone().multiply(S);return p.copyPosition(L),F=p.clone().multiply(y),F.premultiply(h.invert()),F}function zt(l){l=l||0;const e=["ZYX","YZX","XZY","ZXY","YXZ","XYZ"];return l===6?(console.warn("THREE.FBXLoader: unsupported Euler Order: Spherical XYZ. Animations and rotations may be incorrect."),e[0]):e[l]}function Be(l){return l.split(",").map(function(t){return parseFloat(t)})}function Kt(l,e,t){return e===void 0&&(e=0),t===void 0&&(t=l.byteLength),new TextDecoder().decode(new Uint8Array(l,e,t))}function gr(l,e){for(let t=0,n=l.length,s=e.length;t<s;t++,n++)l[n]=e[t]}function mr(l,e,t,n){for(let s=t,r=0;s<n;s++,r++)l[r]=e[s];return l}const dr={mixamorigHips:"hips",mixamorigSpine:"spine",mixamorigSpine1:"chest",mixamorigSpine2:"upperChest",mixamorigNeck:"neck",mixamorigHead:"head",mixamorigLeftShoulder:"leftShoulder",mixamorigLeftArm:"leftUpperArm",mixamorigLeftForeArm:"leftLowerArm",mixamorigLeftHand:"leftHand",mixamorigLeftHandThumb1:"leftThumbProximal",mixamorigLeftHandThumb2:"leftThumbIntermediate",mixamorigLeftHandThumb3:"leftThumbDistal",mixamorigLeftHandIndex1:"leftIndexProximal",mixamorigLeftHandIndex2:"leftIndexIntermediate",mixamorigLeftHandIndex3:"leftIndexDistal",mixamorigLeftHandMiddle1:"leftMiddleProximal",mixamorigLeftHandMiddle2:"leftMiddleIntermediate",mixamorigLeftHandMiddle3:"leftMiddleDistal",mixamorigLeftHandRing1:"leftRingProximal",mixamorigLeftHandRing2:"leftRingIntermediate",mixamorigLeftHandRing3:"leftRingDistal",mixamorigLeftHandPinky1:"leftLittleProximal",mixamorigLeftHandPinky2:"leftLittleIntermediate",mixamorigLeftHandPinky3:"leftLittleDistal",mixamorigRightShoulder:"rightShoulder",mixamorigRightArm:"rightUpperArm",mixamorigRightForeArm:"rightLowerArm",mixamorigRightHand:"rightHand",mixamorigRightHandPinky1:"rightLittleProximal",mixamorigRightHandPinky2:"rightLittleIntermediate",mixamorigRightHandPinky3:"rightLittleDistal",mixamorigRightHandRing1:"rightRingProximal",mixamorigRightHandRing2:"rightRingIntermediate",mixamorigRightHandRing3:"rightRingDistal",mixamorigRightHandMiddle1:"rightMiddleProximal",mixamorigRightHandMiddle2:"rightMiddleIntermediate",mixamorigRightHandMiddle3:"rightMiddleDistal",mixamorigRightHandIndex1:"rightIndexProximal",mixamorigRightHandIndex2:"rightIndexIntermediate",mixamorigRightHandIndex3:"rightIndexDistal",mixamorigRightHandThumb1:"rightThumbProximal",mixamorigRightHandThumb2:"rightThumbIntermediate",mixamorigRightHandThumb3:"rightThumbDistal",mixamorigLeftUpLeg:"leftUpperLeg",mixamorigLeftLeg:"leftLowerLeg",mixamorigLeftFoot:"leftFoot",mixamorigLeftToeBase:"leftToes",mixamorigRightUpLeg:"rightUpperLeg",mixamorigRightLeg:"rightLowerLeg",mixamorigRightFoot:"rightFoot",mixamorigRightToeBase:"rightToes"};async function _r(l,e){}function mt(l,e){return new rr().loadAsync(l).then(n=>{const s=xe.findByName(n.animations,"mixamo.com"),r=[],i=new O,a=new O,o=new O,u=new b,h=n.getObjectByName("mixamorigHips")?.position.y,c=e.humanoid?.getNormalizedBoneNode("hips")?.getWorldPosition(u).y,p=e.scene.getWorldPosition(u).y;let f=1;c!==void 0&&p!==void 0&&h!==void 0?f=Math.abs(c-p)/h:console.error("One or more variables are undefined:",{vrmHipsY:c,vrmRootY:p,motionHipsHeight:h}),s.tracks.forEach(m=>{const d=m.name.split("."),_=d[0],T=dr[_],w=e.humanoid?.getNormalizedBoneNode(T)?.name,y=n.getObjectByName(_);if(w!=null){const M=d[1];if(y?.getWorldQuaternion(i).invert(),y?.parent?.getWorldQuaternion(a),m instanceof ue){for(let A=0;A<m.values.length;A+=4){const F=m.values.slice(A,A+4);o.fromArray(F),o.premultiply(a).multiply(i),o.toArray(F),F.forEach((S,L)=>{m.values[L+A]=S})}r.push(new ue(`${w}.${M}`,m.times,m.values.map((A,F)=>e.meta?.metaVersion==="0"&&F%2===0?-A:A)))}else if(m instanceof le){const A=m.values.map((F,S)=>(e.meta?.metaVersion==="0"&&S%3!==1?-F:F)*f);r.push(new le(`${w}.${M}`,m.times,A))}}});const g=new xe("vrmAnimation",s.duration,r);return _r(),g})}const dt=2048;class wr{audio;analyser;timeDomainData;constructor(e){this.audio=e,this.analyser=e.createAnalyser(),this.timeDomainData=new Float32Array(dt)}update(){this.analyser.getFloatTimeDomainData(this.timeDomainData);let e=0;for(let t=0;t<dt;t++)e=Math.max(e,Math.abs(this.timeDomainData[t]));return e=1/(1+Math.exp(-45*e+5)),e<.1&&(e=0),{volume:e}}async playFromArrayBuffer(e,t){try{if(e===null)return;const n=await this.audio.decodeAudioData(e),s=this.audio.createBufferSource();s.buffer=n,s.connect(this.audio.destination),s.connect(this.analyser),s.start(),t&&s.addEventListener("ended",t)}catch(n){console.error(n),t?.()}}}class Tr{_vrm;_lookAtTarget;constructor(e,t){this._vrm=e,this._lookAtTarget=new oe,t.add(this._lookAtTarget)}start(){this._vrm.lookAt&&(this._vrm.lookAt.target=this._lookAtTarget)}}const yr=.12,Ar=5;class Fr{_expressionManager;_remainingTime;_isOpen;_isAutoBlink;constructor(e){this._expressionManager=e,this._remainingTime=0,this._isAutoBlink=!0,this._isOpen=!0}setEnable(e){return this._isAutoBlink=e,this._isOpen?0:this._remainingTime}update(e){if(this._remainingTime>0){this._remainingTime-=e;return}if(this._isOpen&&this._isAutoBlink){this.close();return}this.open()}close(){this._isOpen=!1,this._remainingTime=yr,this._expressionManager.setValue("blink",1)}open(){this._isOpen=!0,this._remainingTime=Ar,this._expressionManager.setValue("blink",0)}}class Er{primitives;index;weight;constructor({primitives:e,index:t,weight:n}){this.primitives=e,this.index=t,this.weight=n}applyWeight(e){this.primitives.forEach(t=>{t.morphTargetInfluences?.[this.index]!=null&&(t.morphTargetInfluences[this.index]+=this.weight*e)})}clearAppliedWeight(){this.primitives.forEach(e=>{e.morphTargetInfluences?.[this.index]!=null&&(e.morphTargetInfluences[this.index]=0)})}}function xr(l,e){const t=[];return e.forEach(({name:n,targets:s})=>{const r=new Hn(n),i=l.scene.getObjectByName("Face");if(!i){console.warn("vrm.faceObjectNotFound");return}const a=i.children.filter(h=>h instanceof $e),u=i.children[0].morphTargetDictionary;if(!u){console.warn("vrm.morphTargetDictionaryNotFound");return}s.forEach(({targetName:h,weight:c})=>{u[h]!==void 0?r.addBind(new Er({primitives:a,index:u[h],weight:c})):console.warn("vrm.targetNotFound",{values:{targetName:h}})}),t.push(r)}),t}const _t=[{name:"Fcl_EYE_Natural",targets:[{targetName:"Fcl_EYE_Natural",weight:1}]},{name:"Fcl_EYE_Angry",targets:[{targetName:"Fcl_EYE_Angry",weight:1}]},{name:"Fcl_EYE_Close",targets:[{targetName:"Fcl_EYE_Close",weight:1}]},{name:"Fcl_EYE_Close_R",targets:[{targetName:"Fcl_EYE_Close_R",weight:1}]},{name:"Fcl_EYE_Close_L",targets:[{targetName:"Fcl_EYE_Close_L",weight:1}]},{name:"Fcl_EYE_Fun",targets:[{targetName:"Fcl_EYE_Fun",weight:1}]},{name:"Fcl_EYE_Joy",targets:[{targetName:"Fcl_EYE_Joy",weight:1}]},{name:"Fcl_EYE_Joy_R",targets:[{targetName:"Fcl_EYE_Joy_R",weight:1}]},{name:"Fcl_EYE_Joy_L",targets:[{targetName:"Fcl_EYE_Joy_L",weight:1}]},{name:"Fcl_EYE_Sorrow",targets:[{targetName:"Fcl_EYE_Sorrow",weight:1}]},{name:"Fcl_EYE_Surprised",targets:[{targetName:"Fcl_EYE_Surprised",weight:1}]},{name:"Fcl_EYE_Spread",targets:[{targetName:"Fcl_EYE_Spread",weight:1}]},{name:"Fcl_EYE_Iris_Hide",targets:[{targetName:"Fcl_EYE_Iris_Hide",weight:1}]},{name:"Fcl_EYE_Highlight_Hide",targets:[{targetName:"Fcl_EYE_Highlight_Hide",weight:1}]},{name:"Fcl_MTH_Close",targets:[{targetName:"Fcl_MTH_Close",weight:1}]},{name:"Fcl_MTH_Up",targets:[{targetName:"Fcl_MTH_Up",weight:1}]},{name:"Fcl_MTH_Down",targets:[{targetName:"Fcl_MTH_Down",weight:1}]},{name:"Fcl_MTH_Angry",targets:[{targetName:"Fcl_MTH_Angry",weight:1}]},{name:"Fcl_MTH_Small",targets:[{targetName:"Fcl_MTH_Small",weight:1}]},{name:"Fcl_MTH_Large",targets:[{targetName:"Fcl_MTH_Large",weight:1}]},{name:"Fcl_MTH_Neutral",targets:[{targetName:"Fcl_MTH_Neutral",weight:1}]},{name:"Fcl_MTH_Fun",targets:[{targetName:"Fcl_MTH_Fun",weight:1}]},{name:"Fcl_MTH_Joy",targets:[{targetName:"Fcl_MTH_Joy",weight:1}]},{name:"Fcl_MTH_Sorrow",targets:[{targetName:"Fcl_MTH_Sorrow",weight:1}]},{name:"Fcl_MTH_Surprised",targets:[{targetName:"Fcl_MTH_Surprised",weight:1}]},{name:"Fcl_MTH_SkinFung",targets:[{targetName:"Fcl_MTH_SkinFung",weight:1}]},{name:"Fcl_MTH_SkinFung_R",targets:[{targetName:"Fcl_MTH_SkinFung_R",weight:1}]},{name:"Fcl_MTH_SkinFung_L",targets:[{targetName:"Fcl_MTH_SkinFung_L",weight:1}]},{name:"Fcl_MTH_A",targets:[{targetName:"Fcl_MTH_A",weight:1}]},{name:"Fcl_MTH_I",targets:[{targetName:"Fcl_MTH_I",weight:1}]},{name:"Fcl_MTH_U",targets:[{targetName:"Fcl_MTH_U",weight:1}]},{name:"Fcl_MTH_E",targets:[{targetName:"Fcl_MTH_E",weight:1}]},{name:"Fcl_MTH_O",targets:[{targetName:"Fcl_MTH_O",weight:1}]},{name:"Fcl_HA_Hide",targets:[{targetName:"Fcl_HA_Hide",weight:1}]},{name:"Fcl_HA_Fung1",targets:[{targetName:"Fcl_HA_Fung1",weight:1}]},{name:"Fcl_HA_Fung1_Low",targets:[{targetName:"Fcl_HA_Fung1_Low",weight:1}]},{name:"Fcl_HA_Fung1_Up",targets:[{targetName:"Fcl_HA_Fung1_Up",weight:1}]},{name:"Fcl_HA_Fung2",targets:[{targetName:"Fcl_HA_Fung2",weight:1}]},{name:"Fcl_HA_Fung2_Low",targets:[{targetName:"Fcl_HA_Fung2_Low",weight:1}]},{name:"Fcl_HA_Fung2_Up",targets:[{targetName:"Fcl_HA_Fung2_Up",weight:1}]},{name:"Fcl_HA_Fung3",targets:[{targetName:"Fcl_HA_Fung3",weight:1}]},{name:"Fcl_HA_Fung3_Up",targets:[{targetName:"Fcl_HA_Fung3_Up",weight:1}]},{name:"Fcl_HA_Fung3_Low",targets:[{targetName:"Fcl_HA_Fung3_Low",weight:1}]},{name:"Fcl_HA_Short",targets:[{targetName:"Fcl_HA_Short",weight:1}]},{name:"Fcl_HA_Short_Up",targets:[{targetName:"Fcl_HA_Short_Up",weight:1}]},{name:"Fcl_HA_Short_Low",targets:[{targetName:"Fcl_HA_Short_Low",weight:1}]},{name:"admiration",targets:[{targetName:"Fcl_BRW_Surprised",weight:1},{targetName:"Fcl_EYE_Spread",weight:1},{targetName:"Fcl_MTH_Joy",weight:.45},{targetName:"Fcl_MTH_O",weight:.7},{targetName:"Fcl_MTH_Down",weight:.25},{targetName:"Fcl_MTH_Large",weight:1-.45}]},{name:"amusement",targets:[{targetName:"Fcl_EYE_Fun",weight:.8},{targetName:"Fcl_MTH_Fun",weight:.9},{targetName:"Fcl_BRW_Fun",weight:.7}]},{name:"anger",targets:[{targetName:"Fcl_BRW_Angry",weight:.7},{targetName:"Fcl_EYE_Angry",weight:.9},{targetName:"Fcl_MTH_Angry",weight:.8}]},{name:"annoyance",targets:[{targetName:"Fcl_BRW_Angry",weight:.6},{targetName:"Fcl_EYE_Close_R",weight:.6},{targetName:"Fcl_EYE_Close_L",weight:.6},{targetName:"Fcl_MTH_Angry",weight:.7}]},{name:"approval",targets:[{targetName:"Fcl_EYE_Joy",weight:.8},{targetName:"Fcl_MTH_Fun",weight:.7},{targetName:"Fcl_BRW_Fun",weight:.5}]},{name:"caring",targets:[{targetName:"Fcl_EYE_Joy",weight:.46},{targetName:"Fcl_EYE_Sorrow",weight:1},{targetName:"Fcl_EYE_Surprised",weight:.89},{targetName:"Fcl_EYE_Highlight_Hide",weight:.64},{targetName:"Fcl_MTH_Down",weight:.01},{targetName:"Fcl_MTH_Angry",weight:.91},{targetName:"Fcl_MTH_Large",weight:.33}]},{name:"confusion",targets:[{targetName:"Fcl_EYE_Surprised",weight:.7},{targetName:"Fcl_BRW_Surprised",weight:.6},{targetName:"Fcl_MTH_Neutral",weight:.4}]},{name:"curiosity",targets:[{targetName:"Fcl_EYE_Natural",weight:.9},{targetName:"Fcl_BRW_Joy",weight:.7},{targetName:"Fcl_MTH_Small",weight:.4},{targetName:"Fcl_EYE_Surprised",weight:.3}]},{name:"desire",targets:[{targetName:"Fcl_EYE_Close",weight:.7},{targetName:"Fcl_MTH_Fun",weight:.8}]},{name:"disappointment",targets:[{targetName:"Fcl_BRW_Sorrow",weight:.39},{targetName:"Fcl_EYE_Sorrow",weight:.6},{targetName:"Fcl_MTH_Close",weight:1},{targetName:"Fcl_EYE_Highlight_Hide",weight:1},{targetName:"Fcl_MTH_Angry",weight:.42},{targetName:"Fcl_MTH_Large",weight:.01},{targetName:"Fcl_EYE_Surprised",weight:1},{targetName:"Fcl_EYE_Close",weight:.13},{targetName:"Fcl_EYE_Angry",weight:.47}]},{name:"disapproval",targets:[{targetName:"Fcl_BRW_Angry",weight:.61},{targetName:"Fcl_EYE_Angry",weight:1},{targetName:"Fcl_MTH_Angry",weight:.64},{targetName:"Fcl_MTH_Small",weight:.53},{targetName:"Fcl_EYE_Sorrow",weight:1}]},{name:"disgust",targets:[{targetName:"Fcl_EYE_Highlight_Hide",weight:1},{targetName:"Fcl_EYE_Surprised",weight:1},{targetName:"Fcl_EYE_Spread",weight:.48},{targetName:"Fcl_BRW_Joy",weight:.1},{targetName:"Fcl_BRW_Sorrow",weight:.69},{targetName:"Fcl_MTH_Sorrow",weight:.48},{targetName:"Fcl_MTH_Angry",weight:.47},{targetName:"Fcl_MTH_Small",weight:.02},{targetName:"Fcl_MTH_Large",weight:.45},{targetName:"Fcl_MTH_Down",weight:.18}]},{name:"embarrassment",targets:[{targetName:"Fcl_MTH_Small",weight:.76},{targetName:"Fcl_BRW_Joy",weight:.44},{targetName:"Fcl_BRW_Sorrow",weight:.16},{targetName:"Fcl_EYE_Sorrow",weight:1},{targetName:"Fcl_EYE_Fun",weight:1},{targetName:"Fcl_EYE_Spread",weight:.72},{targetName:"Fcl_EYE_Highlight_Hide",weight:.52},{targetName:"Fcl_MTH_Close",weight:1},{targetName:"Fcl_MTH_Angry",weight:.48},{targetName:"Fcl_MTH_Up",weight:.28}]},{name:"excitement",targets:[{targetName:"Fcl_EYE_Fun",weight:1},{targetName:"Fcl_MTH_Fun",weight:1},{targetName:"Fcl_BRW_Fun",weight:.68},{targetName:"Fcl_BRW_Angry",weight:.7},{targetName:"Fcl_EYE_Spread",weight:.38},{targetName:"Fcl_EYE_Surprised",weight:.4},{targetName:"Fcl_MTH_Joy",weight:.46},{targetName:"Fcl_MTH_Large",weight:.38}]},{name:"fear",targets:[{targetName:"Fcl_BRW_Sorrow",weight:1},{targetName:"Fcl_BRW_Surprised",weight:1},{targetName:"Fcl_EYE_Highlight_Hide",weight:.39},{targetName:"Fcl_MTH_Close",weight:1},{targetName:"Fcl_MTH_Neutral",weight:1},{targetName:"Fcl_MTH_Angry",weight:1},{targetName:"Fcl_EYE_Spread",weight:.83},{targetName:"Fcl_MTH_Small",weight:.58},{targetName:"Fcl_EYE_Surprised",weight:1},{targetName:"Fcl_EYE_Sorrow",weight:.41}]},{name:"gratitude",targets:[{targetName:"Fcl_MTH_Neutral",weight:1},{targetName:"Fcl_MTH_Fun",weight:1},{targetName:"Fcl_MTH_Close",weight:.4},{targetName:"Fcl_EYE_Sorrow",weight:1},{targetName:"Fcl_EYE_Fun",weight:1},{targetName:"Fcl_BRW_Sorrow",weight:.15},{targetName:"Fcl_BRW_Joy",weight:.22},{targetName:"Fcl_BRW_Angry",weight:.19}]},{name:"grief",targets:[{targetName:"Fcl_BRW_Sorrow",weight:1},{targetName:"Fcl_EYE_Sorrow",weight:.54},{targetName:"Fcl_EYE_Spread",weight:.25},{targetName:"Fcl_MTH_Angry",weight:.35},{targetName:"Fcl_MTH_A",weight:.31},{targetName:"Fcl_MTH_U",weight:.44},{targetName:"Fcl_MTH_Down",weight:.12}]},{name:"joy",targets:[{targetName:"Fcl_EYE_Joy",weight:1},{targetName:"Fcl_MTH_Joy",weight:1},{targetName:"Fcl_BRW_Joy",weight:.7}]},{name:"love",targets:[{targetName:"Fcl_EYE_Fun",weight:1},{targetName:"Fcl_BRW_Sorrow",weight:.17},{targetName:"Fcl_BRW_Surprised",weight:.57},{targetName:"Fcl_MTH_Close",weight:.99},{targetName:"Fcl_MTH_Fun",weight:.71},{targetName:"Fcl_MTH_Down",weight:.24},{targetName:"Fcl_EYE_Joy",weight:.25}]},{name:"nervousness",targets:[{targetName:"Fcl_MTH_Close",weight:1},{targetName:"Fcl_MTH_Small",weight:.53},{targetName:"Fcl_EYE_Spread",weight:.24},{targetName:"Fcl_EYE_Sorrow",weight:.86},{targetName:"Fcl_EYE_Surprised",weight:1},{targetName:"Fcl_EYE_Close",weight:.17},{targetName:"Fcl_BRW_Angry",weight:.26}]},{name:"optimism",targets:[{targetName:"Fcl_EYE_Close",weight:1},{targetName:"Fcl_BRW_Fun",weight:1},{targetName:"Fcl_MTH_Large",weight:.56},{targetName:"Fcl_MTH_Fun",weight:1}]},{name:"pride",targets:[{targetName:"Fcl_EYE_Close",weight:.16},{targetName:"Fcl_MTH_Fun",weight:1},{targetName:"Fcl_BRW_Angry",weight:.7},{targetName:"Fcl_MTH_Joy",weight:.18},{targetName:"Fcl_MTH_Large",weight:.17}]},{name:"realization",targets:[{targetName:"Fcl_MTH_Small",weight:1},{targetName:"Fcl_EYE_Surprised",weight:1},{targetName:"Fcl_MTH_Joy",weight:.22},{targetName:"Fcl_MTH_Surprised",weight:.11},{targetName:"Fcl_BRW_Joy",weight:.66}]},{name:"relief",targets:[{targetName:"Fcl_MTH_Fun",weight:1},{targetName:"Fcl_BRW_Fun",weight:.74},{targetName:"Fcl_BRW_Joy",weight:.77},{targetName:"Fcl_BRW_Surprised",weight:.05},{targetName:"Fcl_EYE_Joy",weight:.12},{targetName:"Fcl_MTH_Close",weight:.57},{targetName:"Fcl_MTH_Neutral",weight:.43},{targetName:"Fcl_MTH_Small",weight:.15}]},{name:"remorse",targets:[{targetName:"Fcl_BRW_Sorrow",weight:.51},{targetName:"Fcl_BRW_Surprised",weight:.51},{targetName:"Fcl_EYE_Sorrow",weight:1},{targetName:"Fcl_EYE_Surprised",weight:1},{targetName:"Fcl_EYE_Highlight_Hide",weight:.59},{targetName:"Fcl_MTH_Down",weight:.55},{targetName:"Fcl_MTH_Angry",weight:.45}]},{name:"sadness",targets:[{targetName:"Fcl_MTH_Sorrow",weight:.41},{targetName:"Fcl_MTH_Angry",weight:.51},{targetName:"Fcl_MTH_Close",weight:1},{targetName:"Fcl_EYE_Highlight_Hide",weight:1},{targetName:"Fcl_EYE_Sorrow",weight:1},{targetName:"Fcl_MTH_O",weight:.14},{targetName:"Fcl_HA_Hide",weight:1},{targetName:"Fcl_EYE_Surprised",weight:1},{targetName:"Fcl_EYE_Close",weight:.8}]},{name:"surprise",targets:[{targetName:"Fcl_EYE_Surprised",weight:1},{targetName:"Fcl_MTH_Surprised",weight:1},{targetName:"Fcl_BRW_Surprised",weight:.8}]},{name:"neutral",targets:[{targetName:"Fcl_ALL_Neutral",weight:1}]}];class Mr{_autoLookAt;_autoBlink;_expressionManager;_currentLipSync;_currentExpressions=[];constructor(e,t){this._autoLookAt=new Tr(e,t),this._autoLookAt.start(),this._currentLipSync=null,e.expressionManager&&(this._expressionManager=e.expressionManager,this._autoBlink=new Fr(e.expressionManager));const n=["Fcl_MTH_A","Fcl_MTH_I","Fcl_MTH_U","Fcl_MTH_E","Fcl_MTH_O","Fcl_MTH_Joy","Fcl_MTH_Sorrow","Fcl_MTH_Surprised"];_t.forEach(r=>{r.targets.forEach(i=>{n.includes(i.targetName)&&(i.weight=0)})}),xr(e,_t).forEach(r=>{this._expressionManager?.registerExpression(r)})}_easeInOutSine(e){return .5*(1-Math.cos(Math.PI*e))}playEmotion(e){this._currentExpressions=this._currentExpressions.map(t=>{const n=e.find(s=>s.key===t.key);return{key:t.key,value:t.target_value,target_value:n?.value??0,ease_time:0}}),e.forEach(t=>{this._currentExpressions.find(n=>n.key===t.key)===void 0&&this._currentExpressions.push({key:t.key,value:0,target_value:t.value,ease_time:0})})}lipSync(e,t){this._currentLipSync&&this._expressionManager?.setValue(this._currentLipSync.preset,0),this._currentLipSync={preset:e,value:t}}lerp(e,t,n){return e+n*(t-e)}update(e){if(this._autoBlink&&this._autoBlink.update(e),this._currentExpressions.forEach(t=>{t.ease_time!==1&&(t.ease_time=Math.min(t.ease_time+e,1),this._expressionManager?.setValue(t.key,this.lerp(t.value,t.target_value,this._easeInOutSine(t.ease_time))))}),this._currentExpressions=this._currentExpressions.filter(t=>t.target_value!==0||t.ease_time!==1),this._currentLipSync){const t=this._currentLipSync.value*.5;this._expressionManager?.setValue(this._currentLipSync.preset,t)}}}function Xt(l,e,t,n,s){if(n<=0)return;const r=2*Math.log(2)/n,i=l.clone().sub(t),a=e.clone().addScaledVector(i,r),o=Math.exp(-r*s);l.copy(t).addScaledVector(i.addScaledVector(a,s),o),e.copy(a).sub(i.multiplyScalar(r)).multiplyScalar(o)}function Rr(l,e,t,n,s){if(e.lengthSq()>1e-12){const u=new Ht().setFromAxisAngle(e.clone().normalize(),e.length()*s);l.multiply(u).normalize()}const r=l.clone().invert().multiply(t).normalize();r.w<0&&(r.x*=-1,r.y*=-1,r.z*=-1,r.w*=-1);const i=2*Math.acos(Ke.clamp(r.w,-1,1));if(i<1e-5){e.set(0,0,0);return}const o=new B(r.x,r.y,r.z).normalize().multiplyScalar(i);Xt(o,e,new B(0,0,0),n,s)}function vr(l){return l.halfPos===0?!0:l.velPos.lengthSq()<1e-6&&l.bone.position.distanceToSquared(l.originalPos)<1e-4}function Sr(l){const t=2*(1-Math.abs(l.bone.quaternion.dot(l.originalQuat)));return l.velRot.lengthSq()<1e-4&&t<1e-4}const Lr=Jn([]);function Nr(l,e,t=Math.random()*360){Lr.update(n=>[...n,{id:crypto.randomUUID(),x:l,y:e,angle:t}])}function Ir(l,e=["Hips","hips","Root","mixamorigHips"]){const t=Array.isArray(l)?l:[l];for(const n of t)n.tracks=n.tracks.filter(s=>{if(!(s instanceof le))return!0;const[r,i]=s.name.split(".");return!(e.includes(r)&&i==="position")}),n.resetDuration();return t}function br(l,e,t,n,s,r){const i=new B().subVectors(t,l).multiplyScalar(n).addScaledVector(e,-s);e.addScaledVector(i,r),l.addScaledVector(e,r)}class Hr{cfg={rotImpulseHead:15,halfRotHead:.25,rotImpulseBody:12,halfRotBody:.25,rotImpulseLimb:10,halfRotLimb:.3};gltf=null;vrm=null;expressionController;lipSync;springManager;stateManager;lookPos=new B;lookVel=new B;lookTarget=new ye;gazeGoal=new ye;lookStiffness=120;lookDamping=25;hitStates=[];camera;raycaster=new Pn;hittableBones=[];mixer;actions={};lookAtTarget=new ye;lookAtGoal=new ye;eyeGazeTimer=0;nextGazeChangeTime=0;gazeMoveSpeed=1;isFollowingMouse=!1;constructor(){this.lipSync=new wr(new AudioContext)}canvas=null;setCanvas(e){this.canvas=e}async load(e,t){this.camera=t;const n=Hs();try{this.gltf=await n.loadAsync(e)}catch{console.warn("VRM load failed. Fallback to sample model."),this.gltf=await n.loadAsync("./AvatarSample_B.vrm")}if(this.vrm=this.gltf.userData.vrm,!this.vrm)return null;this.springManager=this.vrm.springBoneManager,this.springManager?.reset(),this.vrm.scene.add(this.lookTarget),this.vrm.scene.add(this.gazeGoal),this.vrm.lookAt.target=this.lookTarget,this.vrm.lookAt.autoUpdate=!0,this.stateManager=new kn(this,this.vrm);const s=["head","neck","upperChest","chest","spine","leftUpperArm","leftLowerArm","leftHand","rightUpperArm","rightLowerArm","rightHand","leftUpperLeg","leftLowerLeg","leftFoot","rightUpperLeg","rightLowerLeg","rightFoot"];return this.hittableBones=s.map(r=>this.vrm.humanoid.getRawBoneNode(r)).filter(r=>!!r),this.expressionController=new Mr(this.vrm,t),this.setupLookAt(),this.vrm}async initAnimations(){if(!this.vrm)return;this.mixer=new Dn(this.vrm.scene);const e=["Breathing Idle.fbx","Breathing Idle1.fbx","Breathing Idle2.fbx","Idle_nomal.fbx","base/Idle Base.fbx","base/Arms crossed.fbx","base/Hands on waist.fbx","base/Looking Around.fbx","Neck Stretching.fbx","Arm Stretching.fbx","Yawning.fbx","base/Listening.fbx","base/Listening2.fbx","base/Listening Start.fbx","base/Listening End.fbx","base/talk1.fbx","base/talk2.fbx","base/talk3.fbx"];this.actions={},await Promise.all(e.map(async t=>{const n=await mt(`/animations/${t}`,this.vrm);t.includes("/")&&(t=t.split("/")[1]),Ir(n);const s=this.mixer.clipAction(n);this.actions[t]=s}))}async loadAnimations(e){const n=await(await fetch("/anims.json")).json();for(const s of n)mt(Qn+`/animations/${s}`,e).then(r=>{this.actions==null&&(this.actions={}),this.actions&&this.mixer&&(this.actions={...this.actions,[s]:this.mixer.clipAction(r)},console.log("load animation :",s))})}Emotion(e,t=1){this.expressionController?.playEmotion([{key:e,value:t}])}setupLookAt(){if(this.vrm?.lookAt){if(this.vrm.lookAt){this.vrm.scene.add(this.lookAtTarget),this.vrm.scene.add(this.lookAtGoal);const e=this.vrm.humanoid.getRawBoneNode("head"),t=this.vrm.lookAt.applier.applyYawPitch;this.vrm.lookAt.applier.applyYawPitch=function(n,s){if(t.call(this,n,s),!e)return;const r=5,i=7,a=1.6,o=.2;let u=0;Math.abs(n)>r&&(u=(n-Math.sign(n)*r)*a);let h=0;Math.abs(s)>i&&(h=(s-Math.sign(s)*i)*a);const c=new Ht().setFromEuler(new Cn(h*Ke.DEG2RAD,u*Ke.DEG2RAD,0,"YXZ")),p=e.quaternion.clone().multiply(c);e.quaternion.slerp(p,o)},this.lookAtTarget.position.set(0,0,0),this.vrm.lookAt.target=this.lookAtTarget,this.vrm.lookAt.autoUpdate=!0}this.changeGaze()}}changeGaze(e={x:1.5,y:.8,z:1}){this.nextGazeChangeTime=2+Math.random()*5,this.eyeGazeTimer=0,this.gazeMoveSpeed=10+Math.random()*5,this.lookAtGoal.position.set((Math.random()-.5)*e.x,(Math.random()-.5)*e.y+1,Math.random()*e.z+.5)}startMouseFollowing(){this.isFollowingMouse=!0,this.gazeMoveSpeed=20}stopMouseFollowing(){this.isFollowingMouse=!1}updateMouseGaze(e,t){this.isFollowingMouse&&this.lookAtGoal.position.set(e*2,-t*1+1,1)}getHalfLifeParams(e){const t=e.toLowerCase();return t.includes("head")||t.includes("neck")?{halfPos:0,halfRot:this.cfg.halfRotHead}:t.includes("chest")||t.includes("spine")||t.includes("upperchest")?{halfPos:.25,halfRot:this.cfg.halfRotBody}:{halfPos:.25,halfRot:this.cfg.halfRotLimb}}getHalfLifeParams2(e){const s=e.toLowerCase();return{halfPos:s.includes("head")||s.includes("neck")?0:.25,halfRot:s.includes("head")||s.includes("neck")?.18:.25}}mouseFollowTimer=null;hitByMouse(e,t,n=1){this.resetHitSprings(),this.raycaster.setFromCamera({x:e,y:t},this.camera);const s=this.raycaster.ray;let r=null,i=1/0;const a=new B;for(const A of this.hittableBones){A.getWorldPosition(a);const F=s.distanceToPoint(a);F<.15&&F<i&&(r=A,i=F)}if(!r)return;const o=new B;r.getWorldPosition(o);const u=new B;s.closestPointToPoint(o,u);const h=u.clone().project(this.camera),c=this.canvas.getBoundingClientRect(),p=(h.x*.5+.5)*c.width+c.left,f=(-h.y*.5+.5)*c.height+c.top;Nr(p,f);const g=u.clone().sub(o),m=new B().crossVectors(s.direction,g);m.lengthSq()<1e-6&&m.set(0,1,0).cross(s.direction),m.normalize();const d=r.name.toLowerCase(),_=d.includes("head")||d.includes("neck")?this.cfg.rotImpulseHead:d.includes("chest")||d.includes("spine")?this.cfg.rotImpulseBody:this.cfg.rotImpulseLimb,{halfPos:T,halfRot:w}=this.getHalfLifeParams(r.name),y=s.direction.clone().multiplyScalar(.6*n),M=m.multiplyScalar(_*n);this.hitStates.push({bone:r,originalPos:r.position.clone(),originalQuat:r.quaternion.clone(),velPos:y,velRot:M,halfPos:T,halfRot:w}),this.startMouseFollowing(),this.mouseFollowTimer&&clearTimeout(this.mouseFollowTimer),this.mouseFollowTimer=setTimeout(()=>{this.stopMouseFollowing()},3e3)}async speak(e){await new Promise(t=>{this.lipSync.playFromArrayBuffer(e,()=>t(!0))})}resetHitSprings(){for(const e of this.hitStates)e.bone.position.copy(e.originalPos),e.bone.quaternion.copy(e.originalQuat),e.bone.updateMatrixWorld(!0);this.hitStates.length=0,this.hitStates=[]}applyHitSprings(e){for(let t=this.hitStates.length-1;t>=0;--t){const n=this.hitStates[t];Xt(n.bone.position,n.velPos,n.originalPos,n.halfPos,e),Rr(n.bone.quaternion,n.velRot,n.originalQuat,n.halfRot,e),n.bone.updateMatrixWorld(!0),vr(n)&&Sr(n)&&(n.bone.position.copy(n.originalPos),n.bone.quaternion.copy(n.originalQuat),this.hitStates.splice(t,1))}}fps=0;DEBUG_MODE=!1;doGesture(e){this.stateManager?.triggerGesture(e)}update(e){if(!this.vrm)return;br(this.lookPos,this.lookVel,this.gazeGoal.position,this.lookStiffness,this.lookDamping,e),this.lookTarget.position.copy(this.lookPos),this.eyeGazeTimer+=e,!this.isFollowingMouse&&this.eyeGazeTimer>this.nextGazeChangeTime&&this.changeGaze(),this.lookAtTarget.position.distanceTo(this.lookAtGoal.position)>.01&&this.lookAtTarget.position.lerp(this.lookAtGoal.position,e*this.gazeMoveSpeed);const n=this.lipSync.update().volume;this.expressionController?.lipSync("aa",n),this.expressionController?.update(e),this.mixer?.update(e),this.springManager?.update(e),this.vrm.update(e),this.stateManager?.update(e),this.applyHitSprings(e),this.fps+=e,this.DEBUG_MODE&&this.fps>1&&(this.fps=0,console.log("DEBUG INFO: ",this.stateManager?.getDebugInfo()))}dispose(){this.vrm&&(Bn.deepDispose(this.vrm.scene),this.vrm=null)}}const H=[];for(let l=0;l<256;++l)H.push((l+256).toString(16).slice(1));function Pr(l,e=0){return(H[l[e+0]]+H[l[e+1]]+H[l[e+2]]+H[l[e+3]]+"-"+H[l[e+4]]+H[l[e+5]]+"-"+H[l[e+6]]+H[l[e+7]]+"-"+H[l[e+8]]+H[l[e+9]]+"-"+H[l[e+10]]+H[l[e+11]]+H[l[e+12]]+H[l[e+13]]+H[l[e+14]]+H[l[e+15]]).toLowerCase()}let Oe;const kr=new Uint8Array(16);function Dr(){if(!Oe){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");Oe=crypto.getRandomValues.bind(crypto)}return Oe(kr)}const Cr=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),wt={randomUUID:Cr};function Br(l,e,t){if(wt.randomUUID&&!l)return wt.randomUUID();l=l||{};const n=l.random??l.rng?.()??Dr();if(n.length<16)throw new Error("Random bytes length must be >= 16");return n[6]=n[6]&15|64,n[8]=n[8]&63|128,Pr(n)}class Or{model=new Hr;renderer;scene;camera;clock=new On;canvas;id=Br();animationFrameId=null;isStopped=!1;postProcessing;constructor(e){this.canvas=e,this.renderer=new Un({canvas:e,antialias:!0,alpha:!0}),this.renderer.setSize(e.clientWidth,e.clientHeight),this.renderer.setPixelRatio(window.devicePixelRatio),this.renderer.outputColorSpace=Gn,this.scene=new Vn,this.camera=new jn(25,e.clientWidth/e.clientHeight,.1,100),this.camera.position.set(0,1.35,2.5),this.scene.remove(...this.scene.children.filter(s=>s instanceof Yn));const t=new zn(16777215,1.6);t.position.set(1,2,2),this.scene.add(t);const n=Kn(this.scene,this.camera);Xn(n,.1,.001,.2),this.postProcessing=new Wn(this.renderer),this.postProcessing.outputNode=n}getHeadPointInUI(){if(!this.model.vrm)return console.warn("VRM 모델이 로드되지 않았습니다."),null;const e=this.model.vrm.humanoid.getBoneNode("head");if(!e)return console.warn("헤드 본을 찾을 수 없습니다."),null;const t=new B;e.getWorldPosition(t);const n=t.clone().project(this.camera);if(n.z<1){const s=(n.x*.5+.5)*this.canvas.clientWidth,r=(n.y*-.5+.5)*this.canvas.clientHeight;return{x:Math.round(s),y:Math.round(r)}}return null}async loadModel(e){this.model.vrm&&this.scene.remove(this.model.vrm.scene);const t=await this.model.load(e,this.camera);if(!t)return console.error("VRM 로딩 실패"),null;t.scene.traverse(o=>{o.isMesh&&(o.castShadow=!0,o.receiveShadow=!0)});const n=new qn().setFromObject(t.scene);t.scene.position.y=-n.min.y,t.scene.updateMatrixWorld(!0);const s=new B;n.getSize(s);const r=new B;n.getCenter(r);const i=r.y+s.y/2*.9,a=s.y*1.5;return this.camera.position.set(r.x,i,a),this.camera.lookAt(new B(r.x,i,r.z)),this.camera.updateProjectionMatrix(),this.model.initAnimations(),this.scene.add(t.scene),this.clock.running||this.start(),this.model}renderLoop=async()=>{if(this.isStopped){console.log("Render loop stopped by flag.");return}const e=this.clock.getDelta();this.model.update(e),await this.renderer.renderAsync(this.scene,this.camera),this.postProcessing.render(),this.animationFrameId=requestAnimationFrame(this.renderLoop)};updateUIPosition(){if(!this.model?.vrm)return;const e=this.model.vrm.humanoid.getBoneNode("head");if(!e)return;console.log("--- UI Update ---");const t=new B;e.getWorldPosition(t),console.log("Head World Pos:",{x:t.x.toFixed(2),y:t.y.toFixed(2),z:t.z.toFixed(2)});const n=t.clone().project(this.camera);console.log("Projected (NDC):",{x:n.x.toFixed(2),y:n.y.toFixed(2),z:n.z.toFixed(2)});const s=n.z<1;console.log("Is On Screen?",s)}start(){this.clock.start(),this.renderLoop(),this.isStopped=!1}stop(){if(this.isStopped){console.log("Viewer is already stopped.");return}this.isStopped=!0,console.log("Stopping viewer and releasing resources..."),this.animationFrameId&&cancelAnimationFrame(this.animationFrameId),this.clock.stop(),this.model&&this.model.vrm&&(this.scene.remove(this.model.vrm.scene),console.log("VRM model removed from scene.")),this.renderer.dispose(),console.log("Renderer disposed."),this.model&&(this.model.vrm=null),console.log("Viewer stopped successfully.")}}let Wt=null,$=null;function Xr(){return $}function Wr(l,e){$&&$.stop(),$=new Or(l);let t=$.loadModel(`${en}${e.owner_id[0]}/${e.id}.vrm`);return t.then(n=>{Wt=n,$&&$.start()}),t}function qr(){Wt&&$?.stop()}export{Xr as g,Lr as s,Wr as t,qr as u};
