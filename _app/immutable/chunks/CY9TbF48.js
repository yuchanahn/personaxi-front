import{V as st}from"./BS5RVGlS.js";import{M as ot,a as lt,Q as Ve,b as we,V as I,O as te,R as ct,C as ht,A as gt,E as ut,c as mt,W as pt,S as ft,d as dt,P as _t,L as wt,D as yt,p as Ft,e as vt,f as xt,B as Tt}from"./pfmv5nwf.js";import{aj as Et,ak as le,f as P,al as Mt,L as ye,c as St,F as At,i as bt,R as He,r as Ne,a3 as Lt,am as ue,an as Ht,C as Y,S as ne,ao as Nt,g as M,U as Re,$ as Ie,y as ae,O as re,Y as Rt,W as It,P as Pe,X as R,e as Pt,D as kt,A as Dt,E as Ye,u as Bt,H as Ct,Z as Ot,ap as Vt,z as me,aq as J,ar as Yt,ah as Ut,V as zt,as as Gt,at as V,_ as Fe,Q as C,a4 as se,a6 as oe,a5 as Wt,au as jt,av as Xt}from"./vNtm5tQc.js";import"./C-VEydUt.js";import"./-4D0oWvs.js";import{b as Jt}from"./DqiWXVxP.js";import{G as qt}from"./D5415qcM.js";import{w as $t}from"./e6l8DgL1.js";import{v as Kt}from"./BKrj-4V8.js";function Qt(){const l=new qt;return l.register(e=>{const t=new ot(e,{materialType:lt});return new Et(e,{mtoonMaterialPlugin:t})}),l}/*!
fflate - fast JavaScript compression/decompression
<https://101arrowz.github.io/fflate>
Licensed under MIT. https://github.com/101arrowz/fflate/blob/master/LICENSE
version 0.8.2
*/var D=Uint8Array,$=Uint16Array,Zt=Int32Array,Ue=new D([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),ze=new D([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),en=new D([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),Ge=function(l,e){for(var t=new $(31),n=0;n<31;++n)t[n]=e+=1<<l[n-1];for(var i=new Zt(t[30]),n=1;n<30;++n)for(var r=t[n];r<t[n+1];++r)i[r]=r-t[n]<<5|n;return{b:t,r:i}},We=Ge(Ue,2),je=We.b,tn=We.r;je[28]=258,tn[258]=28;var nn=Ge(ze,0),rn=nn.b,ve=new $(32768);for(var E=0;E<32768;++E){var z=(E&43690)>>1|(E&21845)<<1;z=(z&52428)>>2|(z&13107)<<2,z=(z&61680)>>4|(z&3855)<<4,ve[E]=((z&65280)>>8|(z&255)<<8)>>1}var Q=function(l,e,t){for(var n=l.length,i=0,r=new $(e);i<n;++i)l[i]&&++r[l[i]-1];var a=new $(e);for(i=1;i<e;++i)a[i]=a[i-1]+r[i-1]<<1;var s;if(t){s=new $(1<<e);var o=15-e;for(i=0;i<n;++i)if(l[i])for(var g=i<<4|l[i],h=e-l[i],c=a[l[i]-1]++<<h,u=c|(1<<h)-1;c<=u;++c)s[ve[c]>>o]=g}else for(s=new $(n),i=0;i<n;++i)l[i]&&(s[i]=ve[a[l[i]-1]++]>>15-l[i]);return s},Z=new D(288);for(var E=0;E<144;++E)Z[E]=8;for(var E=144;E<256;++E)Z[E]=9;for(var E=256;E<280;++E)Z[E]=7;for(var E=280;E<288;++E)Z[E]=8;var Xe=new D(32);for(var E=0;E<32;++E)Xe[E]=5;var an=Q(Z,9,1),sn=Q(Xe,5,1),pe=function(l){for(var e=l[0],t=1;t<l.length;++t)l[t]>e&&(e=l[t]);return e},B=function(l,e,t){var n=e/8|0;return(l[n]|l[n+1]<<8)>>(e&7)&t},fe=function(l,e){var t=e/8|0;return(l[t]|l[t+1]<<8|l[t+2]<<16)>>(e&7)},on=function(l){return(l+7)/8|0},ln=function(l,e,t){return(t==null||t>l.length)&&(t=l.length),new D(l.subarray(e,t))},cn=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],O=function(l,e,t){var n=new Error(e||cn[l]);if(n.code=l,Error.captureStackTrace&&Error.captureStackTrace(n,O),!t)throw n;return n},hn=function(l,e,t,n){var i=l.length,r=0;if(!i||e.f&&!e.l)return t||new D(0);var a=!t,s=a||e.i!=2,o=e.i;a&&(t=new D(i*3));var g=function(Ae){var be=t.length;if(Ae>be){var Le=new D(Math.max(be*2,Ae));Le.set(t),t=Le}},h=e.f||0,c=e.p||0,u=e.b||0,m=e.l,p=e.d,f=e.m,d=e.n,y=i*8;do{if(!m){h=B(l,c,1);var v=B(l,c+1,3);if(c+=3,v)if(v==1)m=an,p=sn,f=9,d=5;else if(v==2){var F=B(l,c,31)+257,x=B(l,c+10,15)+4,L=F+B(l,c+5,31)+1;c+=14;for(var k=new D(L),b=new D(19),H=0;H<x;++H)b[en[H]]=B(l,c+H*3,7);c+=x*3;for(var W=pe(b),tt=(1<<W)-1,nt=Q(b,W,1),H=0;H<L;){var xe=nt[B(l,c,tt)];c+=xe&15;var _=xe>>4;if(_<16)k[H++]=_;else{var j=0,ee=0;for(_==16?(ee=3+B(l,c,3),c+=2,j=k[H-1]):_==17?(ee=3+B(l,c,7),c+=3):_==18&&(ee=11+B(l,c,127),c+=7);ee--;)k[H++]=j}}var Te=k.subarray(0,F),U=k.subarray(F);f=pe(Te),d=pe(U),m=Q(Te,f,1),p=Q(U,d,1)}else O(1);else{var _=on(c)+4,T=l[_-4]|l[_-3]<<8,A=_+T;if(A>i){o&&O(0);break}s&&g(u+T),t.set(l.subarray(_,A),u),e.b=u+=T,e.p=c=A*8,e.f=h;continue}if(c>y){o&&O(0);break}}s&&g(u+131072);for(var it=(1<<f)-1,rt=(1<<d)-1,ce=c;;ce=c){var j=m[fe(l,c)&it],X=j>>4;if(c+=j&15,c>y){o&&O(0);break}if(j||O(2),X<256)t[u++]=X;else if(X==256){ce=c,m=null;break}else{var Ee=X-254;if(X>264){var H=X-257,K=Ue[H];Ee=B(l,c,(1<<K)-1)+je[H],c+=K}var he=p[fe(l,c)&rt],ge=he>>4;he||O(3),c+=he&15;var U=rn[ge];if(ge>3){var K=ze[ge];U+=fe(l,c)&(1<<K)-1,c+=K}if(c>y){o&&O(0);break}s&&g(u+131072);var Me=u+Ee;if(u<U){var Se=r-U,at=Math.min(U,Me);for(Se+u<0&&O(3);u<at;++u)t[u]=n[Se+u]}for(;u<Me;++u)t[u]=t[u-U]}}e.l=m,e.p=ce,e.b=u,e.f=h,m&&(h=1,e.m=f,e.d=p,e.n=d)}while(!h);return u!=t.length&&a?ln(t,0,u):t.subarray(0,u)},gn=new D(0),un=function(l,e){return((l[0]&15)!=8||l[0]>>4>7||(l[0]<<8|l[1])%31)&&O(6,"invalid zlib data"),(l[1]>>5&1)==1&&O(6,"invalid zlib data: "+(l[1]&32?"need":"unexpected")+" dictionary"),(l[1]>>3&4)+2};function mn(l,e){return hn(l.subarray(un(l),-4),{i:2},e,e)}var pn=typeof TextDecoder<"u"&&new TextDecoder,fn=0;try{pn.decode(gn,{stream:!0}),fn=1}catch{}function Je(l,e,t){const n=t.length-l-1;if(e>=t[n])return n-1;if(e<=t[l])return l;let i=l,r=n,a=Math.floor((i+r)/2);for(;e<t[a]||e>=t[a+1];)e<t[a]?r=a:i=a,a=Math.floor((i+r)/2);return a}function dn(l,e,t,n){const i=[],r=[],a=[];i[0]=1;for(let s=1;s<=t;++s){r[s]=e-n[l+1-s],a[s]=n[l+s]-e;let o=0;for(let g=0;g<s;++g){const h=a[g+1],c=r[s-g],u=i[g]/(h+c);i[g]=o+h*u,o=c*u}i[s]=o}return i}function _n(l,e,t,n){const i=Je(l,n,e),r=dn(i,n,l,e),a=new le(0,0,0,0);for(let s=0;s<=l;++s){const o=t[i-l+s],g=r[s],h=o.w*g;a.x+=o.x*h,a.y+=o.y*h,a.z+=o.z*h,a.w+=o.w*g}return a}function wn(l,e,t,n,i){const r=[];for(let c=0;c<=t;++c)r[c]=0;const a=[];for(let c=0;c<=n;++c)a[c]=r.slice(0);const s=[];for(let c=0;c<=t;++c)s[c]=r.slice(0);s[0][0]=1;const o=r.slice(0),g=r.slice(0);for(let c=1;c<=t;++c){o[c]=e-i[l+1-c],g[c]=i[l+c]-e;let u=0;for(let m=0;m<c;++m){const p=g[m+1],f=o[c-m];s[c][m]=p+f;const d=s[m][c-1]/s[c][m];s[m][c]=u+p*d,u=f*d}s[c][c]=u}for(let c=0;c<=t;++c)a[0][c]=s[c][t];for(let c=0;c<=t;++c){let u=0,m=1;const p=[];for(let f=0;f<=t;++f)p[f]=r.slice(0);p[0][0]=1;for(let f=1;f<=n;++f){let d=0;const y=c-f,v=t-f;c>=f&&(p[m][0]=p[u][0]/s[v+1][y],d=p[m][0]*s[y][v]);const _=y>=-1?1:-y,T=c-1<=v?f-1:t-c;for(let F=_;F<=T;++F)p[m][F]=(p[u][F]-p[u][F-1])/s[v+1][y+F],d+=p[m][F]*s[y+F][v];c<=v&&(p[m][f]=-p[u][f-1]/s[v+1][c],d+=p[m][f]*s[c][v]),a[f][c]=d;const A=u;u=m,m=A}}let h=t;for(let c=1;c<=n;++c){for(let u=0;u<=t;++u)a[c][u]*=h;h*=t-c}return a}function yn(l,e,t,n,i){const r=i<l?i:l,a=[],s=Je(l,n,e),o=wn(s,n,l,r,e),g=[];for(let h=0;h<t.length;++h){const c=t[h].clone(),u=c.w;c.x*=u,c.y*=u,c.z*=u,g[h]=c}for(let h=0;h<=r;++h){const c=g[s-l].clone().multiplyScalar(o[h][0]);for(let u=1;u<=l;++u)c.add(g[s-l+u].clone().multiplyScalar(o[h][u]));a[h]=c}for(let h=r+1;h<=i+1;++h)a[h]=new le(0,0,0);return a}function Fn(l,e){let t=1;for(let i=2;i<=l;++i)t*=i;let n=1;for(let i=2;i<=e;++i)n*=i;for(let i=2;i<=l-e;++i)n*=i;return t/n}function vn(l){const e=l.length,t=[],n=[];for(let r=0;r<e;++r){const a=l[r];t[r]=new P(a.x,a.y,a.z),n[r]=a.w}const i=[];for(let r=0;r<e;++r){const a=t[r].clone();for(let s=1;s<=r;++s)a.sub(i[r-s].clone().multiplyScalar(Fn(r,s)*n[s]));i[r]=a.divideScalar(n[0])}return i}function xn(l,e,t,n,i){const r=yn(l,e,t,n,i);return vn(r)}class Tn extends Mt{constructor(e,t,n,i,r){super(),this.degree=e,this.knots=t,this.controlPoints=[],this.startKnot=i||0,this.endKnot=r||this.knots.length-1;for(let a=0;a<n.length;++a){const s=n[a];this.controlPoints[a]=new le(s.x,s.y,s.z,s.w)}}getPoint(e,t=new P){const n=t,i=this.knots[this.startKnot]+e*(this.knots[this.endKnot]-this.knots[this.startKnot]),r=_n(this.degree,this.knots,this.controlPoints,i);return r.w!==1&&r.divideScalar(r.w),n.set(r.x,r.y,r.z)}getTangent(e,t=new P){const n=t,i=this.knots[0]+e*(this.knots[this.knots.length-1]-this.knots[0]),r=xn(this.degree,this.knots,this.controlPoints,i,1);return n.copy(r[1]).normalize(),n}}let w,S,N;class En extends ye{constructor(e){super(e)}load(e,t,n,i){const r=this,a=r.path===""?St.extractUrlBase(e):r.path,s=new At(this.manager);s.setPath(r.path),s.setResponseType("arraybuffer"),s.setRequestHeader(r.requestHeader),s.setWithCredentials(r.withCredentials),s.load(e,function(o){try{t(r.parse(o,a))}catch(g){i?i(g):console.error(g),r.manager.itemError(e)}},n,i)}parse(e,t){if(Hn(e))w=new Ln().parse(e);else{const i=Qe(e);if(!Nn(i))throw new Error("THREE.FBXLoader: Unknown format.");if(De(i)<7e3)throw new Error("THREE.FBXLoader: FBX version not supported, FileVersion: "+De(i));w=new bn().parse(i)}const n=new bt(this.manager).setPath(this.resourcePath||t).setCrossOrigin(this.crossOrigin);return new Mn(n,this.manager).parse(w)}}class Mn{constructor(e,t){this.textureLoader=e,this.manager=t}parse(){S=this.parseConnections();const e=this.parseImages(),t=this.parseTextures(e),n=this.parseMaterials(t),i=this.parseDeformers(),r=new Sn().parse(i);return this.parseScene(i,r,n),N}parseConnections(){const e=new Map;return"Connections"in w&&w.Connections.connections.forEach(function(n){const i=n[0],r=n[1],a=n[2];e.has(i)||e.set(i,{parents:[],children:[]});const s={ID:r,relationship:a};e.get(i).parents.push(s),e.has(r)||e.set(r,{parents:[],children:[]});const o={ID:i,relationship:a};e.get(r).children.push(o)}),e}parseImages(){const e={},t={};if("Video"in w.Objects){const n=w.Objects.Video;for(const i in n){const r=n[i],a=parseInt(i);if(e[a]=r.RelativeFilename||r.Filename,"Content"in r){const s=r.Content instanceof ArrayBuffer&&r.Content.byteLength>0,o=typeof r.Content=="string"&&r.Content!=="";if(s||o){const g=this.parseImage(n[i]);t[r.RelativeFilename||r.Filename]=g}}}}for(const n in e){const i=e[n];t[i]!==void 0?e[n]=t[i]:e[n]=e[n].split("\\").pop()}return e}parseImage(e){const t=e.Content,n=e.RelativeFilename||e.Filename,i=n.slice(n.lastIndexOf(".")+1).toLowerCase();let r;switch(i){case"bmp":r="image/bmp";break;case"jpg":case"jpeg":r="image/jpeg";break;case"png":r="image/png";break;case"tif":r="image/tiff";break;case"tga":this.manager.getHandler(".tga")===null&&console.warn("FBXLoader: TGA loader not found, skipping ",n),r="image/tga";break;default:console.warn('FBXLoader: Image type "'+i+'" is not supported.');return}if(typeof t=="string")return"data:"+r+";base64,"+t;{const a=new Uint8Array(t);return window.URL.createObjectURL(new Blob([a],{type:r}))}}parseTextures(e){const t=new Map;if("Texture"in w.Objects){const n=w.Objects.Texture;for(const i in n){const r=this.parseTexture(n[i],e);t.set(parseInt(i),r)}}return t}parseTexture(e,t){const n=this.loadTexture(e,t);n.ID=e.id,n.name=e.attrName;const i=e.WrapModeU,r=e.WrapModeV,a=i!==void 0?i.value:0,s=r!==void 0?r.value:0;if(n.wrapS=a===0?He:Ne,n.wrapT=s===0?He:Ne,"Scaling"in e){const o=e.Scaling.value;n.repeat.x=o[0],n.repeat.y=o[1]}if("Translation"in e){const o=e.Translation.value;n.offset.x=o[0],n.offset.y=o[1]}return n}loadTexture(e,t){const n=new Set(["tga","tif","tiff","exr","dds","hdr","ktx2"]),i=e.FileName.split(".").pop().toLowerCase(),r=n.has(i)?this.manager.getHandler(`.${i}`):this.textureLoader;if(!r)return console.warn(`FBXLoader: ${i.toUpperCase()} loader not found, creating placeholder texture for`,e.RelativeFilename),new Lt;const a=r.path;a||r.setPath(this.textureLoader.path);const s=S.get(e.id).children;let o;s!==void 0&&s.length>0&&t[s[0].ID]!==void 0&&(o=t[s[0].ID],(o.indexOf("blob:")===0||o.indexOf("data:")===0)&&r.setPath(void 0));const g=r.load(o);return r.setPath(a),g}parseMaterials(e){const t=new Map;if("Material"in w.Objects){const n=w.Objects.Material;for(const i in n){const r=this.parseMaterial(n[i],e);r!==null&&t.set(parseInt(i),r)}}return t}parseMaterial(e,t){const n=e.id,i=e.attrName;let r=e.ShadingModel;if(typeof r=="object"&&(r=r.value),!S.has(n))return null;const a=this.parseParameters(e,t,n);let s;switch(r.toLowerCase()){case"phong":s=new ue;break;case"lambert":s=new Ht;break;default:console.warn('THREE.FBXLoader: unknown material type "%s". Defaulting to MeshPhongMaterial.',r),s=new ue;break}return s.setValues(a),s.name=i,s}parseParameters(e,t,n){const i={};e.BumpFactor&&(i.bumpScale=e.BumpFactor.value),e.Diffuse?i.color=new Y().fromArray(e.Diffuse.value).convertSRGBToLinear():e.DiffuseColor&&(e.DiffuseColor.type==="Color"||e.DiffuseColor.type==="ColorRGB")&&(i.color=new Y().fromArray(e.DiffuseColor.value).convertSRGBToLinear()),e.DisplacementFactor&&(i.displacementScale=e.DisplacementFactor.value),e.Emissive?i.emissive=new Y().fromArray(e.Emissive.value).convertSRGBToLinear():e.EmissiveColor&&(e.EmissiveColor.type==="Color"||e.EmissiveColor.type==="ColorRGB")&&(i.emissive=new Y().fromArray(e.EmissiveColor.value).convertSRGBToLinear()),e.EmissiveFactor&&(i.emissiveIntensity=parseFloat(e.EmissiveFactor.value)),e.Opacity&&(i.opacity=parseFloat(e.Opacity.value)),i.opacity<1&&(i.transparent=!0),e.ReflectionFactor&&(i.reflectivity=e.ReflectionFactor.value),e.Shininess&&(i.shininess=e.Shininess.value),e.Specular?i.specular=new Y().fromArray(e.Specular.value).convertSRGBToLinear():e.SpecularColor&&e.SpecularColor.type==="Color"&&(i.specular=new Y().fromArray(e.SpecularColor.value).convertSRGBToLinear());const r=this;return S.get(n).children.forEach(function(a){const s=a.relationship;switch(s){case"Bump":i.bumpMap=r.getTexture(t,a.ID);break;case"Maya|TEX_ao_map":i.aoMap=r.getTexture(t,a.ID);break;case"DiffuseColor":case"Maya|TEX_color_map":i.map=r.getTexture(t,a.ID),i.map!==void 0&&(i.map.colorSpace=ne);break;case"DisplacementColor":i.displacementMap=r.getTexture(t,a.ID);break;case"EmissiveColor":i.emissiveMap=r.getTexture(t,a.ID),i.emissiveMap!==void 0&&(i.emissiveMap.colorSpace=ne);break;case"NormalMap":case"Maya|TEX_normal_map":i.normalMap=r.getTexture(t,a.ID);break;case"ReflectionColor":i.envMap=r.getTexture(t,a.ID),i.envMap!==void 0&&(i.envMap.mapping=Nt,i.envMap.colorSpace=ne);break;case"SpecularColor":i.specularMap=r.getTexture(t,a.ID),i.specularMap!==void 0&&(i.specularMap.colorSpace=ne);break;case"TransparentColor":case"TransparencyFactor":i.alphaMap=r.getTexture(t,a.ID),i.transparent=!0;break;case"AmbientColor":case"ShininessExponent":case"SpecularFactor":case"VectorDisplacementColor":default:console.warn("THREE.FBXLoader: %s map is not supported in three.js, skipping texture.",s);break}}),i}getTexture(e,t){return"LayeredTexture"in w.Objects&&t in w.Objects.LayeredTexture&&(console.warn("THREE.FBXLoader: layered textures are not supported in three.js. Discarding all but first layer."),t=S.get(t).children[0].ID),e.get(t)}parseDeformers(){const e={},t={};if("Deformer"in w.Objects){const n=w.Objects.Deformer;for(const i in n){const r=n[i],a=S.get(parseInt(i));if(r.attrType==="Skin"){const s=this.parseSkeleton(a,n);s.ID=i,a.parents.length>1&&console.warn("THREE.FBXLoader: skeleton attached to more than one geometry is not supported."),s.geometryID=a.parents[0].ID,e[i]=s}else if(r.attrType==="BlendShape"){const s={id:i};s.rawTargets=this.parseMorphTargets(a,n),s.id=i,a.parents.length>1&&console.warn("THREE.FBXLoader: morph target attached to more than one geometry is not supported."),t[i]=s}}}return{skeletons:e,morphTargets:t}}parseSkeleton(e,t){const n=[];return e.children.forEach(function(i){const r=t[i.ID];if(r.attrType!=="Cluster")return;const a={ID:i.ID,indices:[],weights:[],transformLink:new M().fromArray(r.TransformLink.a)};"Indexes"in r&&(a.indices=r.Indexes.a,a.weights=r.Weights.a),n.push(a)}),{rawBones:n,bones:[]}}parseMorphTargets(e,t){const n=[];for(let i=0;i<e.children.length;i++){const r=e.children[i],a=t[r.ID],s={name:a.attrName,initialWeight:a.DeformPercent,id:a.id,fullWeights:a.FullWeights.a};if(a.attrType!=="BlendShapeChannel")return;s.geoID=S.get(parseInt(r.ID)).children.filter(function(o){return o.relationship===void 0})[0].ID,n.push(s)}return n}parseScene(e,t,n){N=new Re;const i=this.parseModels(e.skeletons,t,n),r=w.Objects.Model,a=this;i.forEach(function(o){const g=r[o.ID];a.setLookAtProperties(o,g),S.get(o.ID).parents.forEach(function(c){const u=i.get(c.ID);u!==void 0&&u.add(o)}),o.parent===null&&N.add(o)}),this.bindSkeleton(e.skeletons,t,i),this.addGlobalSceneSettings(),N.traverse(function(o){if(o.userData.transformData){o.parent&&(o.userData.transformData.parentMatrix=o.parent.matrix,o.userData.transformData.parentMatrixWorld=o.parent.matrixWorld);const g=$e(o.userData.transformData);o.applyMatrix4(g),o.updateWorldMatrix()}});const s=new An().parse();N.children.length===1&&N.children[0].isGroup&&(N.children[0].animations=s,N=N.children[0]),N.animations=s}parseModels(e,t,n){const i=new Map,r=w.Objects.Model;for(const a in r){const s=parseInt(a),o=r[a],g=S.get(s);let h=this.buildSkeleton(g,e,s,o.attrName);if(!h){switch(o.attrType){case"Camera":h=this.createCamera(g);break;case"Light":h=this.createLight(g);break;case"Mesh":h=this.createMesh(g,t,n);break;case"NurbsCurve":h=this.createCurve(g,t);break;case"LimbNode":case"Root":h=new Ie;break;case"Null":default:h=new Re;break}h.name=o.attrName?ae.sanitizeNodeName(o.attrName):"",h.userData.originalName=o.attrName,h.ID=s}this.getTransformData(h,o),i.set(s,h)}return i}buildSkeleton(e,t,n,i){let r=null;return e.parents.forEach(function(a){for(const s in t){const o=t[s];o.rawBones.forEach(function(g,h){if(g.ID===a.ID){const c=r;r=new Ie,r.matrixWorld.copy(g.transformLink),r.name=i?ae.sanitizeNodeName(i):"",r.userData.originalName=i,r.ID=n,o.bones[h]=r,c!==null&&r.add(c)}})}}),r}createCamera(e){let t,n;if(e.children.forEach(function(i){const r=w.Objects.NodeAttribute[i.ID];r!==void 0&&(n=r)}),n===void 0)t=new re;else{let i=0;n.CameraProjectionType!==void 0&&n.CameraProjectionType.value===1&&(i=1);let r=1;n.NearPlane!==void 0&&(r=n.NearPlane.value/1e3);let a=1e3;n.FarPlane!==void 0&&(a=n.FarPlane.value/1e3);let s=window.innerWidth,o=window.innerHeight;n.AspectWidth!==void 0&&n.AspectHeight!==void 0&&(s=n.AspectWidth.value,o=n.AspectHeight.value);const g=s/o;let h=45;n.FieldOfView!==void 0&&(h=n.FieldOfView.value);const c=n.FocalLength?n.FocalLength.value:null;switch(i){case 0:t=new It(h,g,r,a),c!==null&&t.setFocalLength(c);break;case 1:t=new Rt(-s/2,s/2,o/2,-o/2,r,a);break;default:console.warn("THREE.FBXLoader: Unknown camera type "+i+"."),t=new re;break}}return t}createLight(e){let t,n;if(e.children.forEach(function(i){const r=w.Objects.NodeAttribute[i.ID];r!==void 0&&(n=r)}),n===void 0)t=new re;else{let i;n.LightType===void 0?i=0:i=n.LightType.value;let r=16777215;n.Color!==void 0&&(r=new Y().fromArray(n.Color.value).convertSRGBToLinear());let a=n.Intensity===void 0?1:n.Intensity.value/100;n.CastLightOnObject!==void 0&&n.CastLightOnObject.value===0&&(a=0);let s=0;n.FarAttenuationEnd!==void 0&&(n.EnableFarAttenuation!==void 0&&n.EnableFarAttenuation.value===0?s=0:s=n.FarAttenuationEnd.value);const o=1;switch(i){case 0:t=new Pe(r,a,s,o);break;case 1:t=new kt(r,a);break;case 2:let g=Math.PI/3;n.InnerAngle!==void 0&&(g=R.degToRad(n.InnerAngle.value));let h=0;n.OuterAngle!==void 0&&(h=R.degToRad(n.OuterAngle.value),h=Math.max(h,1)),t=new Pt(r,a,s,g,h,o);break;default:console.warn("THREE.FBXLoader: Unknown light type "+n.LightType.value+", defaulting to a PointLight."),t=new Pe(r,a);break}n.CastShadows!==void 0&&n.CastShadows.value===1&&(t.castShadow=!0)}return t}createMesh(e,t,n){let i,r=null,a=null;const s=[];return e.children.forEach(function(o){t.has(o.ID)&&(r=t.get(o.ID)),n.has(o.ID)&&s.push(n.get(o.ID))}),s.length>1?a=s:s.length>0?a=s[0]:(a=new ue({name:ye.DEFAULT_MATERIAL_NAME,color:13421772}),s.push(a)),"color"in r.attributes&&s.forEach(function(o){o.vertexColors=!0}),r.FBX_Deformer?(i=new Dt(r,a),i.normalizeSkinWeights()):i=new Ye(r,a),i}createCurve(e,t){const n=e.children.reduce(function(r,a){return t.has(a.ID)&&(r=t.get(a.ID)),r},null),i=new Bt({name:ye.DEFAULT_MATERIAL_NAME,color:3342591,linewidth:1});return new Ct(n,i)}getTransformData(e,t){const n={};"InheritType"in t&&(n.inheritType=parseInt(t.InheritType.value)),"RotationOrder"in t?n.eulerOrder=Ke(t.RotationOrder.value):n.eulerOrder="ZYX","Lcl_Translation"in t&&(n.translation=t.Lcl_Translation.value),"PreRotation"in t&&(n.preRotation=t.PreRotation.value),"Lcl_Rotation"in t&&(n.rotation=t.Lcl_Rotation.value),"PostRotation"in t&&(n.postRotation=t.PostRotation.value),"Lcl_Scaling"in t&&(n.scale=t.Lcl_Scaling.value),"ScalingOffset"in t&&(n.scalingOffset=t.ScalingOffset.value),"ScalingPivot"in t&&(n.scalingPivot=t.ScalingPivot.value),"RotationOffset"in t&&(n.rotationOffset=t.RotationOffset.value),"RotationPivot"in t&&(n.rotationPivot=t.RotationPivot.value),e.userData.transformData=n}setLookAtProperties(e,t){"LookAtProperty"in t&&S.get(e.ID).children.forEach(function(i){if(i.relationship==="LookAtProperty"){const r=w.Objects.Model[i.ID];if("Lcl_Translation"in r){const a=r.Lcl_Translation.value;e.target!==void 0?(e.target.position.fromArray(a),N.add(e.target)):e.lookAt(new P().fromArray(a))}}})}bindSkeleton(e,t,n){const i=this.parsePoseNodes();for(const r in e){const a=e[r];S.get(parseInt(a.ID)).parents.forEach(function(o){if(t.has(o.ID)){const g=o.ID;S.get(g).parents.forEach(function(c){n.has(c.ID)&&n.get(c.ID).bind(new Ot(a.bones),i[c.ID])})}})}}parsePoseNodes(){const e={};if("Pose"in w.Objects){const t=w.Objects.Pose;for(const n in t)if(t[n].attrType==="BindPose"&&t[n].NbPoseNodes>0){const i=t[n].PoseNode;Array.isArray(i)?i.forEach(function(r){e[r.Node]=new M().fromArray(r.Matrix.a)}):e[i.Node]=new M().fromArray(i.Matrix.a)}}return e}addGlobalSceneSettings(){if("GlobalSettings"in w){if("AmbientColor"in w.GlobalSettings){const e=w.GlobalSettings.AmbientColor.value,t=e[0],n=e[1],i=e[2];if(t!==0||n!==0||i!==0){const r=new Y(t,n,i).convertSRGBToLinear();N.add(new Vt(r,1))}}"UnitScaleFactor"in w.GlobalSettings&&(N.userData.unitScaleFactor=w.GlobalSettings.UnitScaleFactor.value)}}}class Sn{constructor(){this.negativeMaterialIndices=!1}parse(e){const t=new Map;if("Geometry"in w.Objects){const n=w.Objects.Geometry;for(const i in n){const r=S.get(parseInt(i)),a=this.parseGeometry(r,n[i],e);t.set(parseInt(i),a)}}return this.negativeMaterialIndices===!0&&console.warn("THREE.FBXLoader: The FBX file contains invalid (negative) material indices. The asset might not render as expected."),t}parseGeometry(e,t,n){switch(t.attrType){case"Mesh":return this.parseMeshGeometry(e,t,n);case"NurbsCurve":return this.parseNurbsGeometry(t)}}parseMeshGeometry(e,t,n){const i=n.skeletons,r=[],a=e.parents.map(function(c){return w.Objects.Model[c.ID]});if(a.length===0)return;const s=e.children.reduce(function(c,u){return i[u.ID]!==void 0&&(c=i[u.ID]),c},null);e.children.forEach(function(c){n.morphTargets[c.ID]!==void 0&&r.push(n.morphTargets[c.ID])});const o=a[0],g={};"RotationOrder"in o&&(g.eulerOrder=Ke(o.RotationOrder.value)),"InheritType"in o&&(g.inheritType=parseInt(o.InheritType.value)),"GeometricTranslation"in o&&(g.translation=o.GeometricTranslation.value),"GeometricRotation"in o&&(g.rotation=o.GeometricRotation.value),"GeometricScaling"in o&&(g.scale=o.GeometricScaling.value);const h=$e(g);return this.genGeometry(t,s,r,h)}genGeometry(e,t,n,i){const r=new me;e.attrName&&(r.name=e.attrName);const a=this.parseGeoNode(e,t),s=this.genBuffers(a),o=new J(s.vertex,3);if(o.applyMatrix4(i),r.setAttribute("position",o),s.colors.length>0&&r.setAttribute("color",new J(s.colors,3)),t&&(r.setAttribute("skinIndex",new Yt(s.weightsIndices,4)),r.setAttribute("skinWeight",new J(s.vertexWeights,4)),r.FBX_Deformer=t),s.normal.length>0){const g=new Ut().getNormalMatrix(i),h=new J(s.normal,3);h.applyNormalMatrix(g),r.setAttribute("normal",h)}if(s.uvs.forEach(function(g,h){const c=h===0?"uv":`uv${h}`;r.setAttribute(c,new J(s.uvs[h],2))}),a.material&&a.material.mappingType!=="AllSame"){let g=s.materialIndex[0],h=0;if(s.materialIndex.forEach(function(c,u){c!==g&&(r.addGroup(h,u-h,g),g=c,h=u)}),r.groups.length>0){const c=r.groups[r.groups.length-1],u=c.start+c.count;u!==s.materialIndex.length&&r.addGroup(u,s.materialIndex.length-u,g)}r.groups.length===0&&r.addGroup(0,s.materialIndex.length,s.materialIndex[0])}return this.addMorphTargets(r,e,n,i),r}parseGeoNode(e,t){const n={};if(n.vertexPositions=e.Vertices!==void 0?e.Vertices.a:[],n.vertexIndices=e.PolygonVertexIndex!==void 0?e.PolygonVertexIndex.a:[],e.LayerElementColor&&(n.color=this.parseVertexColors(e.LayerElementColor[0])),e.LayerElementMaterial&&(n.material=this.parseMaterialIndices(e.LayerElementMaterial[0])),e.LayerElementNormal&&(n.normal=this.parseNormals(e.LayerElementNormal[0])),e.LayerElementUV){n.uv=[];let i=0;for(;e.LayerElementUV[i];)e.LayerElementUV[i].UV&&n.uv.push(this.parseUVs(e.LayerElementUV[i])),i++}return n.weightTable={},t!==null&&(n.skeleton=t,t.rawBones.forEach(function(i,r){i.indices.forEach(function(a,s){n.weightTable[a]===void 0&&(n.weightTable[a]=[]),n.weightTable[a].push({id:r,weight:i.weights[s]})})})),n}genBuffers(e){const t={vertex:[],normal:[],colors:[],uvs:[],materialIndex:[],vertexWeights:[],weightsIndices:[]};let n=0,i=0,r=!1,a=[],s=[],o=[],g=[],h=[],c=[];const u=this;return e.vertexIndices.forEach(function(m,p){let f,d=!1;m<0&&(m=m^-1,d=!0);let y=[],v=[];if(a.push(m*3,m*3+1,m*3+2),e.color){const _=ie(p,n,m,e.color);o.push(_[0],_[1],_[2])}if(e.skeleton){if(e.weightTable[m]!==void 0&&e.weightTable[m].forEach(function(_){v.push(_.weight),y.push(_.id)}),v.length>4){r||(console.warn("THREE.FBXLoader: Vertex has more than 4 skinning weights assigned to vertex. Deleting additional weights."),r=!0);const _=[0,0,0,0],T=[0,0,0,0];v.forEach(function(A,F){let x=A,L=y[F];T.forEach(function(k,b,H){if(x>k){H[b]=x,x=k;const W=_[b];_[b]=L,L=W}})}),y=_,v=T}for(;v.length<4;)v.push(0),y.push(0);for(let _=0;_<4;++_)h.push(v[_]),c.push(y[_])}if(e.normal){const _=ie(p,n,m,e.normal);s.push(_[0],_[1],_[2])}e.material&&e.material.mappingType!=="AllSame"&&(f=ie(p,n,m,e.material)[0],f<0&&(u.negativeMaterialIndices=!0,f=0)),e.uv&&e.uv.forEach(function(_,T){const A=ie(p,n,m,_);g[T]===void 0&&(g[T]=[]),g[T].push(A[0]),g[T].push(A[1])}),i++,d&&(u.genFace(t,e,a,f,s,o,g,h,c,i),n++,i=0,a=[],s=[],o=[],g=[],h=[],c=[])}),t}getNormalNewell(e){const t=new P(0,0,0);for(let n=0;n<e.length;n++){const i=e[n],r=e[(n+1)%e.length];t.x+=(i.y-r.y)*(i.z+r.z),t.y+=(i.z-r.z)*(i.x+r.x),t.z+=(i.x-r.x)*(i.y+r.y)}return t.normalize(),t}getNormalTangentAndBitangent(e){const t=this.getNormalNewell(e),i=(Math.abs(t.z)>.5?new P(0,1,0):new P(0,0,1)).cross(t).normalize(),r=t.clone().cross(i).normalize();return{normal:t,tangent:i,bitangent:r}}flattenVertex(e,t,n){return new zt(e.dot(t),e.dot(n))}genFace(e,t,n,i,r,a,s,o,g,h){let c;if(h>3){const u=[],m=t.baseVertexPositions||t.vertexPositions;for(let y=0;y<n.length;y+=3)u.push(new P(m[n[y]],m[n[y+1]],m[n[y+2]]));const{tangent:p,bitangent:f}=this.getNormalTangentAndBitangent(u),d=[];for(const y of u)d.push(this.flattenVertex(y,p,f));c=Gt.triangulateShape(d,[])}else c=[[0,1,2]];for(const[u,m,p]of c)e.vertex.push(t.vertexPositions[n[u*3]]),e.vertex.push(t.vertexPositions[n[u*3+1]]),e.vertex.push(t.vertexPositions[n[u*3+2]]),e.vertex.push(t.vertexPositions[n[m*3]]),e.vertex.push(t.vertexPositions[n[m*3+1]]),e.vertex.push(t.vertexPositions[n[m*3+2]]),e.vertex.push(t.vertexPositions[n[p*3]]),e.vertex.push(t.vertexPositions[n[p*3+1]]),e.vertex.push(t.vertexPositions[n[p*3+2]]),t.skeleton&&(e.vertexWeights.push(o[u*4]),e.vertexWeights.push(o[u*4+1]),e.vertexWeights.push(o[u*4+2]),e.vertexWeights.push(o[u*4+3]),e.vertexWeights.push(o[m*4]),e.vertexWeights.push(o[m*4+1]),e.vertexWeights.push(o[m*4+2]),e.vertexWeights.push(o[m*4+3]),e.vertexWeights.push(o[p*4]),e.vertexWeights.push(o[p*4+1]),e.vertexWeights.push(o[p*4+2]),e.vertexWeights.push(o[p*4+3]),e.weightsIndices.push(g[u*4]),e.weightsIndices.push(g[u*4+1]),e.weightsIndices.push(g[u*4+2]),e.weightsIndices.push(g[u*4+3]),e.weightsIndices.push(g[m*4]),e.weightsIndices.push(g[m*4+1]),e.weightsIndices.push(g[m*4+2]),e.weightsIndices.push(g[m*4+3]),e.weightsIndices.push(g[p*4]),e.weightsIndices.push(g[p*4+1]),e.weightsIndices.push(g[p*4+2]),e.weightsIndices.push(g[p*4+3])),t.color&&(e.colors.push(a[u*3]),e.colors.push(a[u*3+1]),e.colors.push(a[u*3+2]),e.colors.push(a[m*3]),e.colors.push(a[m*3+1]),e.colors.push(a[m*3+2]),e.colors.push(a[p*3]),e.colors.push(a[p*3+1]),e.colors.push(a[p*3+2])),t.material&&t.material.mappingType!=="AllSame"&&(e.materialIndex.push(i),e.materialIndex.push(i),e.materialIndex.push(i)),t.normal&&(e.normal.push(r[u*3]),e.normal.push(r[u*3+1]),e.normal.push(r[u*3+2]),e.normal.push(r[m*3]),e.normal.push(r[m*3+1]),e.normal.push(r[m*3+2]),e.normal.push(r[p*3]),e.normal.push(r[p*3+1]),e.normal.push(r[p*3+2])),t.uv&&t.uv.forEach(function(f,d){e.uvs[d]===void 0&&(e.uvs[d]=[]),e.uvs[d].push(s[d][u*2]),e.uvs[d].push(s[d][u*2+1]),e.uvs[d].push(s[d][m*2]),e.uvs[d].push(s[d][m*2+1]),e.uvs[d].push(s[d][p*2]),e.uvs[d].push(s[d][p*2+1])})}addMorphTargets(e,t,n,i){if(n.length===0)return;e.morphTargetsRelative=!0,e.morphAttributes.position=[];const r=this;n.forEach(function(a){a.rawTargets.forEach(function(s){const o=w.Objects.Geometry[s.geoID];o!==void 0&&r.genMorphGeometry(e,t,o,i,s.name)})})}genMorphGeometry(e,t,n,i,r){const a=t.Vertices!==void 0?t.Vertices.a:[],s=t.PolygonVertexIndex!==void 0?t.PolygonVertexIndex.a:[],o=n.Vertices!==void 0?n.Vertices.a:[],g=n.Indexes!==void 0?n.Indexes.a:[],h=e.attributes.position.count*3,c=new Float32Array(h);for(let f=0;f<g.length;f++){const d=g[f]*3;c[d]=o[f*3],c[d+1]=o[f*3+1],c[d+2]=o[f*3+2]}const u={vertexIndices:s,vertexPositions:c,baseVertexPositions:a},m=this.genBuffers(u),p=new J(m.vertex,3);p.name=r||n.attrName,p.applyMatrix4(i),e.morphAttributes.position.push(p)}parseNormals(e){const t=e.MappingInformationType,n=e.ReferenceInformationType,i=e.Normals.a;let r=[];return n==="IndexToDirect"&&("NormalIndex"in e?r=e.NormalIndex.a:"NormalsIndex"in e&&(r=e.NormalsIndex.a)),{dataSize:3,buffer:i,indices:r,mappingType:t,referenceType:n}}parseUVs(e){const t=e.MappingInformationType,n=e.ReferenceInformationType,i=e.UV.a;let r=[];return n==="IndexToDirect"&&(r=e.UVIndex.a),{dataSize:2,buffer:i,indices:r,mappingType:t,referenceType:n}}parseVertexColors(e){const t=e.MappingInformationType,n=e.ReferenceInformationType,i=e.Colors.a;let r=[];n==="IndexToDirect"&&(r=e.ColorIndex.a);for(let a=0,s=new Y;a<i.length;a+=4)s.fromArray(i,a).convertSRGBToLinear().toArray(i,a);return{dataSize:4,buffer:i,indices:r,mappingType:t,referenceType:n}}parseMaterialIndices(e){const t=e.MappingInformationType,n=e.ReferenceInformationType;if(t==="NoMappingInformation")return{dataSize:1,buffer:[0],indices:[0],mappingType:"AllSame",referenceType:n};const i=e.Materials.a,r=[];for(let a=0;a<i.length;++a)r.push(a);return{dataSize:1,buffer:i,indices:r,mappingType:t,referenceType:n}}parseNurbsGeometry(e){const t=parseInt(e.Order);if(isNaN(t))return console.error("THREE.FBXLoader: Invalid Order %s given for geometry ID: %s",e.Order,e.id),new me;const n=t-1,i=e.KnotVector.a,r=[],a=e.Points.a;for(let c=0,u=a.length;c<u;c+=4)r.push(new le().fromArray(a,c));let s,o;if(e.Form==="Closed")r.push(r[0]);else if(e.Form==="Periodic"){s=n,o=i.length-1-s;for(let c=0;c<n;++c)r.push(r[c])}const h=new Tn(n,i,r,s,o).getPoints(r.length*12);return new me().setFromPoints(h)}}class An{parse(){const e=[],t=this.parseClips();if(t!==void 0)for(const n in t){const i=t[n],r=this.addClip(i);e.push(r)}return e}parseClips(){if(w.Objects.AnimationCurve===void 0)return;const e=this.parseAnimationCurveNodes();this.parseAnimationCurves(e);const t=this.parseAnimationLayers(e);return this.parseAnimStacks(t)}parseAnimationCurveNodes(){const e=w.Objects.AnimationCurveNode,t=new Map;for(const n in e){const i=e[n];if(i.attrName.match(/S|R|T|DeformPercent/)!==null){const r={id:i.id,attr:i.attrName,curves:{}};t.set(r.id,r)}}return t}parseAnimationCurves(e){const t=w.Objects.AnimationCurve;for(const n in t){const i={id:t[n].id,times:t[n].KeyTime.a.map(Rn),values:t[n].KeyValueFloat.a},r=S.get(i.id);if(r!==void 0){const a=r.parents[0].ID,s=r.parents[0].relationship;s.match(/X/)?e.get(a).curves.x=i:s.match(/Y/)?e.get(a).curves.y=i:s.match(/Z/)?e.get(a).curves.z=i:s.match(/DeformPercent/)&&e.has(a)&&(e.get(a).curves.morph=i)}}}parseAnimationLayers(e){const t=w.Objects.AnimationLayer,n=new Map;for(const i in t){const r=[],a=S.get(parseInt(i));a!==void 0&&(a.children.forEach(function(o,g){if(e.has(o.ID)){const h=e.get(o.ID);if(h.curves.x!==void 0||h.curves.y!==void 0||h.curves.z!==void 0){if(r[g]===void 0){const c=S.get(o.ID).parents.filter(function(u){return u.relationship!==void 0})[0].ID;if(c!==void 0){const u=w.Objects.Model[c.toString()];if(u===void 0){console.warn("THREE.FBXLoader: Encountered a unused curve.",o);return}const m={modelName:u.attrName?ae.sanitizeNodeName(u.attrName):"",ID:u.id,initialPosition:[0,0,0],initialRotation:[0,0,0],initialScale:[1,1,1]};N.traverse(function(p){p.ID===u.id&&(m.transform=p.matrix,p.userData.transformData&&(m.eulerOrder=p.userData.transformData.eulerOrder))}),m.transform||(m.transform=new M),"PreRotation"in u&&(m.preRotation=u.PreRotation.value),"PostRotation"in u&&(m.postRotation=u.PostRotation.value),r[g]=m}}r[g]&&(r[g][h.attr]=h)}else if(h.curves.morph!==void 0){if(r[g]===void 0){const c=S.get(o.ID).parents.filter(function(y){return y.relationship!==void 0})[0].ID,u=S.get(c).parents[0].ID,m=S.get(u).parents[0].ID,p=S.get(m).parents[0].ID,f=w.Objects.Model[p],d={modelName:f.attrName?ae.sanitizeNodeName(f.attrName):"",morphName:w.Objects.Deformer[c].attrName};r[g]=d}r[g][h.attr]=h}}}),n.set(parseInt(i),r))}return n}parseAnimStacks(e){const t=w.Objects.AnimationStack,n={};for(const i in t){const r=S.get(parseInt(i)).children;r.length>1&&console.warn("THREE.FBXLoader: Encountered an animation stack with multiple layers, this is currently not supported. Ignoring subsequent layers.");const a=e.get(r[0].ID);n[i]={name:t[i].attrName,layer:a}}return n}addClip(e){let t=[];const n=this;return e.layer.forEach(function(i){t=t.concat(n.generateTracks(i))}),new Fe(e.name,-1,t)}generateTracks(e){const t=[];let n=new P,i=new P;if(e.transform&&e.transform.decompose(n,new C,i),n=n.toArray(),i=i.toArray(),e.T!==void 0&&Object.keys(e.T.curves).length>0){const r=this.generateVectorTrack(e.modelName,e.T.curves,n,"position");r!==void 0&&t.push(r)}if(e.R!==void 0&&Object.keys(e.R.curves).length>0){const r=this.generateRotationTrack(e.modelName,e.R.curves,e.preRotation,e.postRotation,e.eulerOrder);r!==void 0&&t.push(r)}if(e.S!==void 0&&Object.keys(e.S.curves).length>0){const r=this.generateVectorTrack(e.modelName,e.S.curves,i,"scale");r!==void 0&&t.push(r)}if(e.DeformPercent!==void 0){const r=this.generateMorphTrack(e);r!==void 0&&t.push(r)}return t}generateVectorTrack(e,t,n,i){const r=this.getTimesForAllAxes(t),a=this.getKeyframeTrackValues(r,t,n);return new se(e+"."+i,r,a)}generateRotationTrack(e,t,n,i,r){let a,s;if(t.x!==void 0&&t.y!==void 0&&t.z!==void 0){const c=this.interpolateRotations(t.x,t.y,t.z,r);a=c[0],s=c[1]}n!==void 0&&(n=n.map(R.degToRad),n.push(r),n=new V().fromArray(n),n=new C().setFromEuler(n)),i!==void 0&&(i=i.map(R.degToRad),i.push(r),i=new V().fromArray(i),i=new C().setFromEuler(i).invert());const o=new C,g=new V,h=[];if(!s||!a)return new oe(e+".quaternion",[0],[0]);for(let c=0;c<s.length;c+=3)g.set(s[c],s[c+1],s[c+2],r),o.setFromEuler(g),n!==void 0&&o.premultiply(n),i!==void 0&&o.multiply(i),c>2&&new C().fromArray(h,(c-3)/3*4).dot(o)<0&&o.set(-o.x,-o.y,-o.z,-o.w),o.toArray(h,c/3*4);return new oe(e+".quaternion",a,h)}generateMorphTrack(e){const t=e.DeformPercent.curves.morph,n=t.values.map(function(r){return r/100}),i=N.getObjectByName(e.modelName).morphTargetDictionary[e.morphName];return new Wt(e.modelName+".morphTargetInfluences["+i+"]",t.times,n)}getTimesForAllAxes(e){let t=[];if(e.x!==void 0&&(t=t.concat(e.x.times)),e.y!==void 0&&(t=t.concat(e.y.times)),e.z!==void 0&&(t=t.concat(e.z.times)),t=t.sort(function(n,i){return n-i}),t.length>1){let n=1,i=t[0];for(let r=1;r<t.length;r++){const a=t[r];a!==i&&(t[n]=a,i=a,n++)}t=t.slice(0,n)}return t}getKeyframeTrackValues(e,t,n){const i=n,r=[];let a=-1,s=-1,o=-1;return e.forEach(function(g){if(t.x&&(a=t.x.times.indexOf(g)),t.y&&(s=t.y.times.indexOf(g)),t.z&&(o=t.z.times.indexOf(g)),a!==-1){const h=t.x.values[a];r.push(h),i[0]=h}else r.push(i[0]);if(s!==-1){const h=t.y.values[s];r.push(h),i[1]=h}else r.push(i[1]);if(o!==-1){const h=t.z.values[o];r.push(h),i[2]=h}else r.push(i[2])}),r}interpolateRotations(e,t,n,i){const r=[],a=[];r.push(e.times[0]),a.push(R.degToRad(e.values[0])),a.push(R.degToRad(t.values[0])),a.push(R.degToRad(n.values[0]));for(let s=1;s<e.values.length;s++){const o=[e.values[s-1],t.values[s-1],n.values[s-1]];if(isNaN(o[0])||isNaN(o[1])||isNaN(o[2]))continue;const g=o.map(R.degToRad),h=[e.values[s],t.values[s],n.values[s]];if(isNaN(h[0])||isNaN(h[1])||isNaN(h[2]))continue;const c=h.map(R.degToRad),u=[h[0]-o[0],h[1]-o[1],h[2]-o[2]],m=[Math.abs(u[0]),Math.abs(u[1]),Math.abs(u[2])];if(m[0]>=180||m[1]>=180||m[2]>=180){const f=Math.max(...m)/180,d=new V(...g,i),y=new V(...c,i),v=new C().setFromEuler(d),_=new C().setFromEuler(y);v.dot(_)&&_.set(-_.x,-_.y,-_.z,-_.w);const T=e.times[s-1],A=e.times[s]-T,F=new C,x=new V;for(let L=0;L<1;L+=1/f)F.copy(v.clone().slerp(_.clone(),L)),r.push(T+L*A),x.setFromQuaternion(F,i),a.push(x.x),a.push(x.y),a.push(x.z)}else r.push(e.times[s]),a.push(R.degToRad(e.values[s])),a.push(R.degToRad(t.values[s])),a.push(R.degToRad(n.values[s]))}return[r,a]}}class bn{getPrevNode(){return this.nodeStack[this.currentIndent-2]}getCurrentNode(){return this.nodeStack[this.currentIndent-1]}getCurrentProp(){return this.currentProp}pushStack(e){this.nodeStack.push(e),this.currentIndent+=1}popStack(){this.nodeStack.pop(),this.currentIndent-=1}setCurrentProp(e,t){this.currentProp=e,this.currentPropName=t}parse(e){this.currentIndent=0,this.allNodes=new qe,this.nodeStack=[],this.currentProp=[],this.currentPropName="";const t=this,n=e.split(/[\r\n]+/);return n.forEach(function(i,r){const a=i.match(/^[\s\t]*;/),s=i.match(/^[\s\t]*$/);if(a||s)return;const o=i.match("^\\t{"+t.currentIndent+"}(\\w+):(.*){",""),g=i.match("^\\t{"+t.currentIndent+"}(\\w+):[\\s\\t\\r\\n](.*)"),h=i.match("^\\t{"+(t.currentIndent-1)+"}}");o?t.parseNodeBegin(i,o):g?t.parseNodeProperty(i,g,n[++r]):h?t.popStack():i.match(/^[^\s\t}]/)&&t.parseNodePropertyContinued(i)}),this.allNodes}parseNodeBegin(e,t){const n=t[1].trim().replace(/^"/,"").replace(/"$/,""),i=t[2].split(",").map(function(o){return o.trim().replace(/^"/,"").replace(/"$/,"")}),r={name:n},a=this.parseNodeAttr(i),s=this.getCurrentNode();this.currentIndent===0?this.allNodes.add(n,r):n in s?(n==="PoseNode"?s.PoseNode.push(r):s[n].id!==void 0&&(s[n]={},s[n][s[n].id]=s[n]),a.id!==""&&(s[n][a.id]=r)):typeof a.id=="number"?(s[n]={},s[n][a.id]=r):n!=="Properties70"&&(n==="PoseNode"?s[n]=[r]:s[n]=r),typeof a.id=="number"&&(r.id=a.id),a.name!==""&&(r.attrName=a.name),a.type!==""&&(r.attrType=a.type),this.pushStack(r)}parseNodeAttr(e){let t=e[0];e[0]!==""&&(t=parseInt(e[0]),isNaN(t)&&(t=e[0]));let n="",i="";return e.length>1&&(n=e[1].replace(/^(\w+)::/,""),i=e[2]),{id:t,name:n,type:i}}parseNodeProperty(e,t,n){let i=t[1].replace(/^"/,"").replace(/"$/,"").trim(),r=t[2].replace(/^"/,"").replace(/"$/,"").trim();i==="Content"&&r===","&&(r=n.replace(/"/g,"").replace(/,$/,"").trim());const a=this.getCurrentNode();if(a.name==="Properties70"){this.parseNodeSpecialProperty(e,i,r);return}if(i==="C"){const o=r.split(",").slice(1),g=parseInt(o[0]),h=parseInt(o[1]);let c=r.split(",").slice(3);c=c.map(function(u){return u.trim().replace(/^"/,"")}),i="connections",r=[g,h],Pn(r,c),a[i]===void 0&&(a[i]=[])}i==="Node"&&(a.id=r),i in a&&Array.isArray(a[i])?a[i].push(r):i!=="a"?a[i]=r:a.a=r,this.setCurrentProp(a,i),i==="a"&&r.slice(-1)!==","&&(a.a=_e(r))}parseNodePropertyContinued(e){const t=this.getCurrentNode();t.a+=e,e.slice(-1)!==","&&(t.a=_e(t.a))}parseNodeSpecialProperty(e,t,n){const i=n.split('",').map(function(h){return h.trim().replace(/^\"/,"").replace(/\s/,"_")}),r=i[0],a=i[1],s=i[2],o=i[3];let g=i[4];switch(a){case"int":case"enum":case"bool":case"ULongLong":case"double":case"Number":case"FieldOfView":g=parseFloat(g);break;case"Color":case"ColorRGB":case"Vector3D":case"Lcl_Translation":case"Lcl_Rotation":case"Lcl_Scaling":g=_e(g);break}this.getPrevNode()[r]={type:a,type2:s,flag:o,value:g},this.setCurrentProp(this.getPrevNode(),r)}}class Ln{parse(e){const t=new ke(e);t.skip(23);const n=t.getUint32();if(n<6400)throw new Error("THREE.FBXLoader: FBX version not supported, FileVersion: "+n);const i=new qe;for(;!this.endOfContent(t);){const r=this.parseNode(t,n);r!==null&&i.add(r.name,r)}return i}endOfContent(e){return e.size()%16===0?(e.getOffset()+160+16&-16)>=e.size():e.getOffset()+160+16>=e.size()}parseNode(e,t){const n={},i=t>=7500?e.getUint64():e.getUint32(),r=t>=7500?e.getUint64():e.getUint32();t>=7500?e.getUint64():e.getUint32();const a=e.getUint8(),s=e.getString(a);if(i===0)return null;const o=[];for(let u=0;u<r;u++)o.push(this.parseProperty(e));const g=o.length>0?o[0]:"",h=o.length>1?o[1]:"",c=o.length>2?o[2]:"";for(n.singleProperty=r===1&&e.getOffset()===i;i>e.getOffset();){const u=this.parseNode(e,t);u!==null&&this.parseSubNode(s,n,u)}return n.propertyList=o,typeof g=="number"&&(n.id=g),h!==""&&(n.attrName=h),c!==""&&(n.attrType=c),s!==""&&(n.name=s),n}parseSubNode(e,t,n){if(n.singleProperty===!0){const i=n.propertyList[0];Array.isArray(i)?(t[n.name]=n,n.a=i):t[n.name]=i}else if(e==="Connections"&&n.name==="C"){const i=[];n.propertyList.forEach(function(r,a){a!==0&&i.push(r)}),t.connections===void 0&&(t.connections=[]),t.connections.push(i)}else if(n.name==="Properties70")Object.keys(n).forEach(function(r){t[r]=n[r]});else if(e==="Properties70"&&n.name==="P"){let i=n.propertyList[0],r=n.propertyList[1];const a=n.propertyList[2],s=n.propertyList[3];let o;i.indexOf("Lcl ")===0&&(i=i.replace("Lcl ","Lcl_")),r.indexOf("Lcl ")===0&&(r=r.replace("Lcl ","Lcl_")),r==="Color"||r==="ColorRGB"||r==="Vector"||r==="Vector3D"||r.indexOf("Lcl_")===0?o=[n.propertyList[4],n.propertyList[5],n.propertyList[6]]:o=n.propertyList[4],t[i]={type:r,type2:a,flag:s,value:o}}else t[n.name]===void 0?typeof n.id=="number"?(t[n.name]={},t[n.name][n.id]=n):t[n.name]=n:n.name==="PoseNode"?(Array.isArray(t[n.name])||(t[n.name]=[t[n.name]]),t[n.name].push(n)):t[n.name][n.id]===void 0&&(t[n.name][n.id]=n)}parseProperty(e){const t=e.getString(1);let n;switch(t){case"C":return e.getBoolean();case"D":return e.getFloat64();case"F":return e.getFloat32();case"I":return e.getInt32();case"L":return e.getInt64();case"R":return n=e.getUint32(),e.getArrayBuffer(n);case"S":return n=e.getUint32(),e.getString(n);case"Y":return e.getInt16();case"b":case"c":case"d":case"f":case"i":case"l":const i=e.getUint32(),r=e.getUint32(),a=e.getUint32();if(r===0)switch(t){case"b":case"c":return e.getBooleanArray(i);case"d":return e.getFloat64Array(i);case"f":return e.getFloat32Array(i);case"i":return e.getInt32Array(i);case"l":return e.getInt64Array(i)}const s=mn(new Uint8Array(e.getArrayBuffer(a))),o=new ke(s.buffer);switch(t){case"b":case"c":return o.getBooleanArray(i);case"d":return o.getFloat64Array(i);case"f":return o.getFloat32Array(i);case"i":return o.getInt32Array(i);case"l":return o.getInt64Array(i)}break;default:throw new Error("THREE.FBXLoader: Unknown property type "+t)}}}class ke{constructor(e,t){this.dv=new DataView(e),this.offset=0,this.littleEndian=t!==void 0?t:!0,this._textDecoder=new TextDecoder}getOffset(){return this.offset}size(){return this.dv.buffer.byteLength}skip(e){this.offset+=e}getBoolean(){return(this.getUint8()&1)===1}getBooleanArray(e){const t=[];for(let n=0;n<e;n++)t.push(this.getBoolean());return t}getUint8(){const e=this.dv.getUint8(this.offset);return this.offset+=1,e}getInt16(){const e=this.dv.getInt16(this.offset,this.littleEndian);return this.offset+=2,e}getInt32(){const e=this.dv.getInt32(this.offset,this.littleEndian);return this.offset+=4,e}getInt32Array(e){const t=[];for(let n=0;n<e;n++)t.push(this.getInt32());return t}getUint32(){const e=this.dv.getUint32(this.offset,this.littleEndian);return this.offset+=4,e}getInt64(){let e,t;return this.littleEndian?(e=this.getUint32(),t=this.getUint32()):(t=this.getUint32(),e=this.getUint32()),t&2147483648?(t=~t&4294967295,e=~e&4294967295,e===4294967295&&(t=t+1&4294967295),e=e+1&4294967295,-(t*4294967296+e)):t*4294967296+e}getInt64Array(e){const t=[];for(let n=0;n<e;n++)t.push(this.getInt64());return t}getUint64(){let e,t;return this.littleEndian?(e=this.getUint32(),t=this.getUint32()):(t=this.getUint32(),e=this.getUint32()),t*4294967296+e}getFloat32(){const e=this.dv.getFloat32(this.offset,this.littleEndian);return this.offset+=4,e}getFloat32Array(e){const t=[];for(let n=0;n<e;n++)t.push(this.getFloat32());return t}getFloat64(){const e=this.dv.getFloat64(this.offset,this.littleEndian);return this.offset+=8,e}getFloat64Array(e){const t=[];for(let n=0;n<e;n++)t.push(this.getFloat64());return t}getArrayBuffer(e){const t=this.dv.buffer.slice(this.offset,this.offset+e);return this.offset+=e,t}getString(e){const t=this.offset;let n=new Uint8Array(this.dv.buffer,t,e);this.skip(e);const i=n.indexOf(0);return i>=0&&(n=new Uint8Array(this.dv.buffer,t,i)),this._textDecoder.decode(n)}}class qe{add(e,t){this[e]=t}}function Hn(l){const e="Kaydara FBX Binary  \0";return l.byteLength>=e.length&&e===Qe(l,0,e.length)}function Nn(l){const e=["K","a","y","d","a","r","a","\\","F","B","X","\\","B","i","n","a","r","y","\\","\\"];let t=0;function n(i){const r=l[i-1];return l=l.slice(t+i),t++,r}for(let i=0;i<e.length;++i)if(n(1)===e[i])return!1;return!0}function De(l){const e=/FBXVersion: (\d+)/,t=l.match(e);if(t)return parseInt(t[1]);throw new Error("THREE.FBXLoader: Cannot find the version number for the file given.")}function Rn(l){return l/46186158e3}const In=[];function ie(l,e,t,n){let i;switch(n.mappingType){case"ByPolygonVertex":i=l;break;case"ByPolygon":i=e;break;case"ByVertice":i=t;break;case"AllSame":i=n.indices[0];break;default:console.warn("THREE.FBXLoader: unknown attribute mapping type "+n.mappingType)}n.referenceType==="IndexToDirect"&&(i=n.indices[i]);const r=i*n.dataSize,a=r+n.dataSize;return kn(In,n.buffer,r,a)}const de=new V,q=new P;function $e(l){const e=new M,t=new M,n=new M,i=new M,r=new M,a=new M,s=new M,o=new M,g=new M,h=new M,c=new M,u=new M,m=l.inheritType?l.inheritType:0;if(l.translation&&e.setPosition(q.fromArray(l.translation)),l.preRotation){const b=l.preRotation.map(R.degToRad);b.push(l.eulerOrder||V.DEFAULT_ORDER),t.makeRotationFromEuler(de.fromArray(b))}if(l.rotation){const b=l.rotation.map(R.degToRad);b.push(l.eulerOrder||V.DEFAULT_ORDER),n.makeRotationFromEuler(de.fromArray(b))}if(l.postRotation){const b=l.postRotation.map(R.degToRad);b.push(l.eulerOrder||V.DEFAULT_ORDER),i.makeRotationFromEuler(de.fromArray(b)),i.invert()}l.scale&&r.scale(q.fromArray(l.scale)),l.scalingOffset&&s.setPosition(q.fromArray(l.scalingOffset)),l.scalingPivot&&a.setPosition(q.fromArray(l.scalingPivot)),l.rotationOffset&&o.setPosition(q.fromArray(l.rotationOffset)),l.rotationPivot&&g.setPosition(q.fromArray(l.rotationPivot)),l.parentMatrixWorld&&(c.copy(l.parentMatrix),h.copy(l.parentMatrixWorld));const p=t.clone().multiply(n).multiply(i),f=new M;f.extractRotation(h);const d=new M;d.copyPosition(h);const y=d.clone().invert().multiply(h),v=f.clone().invert().multiply(y),_=r,T=new M;if(m===0)T.copy(f).multiply(p).multiply(v).multiply(_);else if(m===1)T.copy(f).multiply(v).multiply(p).multiply(_);else{const H=new M().scale(new P().setFromMatrixScale(c)).clone().invert(),W=v.clone().multiply(H);T.copy(f).multiply(p).multiply(W).multiply(_)}const A=g.clone().invert(),F=a.clone().invert();let x=e.clone().multiply(o).multiply(g).multiply(t).multiply(n).multiply(i).multiply(A).multiply(s).multiply(a).multiply(r).multiply(F);const L=new M().copyPosition(x),k=h.clone().multiply(L);return u.copyPosition(k),x=u.clone().multiply(T),x.premultiply(h.invert()),x}function Ke(l){l=l||0;const e=["ZYX","YZX","XZY","ZXY","YXZ","XYZ"];return l===6?(console.warn("THREE.FBXLoader: unsupported Euler Order: Spherical XYZ. Animations and rotations may be incorrect."),e[0]):e[l]}function _e(l){return l.split(",").map(function(t){return parseFloat(t)})}function Qe(l,e,t){return e===void 0&&(e=0),t===void 0&&(t=l.byteLength),new TextDecoder().decode(new Uint8Array(l,e,t))}function Pn(l,e){for(let t=0,n=l.length,i=e.length;t<i;t++,n++)l[n]=e[t]}function kn(l,e,t,n){for(let i=t,r=0;i<n;i++,r++)l[r]=e[i];return l}const Dn={mixamorigHips:"hips",mixamorigSpine:"spine",mixamorigSpine1:"chest",mixamorigSpine2:"upperChest",mixamorigNeck:"neck",mixamorigHead:"head",mixamorigLeftShoulder:"leftShoulder",mixamorigLeftArm:"leftUpperArm",mixamorigLeftForeArm:"leftLowerArm",mixamorigLeftHand:"leftHand",mixamorigLeftHandThumb1:"leftThumbProximal",mixamorigLeftHandThumb2:"leftThumbIntermediate",mixamorigLeftHandThumb3:"leftThumbDistal",mixamorigLeftHandIndex1:"leftIndexProximal",mixamorigLeftHandIndex2:"leftIndexIntermediate",mixamorigLeftHandIndex3:"leftIndexDistal",mixamorigLeftHandMiddle1:"leftMiddleProximal",mixamorigLeftHandMiddle2:"leftMiddleIntermediate",mixamorigLeftHandMiddle3:"leftMiddleDistal",mixamorigLeftHandRing1:"leftRingProximal",mixamorigLeftHandRing2:"leftRingIntermediate",mixamorigLeftHandRing3:"leftRingDistal",mixamorigLeftHandPinky1:"leftLittleProximal",mixamorigLeftHandPinky2:"leftLittleIntermediate",mixamorigLeftHandPinky3:"leftLittleDistal",mixamorigRightShoulder:"rightShoulder",mixamorigRightArm:"rightUpperArm",mixamorigRightForeArm:"rightLowerArm",mixamorigRightHand:"rightHand",mixamorigRightHandPinky1:"rightLittleProximal",mixamorigRightHandPinky2:"rightLittleIntermediate",mixamorigRightHandPinky3:"rightLittleDistal",mixamorigRightHandRing1:"rightRingProximal",mixamorigRightHandRing2:"rightRingIntermediate",mixamorigRightHandRing3:"rightRingDistal",mixamorigRightHandMiddle1:"rightMiddleProximal",mixamorigRightHandMiddle2:"rightMiddleIntermediate",mixamorigRightHandMiddle3:"rightMiddleDistal",mixamorigRightHandIndex1:"rightIndexProximal",mixamorigRightHandIndex2:"rightIndexIntermediate",mixamorigRightHandIndex3:"rightIndexDistal",mixamorigRightHandThumb1:"rightThumbProximal",mixamorigRightHandThumb2:"rightThumbIntermediate",mixamorigRightHandThumb3:"rightThumbDistal",mixamorigLeftUpLeg:"leftUpperLeg",mixamorigLeftLeg:"leftLowerLeg",mixamorigLeftFoot:"leftFoot",mixamorigLeftToeBase:"leftToes",mixamorigRightUpLeg:"rightUpperLeg",mixamorigRightLeg:"rightLowerLeg",mixamorigRightFoot:"rightFoot",mixamorigRightToeBase:"rightToes"};async function Bn(l,e){}function Be(l,e){return new En().loadAsync(l).then(n=>{const i=Fe.findByName(n.animations,"mixamo.com"),r=[],a=new C,s=new C,o=new C,g=new P,h=n.getObjectByName("mixamorigHips")?.position.y,c=e.humanoid?.getNormalizedBoneNode("hips")?.getWorldPosition(g).y,u=e.scene.getWorldPosition(g).y;let m=1;c!==void 0&&u!==void 0&&h!==void 0?m=Math.abs(c-u)/h:console.error("One or more variables are undefined:",{vrmHipsY:c,vrmRootY:u,motionHipsHeight:h}),i.tracks.forEach(f=>{const d=f.name.split("."),y=d[0],v=Dn[y],_=e.humanoid?.getNormalizedBoneNode(v)?.name,T=n.getObjectByName(y);if(_!=null){const A=d[1];if(T?.getWorldQuaternion(a).invert(),T?.parent?.getWorldQuaternion(s),f instanceof oe){for(let F=0;F<f.values.length;F+=4){const x=f.values.slice(F,F+4);o.fromArray(x),o.premultiply(s).multiply(a),o.toArray(x),x.forEach((L,k)=>{f.values[k+F]=L})}r.push(new oe(`${_}.${A}`,f.times,f.values.map((F,x)=>e.meta?.metaVersion==="0"&&x%2===0?-F:F)))}else if(f instanceof se){const F=f.values.map((x,L)=>(e.meta?.metaVersion==="0"&&L%3!==1?-x:x)*m);r.push(new se(`${_}.${A}`,f.times,F))}}});const p=new Fe("vrmAnimation",i.duration,r);return Bn(),p})}const Ce=2048;class Cn{audio;analyser;timeDomainData;currentSource=null;isPlaying=!1;constructor(e){this.audio=e,this.analyser=e.createAnalyser(),this.timeDomainData=new Float32Array(Ce)}update(){this.analyser.getFloatTimeDomainData(this.timeDomainData);let e=0;for(let t=0;t<Ce;t++)e=Math.max(e,Math.abs(this.timeDomainData[t]));return e=1/(1+Math.exp(-45*e+5)),e<.1&&(e=0),{volume:e}}async playFromArrayBuffer(e,t){try{if(e===null)return;if(this.currentSource){console.log(" Stopping previous VRM audio for lip sync");try{this.currentSource.stop()}catch{}this.currentSource.disconnect(),this.currentSource=null,this.isPlaying=!1}this.isPlaying=!0;const n=await this.audio.decodeAudioData(e);if(!this.isPlaying){console.log(" Audio playback cancelled during decoding (new audio arrived)"),t?.();return}const i=this.audio.createBufferSource();i.buffer=n,i.connect(this.audio.destination),i.connect(this.analyser),this.currentSource=i,i.start(),t?i.addEventListener("ended",()=>{this.currentSource===i&&(this.currentSource=null,this.isPlaying=!1),t()}):i.addEventListener("ended",()=>{this.currentSource===i&&(this.currentSource=null,this.isPlaying=!1)})}catch(n){console.error(n),this.currentSource=null,this.isPlaying=!1,t?.()}}}class On{_vrm;_lookAtTarget;constructor(e,t){this._vrm=e,this._lookAtTarget=new re,t.add(this._lookAtTarget)}start(){this._vrm.lookAt&&(this._vrm.lookAt.target=this._lookAtTarget)}}const Vn=.12,Yn=5;class Un{_expressionManager;_remainingTime;_isOpen;_isAutoBlink;constructor(e){this._expressionManager=e,this._remainingTime=0,this._isAutoBlink=!0,this._isOpen=!0}setEnable(e){return this._isAutoBlink=e,this._isOpen?0:this._remainingTime}update(e){if(this._remainingTime>0){this._remainingTime-=e;return}if(this._isOpen&&this._isAutoBlink){this.close();return}this.open()}close(){this._isOpen=!1,this._remainingTime=Vn,this._expressionManager.setValue("blink",1)}open(){this._isOpen=!0,this._remainingTime=Yn,this._expressionManager.setValue("blink",0)}}class zn{primitives;index;weight;constructor({primitives:e,index:t,weight:n}){this.primitives=e,this.index=t,this.weight=n}applyWeight(e){this.primitives.forEach(t=>{t.morphTargetInfluences?.[this.index]!=null&&(t.morphTargetInfluences[this.index]+=this.weight*e)})}clearAppliedWeight(){this.primitives.forEach(e=>{e.morphTargetInfluences?.[this.index]!=null&&(e.morphTargetInfluences[this.index]=0)})}}function Gn(l,e){const t=[];return e.forEach(({name:n,targets:i})=>{const r=new jt(n),a=l.scene.getObjectByName("Face");if(!a){console.warn("vrm.faceObjectNotFound");return}const s=a.children.filter(h=>h instanceof Ye),g=a.children[0].morphTargetDictionary;if(!g){console.warn("vrm.morphTargetDictionaryNotFound");return}i.forEach(({targetName:h,weight:c})=>{g[h]!==void 0?r.addBind(new zn({primitives:s,index:g[h],weight:c})):console.warn("vrm.targetNotFound",{values:{targetName:h}})}),t.push(r)}),t}const Oe=[{name:"Fcl_EYE_Natural",targets:[{targetName:"Fcl_EYE_Natural",weight:1}]},{name:"Fcl_EYE_Angry",targets:[{targetName:"Fcl_EYE_Angry",weight:1}]},{name:"Fcl_EYE_Close",targets:[{targetName:"Fcl_EYE_Close",weight:1}]},{name:"Fcl_EYE_Close_R",targets:[{targetName:"Fcl_EYE_Close_R",weight:1}]},{name:"Fcl_EYE_Close_L",targets:[{targetName:"Fcl_EYE_Close_L",weight:1}]},{name:"Fcl_EYE_Fun",targets:[{targetName:"Fcl_EYE_Fun",weight:1}]},{name:"Fcl_EYE_Joy",targets:[{targetName:"Fcl_EYE_Joy",weight:1}]},{name:"Fcl_EYE_Joy_R",targets:[{targetName:"Fcl_EYE_Joy_R",weight:1}]},{name:"Fcl_EYE_Joy_L",targets:[{targetName:"Fcl_EYE_Joy_L",weight:1}]},{name:"Fcl_EYE_Sorrow",targets:[{targetName:"Fcl_EYE_Sorrow",weight:1}]},{name:"Fcl_EYE_Surprised",targets:[{targetName:"Fcl_EYE_Surprised",weight:1}]},{name:"Fcl_EYE_Spread",targets:[{targetName:"Fcl_EYE_Spread",weight:1}]},{name:"Fcl_EYE_Iris_Hide",targets:[{targetName:"Fcl_EYE_Iris_Hide",weight:1}]},{name:"Fcl_EYE_Highlight_Hide",targets:[{targetName:"Fcl_EYE_Highlight_Hide",weight:1}]},{name:"Fcl_MTH_Close",targets:[{targetName:"Fcl_MTH_Close",weight:1}]},{name:"Fcl_MTH_Up",targets:[{targetName:"Fcl_MTH_Up",weight:1}]},{name:"Fcl_MTH_Down",targets:[{targetName:"Fcl_MTH_Down",weight:1}]},{name:"Fcl_MTH_Angry",targets:[{targetName:"Fcl_MTH_Angry",weight:1}]},{name:"Fcl_MTH_Small",targets:[{targetName:"Fcl_MTH_Small",weight:1}]},{name:"Fcl_MTH_Large",targets:[{targetName:"Fcl_MTH_Large",weight:1}]},{name:"Fcl_MTH_Neutral",targets:[{targetName:"Fcl_MTH_Neutral",weight:1}]},{name:"Fcl_MTH_Fun",targets:[{targetName:"Fcl_MTH_Fun",weight:1}]},{name:"Fcl_MTH_Joy",targets:[{targetName:"Fcl_MTH_Joy",weight:1}]},{name:"Fcl_MTH_Sorrow",targets:[{targetName:"Fcl_MTH_Sorrow",weight:1}]},{name:"Fcl_MTH_Surprised",targets:[{targetName:"Fcl_MTH_Surprised",weight:1}]},{name:"Fcl_MTH_SkinFung",targets:[{targetName:"Fcl_MTH_SkinFung",weight:1}]},{name:"Fcl_MTH_SkinFung_R",targets:[{targetName:"Fcl_MTH_SkinFung_R",weight:1}]},{name:"Fcl_MTH_SkinFung_L",targets:[{targetName:"Fcl_MTH_SkinFung_L",weight:1}]},{name:"Fcl_MTH_A",targets:[{targetName:"Fcl_MTH_A",weight:1}]},{name:"Fcl_MTH_I",targets:[{targetName:"Fcl_MTH_I",weight:1}]},{name:"Fcl_MTH_U",targets:[{targetName:"Fcl_MTH_U",weight:1}]},{name:"Fcl_MTH_E",targets:[{targetName:"Fcl_MTH_E",weight:1}]},{name:"Fcl_MTH_O",targets:[{targetName:"Fcl_MTH_O",weight:1}]},{name:"Fcl_HA_Hide",targets:[{targetName:"Fcl_HA_Hide",weight:1}]},{name:"Fcl_HA_Fung1",targets:[{targetName:"Fcl_HA_Fung1",weight:1}]},{name:"Fcl_HA_Fung1_Low",targets:[{targetName:"Fcl_HA_Fung1_Low",weight:1}]},{name:"Fcl_HA_Fung1_Up",targets:[{targetName:"Fcl_HA_Fung1_Up",weight:1}]},{name:"Fcl_HA_Fung2",targets:[{targetName:"Fcl_HA_Fung2",weight:1}]},{name:"Fcl_HA_Fung2_Low",targets:[{targetName:"Fcl_HA_Fung2_Low",weight:1}]},{name:"Fcl_HA_Fung2_Up",targets:[{targetName:"Fcl_HA_Fung2_Up",weight:1}]},{name:"Fcl_HA_Fung3",targets:[{targetName:"Fcl_HA_Fung3",weight:1}]},{name:"Fcl_HA_Fung3_Up",targets:[{targetName:"Fcl_HA_Fung3_Up",weight:1}]},{name:"Fcl_HA_Fung3_Low",targets:[{targetName:"Fcl_HA_Fung3_Low",weight:1}]},{name:"Fcl_HA_Short",targets:[{targetName:"Fcl_HA_Short",weight:1}]},{name:"Fcl_HA_Short_Up",targets:[{targetName:"Fcl_HA_Short_Up",weight:1}]},{name:"Fcl_HA_Short_Low",targets:[{targetName:"Fcl_HA_Short_Low",weight:1}]},{name:"admiration",targets:[{targetName:"Fcl_BRW_Surprised",weight:1},{targetName:"Fcl_EYE_Spread",weight:1},{targetName:"Fcl_MTH_Joy",weight:.45},{targetName:"Fcl_MTH_O",weight:.7},{targetName:"Fcl_MTH_Down",weight:.25},{targetName:"Fcl_MTH_Large",weight:1-.45}]},{name:"amusement",targets:[{targetName:"Fcl_EYE_Fun",weight:.8},{targetName:"Fcl_MTH_Fun",weight:.9},{targetName:"Fcl_BRW_Fun",weight:.7}]},{name:"anger",targets:[{targetName:"Fcl_BRW_Angry",weight:.7},{targetName:"Fcl_EYE_Angry",weight:.9},{targetName:"Fcl_MTH_Angry",weight:.8}]},{name:"annoyance",targets:[{targetName:"Fcl_BRW_Angry",weight:.6},{targetName:"Fcl_EYE_Close_R",weight:.6},{targetName:"Fcl_EYE_Close_L",weight:.6},{targetName:"Fcl_MTH_Angry",weight:.7}]},{name:"approval",targets:[{targetName:"Fcl_EYE_Joy",weight:.8},{targetName:"Fcl_MTH_Fun",weight:.7},{targetName:"Fcl_BRW_Fun",weight:.5}]},{name:"caring",targets:[{targetName:"Fcl_EYE_Joy",weight:.46},{targetName:"Fcl_EYE_Sorrow",weight:1},{targetName:"Fcl_EYE_Surprised",weight:.89},{targetName:"Fcl_EYE_Highlight_Hide",weight:.64},{targetName:"Fcl_MTH_Down",weight:.01},{targetName:"Fcl_MTH_Angry",weight:.91},{targetName:"Fcl_MTH_Large",weight:.33}]},{name:"confusion",targets:[{targetName:"Fcl_EYE_Surprised",weight:.7},{targetName:"Fcl_BRW_Surprised",weight:.6},{targetName:"Fcl_MTH_Neutral",weight:.4}]},{name:"curiosity",targets:[{targetName:"Fcl_EYE_Natural",weight:.9},{targetName:"Fcl_BRW_Joy",weight:.7},{targetName:"Fcl_MTH_Small",weight:.4},{targetName:"Fcl_EYE_Surprised",weight:.3}]},{name:"desire",targets:[{targetName:"Fcl_EYE_Close",weight:.7},{targetName:"Fcl_MTH_Fun",weight:.8}]},{name:"disappointment",targets:[{targetName:"Fcl_BRW_Sorrow",weight:.39},{targetName:"Fcl_EYE_Sorrow",weight:.6},{targetName:"Fcl_MTH_Close",weight:1},{targetName:"Fcl_EYE_Highlight_Hide",weight:1},{targetName:"Fcl_MTH_Angry",weight:.42},{targetName:"Fcl_MTH_Large",weight:.01},{targetName:"Fcl_EYE_Surprised",weight:1},{targetName:"Fcl_EYE_Close",weight:.13},{targetName:"Fcl_EYE_Angry",weight:.47}]},{name:"disapproval",targets:[{targetName:"Fcl_BRW_Angry",weight:.61},{targetName:"Fcl_EYE_Angry",weight:1},{targetName:"Fcl_MTH_Angry",weight:.64},{targetName:"Fcl_MTH_Small",weight:.53},{targetName:"Fcl_EYE_Sorrow",weight:1}]},{name:"disgust",targets:[{targetName:"Fcl_EYE_Highlight_Hide",weight:1},{targetName:"Fcl_EYE_Surprised",weight:1},{targetName:"Fcl_EYE_Spread",weight:.48},{targetName:"Fcl_BRW_Joy",weight:.1},{targetName:"Fcl_BRW_Sorrow",weight:.69},{targetName:"Fcl_MTH_Sorrow",weight:.48},{targetName:"Fcl_MTH_Angry",weight:.47},{targetName:"Fcl_MTH_Small",weight:.02},{targetName:"Fcl_MTH_Large",weight:.45},{targetName:"Fcl_MTH_Down",weight:.18}]},{name:"embarrassment",targets:[{targetName:"Fcl_MTH_Small",weight:.76},{targetName:"Fcl_BRW_Joy",weight:.44},{targetName:"Fcl_BRW_Sorrow",weight:.16},{targetName:"Fcl_EYE_Sorrow",weight:1},{targetName:"Fcl_EYE_Fun",weight:1},{targetName:"Fcl_EYE_Spread",weight:.72},{targetName:"Fcl_EYE_Highlight_Hide",weight:.52},{targetName:"Fcl_MTH_Close",weight:1},{targetName:"Fcl_MTH_Angry",weight:.48},{targetName:"Fcl_MTH_Up",weight:.28}]},{name:"excitement",targets:[{targetName:"Fcl_EYE_Fun",weight:1},{targetName:"Fcl_MTH_Fun",weight:1},{targetName:"Fcl_BRW_Fun",weight:.68},{targetName:"Fcl_BRW_Angry",weight:.7},{targetName:"Fcl_EYE_Spread",weight:.38},{targetName:"Fcl_EYE_Surprised",weight:.4},{targetName:"Fcl_MTH_Joy",weight:.46},{targetName:"Fcl_MTH_Large",weight:.38}]},{name:"fear",targets:[{targetName:"Fcl_BRW_Sorrow",weight:1},{targetName:"Fcl_BRW_Surprised",weight:1},{targetName:"Fcl_EYE_Highlight_Hide",weight:.39},{targetName:"Fcl_MTH_Close",weight:1},{targetName:"Fcl_MTH_Neutral",weight:1},{targetName:"Fcl_MTH_Angry",weight:1},{targetName:"Fcl_EYE_Spread",weight:.83},{targetName:"Fcl_MTH_Small",weight:.58},{targetName:"Fcl_EYE_Surprised",weight:1},{targetName:"Fcl_EYE_Sorrow",weight:.41}]},{name:"gratitude",targets:[{targetName:"Fcl_MTH_Neutral",weight:1},{targetName:"Fcl_MTH_Fun",weight:1},{targetName:"Fcl_MTH_Close",weight:.4},{targetName:"Fcl_EYE_Sorrow",weight:1},{targetName:"Fcl_EYE_Fun",weight:1},{targetName:"Fcl_BRW_Sorrow",weight:.15},{targetName:"Fcl_BRW_Joy",weight:.22},{targetName:"Fcl_BRW_Angry",weight:.19}]},{name:"grief",targets:[{targetName:"Fcl_BRW_Sorrow",weight:1},{targetName:"Fcl_EYE_Sorrow",weight:.54},{targetName:"Fcl_EYE_Spread",weight:.25},{targetName:"Fcl_MTH_Angry",weight:.35},{targetName:"Fcl_MTH_A",weight:.31},{targetName:"Fcl_MTH_U",weight:.44},{targetName:"Fcl_MTH_Down",weight:.12}]},{name:"joy",targets:[{targetName:"Fcl_EYE_Joy",weight:1},{targetName:"Fcl_MTH_Joy",weight:1},{targetName:"Fcl_BRW_Joy",weight:.7}]},{name:"love",targets:[{targetName:"Fcl_EYE_Fun",weight:1},{targetName:"Fcl_BRW_Sorrow",weight:.17},{targetName:"Fcl_BRW_Surprised",weight:.57},{targetName:"Fcl_MTH_Close",weight:.99},{targetName:"Fcl_MTH_Fun",weight:.71},{targetName:"Fcl_MTH_Down",weight:.24},{targetName:"Fcl_EYE_Joy",weight:.25}]},{name:"nervousness",targets:[{targetName:"Fcl_MTH_Close",weight:1},{targetName:"Fcl_MTH_Small",weight:.53},{targetName:"Fcl_EYE_Spread",weight:.24},{targetName:"Fcl_EYE_Sorrow",weight:.86},{targetName:"Fcl_EYE_Surprised",weight:1},{targetName:"Fcl_EYE_Close",weight:.17},{targetName:"Fcl_BRW_Angry",weight:.26}]},{name:"optimism",targets:[{targetName:"Fcl_EYE_Close",weight:1},{targetName:"Fcl_BRW_Fun",weight:1},{targetName:"Fcl_MTH_Large",weight:.56},{targetName:"Fcl_MTH_Fun",weight:1}]},{name:"pride",targets:[{targetName:"Fcl_EYE_Close",weight:.16},{targetName:"Fcl_MTH_Fun",weight:1},{targetName:"Fcl_BRW_Angry",weight:.7},{targetName:"Fcl_MTH_Joy",weight:.18},{targetName:"Fcl_MTH_Large",weight:.17}]},{name:"realization",targets:[{targetName:"Fcl_MTH_Small",weight:1},{targetName:"Fcl_EYE_Surprised",weight:1},{targetName:"Fcl_MTH_Joy",weight:.22},{targetName:"Fcl_MTH_Surprised",weight:.11},{targetName:"Fcl_BRW_Joy",weight:.66}]},{name:"relief",targets:[{targetName:"Fcl_MTH_Fun",weight:1},{targetName:"Fcl_BRW_Fun",weight:.74},{targetName:"Fcl_BRW_Joy",weight:.77},{targetName:"Fcl_BRW_Surprised",weight:.05},{targetName:"Fcl_EYE_Joy",weight:.12},{targetName:"Fcl_MTH_Close",weight:.57},{targetName:"Fcl_MTH_Neutral",weight:.43},{targetName:"Fcl_MTH_Small",weight:.15}]},{name:"remorse",targets:[{targetName:"Fcl_BRW_Sorrow",weight:.51},{targetName:"Fcl_BRW_Surprised",weight:.51},{targetName:"Fcl_EYE_Sorrow",weight:1},{targetName:"Fcl_EYE_Surprised",weight:1},{targetName:"Fcl_EYE_Highlight_Hide",weight:.59},{targetName:"Fcl_MTH_Down",weight:.55},{targetName:"Fcl_MTH_Angry",weight:.45}]},{name:"sadness",targets:[{targetName:"Fcl_MTH_Sorrow",weight:.41},{targetName:"Fcl_MTH_Angry",weight:.51},{targetName:"Fcl_MTH_Close",weight:1},{targetName:"Fcl_EYE_Highlight_Hide",weight:1},{targetName:"Fcl_EYE_Sorrow",weight:1},{targetName:"Fcl_MTH_O",weight:.14},{targetName:"Fcl_HA_Hide",weight:1},{targetName:"Fcl_EYE_Surprised",weight:1},{targetName:"Fcl_EYE_Close",weight:.8}]},{name:"surprise",targets:[{targetName:"Fcl_EYE_Surprised",weight:1},{targetName:"Fcl_MTH_Surprised",weight:1},{targetName:"Fcl_BRW_Surprised",weight:.8}]},{name:"neutral",targets:[{targetName:"Fcl_ALL_Neutral",weight:1}]}];class Wn{_autoLookAt;_autoBlink;_expressionManager;_currentLipSync;_currentExpressions=[];constructor(e,t){this._autoLookAt=new On(e,t),this._autoLookAt.start(),this._currentLipSync=null,e.expressionManager&&(this._expressionManager=e.expressionManager,this._autoBlink=new Un(e.expressionManager));const n=["Fcl_MTH_A","Fcl_MTH_I","Fcl_MTH_U","Fcl_MTH_E","Fcl_MTH_O","Fcl_MTH_Joy","Fcl_MTH_Sorrow","Fcl_MTH_Surprised"];Oe.forEach(r=>{r.targets.forEach(a=>{n.includes(a.targetName)&&(a.weight=0)})}),Gn(e,Oe).forEach(r=>{this._expressionManager?.registerExpression(r)})}_easeInOutSine(e){return .5*(1-Math.cos(Math.PI*e))}playEmotion(e){this._currentExpressions=this._currentExpressions.map(t=>{const n=e.find(i=>i.key===t.key);return{key:t.key,value:t.target_value,target_value:n?.value??0,ease_time:0}}),e.forEach(t=>{this._currentExpressions.find(n=>n.key===t.key)===void 0&&this._currentExpressions.push({key:t.key,value:0,target_value:t.value,ease_time:0})})}lipSync(e,t){this._currentLipSync&&this._expressionManager?.setValue(this._currentLipSync.preset,0),this._currentLipSync={preset:e,value:t}}lerp(e,t,n){return e+n*(t-e)}update(e){if(this._autoBlink&&this._autoBlink.update(e),this._currentExpressions.forEach(t=>{t.ease_time!==1&&(t.ease_time=Math.min(t.ease_time+e,1),this._expressionManager?.setValue(t.key,this.lerp(t.value,t.target_value,this._easeInOutSine(t.ease_time))))}),this._currentExpressions=this._currentExpressions.filter(t=>t.target_value!==0||t.ease_time!==1),this._currentLipSync){const t=this._currentLipSync.value*.5;this._expressionManager?.setValue(this._currentLipSync.preset,t)}}}function Ze(l,e,t,n,i){if(n<=0)return;const r=2*Math.log(2)/n,a=l.clone().sub(t),s=e.clone().addScaledVector(a,r),o=Math.exp(-r*i);l.copy(t).addScaledVector(a.addScaledVector(s,i),o),e.copy(s).sub(a.multiplyScalar(r)).multiplyScalar(o)}function jn(l,e,t,n,i){if(e.lengthSq()>1e-12){const g=new Ve().setFromAxisAngle(e.clone().normalize(),e.length()*i);l.multiply(g).normalize()}const r=l.clone().invert().multiply(t).normalize();r.w<0&&(r.x*=-1,r.y*=-1,r.z*=-1,r.w*=-1);const a=2*Math.acos(we.clamp(r.w,-1,1));if(a<1e-5){e.set(0,0,0);return}const o=new I(r.x,r.y,r.z).normalize().multiplyScalar(a);Ze(o,e,new I(0,0,0),n,i)}function Xn(l){return l.halfPos===0?!0:l.velPos.lengthSq()<1e-6&&l.bone.position.distanceToSquared(l.originalPos)<1e-4}function Jn(l){const t=2*(1-Math.abs(l.bone.quaternion.dot(l.originalQuat)));return l.velRot.lengthSq()<1e-4&&t<1e-4}const qn=$t([]);function $n(l,e,t=Math.random()*360){qn.update(n=>[...n,{id:crypto.randomUUID(),x:l,y:e,angle:t}])}function Kn(l,e=["Hips","hips","Root","mixamorigHips"]){const t=Array.isArray(l)?l:[l];for(const n of t)n.tracks=n.tracks.filter(i=>{if(!(i instanceof se))return!0;const[r,a]=i.name.split(".");return!(e.includes(r)&&a==="position")}),n.resetDuration();return t}function Qn(l,e,t,n,i,r){const a=new I().subVectors(t,l).multiplyScalar(n).addScaledVector(e,-i);e.addScaledVector(a,r),l.addScaledVector(e,r)}class Zn{cfg={rotImpulseHead:15,halfRotHead:.25,rotImpulseBody:12,halfRotBody:.25,rotImpulseLimb:10,halfRotLimb:.3};gltf=null;vrm=null;expressionController;lipSync;springManager;stateManager;lookPos=new I;lookVel=new I;lookTarget=new te;gazeGoal=new te;lookStiffness=120;lookDamping=25;hitStates=[];camera;raycaster=new ct;hittableBones=[];mixer;actions={};lookAtTarget=new te;lookAtGoal=new te;eyeGazeTimer=0;nextGazeChangeTime=0;gazeMoveSpeed=1;isFollowingMouse=!1;constructor(){this.lipSync=new Cn(new AudioContext)}canvas=null;setCanvas(e){this.canvas=e}async load(e,t){this.camera=t;const n=Qt();try{this.gltf=await n.loadAsync(e)}catch{console.warn("VRM load failed. Fallback to sample model."),this.gltf=await n.loadAsync("./AvatarSample_B.vrm")}if(this.vrm=this.gltf.userData.vrm,!this.vrm)return null;this.springManager=this.vrm.springBoneManager,this.springManager?.reset(),this.vrm.scene.add(this.lookTarget),this.vrm.scene.add(this.gazeGoal),this.vrm.lookAt.target=this.lookTarget,this.vrm.lookAt.autoUpdate=!0,this.stateManager=new ht(this,this.vrm);const i=["head","neck","upperChest","chest","spine","leftUpperArm","leftLowerArm","leftHand","rightUpperArm","rightLowerArm","rightHand","leftUpperLeg","leftLowerLeg","leftFoot","rightUpperLeg","rightLowerLeg","rightFoot"];return this.hittableBones=i.map(r=>this.vrm.humanoid.getRawBoneNode(r)).filter(r=>!!r),this.expressionController=new Wn(this.vrm,t),this.setupLookAt(),this.vrm}async initAnimations(){if(!this.vrm)return;this.mixer=new gt(this.vrm.scene);const e=["Acknowledging.fbx","Agreeing.fbx","Air Squat Bent Arms.fbx","Angry Gesture.fbx","Angry.fbx","Arm Gesture.fbx","Arm Stretching.fbx","Arms Hip Hop Dance.fbx","Bashful.fbx","Being Cocky.fbx","Bellydancing.fbx","Blow A Kiss.fbx","Bored.fbx","Breathing Idle.fbx","Breathing Idle1.fbx","Breathing Idle2.fbx","Chicken Dance.fbx","Clapping.fbx","Crawling.fbx","Crying.fbx","Dancing Twerk.fbx","Dancing.fbx","Dismissing Gesture.fbx","Drunk Idle Variation.fbx","Drunk Idle.fbx","Dwarf Idle(1).fbx","Dwarf Idle(2).fbx","Dwarf Idle.fbx","Fallen Idle.fbx","Female Laying Pose.fbx","Female Standing Pose.fbx","Fist Pump.fbx","Happy Idle(1).fbx","Happy Idle.fbx","Hard Head Nod.fbx","Head Nod Yes.fbx","Hokey Pokey.fbx","Idle_nomal.fbx","Injured Hurting Idle.fbx","Injured Idle.fbx","Jazz Dancing.fbx","Joyful Jump.fbx","Kick To The Groin.fbx","Kiss.fbx","Kneeling Idle.fbx","Listening.fbx","Looking Around.fbx","Looking Behind.fbx","Low Crawl.fbx","Neck Stretching.fbx","Neutral Idle.fbx","No.fbx","Old Man Idle.fbx","Orc Idle(1).fbx","Orc Idle.fbx","Plotting.fbx","Pointing.fbx","Pouting.fbx","Praying.fbx","Quick Formal Bow.fbx","Reacting.fbx","Rumba Dancing.fbx","Sad Idle(1).fbx","Sad Idle.fbx","Sarcastic Head Nod.fbx","Shoulder Rubbing.fbx","Shrugging.fbx","Snake Hip Hop Dance.fbx","Spank twice.fbx","Standing Arguing.fbx","Standing Greeting.fbx","Standing Idle(1).fbx","Step Hip Hop Dance.fbx","Taken Hostage - Victim.fbx","Talk femininely.fbx","Talking.fbx","Talking1.fbx","Talking2.fbx","Talking3.fbx","Talking4.fbx","Talking5.fbx","Thankful.fbx","Twist Dance.fbx","Victory(1).fbx","Victory.fbx","Walking.fbx","Waving(1).fbx","Waving.fbx","Wheelbarrow Idle.fbx","Yawning.fbx","base/Idle Base.fbx","base/Arms crossed.fbx","base/Hands on waist.fbx","base/Looking Around.fbx","base/Listening.fbx","base/Listening2.fbx","base/Listening Start.fbx","base/Listening End.fbx","base/talk1.fbx","base/talk2.fbx","base/talk3.fbx"];this.actions={},await Promise.all(e.map(async t=>{const n=await Be(`/animations/${t}`,this.vrm);t.includes("/")&&(t=t.split("/")[1]),Kn(n);const i=this.mixer.clipAction(n);this.actions[t]=i}))}async loadAnimations(e){const n=await(await fetch("/anims.json")).json();for(const i of n)Be(Jt+`/animations/${i}`,e).then(r=>{this.actions==null&&(this.actions={}),this.actions&&this.mixer&&(this.actions={...this.actions,[i]:this.mixer.clipAction(r)},console.log("load animation :",i))})}Emotion(e,t=1){this.expressionController?.playEmotion([{key:e,value:t}])}setupLookAt(){if(this.vrm?.lookAt){if(this.vrm.lookAt){this.vrm.scene.add(this.lookAtTarget),this.vrm.scene.add(this.lookAtGoal);const e=this.vrm.humanoid.getRawBoneNode("head"),t=this.vrm.lookAt.applier.applyYawPitch;this.vrm.lookAt.applier.applyYawPitch=function(n,i){if(t.call(this,n,i),!e)return;const r=5,a=7,s=1.6,o=.2;let g=0;Math.abs(n)>r&&(g=(n-Math.sign(n)*r)*s);let h=0;Math.abs(i)>a&&(h=(i-Math.sign(i)*a)*s);const c=new Ve().setFromEuler(new ut(h*we.DEG2RAD,g*we.DEG2RAD,0,"YXZ")),u=e.quaternion.clone().multiply(c);e.quaternion.slerp(u,o)},this.lookAtTarget.position.set(0,0,0),this.vrm.lookAt.target=this.lookAtTarget,this.vrm.lookAt.autoUpdate=!0}this.changeGaze()}}changeGaze(e={x:1.5,y:.8,z:1}){this.nextGazeChangeTime=2+Math.random()*5,this.eyeGazeTimer=0,this.gazeMoveSpeed=10+Math.random()*5,this.lookAtGoal.position.set((Math.random()-.5)*e.x,(Math.random()-.5)*e.y+1,Math.random()*e.z+.5)}startMouseFollowing(){this.isFollowingMouse=!0,this.gazeMoveSpeed=20}stopMouseFollowing(){this.isFollowingMouse=!1}updateMouseGaze(e,t){this.isFollowingMouse&&this.lookAtGoal.position.set(e*2,-t*1+1,1)}getHalfLifeParams(e){const t=e.toLowerCase();return t.includes("head")||t.includes("neck")?{halfPos:0,halfRot:this.cfg.halfRotHead}:t.includes("chest")||t.includes("spine")||t.includes("upperchest")?{halfPos:.25,halfRot:this.cfg.halfRotBody}:{halfPos:.25,halfRot:this.cfg.halfRotLimb}}getHalfLifeParams2(e){const i=e.toLowerCase();return{halfPos:i.includes("head")||i.includes("neck")?0:.25,halfRot:i.includes("head")||i.includes("neck")?.18:.25}}mouseFollowTimer=null;hitByMouse(e,t,n=1){this.resetHitSprings(),this.raycaster.setFromCamera({x:e,y:t},this.camera);const i=this.raycaster.ray;let r=null,a=1/0;const s=new I;for(const F of this.hittableBones){F.getWorldPosition(s);const x=i.distanceToPoint(s);x<.15&&x<a&&(r=F,a=x)}if(!r)return;const o=new I;r.getWorldPosition(o);const g=new I;i.closestPointToPoint(o,g);const h=g.clone().project(this.camera),c=this.canvas.getBoundingClientRect(),u=(h.x*.5+.5)*c.width+c.left,m=(-h.y*.5+.5)*c.height+c.top;$n(u,m);const p=g.clone().sub(o),f=new I().crossVectors(i.direction,p);f.lengthSq()<1e-6&&f.set(0,1,0).cross(i.direction),f.normalize();const d=r.name.toLowerCase(),y=d.includes("head")||d.includes("neck")?this.cfg.rotImpulseHead:d.includes("chest")||d.includes("spine")?this.cfg.rotImpulseBody:this.cfg.rotImpulseLimb,{halfPos:v,halfRot:_}=this.getHalfLifeParams(r.name),T=i.direction.clone().multiplyScalar(.6*n),A=f.multiplyScalar(y*n);this.hitStates.push({bone:r,originalPos:r.position.clone(),originalQuat:r.quaternion.clone(),velPos:T,velRot:A,halfPos:v,halfRot:_}),this.startMouseFollowing(),this.mouseFollowTimer&&clearTimeout(this.mouseFollowTimer),this.mouseFollowTimer=setTimeout(()=>{this.stopMouseFollowing()},3e3)}async speak(e){await new Promise(t=>{this.lipSync.playFromArrayBuffer(e,()=>t(!0))})}resetHitSprings(){for(const e of this.hitStates)e.bone.position.copy(e.originalPos),e.bone.quaternion.copy(e.originalQuat),e.bone.updateMatrixWorld(!0);this.hitStates.length=0,this.hitStates=[]}applyHitSprings(e){for(let t=this.hitStates.length-1;t>=0;--t){const n=this.hitStates[t];Ze(n.bone.position,n.velPos,n.originalPos,n.halfPos,e),jn(n.bone.quaternion,n.velRot,n.originalQuat,n.halfRot,e),n.bone.updateMatrixWorld(!0),Xn(n)&&Jn(n)&&(n.bone.position.copy(n.originalPos),n.bone.quaternion.copy(n.originalQuat),this.hitStates.splice(t,1))}}fps=0;DEBUG_MODE=!1;doGesture(e){this.stateManager?.triggerGesture(e)}update(e){if(!this.vrm)return;Qn(this.lookPos,this.lookVel,this.gazeGoal.position,this.lookStiffness,this.lookDamping,e),this.lookTarget.position.copy(this.lookPos),this.eyeGazeTimer+=e,!this.isFollowingMouse&&this.eyeGazeTimer>this.nextGazeChangeTime&&this.changeGaze(),this.lookAtTarget.position.distanceTo(this.lookAtGoal.position)>.01&&this.lookAtTarget.position.lerp(this.lookAtGoal.position,e*this.gazeMoveSpeed);const n=this.lipSync.update().volume;this.expressionController?.lipSync("aa",n),this.expressionController?.update(e),this.mixer?.update(e),this.springManager?.update(e),this.vrm.update(e),this.stateManager?.update(e),this.applyHitSprings(e),this.fps+=e,this.DEBUG_MODE&&this.fps>1&&(this.fps=0,console.log("DEBUG INFO: ",this.stateManager?.getDebugInfo()))}dispose(){if(this.mouseFollowTimer&&(clearTimeout(this.mouseFollowTimer),this.mouseFollowTimer=null),this.stateManager?.stop(.2),this.mixer?.stopAllAction(),this.vrm?.scene&&this.mixer?.uncacheRoot(this.vrm.scene),this.mixer=void 0,this.actions={},!!this.vrm){try{Xt.deepDispose(this.vrm.scene)}catch(e){console.error(e)}this.vrm=null}}}class ei{model=new Zn;renderer;scene;camera;clock=new mt;canvas;id=Kt();animationFrameId=null;isStopped=!1;postProcessing;constructor(e){this.canvas=e,this.renderer=new pt({canvas:e,antialias:!0,alpha:!0}),this.renderer.setSize(e.clientWidth,e.clientHeight),this.renderer.setPixelRatio(window.devicePixelRatio),this.renderer.outputColorSpace=ft,this.scene=new dt,this.camera=new _t(25,e.clientWidth/e.clientHeight,.1,100),this.camera.position.set(0,1.35,2.5),this.scene.remove(...this.scene.children.filter(i=>i instanceof wt));const t=new yt(16777215,1.6);t.position.set(1,2,2),this.scene.add(t);const n=Ft(this.scene,this.camera);vt(n,.1,.001,.2),this.postProcessing=new xt(this.renderer),this.postProcessing.outputNode=n}getHeadPointInUI(){if(!this.model.vrm)return console.warn("VRM   ."),null;const e=this.model.vrm.humanoid.getBoneNode("head");if(!e)return console.warn("    ."),null;const t=new I;e.getWorldPosition(t);const n=t.clone().project(this.camera);if(n.z<1){const i=(n.x*.5+.5)*this.canvas.clientWidth,r=(n.y*-.5+.5)*this.canvas.clientHeight;return{x:Math.round(i),y:Math.round(r)}}return null}async loadModel(e){this.model.vrm&&this.scene.remove(this.model.vrm.scene);const t=await this.model.load(e,this.camera);if(!t)return console.error("VRM  "),null;t.scene.traverse(o=>{o.isMesh&&(o.castShadow=!0,o.receiveShadow=!0)});const n=new Tt().setFromObject(t.scene);t.scene.position.y=-n.min.y,t.scene.updateMatrixWorld(!0);const i=new I;n.getSize(i);const r=new I;n.getCenter(r);const a=r.y+i.y/2*.9,s=i.y*1.5;return this.camera.position.set(r.x,a,s),this.camera.lookAt(new I(r.x,a,r.z)),this.camera.updateProjectionMatrix(),await this.model.initAnimations(),this.scene.add(t.scene),this.clock.running||this.start(),this.model}renderLoop=async()=>{if(this.isStopped){console.log("Render loop stopped by flag.");return}const e=this.clock.getDelta();this.model.update(e),await this.renderer.renderAsync(this.scene,this.camera),this.postProcessing.render(),this.animationFrameId=requestAnimationFrame(this.renderLoop)};updateUIPosition(){if(!this.model?.vrm)return;const e=this.model.vrm.humanoid.getBoneNode("head");if(!e)return;console.log("--- UI Update ---");const t=new I;e.getWorldPosition(t),console.log("Head World Pos:",{x:t.x.toFixed(2),y:t.y.toFixed(2),z:t.z.toFixed(2)});const n=t.clone().project(this.camera);console.log("Projected (NDC):",{x:n.x.toFixed(2),y:n.y.toFixed(2),z:n.z.toFixed(2)});const i=n.z<1;console.log("Is On Screen?",i)}start(){this.clock.start(),this.renderLoop(),this.isStopped=!1}stop(){if(this.isStopped){console.log("Viewer is already stopped.");return}this.isStopped=!0,console.log("Stopping viewer and releasing resources..."),this.animationFrameId&&cancelAnimationFrame(this.animationFrameId),this.clock.stop(),this.model&&this.model.vrm&&(this.scene.remove(this.model.vrm.scene),console.log("VRM model removed from scene.")),this.model&&(this.model.dispose(),console.log("VRM model disposed.")),this.renderer.dispose(),console.log("Renderer disposed."),console.log("Viewer stopped successfully.")}}let et=null,G=null;function hi(){return G}function gi(l,e){console.log("#### Loading VRM ####"),G&&G.stop(),G=new ei(l);const t=e.vrm_url||`${st}${e.owner_id[0]}/${e.id}.vrm`;let n=G.loadModel(t);return n.then(i=>{et=i,G&&G.start()}),n}function ui(){et&&G?.stop()}export{hi as g,qn as s,gi as t,ui as u};
